<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <title>Staff Management - {{ config.school_name }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Inter font for Solar theme -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Solar Theme Tokens + heroicon base */
      :root {
        --solar-bg-1: #fdf6e3;
        --solar-bg-2: #eee8d5;
        --solar-bg-3: #d6d2c4;
        --solar-primary: #b58900;
        --solar-secondary: #268bd2;
        --solar-green: #859900;
        --solar-red: #dc322f;
        --solar-text-primary: #002b36;
        --solar-text-secondary: #073642;
      }
      :root {
        /* Map legacy vars to Solar */
        --primary-color: var(--solar-primary) !important;
        --secondary-color: var(--solar-secondary) !important;
        --white: #ffffff !important;
        --border-color: rgba(238, 232, 213, 0.5) !important;
        --shadow-md: 0 10px 30px rgba(181, 137, 0, 0.1) !important;
        --border-radius: 12px !important;
        --border-radius-lg: 18px !important;
        --spacing-sm: 8px !important;
        --spacing-md: 12px !important;
        --spacing-lg: 20px !important;
        --spacing-xl: 32px !important;
        --transition: all 0.25s ease !important;
      }
      body {
        background: linear-gradient(
          135deg,
          var(--solar-bg-1) 0%,
          var(--solar-bg-2) 60%,
          var(--solar-bg-3) 100%
        );
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: var(--solar-text-primary);
      }
      .heroicon {
        display: inline-block;
        width: 1.1rem;
        height: 1.1rem;
        fill: currentColor;
        vertical-align: middle;
      }
      .heroicon-lg {
        width: 1.6rem;
        height: 1.6rem;
      }
      .heroicon-xl {
        width: 2rem;
        height: 2rem;
      }
      .heroicon-solar-blue {
        color: var(--solar-secondary);
      }
      .heroicon-solar-green {
        color: var(--solar-green);
      }
      .heroicon-solar-yellow {
        color: var(--solar-primary);
      }
      .heroicon-solar-red {
        color: var(--solar-red);
      }

      .page-title {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--solar-text-primary);
      }
      .btn-outline-secondary {
        border-color: rgba(0, 0, 0, 0.12);
        color: var(--solar-text-secondary);
        background: rgba(253, 246, 227, 0.5);
      }
      .btn-outline-secondary:hover {
        background: rgba(238, 232, 213, 0.8);
        color: var(--solar-text-primary);
      }

      .staff-card {
        border-left: 4px solid var(--solar-primary);
        transition: var(--transition);
        border-radius: var(--border-radius);
      }
      .staff-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
      }

      .role-badge {
        background: linear-gradient(
          135deg,
          var(--solar-primary),
          var(--solar-secondary)
        );
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
      }

      .assignment-section {
        background: linear-gradient(
          135deg,
          rgba(253, 246, 227, 0.9),
          rgba(238, 232, 213, 0.9)
        );
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-md);
      }

      .btn-primary {
        background: var(--solar-secondary);
        border-color: var(--solar-secondary);
      }
      .btn-primary:hover {
        background: #1e78bd;
        border-color: #1e78bd;
      }

      .staff-stats {
        background: linear-gradient(
          135deg,
          var(--solar-primary),
          var(--solar-secondary)
        );
        color: white;
        border-radius: var(--border-radius);
        padding: 1.25rem;
        box-shadow: var(--shadow-md);
      }

      .card {
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
      }
      .card-header {
        background: rgba(253, 246, 227, 0.6);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0 page-title">
              <svg
                class="heroicon heroicon-lg heroicon-solar-yellow"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M16 11c1.657 0 3-1.567 3-3.5S17.657 4 16 4s-3 1.567-3 3.5 1.343 3.5 3 3.5z"
                />
                <path
                  d="M3 8.5C3 6.567 4.79 5 7 5s4 1.567 4 3.5S9.21 12 7 12 3 10.433 3 8.5z"
                />
                <path
                  d="M7 13c-2.761 0-5 1.79-5 4v.5A2.5 2.5 0 004.5 20h5.55a6.5 6.5 0 01.46-5h-3.51z"
                />
                <path
                  d="M16 13a5 5 0 00-5 5v.5c0 .276.224.5.5.5H21.5a.5.5 0 00.5-.5V18a5 5 0 00-5-5z"
                />
              </svg>
              Staff Management
            </h1>
            <a
              href="{{ url_for('classteacher.dashboard') }}"
              class="btn btn-outline-secondary"
            >
              <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M9.53 3.97a.75.75 0 010 1.06L4.56 10h15.19a.75.75 0 010 1.5H4.56l4.97 4.97a.75.75 0 11-1.06 1.06l-6.25-6.25a.75.75 0 010-1.06l6.25-6.25a.75.75 0 011.06 0z"
                  clip-rule="evenodd"
                />
              </svg>
              Back to Dashboard
            </a>
          </div>
        </div>
      </div>

      <!-- Staff Statistics -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="staff-stats text-center">
            <svg
              class="heroicon heroicon-xl mb-2"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M16 11c1.657 0 3-1.567 3-3.5S17.657 4 16 4s-3 1.567-3 3.5 1.343 3.5 3 3.5z"
              />
              <path
                d="M3 8.5C3 6.567 4.79 5 7 5s4 1.567 4 3.5S9.21 12 7 12 3 10.433 3 8.5z"
              />
              <path
                d="M7 13c-2.761 0-5 1.79-5 4v.5A2.5 2.5 0 004.5 20h14a2.5 2.5 0 002.5-2.5V17a5 5 0 00-5-5h-8z"
              />
            </svg>
            <h4>{{ teachers|length }}</h4>
            <p class="mb-0">Total Teachers</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="staff-stats text-center">
            <svg
              class="heroicon heroicon-xl mb-2"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M12 2.25a5.25 5.25 0 015.25 5.25v1.088a6.75 6.75 0 012.25 5.012V18a3 3 0 01-3 3H7.5a3 3 0 01-3-3v-4.4a6.75 6.75 0 012.25-5.012V7.5A5.25 5.25 0 0112 2.25zm0 3a2.25 2.25 0 00-2.25 2.25v.75h4.5V7.5A2.25 2.25 0 0012 5.25z"
                clip-rule="evenodd"
              />
            </svg>
            <h4>{{ active_teachers }}</h4>
            <p class="mb-0">Active Teachers</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="staff-stats text-center">
            <svg
              class="heroicon heroicon-xl mb-2"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path d="M12 3a9 9 0 100 18 9 9 0 000-18z" />
              <path
                d="M9 9.75a.75.75 0 011.5 0V12h3.75a.75.75 0 110 1.5H10.5v2.25a.75.75 0 11-1.5 0V13.5H6.75a.75.75 0 110-1.5H9V9.75z"
              />
            </svg>
            <h4>{{ class_teachers }}</h4>
            <p class="mb-0">Class Teachers</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="staff-stats text-center">
            <svg
              class="heroicon heroicon-xl mb-2"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M11.7 2.3a1 1 0 011.6 0l8 10a1 1 0 01-.8 1.7H3.5a1 1 0 01-.8-1.7l9-10z"
              />
              <path d="M12 6l6 7H6l6-7z" />
            </svg>
            <h4>{{ qualified_teachers }}</h4>
            <p class="mb-0">With Qualifications</p>
          </div>
        </div>
      </div>

      <!-- School Leadership Assignment -->
      <div class="assignment-section">
        <h4 class="mb-3 d-flex align-items-center gap-2">
          <svg
            class="heroicon heroicon-lg heroicon-solar-yellow"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M12 2l2.39 4.84 5.34.78-3.86 3.76.91 5.31L12 14.77l-4.78 2.51.91-5.31L4.27 7.62l5.34-.78L12 2z"
            />
          </svg>
          School Leadership
        </h4>
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title d-flex align-items-center gap-2">
                  <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                      d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
                    />
                    <path
                      fill-rule="evenodd"
                      d="M3 20.25a9 9 0 1118 0v.75H3v-.75z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  Headteacher
                </h6>
                {% if current_headteacher %}
                <p class="mb-2">
                  <strong
                    >{{ current_headteacher.full_name or
                    current_headteacher.username }}</strong
                  >
                  <br />
                  <small class="text-muted"
                    >{{ current_headteacher.employee_id }}</small
                  >
                </p>
                <button
                  class="btn btn-sm btn-outline-primary"
                  data-action="change-headteacher"
                >
                  Change Headteacher
                </button>
                {% else %}
                <p class="text-muted mb-2">No headteacher assigned</p>
                <button
                  class="btn btn-sm btn-primary"
                  data-action="assign-headteacher"
                >
                  Assign Headteacher
                </button>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title d-flex align-items-center gap-2">
                  <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                      d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
                    />
                    <path
                      fill-rule="evenodd"
                      d="M3 20.25a9 9 0 1118 0v.75H3v-.75z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  Deputy Headteacher
                </h6>
                {% if current_deputy %}
                <p class="mb-2">
                  <strong
                    >{{ current_deputy.full_name or current_deputy.username
                    }}</strong
                  >
                  <br />
                  <small class="text-muted"
                    >{{ current_deputy.employee_id }}</small
                  >
                </p>
                <button
                  class="btn btn-sm btn-outline-primary"
                  data-action="change-deputy"
                >
                  Change Deputy
                </button>
                {% else %}
                <p class="text-muted mb-2">No deputy headteacher assigned</p>
                <button
                  class="btn btn-sm btn-primary"
                  data-action="assign-deputy"
                >
                  Assign Deputy
                </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Teachers List -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0 d-flex align-items-center gap-2">
                <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    fill-rule="evenodd"
                    d="M3.75 6.75A.75.75 0 014.5 6h15a.75.75 0 010 1.5h-15a.75.75 0 01-.75-.75zM3.75 12a.75.75 0 01.75-.75h15a.75.75 0 010 1.5h-15A.75.75 0 013.75 12zm0 5.25a.75.75 0 01.75-.75h15a.75.75 0 010 1.5h-15a.75.75 0 01-.75-.75z"
                    clip-rule="evenodd"
                  />
                </svg>
                All Teachers
              </h5>
              <button
                class="btn btn-primary btn-sm d-inline-flex align-items-center gap-2"
                data-action="show-add-teacher"
              >
                <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    fill-rule="evenodd"
                    d="M12 2.25a.75.75 0 01.75.75V11h8a.75.75 0 010 1.5h-8v8a.75.75 0 01-1.5 0v-8H3a.75.75 0 010-1.5h8V3a.75.75 0 01.75-.75z"
                    clip-rule="evenodd"
                  />
                </svg>
                Add Teacher
              </button>
            </div>
            <div class="card-body">
              <div class="row">
                {% for teacher in teachers %}
                <div class="col-md-6 col-lg-4 mb-3">
                  <div class="card staff-card h-100">
                    <div class="card-body">
                      <div
                        class="d-flex justify-content-between align-items-start mb-2"
                      >
                        <h6 class="card-title mb-0">
                          {{ teacher.full_name or teacher.username }}
                        </h6>
                        <span class="role-badge"
                          >{{ teacher.role.title() }}</span
                        >
                      </div>

                      <p
                        class="text-muted small mb-2 d-flex align-items-center gap-1"
                      >
                        <svg
                          class="heroicon"
                          viewBox="0 0 24 24"
                          fill="currentColor"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M14.25 6.087a.75.75 0 010 1.326l-2.25 1.2a.75.75 0 01-1.114-.66V4.5a.75.75 0 011.114-.66l2.25 1.2zM4.5 3.75A1.5 1.5 0 003 5.25v13.5A1.5 1.5 0 004.5 20.25h15a1.5 1.5 0 001.5-1.5V5.25a1.5 1.5 0 00-1.5-1.5h-15z"
                            clip-rule="evenodd"
                          />
                        </svg>
                        {{ teacher.employee_id or 'No ID' }}
                      </p>

                      {% if teacher.qualification %}
                      <p
                        class="text-muted small mb-2 d-flex align-items-center gap-1"
                      >
                        <svg
                          class="heroicon"
                          viewBox="0 0 24 24"
                          fill="currentColor"
                        >
                          <path
                            d="M11.7 2.3a1 1 0 011.6 0l8 10a1 1 0 01-.8 1.7H3.5a1 1 0 01-.8-1.7l9-10z"
                          />
                          <path d="M12 6l6 7H6l6-7z" />
                        </svg>
                        {{ teacher.qualification }}
                      </p>
                      {% endif %} {% if teacher.email %}
                      <p
                        class="text-muted small mb-2 d-flex align-items-center gap-1"
                      >
                        <svg
                          class="heroicon"
                          viewBox="0 0 24 24"
                          fill="currentColor"
                        >
                          <path
                            d="M1.5 6A2.25 2.25 0 013.75 3.75h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6z"
                          />
                          <path
                            d="M2.33 6.46l8.74 5.46a1.5 1.5 0 001.86 0l8.74-5.46"
                          />
                        </svg>
                        {{ teacher.email }}
                      </p>
                      {% endif %}

                      <div
                        class="d-flex justify-content-between align-items-center mt-3"
                      >
                        <div>
                          {% if teacher.is_active %}
                          <span class="badge bg-success">Active</span>
                          {% else %}
                          <span class="badge bg-secondary">Inactive</span>
                          {% endif %}
                        </div>
                        <div class="btn-group btn-group-sm">
                          <button
                            class="btn btn-outline-primary"
                            data-action="edit-teacher"
                            data-teacher-id="{{ teacher.id }}"
                          >
                            <svg
                              class="heroicon"
                              viewBox="0 0 24 24"
                              fill="currentColor"
                            >
                              <path
                                d="M21.731 2.269a2.625 2.625 0 00-3.713 0l-1.92 1.92 3.713 3.713 1.92-1.92a2.625 2.625 0 000-3.713z"
                              />
                              <path
                                d="M2.684 16.311a2.25 2.25 0 01.59-1.014L14.4 4.17l3.713 3.713L6.987 19.01a2.25 2.25 0 01-1.014.59l-3.34.956a.75.75 0 01-.923-.923l.956-3.34z"
                              />
                            </svg>
                          </button>
                          <button
                            class="btn btn-outline-info"
                            data-action="assign-subjects"
                            data-teacher-id="{{ teacher.id }}"
                          >
                            <svg
                              class="heroicon"
                              viewBox="0 0 24 24"
                              fill="currentColor"
                            >
                              <path
                                d="M2.25 5.25A2.25 2.25 0 014.5 3h6.75A2.25 2.25 0 0113.5 5.25v13.5a.75.75 0 01-1.148.638 6.466 6.466 0 00-3.602-1.088H4.5a2.25 2.25 0 01-2.25-2.25V5.25z"
                              />
                              <path
                                d="M12.75 5.25A2.25 2.25 0 0115 3h4.5A2.25 2.25 0 0121.75 5.25v10.5A2.25 2.25 0 0119.5 18h-3.75a6.466 6.466 0 00-3.602 1.088.75.75 0 01-1.148-.638V5.25z"
                              />
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Teacher Modal -->
    <div
      class="modal fade"
      id="editTeacherModal"
      tabindex="-1"
      aria-labelledby="editTeacherModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5
              class="modal-title d-flex align-items-center gap-2"
              id="editTeacherModalLabel"
            >
              <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M21.731 2.269a2.625 2.625 0 00-3.713 0l-1.92 1.92 3.713 3.713 1.92-1.92a2.625 2.625 0 000-3.713z"
                />
                <path
                  d="M2.684 16.311a2.25 2.25 0 01.59-1.014L14.4 4.17l3.713 3.713L6.987 19.01a2.25 2.25 0 01-1.014.59l-3.34.956a.75.75 0 01-.923-.923l.956-3.34z"
                />
              </svg>
              Edit Teacher
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editTeacherForm">
              <input type="hidden" id="editTeacherId" name="teacher_id" />

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="editUsername" class="form-label">Username</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editUsername"
                    name="username"
                    readonly
                  />
                  <small class="text-muted">Username cannot be changed</small>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="editRole" class="form-label">Role</label>
                  <select class="form-select" id="editRole" name="role">
                    <option value="teacher">Teacher</option>
                    <option value="classteacher">Class Teacher</option>
                    <option value="headteacher">Head Teacher</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="editFullName" class="form-label">Full Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editFullName"
                    name="full_name"
                    placeholder="Enter full name"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="editEmployeeId" class="form-label"
                    >Employee ID</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="editEmployeeId"
                    name="employee_id"
                    placeholder="Enter employee ID"
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="editEmail" class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    id="editEmail"
                    name="email"
                    placeholder="Enter email address"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="editPhone" class="form-label">Phone Number</label>
                  <input
                    type="tel"
                    class="form-control"
                    id="editPhone"
                    name="phone_number"
                    placeholder="Enter phone number"
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="editQualification" class="form-label"
                    >Qualification</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="editQualification"
                    name="qualification"
                    placeholder="Enter qualification"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="editSpecialization" class="form-label"
                    >Specialization</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="editSpecialization"
                    name="specialization"
                    placeholder="Enter specialization"
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="editIsActive"
                      name="is_active"
                    />
                    <label class="form-check-label" for="editIsActive">
                      Active Status
                    </label>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary d-inline-flex align-items-center gap-2"
              data-action="save-teacher-changes"
            >
              <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M4.5 12a7.5 7.5 0 1112.53 5.303l3.184 3.183a.75.75 0 11-1.06 1.06l-3.183-3.183A7.5 7.5 0 014.5 12zm7.5-3.75a.75.75 0 00-.75.75v2.25H9a.75.75 0 000 1.5h2.25V15a.75.75 0 001.5 0v-2.25H15a.75.75 0 000-1.5h-2.25V9a.75.75 0 00-.75-.75z"
                  clip-rule="evenodd"
                />
              </svg>
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Subject Assignment Modal -->
    <div
      class="modal fade"
      id="subjectAssignmentModal"
      tabindex="-1"
      aria-labelledby="subjectAssignmentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5
              class="modal-title d-flex align-items-center gap-2"
              id="subjectAssignmentModalLabel"
            >
              <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M2.25 5.25A2.25 2.25 0 014.5 3h6.75A2.25 2.25 0 0113.5 5.25v13.5a.75.75 0 01-1.148.638 6.466 6.466 0 00-3.602-1.088H4.5a2.25 2.25 0 01-2.25-2.25V5.25z"
                />
                <path
                  d="M12.75 5.25A2.25 2.25 0 0115 3h4.5A2.25 2.25 0 0121.75 5.25v10.5A2.25 2.25 0 0119.5 18h-3.75a6.466 6.466 0 00-3.602 1.088.75.75 0 01-1.148-.638V5.25z"
                />
              </svg>
              Assign Subjects to <span id="assignTeacherName"></span>
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="assignTeacherId" name="teacher_id" />

            <div class="row">
              <div class="col-md-6">
                <h6>Available Subjects</h6>
                <div
                  class="border rounded p-3"
                  style="height: 400px; overflow-y: auto"
                >
                  <div id="availableSubjects">
                    <!-- Subjects will be loaded here -->
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <h6>Assigned Subjects</h6>
                <div
                  class="border rounded p-3"
                  style="height: 400px; overflow-y: auto"
                >
                  <div id="assignedSubjects">
                    <!-- Assigned subjects will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary d-inline-flex align-items-center gap-2"
              data-action="save-subject-assignments"
            >
              <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M3 4.5A1.5 1.5 0 014.5 3h15A1.5 1.5 0 0121 4.5V15a1.5 1.5 0 01-1.5 1.5H12l-3.72 3.72A.75.75 0 017 19.5V16.5H4.5A1.5 1.5 0 013 15V4.5z"
                  clip-rule="evenodd"
                />
              </svg>
              Save Assignments
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add New Teacher Modal -->
    <div
      class="modal fade"
      id="addTeacherModal"
      tabindex="-1"
      aria-labelledby="addTeacherModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5
              class="modal-title d-flex align-items-center gap-2"
              id="addTeacherModalLabel"
            >
              <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M12 2.25a.75.75 0 01.75.75V11h8a.75.75 0 010 1.5h-8v8a.75.75 0 01-1.5 0v-8H3a.75.75 0 010-1.5h8V3a.75.75 0 01.75-.75z"
                  clip-rule="evenodd"
                />
              </svg>
              Add New Teacher
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addTeacherForm">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="newUsername" class="form-label"
                    >Username <span class="text-danger">*</span></label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="newUsername"
                    name="username"
                    required
                  />
                  <small class="text-muted">This will be used for login</small>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="newPassword" class="form-label"
                    >Password <span class="text-danger">*</span></label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="newPassword"
                    name="password"
                    required
                  />
                  <small class="text-muted">Minimum 6 characters</small>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="newRole" class="form-label"
                    >Role <span class="text-danger">*</span></label
                  >
                  <select class="form-select" id="newRole" name="role" required>
                    <option value="">Select Role</option>
                    <option value="teacher">Teacher</option>
                    <option value="classteacher">Class Teacher</option>
                    <option value="headteacher">Head Teacher</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="newFullName" class="form-label">Full Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="newFullName"
                    name="full_name"
                    placeholder="Enter full name"
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="newEmployeeId" class="form-label"
                    >Employee ID</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="newEmployeeId"
                    name="employee_id"
                    placeholder="Enter employee ID"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="newEmail" class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    id="newEmail"
                    name="email"
                    placeholder="Enter email address"
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="newPhone" class="form-label">Phone Number</label>
                  <input
                    type="tel"
                    class="form-control"
                    id="newPhone"
                    name="phone_number"
                    placeholder="Enter phone number"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="newQualification" class="form-label"
                    >Qualification</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="newQualification"
                    name="qualification"
                    placeholder="Enter qualification"
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="newSpecialization" class="form-label"
                    >Specialization</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="newSpecialization"
                    name="specialization"
                    placeholder="Enter specialization"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <div class="form-check mt-4">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="newIsActive"
                      name="is_active"
                      checked
                    />
                    <label class="form-check-label" for="newIsActive">
                      Active Status
                    </label>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary d-inline-flex align-items-center gap-2"
              data-action="save-new-teacher"
            >
              <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M12 2.25a.75.75 0 01.75.75V11h8a.75.75 0 010 1.5h-8v8a.75.75 0 01-1.5 0v-8H3a.75.75 0 010-1.5h8V3a.75.75 0 01.75-.75z"
                  clip-rule="evenodd"
                />
              </svg>
              Add Teacher
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Get CSRF token
      function getCSRFToken() {
        return document
          .querySelector("meta[name=csrf-token]")
          .getAttribute("content");
      }

      function assignHeadteacher() {
        // Implementation for headteacher assignment
        alert("Headteacher assignment feature - to be implemented");
      }

      function changeHeadteacher() {
        // Implementation for changing headteacher
        alert("Change headteacher feature - to be implemented");
      }

      function assignDeputy() {
        // Implementation for deputy assignment
        alert("Deputy assignment feature - to be implemented");
      }

      function changeDeputy() {
        // Implementation for changing deputy
        alert("Change deputy feature - to be implemented");
      }

      function editTeacher(teacherId) {
        // Get teacher information first
        fetch(`/staff/teacher/${teacherId}/info`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showEditTeacherModal(data.teacher);
            } else {
              alert("Error loading teacher information: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error loading teacher information");
          });
      }

      function assignSubjects(teacherId) {
        // Get teacher information and available subjects
        Promise.all([
          fetch(`/staff/teacher/${teacherId}/info`),
          fetch("/staff/subjects/list"),
          fetch("/staff/grades/list"),
        ])
          .then((responses) => Promise.all(responses.map((r) => r.json())))
          .then(([teacherData, subjectsData, gradesData]) => {
            if (
              teacherData.success &&
              subjectsData.success &&
              gradesData.success
            ) {
              showSubjectAssignmentModal(
                teacherData.teacher,
                subjectsData.subjects,
                gradesData.grades
              );
            } else {
              alert("Error loading data for subject assignment");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error loading subject assignment data");
          });
      }

      function addNewTeacher() {
        // Show the add new teacher modal
        showAddTeacherModal();
      }

      function showEditTeacherModal(teacher) {
        // Populate the modal with teacher data
        document.getElementById("editTeacherId").value = teacher.id;
        document.getElementById("editUsername").value = teacher.username;
        document.getElementById("editRole").value = teacher.role;
        document.getElementById("editFullName").value = teacher.full_name || "";
        document.getElementById("editEmployeeId").value =
          teacher.employee_id || "";
        document.getElementById("editEmail").value = teacher.email || "";
        document.getElementById("editPhone").value = teacher.phone_number || "";
        document.getElementById("editQualification").value =
          teacher.qualification || "";
        document.getElementById("editSpecialization").value =
          teacher.specialization || "";
        document.getElementById("editIsActive").checked = teacher.is_active;

        // Show the modal
        const modal = new bootstrap.Modal(
          document.getElementById("editTeacherModal")
        );
        modal.show();
      }

      function saveTeacherChanges() {
        const teacherId = document.getElementById("editTeacherId").value;
        const formData = {
          full_name: document.getElementById("editFullName").value,
          role: document.getElementById("editRole").value,
          employee_id: document.getElementById("editEmployeeId").value,
          email: document.getElementById("editEmail").value,
          phone_number: document.getElementById("editPhone").value,
          qualification: document.getElementById("editQualification").value,
          specialization: document.getElementById("editSpecialization").value,
          is_active: document.getElementById("editIsActive").checked,
        };

        // Send update request
        fetch(`/staff/teacher/${teacherId}/update`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify(formData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Close modal
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("editTeacherModal")
              );
              modal.hide();

              // Show success message and reload page
              alert("Teacher updated successfully!");
              location.reload();
            } else {
              alert("Error updating teacher: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error updating teacher");
          });
      }

      function showSubjectAssignmentModal(teacher, subjects, grades) {
        // Set teacher info
        document.getElementById("assignTeacherId").value = teacher.id;
        document.getElementById("assignTeacherName").textContent =
          teacher.full_name || teacher.username;

        // Load available subjects
        const availableSubjectsDiv =
          document.getElementById("availableSubjects");
        availableSubjectsDiv.innerHTML = "";

        subjects.forEach((subject) => {
          const subjectDiv = document.createElement("div");
          subjectDiv.className = "form-check mb-2";
          subjectDiv.innerHTML = `
            <input class="form-check-input" type="checkbox" id="subject_${subject.id}" value="${subject.id}">
            <label class="form-check-label" for="subject_${subject.id}">
              <strong>${subject.name}</strong> <small class="text-muted">(${subject.education_level})</small>
            </label>
          `;
          availableSubjectsDiv.appendChild(subjectDiv);
        });

        // Load current assignments (this would need an API endpoint)
        const assignedSubjectsDiv = document.getElementById("assignedSubjects");
        assignedSubjectsDiv.innerHTML =
          '<p class="text-muted">Current assignments will be loaded here...</p>';

        // Show modal
        const modal = new bootstrap.Modal(
          document.getElementById("subjectAssignmentModal")
        );
        modal.show();
      }

      function saveSubjectAssignments() {
        const teacherId = document.getElementById("assignTeacherId").value;
        const selectedSubjects = [];

        // Get selected subjects
        document
          .querySelectorAll('#availableSubjects input[type="checkbox"]:checked')
          .forEach((checkbox) => {
            selectedSubjects.push(parseInt(checkbox.value));
          });

        // Send assignment request
        fetch("/staff/assign_subjects", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify({
            teacher_id: teacherId,
            subject_ids: selectedSubjects,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("subjectAssignmentModal")
              );
              modal.hide();
              alert("Subject assignments saved successfully!");
              location.reload();
            } else {
              alert("Error saving assignments: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error saving subject assignments");
          });
      }

      function showAddTeacherModal() {
        // Clear form
        document.getElementById("addTeacherForm").reset();
        document.getElementById("newIsActive").checked = true;

        // Show modal
        const modal = new bootstrap.Modal(
          document.getElementById("addTeacherModal")
        );
        modal.show();
      }

      function saveNewTeacher() {
        const formData = {
          username: document.getElementById("newUsername").value,
          password: document.getElementById("newPassword").value,
          role: document.getElementById("newRole").value,
          full_name: document.getElementById("newFullName").value,
          employee_id: document.getElementById("newEmployeeId").value,
          email: document.getElementById("newEmail").value,
          phone_number: document.getElementById("newPhone").value,
          qualification: document.getElementById("newQualification").value,
          specialization: document.getElementById("newSpecialization").value,
          is_active: document.getElementById("newIsActive").checked,
        };

        // Basic validation
        if (!formData.username || !formData.password || !formData.role) {
          alert(
            "Please fill in all required fields (Username, Password, Role)"
          );
          return;
        }

        if (formData.password.length < 6) {
          alert("Password must be at least 6 characters long");
          return;
        }

        // Send create request
        fetch("/staff/create_teacher", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify(formData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addTeacherModal")
              );
              modal.hide();
              alert("Teacher created successfully!");
              location.reload();
            } else {
              alert("Error creating teacher: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error creating teacher");
          });
      }

      // Delegated event handlers replacing inline onclick attributes
      document.addEventListener("click", function (e) {
        const el = e.target.closest("[data-action]");
        if (!el) return;
        const action = el.dataset.action;
        switch (action) {
          case "change-headteacher":
            changeHeadteacher();
            break;
          case "assign-headteacher":
            assignHeadteacher();
            break;
          case "change-deputy":
            changeDeputy();
            break;
          case "assign-deputy":
            assignDeputy();
            break;
          case "show-add-teacher":
            addNewTeacher();
            break;
          case "edit-teacher":
            editTeacher(el.dataset.teacherId);
            break;
          case "assign-subjects":
            assignSubjects(el.dataset.teacherId);
            break;
          case "save-teacher-changes":
            saveTeacherChanges();
            break;
          case "save-subject-assignments":
            saveSubjectAssignments();
            break;
          case "save-new-teacher":
            saveNewTeacher();
            break;
        }
      });
    </script>
  </body>
</html>
