<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <title>
      Class Teacher - {{ school_info.school_name|default('Hillview School') }}
    </title>

    <!-- Performance-optimized CSS -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        /* Modern Color System */
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --secondary: #64748b;
        --success: #059669;
        --warning: #d97706;
        --error: #dc2626;

        /* Neutral Palette */
        --gray-50: #f8fafc;
        --gray-100: #f1f5f9;
        --gray-200: #e2e8f0;
        --gray-300: #cbd5e1;
        --gray-600: #475569;
        --gray-700: #334155;
        --gray-800: #1e293b;
        --gray-900: #0f172a;

        /* Typography */
        --font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;

        /* Spacing */
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-6: 1.5rem;
        --space-8: 2rem;
        --space-12: 3rem;

        /* Layout */
        --border-radius: 0.75rem;
        --border-radius-sm: 0.5rem;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-family);
        background-color: var(--gray-50);
        color: var(--gray-900);
        line-height: 1.6;
      }

      /* Header */
      .header {
        background: white;
        border-bottom: 1px solid var(--gray-200);
        padding: var(--space-4) 0;
        position: sticky;
        top: 0;
        z-index: 50;
      }

      .header-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 var(--space-6);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: var(--space-4);
      }

      .brand img {
        width: 48px;
        height: 48px;
        border-radius: var(--border-radius-sm);
      }

      .brand-text h1 {
        font-size: var(--text-xl);
        font-weight: 700;
        color: var(--gray-900);
      }

      .brand-text p {
        font-size: var(--text-sm);
        color: var(--secondary);
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: var(--space-3);
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-4);
        background: var(--gray-50);
        border-radius: var(--border-radius);
        font-size: var(--text-sm);
        color: var(--gray-700);
      }

      /* Main Container */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-8) var(--space-6);
      }

      /* Context Banner */
      .context-banner {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        padding: var(--space-6);
        border-radius: var(--border-radius);
        margin-bottom: var(--space-8);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .context-info h2 {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--space-2);
      }

      .context-info p {
        font-size: var(--text-base);
        opacity: 0.9;
      }

      .context-stats {
        display: flex;
        gap: var(--space-6);
        text-align: center;
      }

      .context-stat {
        padding: var(--space-3);
        background: rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius-sm);
      }

      .context-stat .number {
        display: block;
        font-size: var(--text-xl);
        font-weight: 700;
      }

      .context-stat .label {
        font-size: var(--text-sm);
        opacity: 0.8;
      }

      /* Primary Actions */
      .primary-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--space-6);
        margin-bottom: var(--space-8);
      }

      .action-card {
        background: white;
        border-radius: var(--border-radius);
        padding: var(--space-6);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .action-card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
        transform: translateY(-2px);
      }

      .action-card-header {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin-bottom: var(--space-4);
      }

      .action-icon {
        width: 48px;
        height: 48px;
        background: var(--primary);
        color: white;
        border-radius: var(--border-radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-lg);
      }

      .action-card h3 {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--gray-900);
      }

      .action-card p {
        color: var(--secondary);
        font-size: var(--text-sm);
        line-height: 1.5;
        margin-bottom: var(--space-4);
      }

      .action-button {
        width: 100%;
        padding: var(--space-3) var(--space-4);
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--border-radius-sm);
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .action-button:hover {
        background: var(--primary-dark);
      }

      .action-button.secondary {
        background: var(--gray-100);
        color: var(--gray-700);
      }

      .action-button.secondary:hover {
        background: var(--gray-200);
      }

      /* Recent Activity */
      .recent-activity {
        background: white;
        border-radius: var(--border-radius);
        padding: var(--space-6);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: between;
        margin-bottom: var(--space-6);
      }

      .section-header h3 {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--gray-900);
      }

      .view-all-link {
        color: var(--primary);
        text-decoration: none;
        font-size: var(--text-sm);
        font-weight: 500;
      }

      .view-all-link:hover {
        text-decoration: underline;
      }

      /* Activity List */
      .activity-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
      }

      .activity-item {
        display: flex;
        align-items: center;
        gap: var(--space-4);
        padding: var(--space-4);
        background: var(--gray-50);
        border-radius: var(--border-radius-sm);
      }

      .activity-icon {
        width: 40px;
        height: 40px;
        background: var(--success);
        color: white;
        border-radius: var(--border-radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-sm);
        flex-shrink: 0;
      }

      .activity-content {
        flex: 1;
      }

      .activity-content h4 {
        font-size: var(--text-base);
        font-weight: 500;
        color: var(--gray-900);
        margin-bottom: var(--space-1);
      }

      .activity-content p {
        font-size: var(--text-sm);
        color: var(--secondary);
      }

      .activity-actions {
        display: flex;
        gap: var(--space-2);
      }

      .activity-btn {
        padding: var(--space-2) var(--space-3);
        font-size: var(--text-xs);
        border: 1px solid var(--gray-300);
        background: white;
        color: var(--gray-700);
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .activity-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
      }

      /* Status Badges */
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-1) var(--space-2);
        font-size: var(--text-xs);
        font-weight: 500;
        border-radius: var(--border-radius-sm);
      }

      .status-badge.success {
        background: #dcfce7;
        color: var(--success);
      }

      .status-badge.warning {
        background: #fef3c7;
        color: var(--warning);
      }

      .status-badge.error {
        background: #fecaca;
        color: var(--error);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .container {
          padding: var(--space-6) var(--space-4);
        }

        .context-banner {
          flex-direction: column;
          gap: var(--space-4);
          text-align: center;
        }

        .context-stats {
          justify-content: center;
        }

        .primary-actions {
          grid-template-columns: 1fr;
        }

        .activity-item {
          flex-direction: column;
          align-items: flex-start;
        }

        .activity-actions {
          width: 100%;
          justify-content: flex-end;
        }
      }

      /* Loading States */
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      .skeleton {
        background: linear-gradient(
          90deg,
          var(--gray-200) 25%,
          var(--gray-100) 50%,
          var(--gray-200) 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* Modal Overlay */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .modal {
        background: white;
        border-radius: var(--border-radius);
        padding: var(--space-8);
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-container">
        <div class="brand">
          {% if school_info.logo_path %}
          <img
            src="{{ url_for('static', filename=school_info.logo_path) }}"
            alt="{{ school_info.school_name or 'School' }} Logo"
          />
          {% endif %}
          <div class="brand-text">
            <h1>{{ school_info.school_name or 'Hillview School' }}</h1>
            <p>Class Teacher Portal</p>
          </div>
        </div>

        <div class="header-actions">
          <div class="user-menu">
            <i class="fas fa-user-circle"></i>
            <span>{{ session.get('username', 'Teacher') }}</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <a
            href="{{ url_for('auth.logout_route') }}"
            class="action-button secondary"
          >
            <i class="fas fa-sign-out-alt"></i> Logout
          </a>
        </div>
      </div>
    </header>

    <!-- Main Container -->
    <div class="container">
      <!-- Context Banner -->
      <div class="context-banner">
        <div class="context-info">
          <h2>
            {% if assignment_summary and
            assignment_summary.class_teacher_assignments %} {{
            assignment_summary.class_teacher_assignments[0].grade_name }} Stream
            {{ assignment_summary.class_teacher_assignments[0].stream_name }} {%
            else %} Multi-Class Teacher {% endif %}
          </h2>
          <p>
            Welcome back! You have {{ total_subjects_taught or 0 }} subjects
            across {{ assignment_summary.grades_involved|length if
            assignment_summary.grades_involved else 0 }} grades.
          </p>
        </div>
        <div class="context-stats">
          <div class="context-stat">
            <span class="number">{{ total_students or 0 }}</span>
            <span class="label">Students</span>
          </div>
          <div class="context-stat">
            <span class="number">{{ total_subjects_taught or 0 }}</span>
            <span class="label">Subjects</span>
          </div>
          <div class="context-stat">
            <span class="number">{{ recent_reports|length or 0 }}</span>
            <span class="label">Reports</span>
          </div>
        </div>
      </div>

      <!-- Primary Actions -->
      <div class="primary-actions">
        <!-- Upload Marks -->
        <div class="action-card" onclick="openUploadModal()">
          <div class="action-card-header">
            <div class="action-icon">
              <i class="fas fa-upload"></i>
            </div>
            <h3>Upload Marks</h3>
          </div>
          <p>
            Add or update student marks for your assigned subjects. Choose
            between manual entry or bulk upload from spreadsheet.
          </p>
          <button class="action-button">
            <i class="fas fa-plus"></i> Start Upload
          </button>
        </div>

        <!-- Generate Reports -->
        <div class="action-card" onclick="openReportModal()">
          <div class="action-card-header">
            <div class="action-icon" style="background: var(--success)">
              <i class="fas fa-file-pdf"></i>
            </div>
            <h3>Generate Reports</h3>
          </div>
          <p>
            Create comprehensive class reports and marksheets. Includes
            automatic parent notifications via email.
          </p>
          <button class="action-button" style="background: var(--success)">
            <i class="fas fa-chart-bar"></i> Generate Report
          </button>
        </div>

        <!-- View Analytics -->
        <div
          class="action-card"
          onclick="window.location.href='{{ url_for('classteacher.analytics_dashboard') }}'"
        >
          <div class="action-card-header">
            <div class="action-icon" style="background: var(--warning)">
              <i class="fas fa-analytics"></i>
            </div>
            <h3>Class Analytics</h3>
          </div>
          <p>
            View detailed performance analytics, trends, and insights for your
            classes and subjects.
          </p>
          <button class="action-button secondary">
            <i class="fas fa-chart-line"></i> View Analytics
          </button>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="recent-activity">
        <div class="section-header">
          <h3>Recent Activity</h3>
          <a
            href="{{ url_for('classteacher.all_reports') }}"
            class="view-all-link"
            >View All →</a
          >
        </div>

        <div class="activity-list">
          {% for report in recent_reports[:5] %}
          <div class="activity-item">
            <div class="activity-icon">
              <i class="fas fa-check"></i>
            </div>
            <div class="activity-content">
              <h4>
                {{ report.grade }} {{ report.stream }} - {{ report.term }}
              </h4>
              <p>
                {{ report.assessment_type }} • {{ report.mark_count }} students
                • {{ report.date }}
              </p>
            </div>
            <div class="activity-actions">
              <button
                class="activity-btn"
                onclick="viewReport('{{ report.grade }}', '{{ report.stream.replace('Stream ', '') }}', '{{ report.term }}', '{{ report.assessment_type }}')"
              >
                <i class="fas fa-eye"></i> View
              </button>
              <button
                class="activity-btn"
                onclick="downloadReport('{{ report.grade }}', '{{ report.stream.replace('Stream ', '') }}', '{{ report.term }}', '{{ report.assessment_type }}')"
              >
                <i class="fas fa-download"></i> PDF
              </button>
            </div>
          </div>
          {% else %}
          <div class="activity-item">
            <div class="activity-icon" style="background: var(--gray-400)">
              <i class="fas fa-info"></i>
            </div>
            <div class="activity-content">
              <h4>No recent reports</h4>
              <p>
                Upload marks and generate your first class report to get
                started.
              </p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal-overlay" id="uploadModal">
      <div class="modal">
        <h3>Upload Student Marks</h3>
        <p>Choose your upload method:</p>

        <div
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
            margin: var(--space-6) 0;
          "
        >
          <div class="action-card" onclick="startManualUpload()">
            <div class="action-icon">
              <i class="fas fa-keyboard"></i>
            </div>
            <h4>Manual Entry</h4>
            <p>Enter marks individually with real-time validation</p>
          </div>

          <div class="action-card" onclick="startBulkUpload()">
            <div class="action-icon" style="background: var(--warning)">
              <i class="fas fa-file-upload"></i>
            </div>
            <h4>Bulk Upload</h4>
            <p>Upload from Excel or CSV spreadsheet</p>
          </div>
        </div>

        <div
          style="display: flex; gap: var(--space-3); justify-content: flex-end"
        >
          <button
            class="action-button secondary"
            onclick="closeModal('uploadModal')"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay" id="reportModal">
      <div class="modal">
        <h3>Generate Class Report</h3>
        <p>Select parameters for your report:</p>

        <form id="reportForm" style="margin: var(--space-6) 0">
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: var(--space-4);
            "
          >
            <div>
              <label
                style="
                  display: block;
                  margin-bottom: var(--space-2);
                  font-weight: 500;
                "
                >Grade</label
              >
              <select
                name="grade"
                required
                style="
                  width: 100%;
                  padding: var(--space-3);
                  border: 1px solid var(--gray-300);
                  border-radius: var(--border-radius-sm);
                "
              >
                <option value="">Select Grade</option>
                {% for grade_option in grades %}
                <option value="{{ grade_option }}">{{ grade_option }}</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label
                style="
                  display: block;
                  margin-bottom: var(--space-2);
                  font-weight: 500;
                "
                >Term</label
              >
              <select
                name="term"
                required
                style="
                  width: 100%;
                  padding: var(--space-3);
                  border: 1px solid var(--gray-300);
                  border-radius: var(--border-radius-sm);
                "
              >
                <option value="">Select Term</option>
                {% for term in terms %}
                <option value="{{ term }}">{{ term }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div style="margin-top: var(--space-4)">
            <label
              style="
                display: block;
                margin-bottom: var(--space-2);
                font-weight: 500;
              "
              >Assessment Type</label
            >
            <select
              name="assessment_type"
              required
              style="
                width: 100%;
                padding: var(--space-3);
                border: 1px solid var(--gray-300);
                border-radius: var(--border-radius-sm);
              "
            >
              <option value="">Select Assessment</option>
              {% for assessment in assessment_types %}
              <option value="{{ assessment }}">{{ assessment }}</option>
              {% endfor %}
            </select>
          </div>
        </form>

        <div
          style="display: flex; gap: var(--space-3); justify-content: flex-end"
        >
          <button
            class="action-button secondary"
            onclick="closeModal('reportModal')"
          >
            Cancel
          </button>
          <button class="action-button" onclick="generateReport()">
            Generate Report
          </button>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Modal Functions
      function openUploadModal() {
        document.getElementById("uploadModal").style.display = "flex";
      }

      function openReportModal() {
        document.getElementById("reportModal").style.display = "flex";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // Upload Functions
      function startManualUpload() {
        window.location.href =
          '{{ url_for("classteacher.dashboard") }}#upload-marks';
      }

      function startBulkUpload() {
        window.location.href =
          '{{ url_for("classteacher.dashboard") }}#bulk-upload';
      }

      // Report Functions
      function generateReport() {
        const form = document.getElementById("reportForm");
        const formData = new FormData(form);

        if (!form.checkValidity()) {
          alert("Please fill in all required fields.");
          return;
        }

        const grade = formData.get("grade");
        const term = formData.get("term");
        const assessmentType = formData.get("assessment_type");

        const url =
          `{{ url_for('classteacher.generate_grade_marksheet', grade='GRADE', term='TERM', assessment_type='ASSESSMENT') }}`
            .replace("GRADE", encodeURIComponent(grade))
            .replace("TERM", encodeURIComponent(term))
            .replace("ASSESSMENT", encodeURIComponent(assessmentType));

        window.open(url, "_blank");
        closeModal("reportModal");
      }

      function viewReport(grade, stream, term, assessmentType) {
        const url =
          `{{ url_for('classteacher.preview_class_report', grade='GRADE', stream='STREAM', term='TERM', assessment_type='ASSESSMENT') }}`
            .replace("GRADE", encodeURIComponent(grade))
            .replace("STREAM", encodeURIComponent(`Stream ${stream}`))
            .replace("TERM", encodeURIComponent(term))
            .replace("ASSESSMENT", encodeURIComponent(assessmentType));

        window.open(url, "_blank");
      }

      function downloadReport(grade, stream, term, assessmentType) {
        const url =
          `{{ url_for('classteacher.generate_grade_marksheet', grade='GRADE', term='TERM', assessment_type='ASSESSMENT', action='download') }}`
            .replace("GRADE", encodeURIComponent(grade))
            .replace("TERM", encodeURIComponent(term))
            .replace("ASSESSMENT", encodeURIComponent(assessmentType));

        window.open(url, "_blank");
      }

      // Close modals when clicking outside
      document.addEventListener("click", function (event) {
        if (event.target.classList.contains("modal-overlay")) {
          event.target.style.display = "none";
        }
      });

      // Keyboard navigation
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          document.querySelectorAll(".modal-overlay").forEach((modal) => {
            modal.style.display = "none";
          });
        }
      });
    </script>
  </body>
</html>
