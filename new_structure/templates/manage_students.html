<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <meta name="description" content="Manage Students - {{ school_info.school_name or 'Hillview School' }} Class Teacher Portal">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#b58900">

    <title>Manage Students - {{ school_info.school_name or 'Hillview School' }} (Class Teacher)</title>

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <!-- Professional Solar Theme Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* SOLAR THEME - FORCE BACKGROUND */
        html {
            background: linear-gradient(135deg, #fdf6e3 0%, #eee8d5 50%, #d6d2c4 100%) !important;
            min-height: 100vh !important;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #fdf6e3 0%, #eee8d5 50%, #d6d2c4 100%) !important;
            min-height: 100vh !important;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
            padding: 20px !important;
            margin: 0 !important;
            overflow-x: hidden !important;
            background-attachment: fixed !important;
        }

        /* Override any Bootstrap or external CSS backgrounds */
        body, html, .container, .container-fluid {
            background: linear-gradient(135deg, #fdf6e3 0%, #eee8d5 50%, #d6d2c4 100%) !important;
        }

        /* Heroicon Colors - Solar Theme */
        .heroicon-solar-blue { fill: #268bd2; }
        .heroicon-solar-yellow { fill: #b58900; }
        .heroicon-solar-green { fill: #859900; }
        .heroicon-solar-red { fill: #dc322f; }
        .heroicon-solar-orange { fill: #cb4b16; }
        .heroicon-solar-cyan { fill: #2aa198; }
        .heroicon-solar-violet { fill: #6c71c4; }
        .heroicon-solar-magenta { fill: #d33682; }
        .heroicon-solar-dark { fill: #002b36; }
        .heroicon-solar-light { fill: #93a1a1; }
        /* Override container styles for manage pages - Solar Theme */
        .manage-container {
            background: transparent !important;
            max-width: 95% !important;
            width: 95% !important;
            margin: 20px auto !important;
            padding: 0 !important;
        }

        /* Page header styling - Solar Theme */
        .page-header {
            background: linear-gradient(145deg, rgba(253, 246, 227, 0.95) 0%, rgba(238, 232, 213, 0.9) 100%);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0, 43, 54, 0.15);
            border: 2px solid rgba(181, 137, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #b58900, #268bd2, #859900, #dc322f);
            border-radius: 25px 25px 0 0;
        }

        .page-header h1 {
            color: #002b36;
            margin-bottom: 10px;
            font-size: 2.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #b58900, #268bd2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .page-subtitle {
            color: #586e75;
            font-size: 1.1rem;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #268bd2;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 12px;
            background: rgba(38, 139, 210, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(38, 139, 210, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links a:hover {
            background: rgba(38, 139, 210, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(38, 139, 210, 0.15);
            text-decoration: none;
        }

        /* Forms grid layout - Solar Enhanced */
        .forms-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        /* Section styling - Solar Theme Enhanced */
        .search-filter-section,
        .add-student-section,
        .bulk-upload-section,
        .students-list-section,
        .students-section {
            background: linear-gradient(145deg, rgba(253, 246, 227, 0.95) 0%, rgba(238, 232, 213, 0.9) 100%);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0, 43, 54, 0.15);
            border: 2px solid rgba(181, 137, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .search-filter-section::before,
        .students-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #859900, #268bd2, #b58900);
            border-radius: 25px 25px 0 0;
        }

        .form-card {
            background: linear-gradient(145deg, rgba(253, 246, 227, 0.95) 0%, rgba(238, 232, 213, 0.9) 100%);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0, 43, 54, 0.15);
            border: 2px solid rgba(181, 137, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .form-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #b58900, #859900, #268bd2);
            border-radius: 25px 25px 0 0;
        }

        .form-card h2 {
            color: #002b36;
            margin-bottom: 25px;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Form styling - Solar Theme Enhanced */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #002b36;
            font-weight: 600;
            font-size: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(88, 110, 117, 0.2);
            border-radius: 12px;
            font-size: 1rem;
            color: #002b36;
            background: rgba(253, 246, 227, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .form-control:focus {
            outline: none;
            border-color: #268bd2;
            box-shadow: 0 0 0 4px rgba(38, 139, 210, 0.1);
            transform: translateY(-2px);
            background: rgba(253, 246, 227, 1);
        }

        /* Button styling - Solar Theme */
        .btn, .search-btn, .clear-search-btn, .add-btn, .upload-btn, .manage-btn {
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn, .search-btn, .add-btn, .upload-btn, .manage-btn {
            background: linear-gradient(135deg, #268bd2 0%, #2c5aa0 100%);
            color: #fdf6e3;
            box-shadow: 0 4px 15px rgba(38, 139, 210, 0.3);
        }

        .btn:hover, .search-btn:hover, .add-btn:hover, .upload-btn:hover, .manage-btn:hover {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3f73 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(38, 139, 210, 0.4);
            text-decoration: none;
            color: #fdf6e3;
        }

        .clear-search-btn {
            background: linear-gradient(135deg, #dc322f 0%, #a02622 100%);
            color: #fdf6e3;
            box-shadow: 0 4px 15px rgba(220, 50, 47, 0.3);
        }

        .clear-search-btn:hover {
            background: linear-gradient(135deg, #a02622 0%, #7a1c1a 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(220, 50, 47, 0.4);
            text-decoration: none;
            color: #fdf6e3;
        }

        /* Level selector - Solar Theme */
        .level-selector {
            background: linear-gradient(145deg, rgba(253, 246, 227, 0.95) 0%, rgba(238, 232, 213, 0.9) 100%);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0, 43, 54, 0.15);
            border: 2px solid rgba(181, 137, 0, 0.2);
            margin-bottom: 30px;
        }

        /* Students section enhancement */
        .students-section h2 {
            color: #002b36;
            margin-bottom: 25px;
            font-size: 1.8rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, #b58900, #268bd2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .manage-container {
                max-width: 98% !important;
                width: 98% !important;
                padding: 15px !important;
            }

            .forms-grid {
                grid-template-columns: 1fr;
                gap: 25px;
            }

            .search-input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input-group input[type="text"] {
                min-width: 100%;
                margin-bottom: 15px;
            }
        }

        .checkbox-column {
            width: 40px;
            text-align: center;
        }
        .delete-all-btn, .delete-selected-btn, .update-btn {
            background-color: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .delete-all-btn:hover, .delete-selected-btn:hover {
            background-color: #c82333;
        }
        .update-btn {
            background-color: #28a745;  /* Green for update button */
        }
        .update-btn:hover {
            background-color: #218838;
        }
        .message {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
            transition: opacity 0.5s ease;
        }
        .message-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .message-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .teacher-info {
            font-style: italic;
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        /* Pagination Styles */
        .pagination-info {
            margin: 10px 0;
            font-size: 0.9em;
            color: #666;
        }

        .pagination-controls {
            margin: 20px 0;
            text-align: center;
        }

        .pagination {
            display: inline-block;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .pagination li {
            display: inline-block;
            margin: 0 2px;
        }

        .pagination li a, .pagination li span {
            display: block;
            padding: 8px 12px;
            text-decoration: none;
            color: #333;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .pagination li a:hover {
            background-color: #e9e9e9;
        }

        .pagination li.active span {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .pagination li.disabled span {
            color: #999;
            cursor: not-allowed;
        }

        /* Filter Form Styles */
        .filter-form {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .filter-form h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #333;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-buttons {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .filter-btn {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .filter-btn:hover {
            background-color: #45a049;
        }

        .reset-btn {
            padding: 8px 15px;
            background-color: #f44336;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            display: inline-block;
        }

        .reset-btn:hover {
            background-color: #d32f2f;
        }

        /* Download Buttons Styles */
        .download-buttons {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .download-buttons h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #333;
        }

        .download-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .download-btn {
            padding: 8px 15px;
            background-color: #2196F3;
            color: white;
            text-decoration: none;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            display: inline-block;
        }

        .download-btn:hover {
            background-color: #0b7dda;
        }

        .download-select select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }

        /* Search Box Styles */
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        /* Bulk Actions Styles */
        .bulk-actions-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .bulk-actions-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #333;
        }

        .bulk-actions-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1em;
            color: #555;
        }

        .bulk-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .bulk-action-group {
            padding: 15px;
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .bulk-edit-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .edit-option-group {
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            margin-top: 10px;
        }

        .delete-all-btn, .delete-selected-btn {
            padding: 8px 15px;
            margin-right: 10px;
            margin-bottom: 10px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .delete-all-btn:hover, .delete-selected-btn:hover {
            background-color: #d32f2f;
        }

        .update-btn {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .update-btn:hover {
            background-color: #45a049;
        }

        /* Table improvements */
        .table-responsive {
            background: rgba(253, 246, 227, 0.7) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border-radius: 20px !important;
            box-shadow: 0 8px 32px rgba(181, 137, 0, 0.15) !important;
            padding: 20px !important;
            margin: var(--spacing-lg) 0 !important;
        }

        table {
            width: 100% !important;
            min-width: 800px !important;
            border-collapse: separate !important;
            border-spacing: 0 !important;
            border-radius: 16px !important;
            overflow: hidden !important;
            box-shadow: 0 8px 32px rgba(181, 137, 0, 0.1) !important;
            background: rgba(255, 255, 255, 0.9) !important;
        }

        th, td {
            padding: 16px 20px !important;
            text-align: left !important;
            border: none !important;
            border-bottom: 1px solid rgba(238, 232, 213, 0.8) !important;
            white-space: nowrap !important;
        }

        th {
            background: linear-gradient(135deg, #268bd2, #2aa198) !important;
            color: white !important;
            font-weight: 600 !important;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            font-size: 14px !important;
            position: sticky !important;
            top: 0;
            z-index: 10;
        }

        td {
            color: #002b36 !important;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            vertical-align: middle !important;
        }

        tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        tr:nth-child(even) {
            background: rgba(238, 232, 213, 0.3) !important;
        }

        tr:hover {
            background: rgba(268, 189, 210, 0.15) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 16px rgba(181, 137, 0, 0.1) !important;
        }

        tbody tr:last-child td {
            border-bottom: none !important;
        }

        th:first-child, td:first-child {
            border-top-left-radius: 12px !important;
            border-bottom-left-radius: 12px !important;
        }

        th:last-child, td:last-child {
            border-top-right-radius: 12px !important;
            border-bottom-right-radius: 12px !important;
        }

        /* Improve button styling */
        .manage-btn, .filter-btn, .download-btn {
            background: var(--primary-color);
            color: var(--white);
            border: none;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .manage-btn:hover, .filter-btn:hover, .download-btn:hover {
            background: var(--secondary-color);
            text-decoration: none;
        }

        /* Navigation links styling */
        .manage-container > a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            margin-right: var(--spacing-md);
        }

        .manage-container > a:hover {
            text-decoration: underline;
        }

        /* Page title styling */
        .manage-container h1 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-lg);
            font-size: 2.5rem;
        }
    </style>
</head>
<body>
    <div class="container manage-container">
        <header class="page-header">
            <h1>
                <svg class="heroicon-solar-blue" width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M8.25 6.75a3.75 3.75 0 117.5 0 3.75 3.75 0 01-7.5 0zM15.75 9.75a3 3 0 116 0 3 3 0 01-6 0zM2.25 9.75a3 3 0 116 0 3 3 0 01-6 0zM6.31 15.117A6.745 6.745 0 0112 12a6.745 6.745 0 016.709 7.498.75.75 0 01-.372.568A12.696 12.696 0 0112 21.75c-2.305 0-4.47-.612-6.337-1.684a.75.75 0 01-.372-.568 6.787 6.787 0 011.019-1.381z"/>
                </svg>
                Manage Students
            </h1>
            <p class="page-subtitle">
                Add, edit, and manage student profiles and information
            </p>
            <div class="nav-links">
                <a href="{{ url_for('classteacher.teacher_management_hub') }}">
                    <svg class="heroicon-solar-green" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M11.0991 1.29289C11.4896 0.902369 12.1228 0.902369 12.5133 1.29289L22.5133 11.2929C22.9038 11.6834 22.9038 12.3166 22.5133 12.7071C22.1228 13.0976 21.4896 13.0976 21.0991 12.7071L20.0124 11.6204V20C20.0124 21.6569 18.6693 23 17.0124 23H7.01245C5.3556 23 4.01245 21.6569 4.01245 20V11.6204L2.92578 12.7071C2.53526 13.0976 1.90209 13.0976 1.51157 12.7071C1.12104 12.3166 1.12104 11.6834 1.51157 11.2929L11.5116 1.29289Z"/>
                    </svg>
                    Teacher Hub
                </a>
                <a href="{{ url_for('classteacher.dashboard') }}">
                    <svg class="heroicon-solar-blue" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3 6C3 4.34315 4.34315 3 6 3H8C9.65685 3 11 4.34315 11 6V8C11 9.65685 9.65685 11 8 11H6C4.34315 11 3 9.65685 3 8V6ZM6 5C5.44772 5 5 5.44772 5 6V8C5 8.55228 5.44772 9 6 9H8C8.55228 9 9 8.55228 9 8V6C9 5.44772 8.55228 5 8 5H6ZM13 6C13 4.34315 14.3431 3 16 3H18C19.6569 3 21 4.34315 21 6V8C21 9.65685 19.6569 11 18 11H16C14.3431 11 13 9.65685 13 8V6ZM16 5C15.4477 5 15 5.44772 15 6V8C15 8.55228 15.4477 9 16 9H18C18.5523 9 19 8.55228 19 8V6C19 5.44772 18.5523 5 18 5H16ZM3 16C3 14.3431 4.34315 13 6 13H8C9.65685 13 11 14.3431 11 16V18C11 19.6569 9.65685 21 8 21H6C4.34315 21 3 19.6569 3 18V16ZM6 15C5.44772 15 5 15.4477 5 16V18C5 18.5523 5.44772 19 6 19H8C8.55228 19 9 18.5523 9 18V16C9 15.4477 8.55228 15 8 15H6ZM13 16C13 14.3431 14.3431 13 16 13H18C19.6569 13 21 14.3431 21 16V18C21 19.6569 19.6569 21 18 21H16C14.3431 21 13 19.6569 13 18V16ZM16 15C15.4477 15 15 15.4477 15 16V18C15 18.5523 15.4477 19 16 19H18C18.5523 19 19 18.5523 19 18V16C19 15.4477 18.5523 15 18 15H16Z"/>
                    </svg>
                    Dashboard
                </a>
                <a href="{{ url_for('auth.logout_route') }}">
                    <svg class="heroicon-solar-red" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M16.5 3.75C16.0858 3.75 15.75 4.08579 15.75 4.5C15.75 4.91421 16.0858 5.25 16.5 5.25H19.5C19.9142 5.25 20.25 5.58579 20.25 6V18C20.25 18.4142 19.9142 18.75 19.5 18.75H16.5C16.0858 18.75 15.75 19.0858 15.75 19.5C15.75 19.9142 16.0858 20.25 16.5 20.25H19.5C20.7426 20.25 21.75 19.2426 21.75 18V6C21.75 4.75736 20.7426 3.75 19.5 3.75H16.5ZM9.96967 7.96967C10.2626 7.67678 10.7374 7.67678 11.0303 7.96967L14.0303 10.9697C14.3232 11.2626 14.3232 11.7374 14.0303 12.0303L11.0303 15.0303C10.7374 15.3232 10.2626 15.3232 9.96967 15.0303C9.67678 14.7374 9.67678 14.2626 9.96967 13.9697L11.1893 12.75H4.5C4.08579 12.75 3.75 12.4142 3.75 12C3.75 11.5858 4.08579 11.25 4.5 11.25H11.1893L9.96967 10.0303C9.67678 9.73744 9.67678 9.26256 9.96967 7.96967Z"/>
                    </svg>
                    Logout
                </a>
            </div>
        </header>

        <!-- Dynamic Message Container -->
        <div id="message-container"></div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="message message-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if error_message %}
            <p class="error">{{ error_message }}</p>
        {% endif %}
        {% if success_message %}
            <p class="success">{{ success_message }}</p>
        {% endif %}

        <!-- Select Educational Level -->
        <div class="level-selector">
            <form id="educational-level-form">
                <label for="educational_level">Educational Level:</label>
                <select name="educational_level" id="educational_level" onchange="updateAllForms()">
                    <option value="">Select Educational Level</option>
                    {% for level in educational_levels %}
                        <option value="{{ level }}" {% if selected_level == level %}selected{% endif %}>{{ level }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>

        <!-- Two column layout for forms -->
        <div class="forms-grid">

            <!-- Form to Add a Student -->
            <div class="form-card">
                <h2>➕ Add New Student</h2>
                <form method="POST" action="{{ url_for('classteacher.manage_students') }}" id="add-student-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="add_student">
                    <input type="hidden" name="educational_level" id="educational_level_student">
                    <div class="form-group">
                        <label for="name">Student Name:</label>
                        <input type="text" name="name" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="admission_number">Admission Number:</label>
                        <input type="text" name="admission_number" id="admission_number" required>
                    </div>
                    <div class="form-group">
                        <label for="grade">Grade:</label>
                        <select name="grade" id="grade" required onchange="updateStreams()">
                            <option value="">Select Grade</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="stream">Stream (Optional):</label>
                        <select name="stream" id="stream">
                            <option value="">-- No Stream (Optional) --</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <!-- Add Gender Field -->
                    <div class="form-group">
                        <label for="gender">Gender:</label>
                        <select name="gender" id="gender" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <button type="submit" class="manage-btn">
                        <svg class="heroicon-solar-blue" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z"/>
                        </svg>
                        Add Student
                    </button>
                </form>
            </div>

            <!-- Form to Bulk Upload Students -->
            <div class="form-card">
                <h2>Bulk Upload Students</h2>
                <form method="POST" action="{{ url_for('classteacher.manage_students') }}" enctype="multipart/form-data" id="bulk-upload-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="bulk_upload_students">
                    <input type="hidden" name="educational_level" id="educational_level_bulk">
                    <div class="form-group">
                        <label for="grade_bulk">Grade:</label>
                        <select name="grade_bulk" id="grade_bulk" required onchange="updateBulkStreams()">
                            <option value="">Select Grade</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="stream">Stream (Optional):</label>
                        <select name="stream" id="stream_bulk">
                            <option value="">-- No Stream (Optional) --</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="student_file">Upload Student List (CSV or Excel):</label>
                        <input type="file" name="student_file" id="student_file" accept=".csv,.xlsx" required>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <p><strong>📋 Flexible Column Support:</strong></p>
                        <p><small><strong>Required:</strong> <code>name</code> (student name)</small></p>
                        <p><small><strong>Optional:</strong> <code>admission_number</code>, <code>grade</code>, <code>stream</code>, <code>gender</code></small></p>
                        <p><small><strong>Column Name Variations Supported:</strong></small></p>
                        <ul style="font-size: 0.85em; margin: 5px 0; padding-left: 20px;">
                            <li><strong>Name:</strong> name, student_name, full_name</li>
                            <li><strong>Admission:</strong> admission_number, addmission_number, adm_number, reg_number</li>
                            <li><strong>Grade:</strong> grade (will auto-assign to correct grade/stream)</li>
                            <li><strong>Stream:</strong> stream (will auto-assign to correct stream)</li>
                        </ul>
                        <p><small>💡 <strong>Your file format works!</strong> The system will automatically handle your column names and generate admission numbers if missing.</small></p>
                    </div>
                    <div class="template-links" style="margin-bottom: 15px;">
                        <p><strong>📥 Download Templates:</strong></p>

                        <!-- Full Templates with Sample Data -->
                        <div style="margin-bottom: 10px;">
                            <p style="font-weight: 600; margin-bottom: 5px; color: #1f7d53;">📋 Full Templates (with sample data):</p>
                            <a href="{{ url_for('classteacher.download_student_template', format='xlsx', type='full') }}" class="download-btn" style="display: inline-block; margin-right: 10px;">
                                <i class="fa fa-file-excel"></i> Excel Template (Full)
                            </a>
                            <a href="{{ url_for('classteacher.download_student_template', format='csv', type='full') }}" class="download-btn" style="display: inline-block;">
                                <i class="fa fa-file-text"></i> CSV Template (Full)
                            </a>
                        </div>

                        <!-- Minimal Templates -->
                        <div style="margin-bottom: 10px;">
                            <p style="font-weight: 600; margin-bottom: 5px; color: #6c757d;">📄 Minimal Templates (fewer examples):</p>
                            <a href="{{ url_for('classteacher.download_student_template', format='xlsx', type='minimal') }}" class="download-btn" style="display: inline-block; margin-right: 10px; background: #6c757d;">
                                <i class="fa fa-file-excel"></i> Excel (Minimal)
                            </a>
                            <a href="{{ url_for('classteacher.download_student_template', format='csv', type='minimal') }}" class="download-btn" style="display: inline-block; background: #6c757d;">
                                <i class="fa fa-file-text"></i> CSV (Minimal)
                            </a>
                        </div>

                        <!-- Headers Only -->
                        <div>
                            <p style="font-weight: 600; margin-bottom: 5px; color: #dc3545;">📝 Headers Only (blank template):</p>
                            <a href="{{ url_for('classteacher.download_student_template', format='csv', type='headers_only') }}" class="download-btn" style="display: inline-block; background: #dc3545;">
                                <i class="fa fa-file-text"></i> CSV (Headers Only)
                            </a>
                        </div>

                        <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 5px; font-size: 0.9em;">
                            <strong>💡 Recommendation:</strong> Use the <strong>Full Excel Template</strong> for best experience - it includes instructions and formatting!
                        </div>
                    </div>
                    <button type="submit" class="manage-btn">
                        <svg class="heroicon-solar-green" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M11.47 1.72a.75.75 0 011.06 0l3 3a.75.75 0 01-1.06 1.06L12 3.31 9.53 5.78a.75.75 0 01-1.06-1.06l3-3zm-3 9.56a.75.75 0 000 1.06L12 15.87l3.47-3.53a.75.75 0 111.06 1.06l-4 4.06a.75.75 0 01-1.06 0l-4-4.06a.75.75 0 010-1.06z"/>
                        </svg>
                        Upload Students
                    </button>
                </form>
            </div>
        </div>

        <!-- Display Existing Students -->
        <div class="students-section">
            <h2>Existing Students</h2>
            {% if grade and stream %}
            <p class="teacher-info">You are assigned to Grade {{ grade }} Stream {{ stream }}</p>
            {% else %}
            <p class="teacher-info">You are not assigned to any specific class. You can manage students across all grades and streams.</p>
            {% endif %}

            <!-- Filter Form -->
            <div class="filter-form">
                <h3>Filter Students</h3>
                <form method="GET" action="{{ url_for('classteacher.manage_students') }}">
                    <div class="filter-grid">
                        <div class="form-group">
                            <label for="search">Search:</label>
                            <input type="text" name="search" id="search" placeholder="Search by name or admission number" value="{{ request.args.get('search', '') }}">
                        </div>
                        <div class="form-group">
                            <label for="filter_educational_level">Educational Level:</label>
                            <select name="educational_level" id="filter_educational_level" onchange="updateFilterGrades()">
                                <option value="">All Levels</option>
                                {% for level in educational_levels %}
                                    <option value="{{ level }}" {% if request.args.get('educational_level') == level %}selected{% endif %}>
                                        {{ level|replace('_', ' ')|title }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter_grade">Grade:</label>
                            <select name="grade_id" id="filter_grade" onchange="updateFilterStreams()">
                                <option value="">All Grades</option>
                                {% for grade_obj in grades %}
                                    <option value="{{ grade_obj.id }}" {% if request.args.get('grade_id')|int == grade_obj.id %}selected{% endif %}>
                                        {{ grade_obj.level }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter_stream">Stream:</label>
                            <select name="stream_id" id="filter_stream">
                                <option value="">All Streams</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group filter-buttons">
                            <button type="submit" class="filter-btn">
                                <svg class="heroicon-solar-blue" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M3.792 2.938A.75.75 0 014.5 2.25h15a.75.75 0 01.708 1.063l-8.25 19.5a.75.75 0 01-1.416 0l-8.25-19.5a.75.75 0 01.5-.875z"/>
                                </svg>
                                Apply Filters
                            </button>
                            <a href="{{ url_for('classteacher.manage_students') }}" class="reset-btn">Reset Filters</a>
                        </div>
                    </div>
                </form>
            </div>

            {% if students %}
                <!-- Pagination Info -->
                <div class="pagination-info">
                    <p>Showing {{ students|length }} of {{ total_students }} students (Page {{ pagination.page }} of {{ pagination.pages }})</p>
                </div>

                <!-- Bulk Actions Section -->
                <div class="bulk-actions-section">
                    <h3>Bulk Actions</h3>
                    <div class="bulk-actions-grid">
                        <!-- Delete Buttons -->
                        <div class="bulk-action-group">
                            <h4>Delete Actions</h4>
                            <button type="button" class="delete-all-btn" onclick="deleteAllStudents()">
                                <svg class="heroicon-solar-red" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 013.878.512.75.75 0 11-.256 1.478l-.209-.035-1.005 13.07a3 3 0 01-2.991 2.77H8.084a3 3 0 01-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 01-.256-1.478A48.567 48.567 0 017.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 013.369 0c1.603.051 2.815 1.387 2.815 2.951zm-6.136-1.452a51.196 51.196 0 013.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 00-6 0v-.113c0-.794.609-1.428 1.364-1.452zm-.355 5.945a.75.75 0 10-1.5.058l.347 9a.75.75 0 101.499-.058l-.346-9zm5.48.058a.75.75 0 00-1.498-.058l-.347 9a.75.75 0 001.5.058l.345-9z"/>
                                </svg>
                                Delete All Learners
                            </button>
                            <button type="button" class="delete-selected-btn" onclick="deleteSelectedStudents()">
                                <svg class="heroicon-solar-red" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M8.586 2.586A2 2 0 0010 2h4a2 2 0 011.414.586L17 4.5a.5.5 0 01-.5.5h-9a.5.5 0 01-.5-.5L8.586 2.586zM16 6v12a3 3 0 01-3 3H11a3 3 0 01-3-3V6h8zm-1.5 3a.5.5 0 00-1 0v6a.5.5 0 001 0V9zm-3 0a.5.5 0 00-1 0v6a.5.5 0 001 0V9z"/>
                                </svg>
                                Delete Selected Learners
                            </button>
                        </div>

                        <!-- Bulk Edit Form -->
                        <div class="bulk-action-group">
                            <h4>Edit Selected Students</h4>
                            <form id="bulk-edit-form" method="POST" action="{{ url_for('classteacher.manage_students') }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="action" value="bulk_edit_students">

                                <div class="bulk-edit-options">
                                    <div class="form-group">
                                        <label for="bulk_edit_type">Edit Type:</label>
                                        <select name="bulk_edit_type" id="bulk_edit_type" onchange="toggleBulkEditFields()">
                                            <option value="">Select Action</option>
                                            <option value="gender">Update Gender</option>
                                            <option value="stream">Move to Stream</option>
                                        </select>
                                    </div>

                                    <!-- Gender Edit Options (initially hidden) -->
                                    <div id="gender_edit_options" class="edit-option-group" style="display: none;">
                                        <div class="form-group">
                                            <label for="bulk_gender">Gender:</label>
                                            <select name="bulk_gender" id="bulk_gender">
                                                <option value="">Select Gender</option>
                                                <option value="Male">Male</option>
                                                <option value="Female">Female</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Stream Edit Options (initially hidden) -->
                                    <div id="stream_edit_options" class="edit-option-group" style="display: none;">
                                        <div class="form-group">
                                            <label for="bulk_grade">Grade:</label>
                                            <select name="bulk_grade" id="bulk_grade" onchange="updateBulkEditStreams()">
                                                <option value="">Select Grade</option>
                                                {% for grade_obj in grades %}
                                                    <option value="{{ grade_obj.id }}">{{ grade_obj.level }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="bulk_stream">Stream:</label>
                                            <select name="bulk_stream" id="bulk_stream" disabled>
                                                <option value="">Select Stream</option>
                                                <!-- Will be populated by JavaScript -->
                                            </select>
                                        </div>
                                    </div>

                                    <button type="button" class="update-btn" onclick="bulkEditStudents()">
                                        <svg class="heroicon-solar-green" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M20.25 12c0 4.556-3.694 8.25-8.25 8.25S3.75 16.556 3.75 12 7.444 3.75 12 3.75s8.25 3.694 8.25 8.25zm-11.03-2.47a.75.75 0 010 1.06l2.25 2.25a.75.75 0 001.06 0l4.5-4.5a.75.75 0 00-1.06-1.06L12 11.25l-1.72-1.72a.75.75 0 00-1.06 0z"/>
                                        </svg>
                                        Apply Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Download Buttons -->
                <div class="download-buttons" style="margin-bottom: 15px;">
                    <h3>Download Class Lists</h3>
                    <div class="download-grid">
                        <a href="{{ url_for('classteacher.download_class_list', search=request.args.get('search', ''), educational_level=request.args.get('educational_level', ''), grade_id=request.args.get('grade_id', ''), stream_id=request.args.get('stream_id', '')) }}" class="download-btn">
                            <i class="fa fa-download"></i> Download Current View
                        </a>
                        <a href="{{ url_for('classteacher.download_class_list', all_grades=1) }}" class="download-btn">
                            <svg class="heroicon-solar-green" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2.25c.621 0 1.125.504 1.125 1.125v8.689l2.97-2.97a1.125 1.125 0 011.59 1.591l-4.875 4.875a1.123 1.123 0 01-1.59 0L6.345 10.685a1.125 1.125 0 111.59-1.591l2.97 2.97V3.375c0-.621.504-1.125 1.125-1.125zm-8.25 12.75a1.125 1.125 0 011.125-1.125h12.25a1.125 1.125 0 010 2.25H4.875a1.125 1.125 0 01-1.125-1.125z"/>
                            </svg> 
                            Download All Students
                        </a>
                        <div class="download-select">
                            <select id="download_grade" onchange="updateDownloadStreams()">
                                <option value="">Select Grade to Download</option>
                                {% for grade_obj in grades %}
                                    <option value="{{ grade_obj.id }}">{{ grade_obj.level }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="download-select">
                            <select id="download_stream" disabled>
                                <option value="">Select Stream to Download</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                        <button type="button" class="download-btn" onclick="downloadSelectedClass()">
                            <svg class="heroicon-solar-blue" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2.25c.621 0 1.125.504 1.125 1.125v8.689l2.97-2.97a1.125 1.125 0 011.59 1.591l-4.875 4.875a1.123 1.123 0 01-1.59 0L6.345 10.685a1.125 1.125 0 111.59-1.591l2.97 2.97V3.375c0-.621.504-1.125 1.125-1.125zm-8.25 12.75a1.125 1.125 0 011.125-1.125h12.25a1.125 1.125 0 010 2.25H4.875a1.125 1.125 0 01-1.125-1.125z"/>
                            </svg>
                            Download Selected Class
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <form id="bulk-delete-form" method="POST" action="{{ url_for('classteacher.manage_students') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="bulk_delete_students">
                        <form id="bulk-update-form" method="POST" action="{{ url_for('classteacher.manage_students') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="bulk_update_genders">
                            <table id="students-table">
                                <thead>
                                    <tr>
                                        <th class="checkbox-column">
                                            <input type="checkbox" id="select-all" onclick="toggleSelectAll()">
                                        </th>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Admission Number</th>
                                        <th>Grade</th>
                                        <th>Stream</th>
                                        <th>Gender</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in students %}
                                        <tr data-grade="{{ student.stream.grade.name if student.stream else '' }}">
                                            <td class="checkbox-column">
                                                <input type="checkbox" name="student_ids" value="{{ student.id }}" class="student-checkbox">
                                            </td>
                                            <td>{{ student.id }}</td>
                                            <td>{{ student.name }}</td>
                                            <td>{{ student.admission_number }}</td>
                                            <td>{{ student.stream.grade.name if student.stream else 'N/A' }}</td>
                                            <td>{{ student.stream.name if student.stream else 'No Stream' }}</td>
                                            <td>
                                                <select name="gender_{{ student.id }}">
                                                    <option value="" {% if not student.gender %}selected{% endif %}>Not Set</option>
                                                    <option value="Male" {% if student.gender == 'male' %}selected{% endif %}>Male</option>
                                                    <option value="Female" {% if student.gender == 'female' %}selected{% endif %}>Female</option>
                                                </select>
                                            </td>
                                            <td>
                                                <form method="POST" action="{{ url_for('classteacher.manage_students') }}" style="display:inline;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                    <input type="hidden" name="action" value="delete_student">
                                                    <input type="hidden" name="student_id" value="{{ student.id }}">
                                                    <button type="submit" class="delete-btn">
                                                        <svg class="heroicon-solar-red" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 013.878.512.75.75 0 11-.256 1.478l-.209-.035-1.005 13.07a3 3 0 01-2.991 2.77H8.084a3 3 0 01-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 01-.256-1.478A48.567 48.567 0 017.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 013.369 0c1.603.051 2.815 1.387 2.815 2.951zm-6.136-1.452a51.196 51.196 0 013.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 00-6 0v-.113c0-.794.609-1.428 1.364-1.452zm-.355 5.945a.75.75 0 10-1.5.058l.347 9a.75.75 0 101.499-.058l-.346-9zm5.48.058a.75.75 0 00-1.498-.058l-.347 9a.75.75 0 001.5.058l.345-9z"/>
                                                        </svg>
                                                        Delete
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </form>
                    </form>
                </div>

                <!-- Pagination Controls -->
                <div class="pagination-controls">
                    <ul class="pagination">
                        {% if pagination.has_prev %}
                            <li><a href="{{ url_for('classteacher.manage_students', page=1, search=request.args.get('search', ''), educational_level=request.args.get('educational_level'), grade_id=request.args.get('grade_id'), stream_id=request.args.get('stream_id')) }}">&laquo; First</a></li>
                            <li><a href="{{ url_for('classteacher.manage_students', page=pagination.prev_num, search=request.args.get('search', ''), educational_level=request.args.get('educational_level'), grade_id=request.args.get('grade_id'), stream_id=request.args.get('stream_id')) }}">&lsaquo; Previous</a></li>
                        {% else %}
                            <li class="disabled"><span>&laquo; First</span></li>
                            <li class="disabled"><span>&lsaquo; Previous</span></li>
                        {% endif %}

                        {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                            {% if page_num %}
                                {% if page_num == pagination.page %}
                                    <li class="active"><span>{{ page_num }}</span></li>
                                {% else %}
                                    <li><a href="{{ url_for('classteacher.manage_students', page=page_num, search=request.args.get('search', ''), educational_level=request.args.get('educational_level'), grade_id=request.args.get('grade_id'), stream_id=request.args.get('stream_id')) }}">{{ page_num }}</a></li>
                                {% endif %}
                            {% else %}
                                <li class="disabled"><span>...</span></li>
                            {% endif %}
                        {% endfor %}

                        {% if pagination.has_next %}
                            <li><a href="{{ url_for('classteacher.manage_students', page=pagination.next_num, search=request.args.get('search', ''), educational_level=request.args.get('educational_level'), grade_id=request.args.get('grade_id'), stream_id=request.args.get('stream_id')) }}">Next &rsaquo;</a></li>
                            <li><a href="{{ url_for('classteacher.manage_students', page=pagination.pages, search=request.args.get('search', ''), educational_level=request.args.get('educational_level'), grade_id=request.args.get('grade_id'), stream_id=request.args.get('stream_id')) }}">Last &raquo;</a></li>
                        {% else %}
                            <li class="disabled"><span>Next &rsaquo;</span></li>
                            <li class="disabled"><span>Last &raquo;</span></li>
                        {% endif %}
                    </ul>
                </div>
            {% else %}
                <p>No students added yet.</p>
            {% endif %}
        </div>
    </div>

    <script>
        const allGrades = {{ (grades or []) | tojson }};
        const educationalLevelMapping = {{ (educational_level_mapping or {}) | tojson }};

        document.addEventListener('DOMContentLoaded', function() {
            const successMessage = "{{ success_message|safe if success_message else '' }}";
            const errorMessage = "{{ error_message|safe if error_message else '' }}";

            if (successMessage) {
                showNotification(successMessage, 'success');
            }
            if (errorMessage) {
                showNotification(errorMessage, 'error');
            }

            // Auto-hide flash messages after 5 seconds
            setTimeout(() => {
                const flashMessages = document.querySelectorAll('.message');
                flashMessages.forEach(message => {
                    message.style.opacity = '0';
                    setTimeout(() => {
                        message.style.display = 'none';
                    }, 500);
                });
            }, 5000);

            const urlParams = new URLSearchParams(window.location.search);
            const savedLevel = urlParams.get('level') || localStorage.getItem('selectedEducationalLevel') || '';

            if (savedLevel) {
                document.getElementById('educational_level').value = savedLevel;
            }

            updateAllForms();

            // Initialize stream dropdowns
            updateStreams();
            updateBulkStreams();

            // Initialize filter form dropdowns on page load
            updateFilterGrades(); // This will also clear streams
            updateFilterStreams();

            // Initialize download form stream dropdown
            const downloadGradeSelect = document.getElementById('download_grade');
            if (downloadGradeSelect) {
                downloadGradeSelect.addEventListener('change', updateDownloadStreams);
            }
        });

        function showNotification(message, type) {
            const container = document.getElementById('message-container');
            const notification = document.createElement('div');
            notification.className = `message message-${type}`;
            notification.textContent = message;
            container.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function updateAllForms() {
            const educationalLevel = document.getElementById('educational_level').value;

            localStorage.setItem('selectedEducationalLevel', educationalLevel);

            document.getElementById('educational_level_student').value = educationalLevel;
            document.getElementById('educational_level_bulk').value = educationalLevel;

            updateGradeOptions();
            updateStreams();
            updateBulkStreams();
        }

        function updateGradeOptions() {
            const educationalLevel = document.getElementById('educational_level').value;
            const gradeSelects = [
                document.getElementById('grade'),
                document.getElementById('grade_bulk')
            ];

            if (educationalLevel) {
                const allowedGrades = educationalLevelMapping[educationalLevel] || [];

                gradeSelects.forEach(gradeSelect => {
                    if (gradeSelect) {
                        gradeSelect.innerHTML = '<option value="">Select Grade</option>';

                        allGrades.forEach(grade => {
                            if (allowedGrades.includes(grade.name)) {
                                const option = document.createElement('option');
                                option.value = grade.id;
                                option.textContent = grade.name;
                                option.setAttribute('data-level', grade.name);
                                gradeSelect.appendChild(option);
                            }
                        });
                    }
                });
            } else {
                gradeSelects.forEach(gradeSelect => {
                    if (gradeSelect) {
                        gradeSelect.innerHTML = '<option value="">Select Grade</option>';
                        allGrades.forEach(grade => {
                            const option = document.createElement('option');
                            option.value = grade.id;
                            option.textContent = grade.name;
                            option.setAttribute('data-level', grade.name);
                            gradeSelect.appendChild(option);
                        });
                    }
                });
            }
        }



        function updateStreams() {
            const gradeId = document.getElementById('grade').value;
            const streamSelect = document.getElementById('stream');

            // Clear the dropdown
            streamSelect.innerHTML = '';

            // Add the "No Stream" option
            const noStreamOption = document.createElement('option');
            noStreamOption.value = "";
            noStreamOption.textContent = "-- No Stream (Optional) --";
            streamSelect.appendChild(noStreamOption);

            if (gradeId) {
                // Determine the correct API endpoint based on current user role and session
                const isHeadteacher = window.location.pathname.includes('/headteacher/') ||
                                    window.location.pathname.includes('/universal/') ||
                                    '{{ session.headteacher_universal_access }}' === 'True';
                const apiEndpoint = isHeadteacher ?
                    `/universal/api/streams/${gradeId}` :
                    `/classteacher/get_streams/${gradeId}`;

                fetch(apiEndpoint)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Handle different response formats
                        let streams = [];
                        if (data.success && data.streams) {
                            streams = data.streams;
                        } else if (data.streams) {
                            streams = data.streams;
                        }

                        if (streams && streams.length > 0) {
                            streams.forEach(stream => {
                                const option = document.createElement('option');
                                option.value = stream.id;
                                option.textContent = stream.name;
                                streamSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching streams:', error);
                    });
            }
        }

        function updateBulkStreams() {
            const gradeId = document.getElementById('grade_bulk').value;
            const streamSelect = document.getElementById('stream_bulk');

            // Clear the dropdown
            streamSelect.innerHTML = '';

            // Add the "No Stream" option
            const noStreamOption = document.createElement('option');
            noStreamOption.value = "";
            noStreamOption.textContent = "-- No Stream (Optional) --";
            streamSelect.appendChild(noStreamOption);

            if (gradeId) {
                // Determine the correct API endpoint based on current user role and session
                const isHeadteacher = window.location.pathname.includes('/headteacher/') ||
                                    window.location.pathname.includes('/universal/') ||
                                    '{{ session.headteacher_universal_access }}' === 'True';
                const apiEndpoint = isHeadteacher ?
                    `/universal/api/streams/${gradeId}` :
                    `/classteacher/get_streams/${gradeId}`;

                fetch(apiEndpoint)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Handle different response formats
                        let streams = [];
                        if (data.success && data.streams) {
                            streams = data.streams;
                        } else if (data.streams) {
                            streams = data.streams;
                        }

                        if (streams && streams.length > 0) {
                            streams.forEach(stream => {
                                const option = document.createElement('option');
                                option.value = stream.id;
                                option.textContent = stream.name;
                                streamSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching streams:', error);
                    });
            }
        }

        function updateFilterGrades() {
            const educationalLevel = document.getElementById('filter_educational_level').value;
            const gradeSelect = document.getElementById('filter_grade');
            const streamSelect = document.getElementById('filter_stream');

            console.log('Updating filter grades for educational level:', educationalLevel);

            // Clear grade dropdown
            gradeSelect.innerHTML = '<option value="">All Grades</option>';

            // Clear stream dropdown
            streamSelect.innerHTML = '<option value="">All Streams</option>';

            if (educationalLevel) {
                // Filter grades based on educational level
                const allowedGrades = educationalLevelMapping[educationalLevel] || [];
                console.log('Allowed grades for', educationalLevel, ':', allowedGrades);

                allGrades.forEach(grade => {
                    if (allowedGrades.includes(grade.name)) {
                        const option = document.createElement('option');
                        option.value = grade.id;
                        option.textContent = grade.name;
                        gradeSelect.appendChild(option);
                    }
                });

                console.log('Updated filter grade dropdown with', gradeSelect.options.length - 1, 'grades');
            } else {
                // If no educational level selected, show all grades
                allGrades.forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade.id;
                    option.textContent = grade.name;
                    gradeSelect.appendChild(option);
                });
            }
        }

        function updateFilterStreams() {
            const gradeId = document.getElementById('filter_grade').value;
            const streamSelect = document.getElementById('filter_stream');
            const currentStreamId = "{{ request.args.get('stream_id', '') }}";

            // Clear the dropdown
            streamSelect.innerHTML = '';

            // Add the "All Streams" option
            const allStreamsOption = document.createElement('option');
            allStreamsOption.value = "";
            allStreamsOption.textContent = "All Streams";
            streamSelect.appendChild(allStreamsOption);

            if (gradeId) {
                // Determine the correct API endpoint based on current user role and session
                const isHeadteacher = window.location.pathname.includes('/headteacher/') ||
                                    window.location.pathname.includes('/universal/') ||
                                    '{{ session.headteacher_universal_access }}' === 'True';
                const apiEndpoint = isHeadteacher ?
                    `/universal/api/streams/${gradeId}` :
                    `/classteacher/get_streams/${gradeId}`;

                console.log(`🔍 Stream API Debug:`);
                console.log(`   URL path: ${window.location.pathname}`);
                console.log(`   Session headteacher_universal_access: '{{ session.headteacher_universal_access }}'`);
                console.log(`   Is headteacher: ${isHeadteacher}`);
                console.log(`   API endpoint: ${apiEndpoint}`);

                fetch(apiEndpoint)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Streams data received:', data);

                        // Handle different response formats
                        let streams = [];
                        if (data.success && data.streams) {
                            // Headteacher API format
                            streams = data.streams;
                        } else if (data.streams) {
                            // Classteacher API format
                            streams = data.streams;
                        }

                        if (streams && streams.length > 0) {
                            streams.forEach(stream => {
                                const option = document.createElement('option');
                                option.value = stream.id;
                                option.textContent = stream.name;
                                if (stream.id.toString() === currentStreamId) {
                                    option.selected = true;
                                }
                                streamSelect.appendChild(option);
                            });
                            console.log(`Added ${streams.length} streams to dropdown`);
                        } else {
                            console.log('No streams found for this grade');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching streams:', error);
                        console.error('API endpoint used:', apiEndpoint);
                        console.error('Grade ID:', gradeId);

                        // Show user-friendly error message
                        const errorOption = document.createElement('option');
                        errorOption.value = "";
                        errorOption.textContent = "Error loading streams";
                        errorOption.disabled = true;
                        streamSelect.appendChild(errorOption);

                        // Show detailed error in console for debugging
                        console.log('Full error details:', {
                            error: error,
                            endpoint: apiEndpoint,
                            gradeId: gradeId,
                            isHeadteacher: window.location.pathname.includes('/headteacher/') || window.location.pathname.includes('/universal/')
                        });
                    });
            }
        }

        // We're now using server-side filtering instead of client-side filtering

        function updateDownloadStreams() {
            const gradeId = document.getElementById('download_grade').value;
            const streamSelect = document.getElementById('download_stream');

            // Clear the dropdown
            streamSelect.innerHTML = '';

            // Add the "All Streams" option
            const allStreamsOption = document.createElement('option');
            allStreamsOption.value = "";
            allStreamsOption.textContent = "All Streams in Grade";
            streamSelect.appendChild(allStreamsOption);

            if (gradeId) {
                streamSelect.disabled = false;

                // Determine the correct API endpoint based on current user role and session
                const isHeadteacher = window.location.pathname.includes('/headteacher/') ||
                                    window.location.pathname.includes('/universal/') ||
                                    '{{ session.headteacher_universal_access }}' === 'True';
                const apiEndpoint = isHeadteacher ?
                    `/universal/api/streams/${gradeId}` :
                    `/classteacher/get_streams/${gradeId}`;

                fetch(apiEndpoint)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Handle different response formats
                        let streams = [];
                        if (data.success && data.streams) {
                            streams = data.streams;
                        } else if (data.streams) {
                            streams = data.streams;
                        }

                        if (streams && streams.length > 0) {
                            streams.forEach(stream => {
                                const option = document.createElement('option');
                                option.value = stream.id;
                                option.textContent = stream.name;
                                streamSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching streams:', error);
                    });
            } else {
                streamSelect.disabled = true;
            }
        }

        function updateBulkEditStreams() {
            const gradeId = document.getElementById('bulk_grade').value;
            const streamSelect = document.getElementById('bulk_stream');

            // Clear the dropdown
            streamSelect.innerHTML = '';

            // Add the default option
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Select Stream";
            streamSelect.appendChild(defaultOption);

            if (gradeId) {
                streamSelect.disabled = false;

                fetch(`/classteacher/get_streams/${gradeId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.streams && data.streams.length > 0) {
                            data.streams.forEach(stream => {
                                const option = document.createElement('option');
                                option.value = stream.id;
                                option.textContent = stream.name;
                                streamSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching streams:', error);
                    });
            } else {
                streamSelect.disabled = true;
            }
        }

        function toggleBulkEditFields() {
            const editType = document.getElementById('bulk_edit_type').value;
            const genderOptions = document.getElementById('gender_edit_options');
            const streamOptions = document.getElementById('stream_edit_options');

            // Hide all option groups first
            genderOptions.style.display = 'none';
            streamOptions.style.display = 'none';

            // Show the selected option group
            if (editType === 'gender') {
                genderOptions.style.display = 'block';
            } else if (editType === 'stream') {
                streamOptions.style.display = 'block';
            }
        }

        function downloadSelectedClass() {
            const gradeId = document.getElementById('download_grade').value;
            const streamId = document.getElementById('download_stream').value;

            if (!gradeId) {
                alert('Please select a grade to download.');
                return;
            }

            let url = `{{ url_for('classteacher.download_class_list') }}?grade_id=${gradeId}`;
            if (streamId) {
                url += `&stream_id=${streamId}`;
            }

            window.location.href = url;
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all');
            const studentCheckboxes = document.querySelectorAll('.student-checkbox');
            studentCheckboxes.forEach(checkbox => {
                if (checkbox.closest('tr').style.display !== 'none') {
                    checkbox.checked = selectAllCheckbox.checked;
                }
            });
        }

        function deleteSelectedStudents() {
            const studentCheckboxes = document.querySelectorAll('.student-checkbox:checked');
            if (studentCheckboxes.length === 0) {
                alert('Please select at least one student to delete.');
                return;
            }

            if (confirm(`Are you sure you want to delete ${studentCheckboxes.length} selected student(s)?`)) {
                document.getElementById('bulk-delete-form').submit();
            }
        }

        function bulkEditStudents() {
            const studentCheckboxes = document.querySelectorAll('.student-checkbox:checked');
            if (studentCheckboxes.length === 0) {
                alert('Please select at least one student to edit.');
                return;
            }

            const editType = document.getElementById('bulk_edit_type').value;
            if (!editType) {
                alert('Please select an edit type.');
                return;
            }

            // Validate based on edit type
            if (editType === 'gender') {
                const gender = document.getElementById('bulk_gender').value;
                if (!gender) {
                    alert('Please select a gender.');
                    return;
                }
            } else if (editType === 'stream') {
                const gradeId = document.getElementById('bulk_grade').value;
                const streamId = document.getElementById('bulk_stream').value;

                if (!gradeId) {
                    alert('Please select a grade.');
                    return;
                }

                if (!streamId) {
                    alert('Please select a stream.');
                    return;
                }
            }

            // Create a hidden form to submit the selected student IDs
            const form = document.getElementById('bulk-edit-form');

            // Remove any existing student ID inputs
            document.querySelectorAll('input[name="student_ids"]').forEach(input => {
                input.remove();
            });

            // Add the selected student IDs to the form
            studentCheckboxes.forEach(checkbox => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'student_ids';
                input.value = checkbox.value;
                form.appendChild(input);
            });

            // Confirm and submit
            const actionText = editType === 'gender' ? 'update the gender of' : 'move';
            if (confirm(`Are you sure you want to ${actionText} ${studentCheckboxes.length} selected student(s)?`)) {
                form.submit();
            }
        }

        function deleteAllStudents() {
            const visibleRows = Array.from(document.querySelectorAll('#students-table tbody tr'))
                .filter(row => row.style.display !== 'none');

            if (visibleRows.length === 0) {
                alert('No students to delete.');
                return;
            }

            if (confirm(`Are you sure you want to delete all ${visibleRows.length} visible student(s)?`)) {
                visibleRows.forEach(row => {
                    const checkbox = row.querySelector('.student-checkbox');
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                document.getElementById('bulk-delete-form').submit();
            }
        }

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                if (!confirm('Are you sure you want to delete this student?')) {
                    e.preventDefault();
                }
            });
        });

        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function() {
                const educationalLevel = document.getElementById('educational_level').value;

                if (educationalLevel) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = 'redirect_level';
                    hiddenField.value = educationalLevel;
                    form.appendChild(hiddenField);
                }
            });
        });
    </script>


</body>
</html>