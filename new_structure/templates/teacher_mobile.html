{% extends "base_mobile.html" %}

{% block title %}Subject Teacher Dashboard - {{ school_info.school_name|default('Hillview School') }}{% endblock %}

{% block description %}Mobile-responsive subject teacher dashboard for {{ school_info.school_name|default('Hillview School') }} management system{% endblock %}

{% block home_url %}{{ url_for('teacher.dashboard') }}{% endblock %}

{% block navigation_items %}
<li class="mobile-nav-item">
    <a href="{{ url_for('teacher.dashboard') }}" class="mobile-nav-link active">
        <i class="fas fa-tachometer-alt"></i>
        Dashboard
    </a>
</li>
<li class="mobile-nav-item">
    <a href="#assignments-section" class="mobile-nav-link" onclick="showSection('assignments-section')">
        <i class="fas fa-chalkboard-teacher"></i>
        My Subjects
    </a>
</li>
<li class="mobile-nav-item">
    <a href="#marks-section" class="mobile-nav-link" onclick="showSection('marks-section')">
        <i class="fas fa-edit"></i>
        Enter Marks
    </a>
</li>
<li class="mobile-nav-item">
    <a href="#reports-section" class="mobile-nav-link" onclick="showSection('reports-section')">
        <i class="fas fa-chart-bar"></i>
        Reports
    </a>
</li>
<li class="mobile-nav-item">
    <a href="{{ url_for('auth.logout_route') }}" class="mobile-nav-link">
        <i class="fas fa-sign-out-alt"></i>
        Logout
    </a>
</li>
{% endblock %}

{% block header_title %}
<i class="fas fa-chalkboard-teacher"></i>
Subject Teacher Dashboard
{% endblock %}

{% block header_subtitle %}
Welcome back, {{ session.get('username', 'Teacher') }}! Manage your classes with ease.
{% endblock %}

{% block extra_css %}
<style>
    /* Prevent horizontal scroll and dropdown overflow on small screens */
    html, body {
        overflow-x: hidden;
        width: 100%;
    }

    /* Ensure form sections don't clip native select dropdowns */
    .mobile-container,
    .dashboard-section,
    .mobile-form-group {
        overflow: visible;
    }

    /* Make selects render predictably on iOS/Android */
    select.mobile-form-control,
    .mobile-form-control.mobile-form-select {
        max-width: 100%;
        width: 100%;
        position: relative;
        z-index: 1; /* keep above decorative layers */
        font-size: 16px; /* avoid iOS zoom */
    }

    /* General control font-size for mobile to avoid zoom */
    .mobile-form-control,
    .mobile-btn,
    label.mobile-form-label {
        font-size: 16px;
    }

    /* Mobile-first teacher dashboard styles */
    .dashboard-section {
        background: var(--bs-light);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: 1px solid rgba(181, 137, 0, 0.2);
    }
    
    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--bs-primary);
    }
    
    .section-header h2 {
        color: var(--bs-dark);
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0 0 0 0.75rem;
    }
    
    .section-header i {
        color: var(--bs-primary);
        font-size: 1.5rem;
    }
    
    /* Mobile-optimized form styles */
    .mobile-form-group {
        margin-bottom: 1.5rem;
    }
    
    .mobile-form-label {
        display: block;
        font-weight: 600;
        color: var(--bs-dark);
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }
    
    .mobile-form-control {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        border: 2px solid var(--bs-secondary);
        border-radius: 0.5rem;
        background-color: var(--bs-light);
        color: var(--bs-dark);
        transition: all 0.2s ease;
        min-height: var(--touch-target);
    }
    
    .mobile-form-control:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.2rem rgba(181, 137, 0, 0.25);
        outline: none;
    }

    /* Mobile sheet picker styles */
    .mobile-sheet-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        z-index: 9999;
        display: none;
    }
    .mobile-sheet {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
        box-shadow: 0 -8px 24px rgba(0,0,0,0.25);
        z-index: 10000;
        transform: translateY(100%);
        transition: transform .25s ease;
        max-height: 70vh;
        overflow: auto;
        padding: 1rem 1rem 0.75rem 1rem;
    }
    .mobile-sheet.open { transform: translateY(0); }
    .mobile-sheet-header { font-weight: 700; margin-bottom: .5rem; }
    .mobile-sheet-options { display: grid; gap: .5rem; }
    .mobile-sheet-option { display: flex; align-items: center; justify-content: space-between; padding: .75rem 1rem; border: 1px solid var(--bs-border-color); border-radius: .5rem; background: #f8f9fa; font-weight: 600; }
    .mobile-sheet-close { display: inline-flex; margin-top: .5rem; }
    .mobile-sheet-grabber { width: 44px; height: 4px; background: #cfd8dc; border-radius: 2px; margin: 0 auto 8px auto; }

    /* Generic picker search */
    .mobile-sheet-search { margin: .5rem 0 0.75rem 0; }
    .mobile-sheet-search input { width: 100%; padding: .5rem .75rem; border: 1px solid var(--bs-border-color); border-radius: .375rem; font-size: 1rem; }

    /* Group header & option icon */
    .mobile-sheet-group-header { font-weight: 700; color: var(--bs-secondary); margin: .75rem 0 .25rem 0; text-transform: uppercase; font-size: .8rem; }
    .mobile-sheet-option .option-left { display:flex; align-items:center; gap:.5rem; }
    .mobile-sheet-option .option-icon { font-size: 1.1rem; }
    .mobile-sheet-alpha { position: sticky; top: 0; background: #fff; padding: 2px .5rem; font-size: .75rem; font-weight: 700; color: var(--bs-secondary); border-top: 1px solid #eee; border-bottom: 1px solid #eee; z-index: 2; }

    /* Trigger button (shown on small screens instead of native select) */
    .education-picker-trigger { display: none; position: relative; z-index: 3; pointer-events: auto; cursor: pointer; }
    .picker-trigger { display: none; position: relative; z-index: 3; pointer-events: auto; cursor: pointer; }
    @media (max-width: 480px) {
        #education_level { display: none !important; }
        .education-picker-trigger { display: inline-flex; width: 100%; }
        /* Hide sheetified native selects on small screens */
        select.mobile-form-select.sheetified { display: none !important; }
        .picker-trigger { display: inline-flex; width: 100%; }
    }
    
    /* Mobile-optimized buttons */
    .mobile-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        min-height: var(--touch-target);
        text-decoration: none;
        gap: 0.5rem;
    }
    
    .mobile-btn-primary {
        background-color: var(--bs-primary);
        color: var(--bs-light);
    }
    
    .mobile-btn-primary:hover {
        background-color: #9a7500;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .mobile-btn-secondary {
        background-color: var(--bs-secondary);
        color: var(--bs-light);
    }
    
    .mobile-btn-success {
        background-color: var(--bs-success);
        color: var(--bs-light);
    }
    
    .mobile-btn-block {
        width: 100%;
        margin-bottom: 1rem;
    }
    
    /* Quick stats cards */
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: linear-gradient(135deg, var(--bs-primary) 0%, var(--bs-info) 100%);
        color: var(--bs-light);
        padding: 1.5rem;
        border-radius: 0.75rem;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    /* Enhanced Mobile Subjects Styling */
    .mobile-subjects-container {
        margin-top: 0.75rem;
        max-height: 100px;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .mobile-subjects-container.expanded {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .mobile-subjects-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-bottom: 0.5rem;
    }
    
    .mobile-subject-chip {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 0.3rem 0.5rem;
        border-radius: 12px;
        font-size: 0.65rem;
        font-weight: 600;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 60px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        transition: all 0.2s ease;
    }
    
    .mobile-subject-chip:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,123,255,0.4);
    }
    
    .chip-subject {
        line-height: 1.1;
        margin-bottom: 0.1rem;
    }
    
    .chip-grade {
        font-size: 0.55rem;
        opacity: 0.9;
        background: rgba(255,255,255,0.2);
        padding: 1px 4px;
        border-radius: 6px;
    }
    
    .mobile-toggle-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.65rem;
        font-weight: 600;
        width: 100%;
        margin-top: 0.3rem;
        transition: all 0.2s ease;
    }
    
    .mobile-toggle-btn:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 6px rgba(40,167,69,0.4);
    }
    
    /* Enhanced Mobile Students Styling */
    .mobile-students-container {
        margin-top: 0.5rem;
        max-width: 100%;
        padding: 0.3rem;
        border-top: 1px solid rgba(0,0,0,0.1);
        background: rgba(248,249,250,0.5);
        border-radius: 8px;
    }

    .mobile-students-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 0.25rem;
        max-height: 140px;
        overflow-y: auto;
        padding: 0.3rem;
        /* Better space utilization */
        grid-auto-rows: min-content;
        justify-content: start;
        align-content: start;
    }

    @media (max-width: 480px) {
        .mobile-students-grid {
            grid-template-columns: repeat(auto-fill, minmax(115px, 1fr));
            gap: 0.2rem;
            max-height: 120px;
        }
    }

    @media (max-width: 360px) {
        .mobile-students-grid {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.15rem;
        }
    }

    .mobile-student-card {
        background: linear-gradient(135deg, rgba(0,123,255,0.1), rgba(40,167,69,0.1));
        border: 1px solid rgba(0,123,255,0.2);
        border-radius: 6px;
        padding: 0.35rem;
        transition: all 0.2s ease;
        font-size: 0.65rem;
        min-height: 50px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        /* Prevent stretching */
        align-self: start;
    }

    .mobile-student-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(0,123,255,0.3);
        border-color: #007bff;
    }

    .mobile-student-card .student-name {
        font-weight: 600;
        color: #212529;
        margin-bottom: 0.2rem;
        line-height: 1.1;
        font-size: 0.65rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .mobile-student-card .student-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.55rem;
        gap: 0.2rem;
    }

    .mobile-student-card .student-admission {
        background: rgba(40,167,69,0.2);
        padding: 1px 3px;
        border-radius: 3px;
        font-weight: 500;
        font-family: monospace;
    }

    .mobile-student-card .student-class {
        background: rgba(0,123,255,0.2);
        padding: 1px 3px;
        border-radius: 3px;
        font-weight: 500;
        white-space: nowrap;
    }

    .mobile-students-toggle {
        background: linear-gradient(135deg, #17a2b8, #28a745);
        color: white;
        border: none;
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.65rem;
        font-weight: 600;
        width: 100%;
        margin-top: 0.3rem;
        transition: all 0.2s ease;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
    }

    .mobile-students-toggle:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 6px rgba(23,162,184,0.4);
    }
    
    /* Mobile table styles */
    .mobile-table-container {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        border-radius: 0.5rem;
        border: 1px solid var(--bs-secondary);
        position: relative;
        width: 100%;
        max-width: 100vw; /* Use viewport width */
    }

    .mobile-table {
        width: 100%;
        min-width: 800px; /* Force table to be much wider than container */
        border-collapse: collapse;
        background: var(--bs-light);
        table-layout: fixed; /* Ensure consistent column widths */
    }
    
    .mobile-table th,
    .mobile-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid rgba(131, 148, 150, 0.2);
        white-space: nowrap; /* Prevent text wrapping */
        vertical-align: top;
    }

    /* Specific column widths for subject assignments table */
    .mobile-table th:nth-child(1),
    .mobile-table td:nth-child(1) {
        width: 300px; /* Subject column - fixed width */
        min-width: 300px;
    }

    .mobile-table th:nth-child(2),
    .mobile-table td:nth-child(2) {
        width: 150px; /* Grade column - fixed width */
        min-width: 150px;
    }

    .mobile-table th:nth-child(3),
    .mobile-table td:nth-child(3) {
        width: 150px; /* Stream column - fixed width */
        min-width: 150px;
    }

    .mobile-table th:nth-child(4),
    .mobile-table td:nth-child(4) {
        width: 200px; /* Role column - fixed width */
        min-width: 200px;
    }
    
    .mobile-table th {
        background-color: var(--bs-dark);
        color: var(--bs-light);
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .mobile-table tbody tr:hover {
        background-color: rgba(181, 137, 0, 0.1);
    }

    /* Enhanced scrollbar for mobile tables */
    .mobile-table-container::-webkit-scrollbar {
        height: 6px;
    }

    .mobile-table-container::-webkit-scrollbar-track {
        background: rgba(131, 148, 150, 0.1);
        border-radius: 3px;
    }

    .mobile-table-container::-webkit-scrollbar-thumb {
        background: var(--bs-primary);
        border-radius: 3px;
    }

    .mobile-table-container::-webkit-scrollbar-thumb:hover {
        background: var(--bs-warning);
    }
    
    /* Section visibility */
    .dashboard-section {
        display: none;
    }
    
    .dashboard-section.active {
        display: block;
    }
    
    /* Responsive adjustments */
    @media (min-width: 480px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .mobile-btn {
            display: inline-flex;
            width: auto;
        }
        
        .mobile-btn-block {
            width: auto;
        }
    }
    
    @media (min-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .dashboard-section {
            padding: 2rem;
        }
        
        .section-header h2 {
            font-size: 1.75rem;
        }
    }
    
    @media (min-width: 992px) {
        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
    
    /* Loading states */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid var(--bs-primary);
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Mobile-optimized input groups */
    .mobile-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .mobile-input-group-horizontal {
        flex-direction: row;
        align-items: center;
    }

    .mobile-input-group-horizontal .mobile-form-control {
        flex: 1;
        margin-right: 0.5rem;
    }

    .mobile-input-group-horizontal .mobile-btn {
        flex-shrink: 0;
    }

    /* Mobile-friendly select dropdowns */
    .mobile-form-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23073642' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        padding-right: 2.5rem;
    }

    /* Mobile-optimized checkboxes and radios */
    .mobile-form-check {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: var(--mobile-border-radius);
        transition: background-color 0.2s ease;
    }

    .mobile-form-check:hover {
        background-color: rgba(181, 137, 0, 0.1);
    }

    .mobile-form-check-input {
        width: 1.25rem;
        height: 1.25rem;
        margin: 0;
        cursor: pointer;
    }

    .mobile-form-check-label {
        margin: 0;
        cursor: pointer;
        font-size: 1rem;
        line-height: 1.5;
    }

    /* Mobile-optimized progress bars */
    .mobile-progress {
        height: 0.75rem;
        background-color: rgba(131, 148, 150, 0.2);
        border-radius: 0.375rem;
        overflow: hidden;
        margin-bottom: 1rem;
    }

    .mobile-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--bs-primary) 0%, var(--bs-info) 100%);
        transition: width 0.3s ease;
        border-radius: 0.375rem;
    }

    /* Mobile-optimized badges */
    .mobile-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        line-height: 1;
        color: var(--bs-light);
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.375rem;
        gap: 0.25rem;
    }

    .mobile-badge-primary { background-color: var(--bs-primary); }
    .mobile-badge-secondary { background-color: var(--bs-secondary); }
    .mobile-badge-success { background-color: var(--bs-success); }
    .mobile-badge-danger { background-color: var(--bs-danger); }
    .mobile-badge-warning { background-color: var(--bs-warning); }
    .mobile-badge-info { background-color: var(--bs-info); }

    /* Mobile-optimized tooltips */
    .mobile-tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
    }

    .mobile-tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--bs-dark);
        color: var(--bs-light);
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 1000;
    }

    .mobile-tooltip:hover::after,
    .mobile-tooltip:focus::after {
        opacity: 1;
        visibility: visible;
    }

    /* Swipe gestures for mobile tables */
    .mobile-table-swipe {
        position: relative;
        overflow: hidden;
    }

    .mobile-table-swipe::before {
        content: '← Swipe to see more →';
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: var(--bs-primary);
        color: var(--bs-light);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.7rem;
        opacity: 0.9;
        pointer-events: none;
        z-index: 15;
        animation: pulse 2s infinite;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    @media (min-width: 768px) {
        .mobile-table-swipe::before {
            display: none;
        }
    }

    /* Subject assignments specific styles */
    .subject-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .subject-icon {
        flex-shrink: 0;
        font-size: 0.875rem;
    }

    .mobile-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
    }

    .mobile-badge-primary {
        background-color: var(--bs-primary);
        color: white;
    }

    .mobile-badge-info {
        background-color: var(--bs-info);
        color: white;
    }

    .mobile-badge-warning {
        background-color: var(--bs-warning);
        color: var(--bs-dark);
    }

    .mobile-badge-success {
        background-color: var(--bs-success);
        color: white;
    }

    /* Mobile Analytics Styles */
    .mobile-analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .mobile-analytics-card {
        background: linear-gradient(135deg, var(--bs-light), var(--bs-white));
        border-radius: 0.75rem;
        padding: 1rem;
        text-align: center;
        border: 1px solid var(--bs-border-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .mobile-analytics-icon {
        font-size: 2rem;
        color: var(--bs-primary);
        margin-bottom: 0.5rem;
    }

    .mobile-analytics-content h4 {
        font-size: 0.875rem;
        color: var(--bs-secondary);
        margin-bottom: 0.25rem;
        font-weight: 600;
    }

    .mobile-analytics-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--bs-dark);
        margin-bottom: 0.25rem;
    }

    .mobile-analytics-change {
        font-size: 0.75rem;
        color: var(--bs-muted);
    }

    /* Mobile Quick Actions */
    .mobile-quick-actions h3 {
        color: var(--bs-dark);
        margin-bottom: 1rem;
        font-size: 1.125rem;
    }

    .mobile-action-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .mobile-action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        background: var(--bs-white);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.75rem;
        text-decoration: none;
        color: var(--bs-dark);
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .mobile-action-btn:hover {
        background: var(--bs-primary);
        color: var(--bs-white);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .mobile-action-btn i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .mobile-action-btn span {
        font-size: 0.875rem;
        font-weight: 600;
    }

    /* Mobile Enhanced Report Styles */
    .mobile-enhanced-report {
        background: var(--bs-white);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-top: 2rem;
        border: 1px solid var(--bs-border-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .mobile-report-header h3 {
        color: var(--bs-primary);
        margin-bottom: 1rem;
        font-size: 1.125rem;
    }

    .mobile-report-details {
        margin-bottom: 1.5rem;
    }

    .mobile-report-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--bs-border-color);
    }

    .mobile-detail-label {
        font-weight: 600;
        color: var(--bs-secondary);
    }

    .mobile-detail-value {
        color: var(--bs-dark);
        font-weight: 500;
    }

    .mobile-report-description {
        font-size: 0.875rem;
        color: var(--bs-muted);
        margin-top: 1rem;
        line-height: 1.4;
    }

    /* Mobile Empty State */
    .mobile-empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--bs-muted);
    }

    .mobile-empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .mobile-empty-state h3 {
        color: var(--bs-secondary);
        margin-bottom: 0.5rem;
    }

    .mobile-empty-state p {
        font-size: 0.875rem;
    }

    /* Mobile Composite Subject Styles */
    .mobile-composite-config {
        background: var(--bs-light);
        border-radius: 0.75rem;
        padding: 1rem;
        margin: 1rem 0;
    }

    .mobile-composite-header h4 {
        color: var(--bs-primary);
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }

    .mobile-composite-header p {
        color: var(--bs-secondary);
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }

    .mobile-component-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .mobile-total-display {
        grid-column: span 2;
        text-align: center;
        padding: 0.75rem;
        background: var(--bs-white);
        border-radius: 0.5rem;
        border: 1px solid var(--bs-border-color);
    }

    .mobile-total-marks {
        font-size: 1.25rem;
        font-weight: bold;
        color: var(--bs-primary);
    }
</style>
{% endblock %}

{% block content %}
<!-- Quick Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ assignment_summary.total_classes_managed if assignment_summary else 0 }}</div>
        <div class="stat-label">Classes Assigned</div>
    </div>
    <div class="stat-card students-mobile">
        <div class="stat-number">{{ my_students|length if my_students else 0 }}</div>
        <div class="stat-label">My Students</div>
        {% if my_students %}
        <div class="mobile-students-container">
          <div class="mobile-students-grid" id="mobile-students-grid">
            {% for student in my_students[:8] %}
            <div class="mobile-student-card">
              <div class="student-name">{{ student.first_name }} {{ student.last_name }}</div>
              <div class="student-details">
                <span class="student-admission">{{ student.admission_number }}</span>
                <span class="student-class">{{ student.grade_level }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
          {% if my_students|length > 8 %}
          <div class="mobile-students-toggle" onclick="toggleMobileStudents()">
            <span id="mobile-students-toggle-text">Show {{ my_students|length - 8 }} More</span>
            <span class="toggle-icon" id="mobile-students-toggle-icon">▼</span>
          </div>
          <div class="mobile-students-grid hidden" id="mobile-students-grid-more">
            {% for student in my_students[8:] %}
            <div class="mobile-student-card">
              <div class="student-name">{{ student.first_name }} {{ student.last_name }}</div>
              <div class="student-details">
                <span class="student-admission">{{ student.admission_number }}</span>
                <span class="student-class">{{ student.grade_level }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% endif %}
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ terms|length if terms else 0 }}</div>
        <div class="stat-label">Active Terms</div>
    </div>
    <div class="stat-card subjects-mobile">
        <div class="stat-number">{{ assignment_summary.total_subjects_taught if assignment_summary else 0 }}</div>
        <div class="stat-label">Subjects Taught</div>
        {% if assignment_summary and assignment_summary.subject_assignments %}
        <div class="mobile-subjects-container">
          <div class="mobile-subjects-grid">
            {% for assignment in assignment_summary.subject_assignments %}
              <div class="mobile-subject-chip">
                <span class="chip-subject">{{ assignment.subject_name }}</span>
                <span class="chip-grade">{{ assignment.grade_level }}</span>
              </div>
            {% endfor %}
          </div>
          {% if assignment_summary.subject_assignments|length > 4 %}
          <button class="mobile-toggle-btn" onclick="toggleMobileSubjects(this)">
            <span class="mobile-toggle-text">View All</span>
          </button>
          {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Subject Teaching Assignments Section -->
{% if assignment_summary and assignment_summary.subject_assignments %}
<div class="dashboard-section active" id="assignments-section">
    <div class="section-header">
        <i class="fas fa-chalkboard-teacher"></i>
        <h2>My Subject Assignments</h2>
    </div>

    <div class="mobile-table-container mobile-table-swipe">
        <table class="mobile-table">
            <thead>
                <tr>
                    <th>
                        <i class="fas fa-book"></i>
                        Subject
                    </th>
                    <th>
                        <i class="fas fa-layer-group"></i>
                        Grade
                    </th>
                    <th>
                        <i class="fas fa-users"></i>
                        Stream
                    </th>
                    <th>
                        <i class="fas fa-user-tag"></i>
                        Role
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for assignment in assignment_summary.subject_assignments %}
                <tr>
                    <td>
                        <div class="subject-info">
                            <div class="subject-icon" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--bs-success), var(--bs-info)); display: inline-flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 0.5rem;">
                                {{ assignment.subject.name[0] if assignment.subject and assignment.subject.name else 'S' }}
                            </div>
                            <div style="display: inline-block;">
                                <strong>{{ assignment.subject.name if assignment.subject else 'Unknown Subject' }}</strong>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="mobile-badge mobile-badge-primary">
                            {{ assignment.grade.name if assignment.grade else 'N/A' }}
                        </span>
                    </td>
                    <td>
                        <span class="mobile-badge mobile-badge-info">
                            {{ assignment.stream.name if assignment.stream else 'All' }}
                        </span>
                    </td>
                    <td>
                        <span class="mobile-badge mobile-badge-warning">
                            {% if assignment.is_class_teacher %}Class Teacher{% else %}Subject Teacher{% endif %}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Marks Entry Section -->
<div id="marks-section" class="dashboard-section">
    <div class="section-header">
        <i class="fas fa-edit"></i>
        <h2>Enter Student Marks</h2>
    </div>

    {% if error_message %}
    <div class="mobile-alert mobile-alert-error" style="margin-bottom: 1rem;">
        <strong>Error:</strong> {{ error_message }}
        <br><br>
        <a href="{{ url_for('teacher.reset_form') }}" class="mobile-btn mobile-btn-error" style="margin-top: 0.5rem;">
            🔄 Reset Form
        </a>
    </div>
    {% endif %}

    {% if not show_students %}
    <!-- Enhanced form with education level filtering -->
    <form id="mobile-upload-form" method="POST" action="{{ url_for('teacher.dashboard') }}" class="mobile-marks-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="mobile" value="true"/>

        <!-- Enhanced Education Level Selection -->
        <div class="mobile-form-group">
            <label for="education_level" class="mobile-form-label">
                <i class="fas fa-graduation-cap"></i>
                Education Level
            </label>
            <select id="education_level" name="education_level" class="mobile-form-control mobile-form-select" required>
                <option value="">🎯 Select Education Level</option>
                <option value="lower_primary" {% if education_level == 'lower_primary' %}selected{% endif %}>🎓 Lower Primary (Grades 1-3)</option>
                <option value="upper_primary" {% if education_level == 'upper_primary' %}selected{% endif %}>📚 Upper Primary (Grades 4-6)</option>
                <option value="junior_secondary" {% if education_level == 'junior_secondary' %}selected{% endif %}>🏫 Junior Secondary (Grades 7-9)</option>
            </select>
            <button type="button" id="education-picker-button" class="mobile-btn mobile-btn-primary mobile-btn-block education-picker-trigger" aria-haspopup="dialog" aria-controls="education-picker" aria-expanded="false" onclick="(window.openEducationPicker ? window.openEducationPicker() : (function(){ var b=document.getElementById('education-picker-backdrop'); var s=document.getElementById('education-picker'); if(b&&s){ b.style.display='block'; s.classList.add('open'); this.setAttribute('aria-expanded','true'); } }).call(this))">
                Select Education Level
            </button>
        </div>

        <!-- Enhanced Subject Selection (filtered by education level) -->
        <div class="mobile-form-group">
            <label for="subject" class="mobile-form-label">
                <i class="fas fa-book"></i>
                Subject
            </label>
            <select id="subject" name="subject" class="mobile-form-control mobile-form-select sheetified" required onchange="handleSubjectSelection()">
                <option value="">📖 Select Subject</option>
                <!-- Subjects will be populated based on education level -->
            </select>
            <button type="button" id="subject-picker-button" class="mobile-btn mobile-btn-primary mobile-btn-block picker-trigger" aria-haspopup="dialog" aria-controls="generic-picker" aria-expanded="false" data-target-select="subject" data-title="Select Subject" onclick="window.openPickerFor ? window.openPickerFor('subject') : null">
                Select Subject
            </button>
            <div id="subject-info" class="mobile-subject-info" style="display: none;">
                <small id="subject-details"></small>
            </div>
        </div>



        <div class="mobile-form-group">
            <label for="grade" class="mobile-form-label">
                <i class="fas fa-layer-group"></i>
                Grade
            </label>
            <select name="grade" id="grade" class="mobile-form-control mobile-form-select sheetified" required>
                <option value="">Select Grade</option>
                {% for grade_obj in grades %}
                <option value="{{ grade_obj.id }}" {% if grade == grade_obj.id|string %}selected{% endif %}>
                    {{ grade_obj.name }}
                </option>
                {% endfor %}
            </select>
            <button type="button" id="grade-picker-button" class="mobile-btn mobile-btn-primary mobile-btn-block picker-trigger" aria-haspopup="dialog" aria-controls="generic-picker" aria-expanded="false" data-target-select="grade" data-title="Select Grade" onclick="window.openPickerFor ? window.openPickerFor('grade') : null">
                Select Grade
            </button>
        </div>

        <div class="mobile-form-group">
            <label for="term" class="mobile-form-label">
                <i class="fas fa-calendar-alt"></i>
                Term
            </label>
            <select name="term" id="term" class="mobile-form-control mobile-form-select sheetified" required>
                <option value="">📅 Select Term</option>
                {% for term_option in terms %}
                <option value="{{ term_option }}" {% if term == term_option %}selected{% endif %}>📆 {{ term_option }}</option>
                {% endfor %}
            </select>
            <button type="button" id="term-picker-button" class="mobile-btn mobile-btn-primary mobile-btn-block picker-trigger" aria-haspopup="dialog" aria-controls="generic-picker" aria-expanded="false" data-target-select="term" data-title="Select Term" onclick="window.openPickerFor ? window.openPickerFor('term') : null">
                Select Term
            </button>
        </div>

        <div class="mobile-form-group">
            <label for="assessment_type" class="mobile-form-label">
                <i class="fas fa-clipboard-check"></i>
                Assessment Type
            </label>
            <select name="assessment_type" id="assessment_type" class="mobile-form-control mobile-form-select sheetified" required>
                <option value="">📝 Select Assessment Type</option>
                {% for assessment_option in assessment_types %}
                <option value="{{ assessment_option }}" {% if assessment_type == assessment_option %}selected{% endif %}>📊 {{ assessment_option }}</option>
                {% endfor %}
            </select>
            <button type="button" id="assessment-picker-button" class="mobile-btn mobile-btn-primary mobile-btn-block picker-trigger" aria-haspopup="dialog" aria-controls="generic-picker" aria-expanded="false" data-target-select="assessment_type" data-title="Select Assessment Type" onclick="window.openPickerFor ? window.openPickerFor('assessment') : null">
                Select Assessment Type
            </button>
        </div>

        <div class="mobile-form-group">
            <label for="stream" class="mobile-form-label">
                <i class="fas fa-users"></i>
                Stream
            </label>
            <select name="stream" id="stream" class="mobile-form-control mobile-form-select sheetified" required>
                <option value="">🏛️ Select Stream</option>
                <!-- Streams will be populated dynamically via JavaScript -->
            </select>
            <button type="button" id="stream-picker-button" class="mobile-btn mobile-btn-primary mobile-btn-block picker-trigger" aria-haspopup="dialog" aria-controls="generic-picker" aria-expanded="false" data-target-select="stream" data-title="Select Stream" onclick="window.openPickerFor ? window.openPickerFor('stream') : null">
                Select Stream
            </button>
        </div>

        <div class="mobile-form-group" id="total-marks-group">
            <label for="total_marks" class="mobile-form-label">
                <i class="fas fa-calculator"></i>
                Total Marks (Out Of)
            </label>
            <input type="number" id="total_marks" name="total_marks" class="mobile-form-control" min="1" value="{{ total_marks if total_marks else '' }}" required>
        </div>

        <!-- Composite Subject Configuration (shown only for English/Kiswahili) -->
        <div id="composite-config" class="mobile-composite-config" style="display: none;">
            <div class="mobile-composite-header">
                <h4>📚 Composite Subject Configuration</h4>
                <p>Set maximum marks for each component:</p>
            </div>

            <div id="english-config" class="mobile-component-config" style="display: none;">
                <div class="mobile-component-grid">
                    <div class="mobile-form-group">
                        <label for="grammar_max">Grammar (Max Marks)</label>
                        <input type="number" id="grammar_max" name="grammar_max" class="mobile-form-control" value="{{ grammar_max_marks }}" min="1" max="1000" oninput="updateComponentMaxMarks()">
                    </div>
                    <div class="mobile-form-group">
                        <label for="composition_max">Composition (Max Marks)</label>
                        <input type="number" id="composition_max" name="composition_max" class="mobile-form-control" value="{{ composition_max_marks }}" min="1" max="1000" oninput="updateComponentMaxMarks()">
                    </div>
                    <div class="mobile-total-display">
                        <label>Total Max Marks</label>
                        <div id="english_total_display" class="mobile-total-marks">{{ grammar_max_marks|int + composition_max_marks|int }}</div>
                    </div>
                </div>
            </div>

            <div id="kiswahili-config" class="mobile-component-config" style="display: none;">
                <div class="mobile-component-grid">
                    <div class="mobile-form-group">
                        <label for="lugha_max">Lugha (Max Marks)</label>
                        <input type="number" id="lugha_max" name="lugha_max" class="mobile-form-control" value="{{ lugha_max_marks }}" min="1" max="1000" oninput="updateComponentMaxMarks()">
                    </div>
                    <div class="mobile-form-group">
                        <label for="insha_max">Insha (Max Marks)</label>
                        <input type="number" id="insha_max" name="insha_max" class="mobile-form-control" value="{{ insha_max_marks }}" min="1" max="1000" oninput="updateComponentMaxMarks()">
                    </div>
                    <div class="mobile-total-display">
                        <label>Total Max Marks</label>
                        <div id="kiswahili_total_display" class="mobile-total-marks">{{ lugha_max_marks|int + insha_max_marks|int }}</div>
                    </div>
                </div>
            </div>
        </div>

        <button type="submit" name="upload_marks" value="1" class="mobile-btn mobile-btn-primary mobile-btn-block" id="mobile-upload-btn" onclick="debugFormSubmission()">
            <i class="fas fa-upload"></i>
            Upload Marks
        </button>
    </form>
    {% endif %}

    {% if students %}
    <!-- Mobile Marks Entry Form -->
    <form id="mobile-marks-form" method="POST" action="{{ url_for('teacher.dashboard') }}" class="mobile-marks-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="submit_marks" value="1"/>
        <input type="hidden" name="mobile" value="true"/>
        <input type="hidden" name="education_level" value="{{ education_level }}"/>
        <input type="hidden" name="subject" value="{{ subject }}"/>
        <input type="hidden" name="grade" value="{{ grade }}"/>
        <input type="hidden" name="stream" value="{{ stream }}"/>
        <input type="hidden" name="term" value="{{ term }}"/>
        <input type="hidden" name="assessment_type" value="{{ assessment_type }}"/>
        <input type="hidden" name="total_marks" value="{{ total_marks }}"/>

        <!-- Subject Header -->
        <div class="mobile-subject-header" style="background: linear-gradient(135deg, var(--bs-primary), var(--bs-info)); color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
            <h3 style="margin: 0; font-size: 1.2rem;">📚 {{ subject }} - Marks Entry</h3>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">
                Grade {{ grade }} {{ stream }} | {{ term }} | {{ assessment_type }} | Total: {{ total_marks }}
            </p>
        </div>

        <div class="mobile-table-container mobile-table-swipe">
            <table class="mobile-table">
                <thead>
                    <tr>
                        <th>
                            <i class="fas fa-user"></i>
                            Student
                        </th>
                        <th>
                            <i class="fas fa-edit"></i>
                            Raw Mark
                        </th>
                        <th>
                            <i class="fas fa-percent"></i>
                            %
                        </th>
                        <th>
                            <i class="fas fa-medal"></i>
                            Grade
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr data-student-id="{{ student.id }}">
                        <td>
                            <div class="student-info">
                                <div class="student-avatar" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--bs-primary), var(--bs-info)); display: inline-flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 0.5rem;">
                                    {{ student.name[0] }}
                                </div>
                                <div style="display: inline-block;">
                                    <strong style="font-size: 0.9rem;">{{ student.name }}</strong><br>
                                    <small class="text-muted">ID: {{ student.id }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <input type="number"
                                   name="mark_{{ student.id }}"
                                   class="mobile-form-control mark-input"
                                   placeholder="0"
                                   min="0"
                                   max="{{ total_marks }}"
                                   step="0.1"
                                   data-student-id="{{ student.id }}"
                                   data-total-marks="{{ total_marks }}"
                                   oninput="updateMobilePercentage({{ student.id }})"
                                   style="width: 70px; font-size: 1rem; text-align: center;">
                        </td>
                        <td>
                            <span id="percentage_{{ student.id }}" class="mobile-badge mobile-badge-info" style="font-size: 0.8rem;">
                                0%
                            </span>
                        </td>
                        <td>
                            <span id="grade_{{ student.id }}" class="mobile-badge mobile-badge-secondary" style="font-size: 0.8rem;">
                                -
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Submit Button -->
        <div style="margin-top: 2rem; text-align: center;">
            <button type="submit" class="mobile-btn mobile-btn-success mobile-btn-block" style="font-size: 1.1rem; padding: 1rem;">
                <i class="fas fa-save"></i>
                Submit All Marks
            </button>
        </div>
    </form>
        <!-- Mobile-friendly pagination -->
        {% if pagination_info and pagination_info.pages > 1 %}
        <div class="mobile-pagination" style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 1rem; padding: 1rem;">
            {% if pagination_info.has_prev %}
            <button type="submit" name="page" value="{{ pagination_info.prev_num }}" class="mobile-btn mobile-btn-outline-primary mobile-btn-sm">
                <i class="fas fa-chevron-left"></i>
                Previous
            </button>
            {% endif %}

            <span class="mobile-badge mobile-badge-primary">
                Page {{ pagination_info.page }} of {{ pagination_info.pages }}
            </span>

            {% if pagination_info.has_next %}
            <button type="submit" name="page" value="{{ pagination_info.next_num }}" class="mobile-btn mobile-btn-outline-primary mobile-btn-sm">
                Next
                <i class="fas fa-chevron-right"></i>
            </button>
            {% endif %}
        </div>
        {% endif %}
    {% endif %}
</div>

<!-- Reports Section -->
<div id="reports-section" class="dashboard-section">
    <div class="section-header">
        <i class="fas fa-chart-bar"></i>
        <h2 style="display:flex; align-items:center; gap:0.5rem; width:100%; justify-content:space-between;">
            <span>Recent Reports</span>
            <a href="#subject-report-history-mobile" class="mobile-btn mobile-btn-secondary" style="padding:0.25rem 0.5rem; font-size:0.8rem;">
                View All
            </a>
        </h2>
    </div>

    {% if recent_reports %}
    <div class="mobile-table-container mobile-table-swipe">
        <table class="mobile-table">
            <thead>
                <tr>
                    <th>
                        <i class="fas fa-layer-group"></i>
                        Grade
                    </th>
                    <th>
                        <i class="fas fa-users"></i>
                        Stream
                    </th>
                    <th>
                        <i class="fas fa-calendar"></i>
                        Term
                    </th>
                    <th>
                        <i class="fas fa-clipboard-check"></i>
                        Assessment
                    </th>
                    <th>
                        <i class="fas fa-chart-line"></i>
                        Average
                    </th>
                    <th>
                        <i class="fas fa-clock"></i>
                        Date
                    </th>
                    <th>
                        <i class="fas fa-cog"></i>
                        Action
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for report in recent_reports %}
                <tr class="js-report-row" {% if report.view_url %}data-url="{{ report.view_url }}" role="button" tabindex="0" style="cursor:pointer;"{% endif %}>
                    <td>
                        <span class="mobile-badge mobile-badge-primary">
                            {{ report.grade }}
                        </span>
                        {% if report.view_url %}
                        <div style="margin-top:0.35rem;">
                            <a href="{{ report.view_url }}" class="mobile-btn mobile-btn-sm mobile-btn-primary" style="padding:0.25rem 0.5rem; font-size:0.75rem;">View</a>
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        <span class="mobile-badge mobile-badge-info">
                            {{ report.stream }}
                        </span>
                    </td>
                    <td>
                        <span class="mobile-badge mobile-badge-secondary">
                            {{ report.term }}
                        </span>
                    </td>
                    <td>
                        <span class="mobile-badge mobile-badge-warning">
                            {{ report.assessment_type }}
                        </span>
                    </td>
                    <td>
                        {% if report.class_average is defined and report.class_average is not none %}
                            <span class="mobile-badge mobile-badge-success">{{ report.class_average }}%</span>
                        {% else %}
                            <span class="mobile-badge mobile-badge-secondary">—</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="mobile-badge mobile-badge-secondary">{{ report.date }}</span>
                    </td>
                    <td>
                        {% if report.view_url %}
                            <a href="{{ report.view_url }}" class="mobile-btn mobile-btn-sm mobile-btn-primary"><i class="fas fa-eye"></i> View</a>
                        {% else %}
                            <span class="mobile-badge mobile-badge-secondary">N/A</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="mobile-empty-state">
        <div class="mobile-empty-icon">
            <i class="fas fa-chart-bar"></i>
        </div>
        <h3>No Recent Reports</h3>
        <p>Upload some marks to generate reports</p>
    </div>
    {% endif %}

    <!-- Enhanced Subject Report Section -->
    {% if show_subject_report %}
    <div class="mobile-enhanced-report">
        <div class="mobile-report-header">
            <h3>📈 Enhanced Subject Report</h3>
            <div class="mobile-report-details">
                <div class="mobile-report-item">
                    <span class="mobile-detail-label">Subject:</span>
                    <span class="mobile-detail-value">{{ subject }}</span>
                </div>
                <div class="mobile-report-item">
                    <span class="mobile-detail-label">Grade & Stream:</span>
                    <span class="mobile-detail-value">{{ grade }} - {{ stream }}</span>
                </div>
                <div class="mobile-report-item">
                    <span class="mobile-detail-label">Assessment:</span>
                    <span class="mobile-detail-value">{{ term }} | {{ assessment_type }}</span>
                </div>
            </div>
        </div>
        <div class="mobile-report-actions">
            <a href="{{ url_for('teacher.generate_subject_report',
                     subject=subject,
                     grade=grade,
                     stream=stream,
                     term=term,
                     assessment_type=assessment_type) }}"
               class="mobile-btn mobile-btn-primary mobile-btn-block" target="_blank">
                📊 Generate Subject Analysis Report
            </a>
            <p class="mobile-report-description">
                Generate a comprehensive subject-specific report with grading analysis,
                performance statistics, and detailed insights for {{ subject }}.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Subject Report History (Filterable) -->
    <div id="subject-report-history-mobile" class="dashboard-section" style="margin-top: 1rem;">
        <div class="section-header">
            <i class="fas fa-history"></i>
            <h2>Subject Report History</h2>
        </div>

        <div class="mobile-input-group" style="gap: 0.5rem;">
            <div class="mobile-input-group-horizontal">
                <select id="m-filter-subject" class="mobile-form-control mobile-form-select" aria-label="Filter by subject">
                    <option value="">All Subjects</option>
                    {% if accessible_subjects %}
                        {% for s in accessible_subjects %}
                            <option value="{{ s.name }}">{{ s.name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
                <select id="m-filter-grade" class="mobile-form-control mobile-form-select" aria-label="Filter by grade">
                    <option value="">All Grades</option>
                    {% if grades %}
                        {% for g in grades %}
                            <option value="{{ g.id }}">{{ g.name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="mobile-input-group-horizontal">
                <select id="m-filter-stream" class="mobile-form-control mobile-form-select" aria-label="Filter by stream">
                    <option value="">All Streams</option>
                    {% if accessible_streams %}
                        {% for st in accessible_streams %}
                            <option value="{{ st.id }}">{{ st.name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
                <select id="m-filter-term" class="mobile-form-control mobile-form-select" aria-label="Filter by term">
                    <option value="">All Terms</option>
                    {% if terms %}
                        {% for t in terms %}
                            <option value="{{ t }}">{{ t }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
                <select id="m-filter-assessment" class="mobile-form-control mobile-form-select" aria-label="Filter by assessment type">
                    <option value="">All Assessments</option>
                    {% if assessment_types %}
                        {% for at in assessment_types %}
                            <option value="{{ at }}">{{ at }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
                <button id="m-filters-clear" type="button" class="mobile-btn mobile-btn-secondary" style="min-height: var(--touch-target);">Clear</button>
            </div>
        </div>

        <div class="mobile-table-container mobile-table-swipe" id="mobile-report-history" aria-live="polite"></div>
    </div>
</div>

<!-- Class Reports Section (unique id to avoid clashes with Subject Report History section) -->
<div id="class-reports-section" class="dashboard-section">
    <div class="section-header">
        <i class="fas fa-chart-bar"></i>
        <h2>Class Reports</h2>
    </div>
    
    <div class="row">
        <div class="col-12">
            <p>Generate and view class performance reports.</p>
            <button class="mobile-btn mobile-btn-primary mobile-btn-block">
                <i class="fas fa-file-pdf"></i>
                Generate Class Report
            </button>
        </div>
    </div>
</div>

<!-- Analytics removed for parity with desktop; to be reintroduced when implemented across views -->

<!-- Mobile Education Level Picker (bottom-sheet) IN-CONTENT so it renders -->
<div id="education-picker-backdrop" class="mobile-sheet-backdrop"></div>
<div id="education-picker" class="mobile-sheet" role="dialog" aria-modal="true" aria-labelledby="education-picker-title">
    <div class="mobile-sheet-grabber" role="presentation"></div>
    <div class="mobile-sheet-header" id="education-picker-title">Select Education Level</div>
    <div class="mobile-sheet-options">
        <button type="button" class="mobile-sheet-option" data-education-value="lower_primary" data-education-label="Lower Primary (Grades 1-3)">🎓 Lower Primary (Grades 1-3)</button>
        <button type="button" class="mobile-sheet-option" data-education-value="upper_primary" data-education-label="Upper Primary (Grades 4-6)">📚 Upper Primary (Grades 4-6)</button>
        <button type="button" class="mobile-sheet-option" data-education-value="junior_secondary" data-education-label="Junior Secondary (Grades 7-9)">🏫 Junior Secondary (Grades 7-9)</button>
    </div>
        <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem;">
            <button type="button" class="mobile-btn mobile-btn-secondary mobile-sheet-close" id="education-picker-cancel">Cancel</button>
            <button type="button" class="mobile-btn mobile-btn-primary" id="education-picker-done">Done</button>
        </div>
    <div style="height: env(safe-area-inset-bottom, 12px);"></div>
    </div>

<!-- Generic Picker for Subject/Grade/Term (mobile) -->
<div id="generic-picker-backdrop" class="mobile-sheet-backdrop"></div>
<div id="generic-picker" class="mobile-sheet" role="dialog" aria-modal="true" aria-labelledby="generic-picker-title">
        <div class="mobile-sheet-grabber" role="presentation"></div>
        <div class="mobile-sheet-header" id="generic-picker-title">Select</div>
    <div class="mobile-sheet-search"><input id="generic-picker-search" type="search" placeholder="Search..." autocomplete="off" /></div>
    <div class="mobile-sheet-options" id="generic-picker-options"></div>
        <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem;">
            <button type="button" class="mobile-btn mobile-btn-secondary mobile-sheet-close" id="generic-picker-cancel">Cancel</button>
            <button type="button" class="mobile-btn mobile-btn-primary" id="generic-picker-done">Done</button>
        </div>
    <div style="height: env(safe-area-inset-bottom, 12px);"></div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    // Mobile subjects toggle function
    function toggleMobileSubjects(button) {
        const container = button.closest('.mobile-subjects-container');
        const toggleText = button.querySelector('.mobile-toggle-text');
        
        if (container.classList.contains('expanded')) {
            container.classList.remove('expanded');
            toggleText.textContent = 'View All';
        } else {
            container.classList.add('expanded');
            toggleText.textContent = 'Show Less';
        }
    }

    // Mobile students toggle function
    function toggleMobileStudents() {
        const moreGrid = document.getElementById('mobile-students-grid-more');
        const toggleText = document.getElementById('mobile-students-toggle-text');
        const toggleIcon = document.getElementById('mobile-students-toggle-icon');
        
        if (moreGrid.classList.contains('hidden')) {
            // Show more students
            moreGrid.classList.remove('hidden');
            toggleText.textContent = 'Show Less';
            toggleIcon.style.transform = 'rotate(180deg)';
        } else {
            // Hide extra students
            moreGrid.classList.add('hidden');
            const totalStudents = {{ my_students|length if my_students else 0 }};
            const extraCount = totalStudents - 8;
            toggleText.textContent = `Show ${extraCount} More`;
            toggleIcon.style.transform = 'rotate(0deg)';
        }
    }

    // Section navigation
    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.dashboard-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Show selected section
        document.getElementById(sectionId).classList.add('active');
        
        // Update navigation active state
        document.querySelectorAll('.mobile-nav-link').forEach(link => {
            link.classList.remove('active');
        });
        const targetLink = document.querySelector(`.mobile-nav-link[href="#${sectionId}"]`);
        if (targetLink) targetLink.classList.add('active');

        // If Reports tab is opened, ensure history is loaded/refreshed
        if (sectionId === 'reports-section') {
            try { initMobileReportHistory(); } catch (e) { /* no-op */ }
        }
        
        // Close mobile menu
        if (window.innerWidth <= 768) {
            document.getElementById('mobileNav').classList.remove('active');
            document.getElementById('mobileNavOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }
    }
    
    // Dynamic subject and grade loading
    document.getElementById('education_level').addEventListener('change', function() {
        const level = this.value;

        // Update subjects
        const subjectSelect = document.getElementById('subject');
        subjectSelect.innerHTML = '<option value="">📖 Select Subject</option>';

        if (level && window.subjectsByEducationLevel && window.subjectsByEducationLevel[level]) {
            window.subjectsByEducationLevel[level].forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
        }

    // Reset subject/grade trigger labels on level change
    var subjBtn0 = document.getElementById('subject-picker-button');
    if (subjBtn0) subjBtn0.textContent = 'Select Subject';
    var gradeBtn0 = document.getElementById('grade-picker-button');
    if (gradeBtn0) gradeBtn0.textContent = 'Select Grade';

        // Update grades
        updateGradesByEducationLevel();
    });
    
    // Initialize subjects data
    window.subjectsByEducationLevel = {{ subjects_by_education_level|tojson }};

    // Desktop functionality ported to mobile
    function updateSubjectsByEducationLevel() {
        const educationLevel = document.getElementById('education_level').value;
        const subjectSelect = document.getElementById('subject');

        // Clear current options
        subjectSelect.innerHTML = '<option value="">📖 Select Subject</option>';

        if (educationLevel && window.subjectsByEducationLevel && window.subjectsByEducationLevel[educationLevel]) {
            window.subjectsByEducationLevel[educationLevel].forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
        }

    // Reset subject trigger label after repopulating
    var subjBtn = document.getElementById('subject-picker-button');
    if (subjBtn) subjBtn.textContent = 'Select Subject';
    }

    function updateGradesByEducationLevel() {
        const educationLevel = document.getElementById('education_level').value;
        const gradeSelect = document.getElementById('grade');

        // Store all original options if not already stored
        if (!window.originalGradeOptions) {
            window.originalGradeOptions = Array.from(gradeSelect.options).map(option => ({
                value: option.value,
                text: option.textContent,
                selected: option.selected
            }));
        }

        // Define grade name mappings for each education level
        const gradeNamesByEducationLevel = {
            'lower_primary': ['Grade 1', 'Grade 2', 'Grade 3'],
            'upper_primary': ['Grade 4', 'Grade 5', 'Grade 6'],
            'junior_secondary': ['Grade 7', 'Grade 8', 'Grade 9']
        };

        // Clear current options
        gradeSelect.innerHTML = '<option value="">🎓 Select Grade</option>';

        if (educationLevel && gradeNamesByEducationLevel[educationLevel]) {
            // Add only the grades for the selected education level
            window.originalGradeOptions.forEach(gradeOption => {
                if (gradeOption.value !== '') { // Skip the default option
                    const gradeName = gradeOption.text.trim();

                    if (gradeNamesByEducationLevel[educationLevel].includes(gradeName)) {
                        const option = document.createElement('option');
                        option.value = gradeOption.value;
                        option.textContent = gradeOption.text;
                        gradeSelect.appendChild(option);
                    }
                }
            });
        } else {
            // If no education level selected, show all grades
            window.originalGradeOptions.forEach(gradeOption => {
                if (gradeOption.value !== '') { // Skip the default option
                    const option = document.createElement('option');
                    option.value = gradeOption.value;
                    option.textContent = gradeOption.text;
                    gradeSelect.appendChild(option);
                }
            });
        }

        // Clear streams when grades change
        const streamSelect = document.getElementById('stream');
        streamSelect.innerHTML = '<option value="">🏛️ Select Stream</option>';
    // Reset stream trigger label (if present)
    var streamBtn = document.getElementById('stream-picker-button');
    if (streamBtn) streamBtn.textContent = 'Select Stream';
    }

    function handleSubjectSelection() {
        const subject = document.getElementById('subject').value;
        const compositeConfig = document.getElementById('composite-config');
        const englishConfig = document.getElementById('english-config');
        const kiswahiliConfig = document.getElementById('kiswahili-config');

        // Hide all composite configs first
        compositeConfig.style.display = 'none';
        englishConfig.style.display = 'none';
        kiswahiliConfig.style.display = 'none';

        // Show appropriate config for composite subjects
        if (subject === 'ENGLISH') {
            compositeConfig.style.display = 'block';
            englishConfig.style.display = 'block';
        } else if (subject === 'KISWAHILI') {
            compositeConfig.style.display = 'block';
            kiswahiliConfig.style.display = 'block';
        }
    }

    function updateComponentMaxMarks() {
        const subject = document.getElementById('subject').value;

        if (subject === 'ENGLISH') {
            const grammarMax = parseInt(document.getElementById('grammar_max').value) || 0;
            const compositionMax = parseInt(document.getElementById('composition_max').value) || 0;
            const total = grammarMax + compositionMax;
            document.getElementById('english_total_display').textContent = total;
            document.getElementById('total_marks').value = total;
        } else if (subject === 'KISWAHILI') {
            const lughaMax = parseInt(document.getElementById('lugha_max').value) || 0;
            const inshaMax = parseInt(document.getElementById('insha_max').value) || 0;
            const total = lughaMax + inshaMax;
            document.getElementById('kiswahili_total_display').textContent = total;
            document.getElementById('total_marks').value = total;
        }
    }

    function updateStreams() {
        const gradeSelect = document.getElementById('grade');
        const streamSelect = document.getElementById('stream');
        const selectedGradeId = gradeSelect.value;

        // Clear current streams
        streamSelect.innerHTML = '<option value="">🏛️ Select Stream</option>';

        if (selectedGradeId) {
            // Show loading state
            streamSelect.innerHTML = '<option value="">Loading streams...</option>';
            var streamBtnLoading = document.getElementById('stream-picker-button');
            if (streamBtnLoading) streamBtnLoading.textContent = 'Loading streams…';

            // Fetch streams from API
            fetch(`/teacher/get_streams/${selectedGradeId}`)
                .then(response => response.json())
                .then(data => {
                    streamSelect.innerHTML = '<option value="">🏛️ Select Stream</option>';

                    if (data.success && data.streams && data.streams.length > 0) {
                        data.streams.forEach(stream => {
                            const option = document.createElement('option');
                            option.value = stream.id;
                            option.textContent = stream.name;
                            streamSelect.appendChild(option);
                        });
                        var streamBtnReady = document.getElementById('stream-picker-button');
                        if (streamBtnReady) streamBtnReady.textContent = 'Select Stream';
                    } else {
                        streamSelect.innerHTML = '<option value="">No streams available</option>';
                        var streamBtnNone = document.getElementById('stream-picker-button');
                        if (streamBtnNone) streamBtnNone.textContent = 'No streams available';
                    }
                })
                .catch(error => {
                    console.error('Error fetching streams:', error);
                    streamSelect.innerHTML = '<option value="">Error loading streams</option>';
                    var streamBtnErr = document.getElementById('stream-picker-button');
                    if (streamBtnErr) streamBtnErr.textContent = 'Error loading streams';
                });
        }
    }

    function debugFormSubmission() {
        console.log('Mobile form submission debug');
        const form = document.getElementById('mobile-upload-form');
        if (form) {
            const formData = new FormData(form);
            for (let [key, value] of formData.entries()) {
                console.log(key, value);
            }
        }
    }

    // Real-time grade conversion for mobile marks entry
    function updateMobilePercentage(studentId) {
        const markInput = document.querySelector(`input[name="mark_${studentId}"]`);
        const percentageDisplay = document.getElementById(`percentage_${studentId}`);
        const gradeDisplay = document.getElementById(`grade_${studentId}`);

        if (!markInput || !percentageDisplay || !gradeDisplay) return;

        const rawMark = parseFloat(markInput.value) || 0;
        const totalMarks = parseFloat(markInput.getAttribute('data-total-marks')) || 100;

        // Calculate percentage
        const percentage = totalMarks > 0 ? (rawMark / totalMarks) * 100 : 0;

        // Update percentage display
        percentageDisplay.textContent = percentage.toFixed(1) + '%';
        percentageDisplay.className = 'mobile-badge ' + (percentage >= 50 ? 'mobile-badge-success' : 'mobile-badge-warning');

        // Calculate grade based on percentage
        let grade = '-';
        if (rawMark > 0) {
            if (percentage >= 90) grade = 'EE1';
            else if (percentage >= 75) grade = 'EE2';
            else if (percentage >= 58) grade = 'ME1';
            else if (percentage >= 41) grade = 'ME2';
            else if (percentage >= 31) grade = 'AE1';
            else if (percentage >= 21) grade = 'AE2';
            else if (percentage >= 11) grade = 'BE1';
            else grade = 'BE2';
        }

        // Update grade display with color coding
        gradeDisplay.textContent = grade;
        if (grade.startsWith('EE')) {
            gradeDisplay.className = 'mobile-badge mobile-badge-success';
        } else if (grade.startsWith('ME')) {
            gradeDisplay.className = 'mobile-badge mobile-badge-info';
        } else if (grade.startsWith('AE')) {
            gradeDisplay.className = 'mobile-badge mobile-badge-warning';
        } else if (grade.startsWith('BE')) {
            gradeDisplay.className = 'mobile-badge mobile-badge-danger';
        } else {
            gradeDisplay.className = 'mobile-badge mobile-badge-secondary';
        }
    }

    // Initialize percentages on page load for existing marks
    document.addEventListener('DOMContentLoaded', function() {
        const markInputs = document.querySelectorAll('.mark-input');
        markInputs.forEach(input => {
            const studentId = input.getAttribute('data-student-id');
            if (studentId && input.value) {
                updateMobilePercentage(studentId);
            }
        });

    // Initialize mobile report history
    try { initMobileReportHistory(); } catch (e) { console.warn('History init failed', e); }
    });

    // Make Recent Reports rows clickable & keyboard accessible
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.js-report-row[data-url]').forEach(row => {
            const url = row.getAttribute('data-url');
            row.addEventListener('click', () => { if (url) window.location.href = url; });
            row.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    if (url) window.location.href = url;
                }
            });
        });
    });

    function updateRegularPercentage(studentKey, mark, totalMarks) {
        const percentage = totalMarks > 0 ? Math.round((mark / totalMarks) * 100) : 0;
        const percentageElement = document.getElementById(`percentage_${studentKey}`);
        if (percentageElement) {
            percentageElement.textContent = `${percentage}%`;

            // Color coding based on percentage
            if (percentage >= 80) {
                percentageElement.style.color = 'var(--bs-success)';
            } else if (percentage >= 60) {
                percentageElement.style.color = 'var(--bs-warning)';
            } else {
                percentageElement.style.color = 'var(--bs-danger)';
            }
        }
    }

    function updateCompositePercentage(studentKey) {
        const inputs = document.querySelectorAll(`input[data-student="${studentKey}"]`);
        let total = 0;
        let maxTotal = 0;

        inputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            const max = parseFloat(input.getAttribute('max')) || 0;
            total += value;
            maxTotal += max;
        });

        const percentage = maxTotal > 0 ? Math.round((total / maxTotal) * 100) : 0;

        // Update total and percentage displays
        const totalElement = document.getElementById(`total_${studentKey}`);
        const percentageElement = document.getElementById(`percentage_${studentKey}`);

        if (totalElement) totalElement.textContent = total;
        if (percentageElement) {
            percentageElement.textContent = `${percentage}%`;

            // Color coding
            if (percentage >= 80) {
                percentageElement.style.color = 'var(--bs-success)';
            } else if (percentage >= 60) {
                percentageElement.style.color = 'var(--bs-warning)';
            } else {
                percentageElement.style.color = 'var(--bs-danger)';
            }
        }
    }

    function clearAllMarks() {
        if (confirm('Are you sure you want to clear all marks? This action cannot be undone.')) {
            document.querySelectorAll('.mobile-mark-input').forEach(input => {
                input.value = '';
            });

            // Clear all percentage displays
            document.querySelectorAll('[id^="percentage_"]').forEach(element => {
                element.textContent = '0%';
                element.style.color = '';
            });

            // Clear all total displays for composite subjects
            document.querySelectorAll('[id^="total_"]').forEach(element => {
                element.textContent = '0';
            });

            showMobileAlert('All marks cleared successfully!', 'info');
        }
    }

    function viewReport(reportId) {
        showMobileAlert(`Opening report ${reportId}...`, 'info');
        // Implement report viewing functionality
    }

    // Initialize grade streams data (if available)
    window.gradeStreams = {{ grades_dict|tojson if grades_dict else '{}' }};

    // Test function for debugging dropdown functionality
    window.testDropdowns = function() {
        console.log('🧪 Testing dropdown functionality...');

        // Check if functions exist
        console.log('updateGradesByEducationLevel exists:', typeof updateGradesByEducationLevel);
        console.log('updateSubjectsByEducationLevel exists:', typeof updateSubjectsByEducationLevel);
        console.log('updateStreams exists:', typeof updateStreams);

        // Test education levels
        const educationLevels = ['lower_primary', 'upper_primary', 'junior_secondary'];

        educationLevels.forEach(level => {
            console.log(`\n📚 Testing ${level}:`);

            // Set education level
            document.getElementById('education_level').value = level;
            updateGradesByEducationLevel();

            // Check grades
            const gradeOptions = Array.from(document.getElementById('grade').options)
                .filter(opt => opt.value !== '')
                .map(opt => opt.textContent);
            console.log(`  Grades: ${gradeOptions.join(', ')}`);

            // Test first grade
            if (gradeOptions.length > 0) {
                const firstGradeOption = document.querySelector('#grade option[value]:not([value=""])');
                if (firstGradeOption) {
                    document.getElementById('grade').value = firstGradeOption.value;
                    console.log(`  Testing grade: ${firstGradeOption.textContent} (ID: ${firstGradeOption.value})`);
                    updateStreams();
                }
            }
        });

        console.log('🧪 Test completed!');
    };

    // Simple test function to check if grade update works
    window.testGradeUpdate = function() {
        console.log('🔧 Testing grade update directly...');
        console.log('Education level element:', document.getElementById('education_level'));
        console.log('Grade element:', document.getElementById('grade'));

        // Set to junior secondary and test
        document.getElementById('education_level').value = 'junior_secondary';
        console.log('Set education level to junior_secondary');

        updateGradesByEducationLevel();

        const gradeOptions = Array.from(document.getElementById('grade').options);
        console.log('Grade options after update:', gradeOptions.map(opt => ({value: opt.value, text: opt.textContent})));
    };

    // Add event listener for education level change (more reliable than inline onchange)
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 DOM loaded, setting up event listeners...');

        const educationLevelSelect = document.getElementById('education_level');
        if (educationLevelSelect) {
            educationLevelSelect.addEventListener('change', function() {
                updateSubjectsByEducationLevel();
                updateGradesByEducationLevel();
            });
        }

        const gradeSelect = document.getElementById('grade');
        if (gradeSelect) {
            gradeSelect.addEventListener('change', function() {
                updateStreams();
            });
        }
    });

    // Open section based on URL hash on load (e.g., #reports-section)
    document.addEventListener('DOMContentLoaded', function() {
    const hash = (window.location && window.location.hash) ? window.location.hash.replace('#', '') : '';
        if (hash) {
            const target = document.getElementById(hash);
            if (target && target.classList.contains('dashboard-section')) {
                showSection(hash);
            }
        }
    });

    // Mobile Education Level bottom-sheet picker (init after DOM ready)
    (function initEducationPickerWhenReady() {
        function init() {
            const btn = document.getElementById('education-picker-button');
            const select = document.getElementById('education_level');
            const backdrop = document.getElementById('education-picker-backdrop');
            const sheet = document.getElementById('education-picker');
            if (!btn || !select || !backdrop || !sheet) return; // Elements may not exist in all views

            // Haptic utility
            window.hapticTap = function() { try { if (navigator.vibrate) navigator.vibrate(10); } catch(_) {} };

            const open = () => {
                backdrop.style.display = 'block';
                sheet.classList.add('open');
                btn.setAttribute('aria-expanded', 'true');
            };
            const close = () => {
                sheet.classList.remove('open');
                backdrop.style.display = 'none';
                btn.setAttribute('aria-expanded', 'false');
            };

            // Expose globals for fallback onclick
            window.openEducationPicker = open;
            window.closeEducationPicker = close;
            btn.addEventListener('click', open);
            backdrop.addEventListener('click', close);
            var cancelBtn = document.getElementById('education-picker-cancel');
            if (cancelBtn) cancelBtn.addEventListener('click', close);
            var doneBtn = document.getElementById('education-picker-done');
            if (doneBtn) doneBtn.addEventListener('click', function(){ window.hapticTap && window.hapticTap(); close(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });

        var optionEls = document.querySelectorAll('[data-education-value]');
            (optionEls && optionEls.forEach ? optionEls : Array.prototype.slice.call(optionEls)).forEach(el => {
                el.addEventListener('click', () => {
                    const value = el.getAttribute('data-education-value');
                    const label = el.getAttribute('data-education-label');
                    select.value = value;
                    // Trigger change for dependent updates
                    const evt = new Event('change', { bubbles: true });
                    select.dispatchEvent(evt);
            // Update trigger label (strip leading emoji/symbols to keep button concise)
            btn.textContent = (label || 'Select Education Level').replace(/^[^A-Za-z0-9]*\s*/, '');
            window.hapticTap && window.hapticTap();
                    close();
                });
            });

            // Sync initial button label with current selection if any
            const selected = select.options[select.selectedIndex];
            if (selected && selected.value) {
                btn.textContent = selected.textContent.replace(/^[^A-Za-z0-9]*\s*/, '');
            }

            // Swipe/drag to close
            (function(){
                let startY = 0, currentY = 0, dragging = false;
                const threshold = 80;
                sheet.addEventListener('touchstart', function(e){
                    if (!sheet.classList.contains('open')) return;
                    dragging = true; startY = e.touches[0].clientY; currentY = startY; sheet.style.transition = 'none';
                }, {passive:true});
                sheet.addEventListener('touchmove', function(e){
                    if (!dragging) return; currentY = e.touches[0].clientY; const dy = Math.max(0, currentY - startY); sheet.style.transform = 'translateY(' + dy + 'px)';
                }, {passive:true});
                sheet.addEventListener('touchend', function(){
                    if (!dragging) return; const dy = Math.max(0, currentY - startY); sheet.style.transition = ''; sheet.style.transform = '';
                    dragging = false; if (dy > threshold) { window.hapticTap && window.hapticTap(); close(); }
                });
            })();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();

    // Generic bottom-sheet picker for Subject/Grade/Term
    (function initGenericPickerWhenReady() {
        function initGeneric() {
            const backdrop = document.getElementById('generic-picker-backdrop');
            const sheet = document.getElementById('generic-picker');
            const optionsBox = document.getElementById('generic-picker-options');
            const titleEl = document.getElementById('generic-picker-title');
            const searchEl = document.getElementById('generic-picker-search');
            const cancelBtn = document.getElementById('generic-picker-cancel');
            if (!backdrop || !sheet || !optionsBox || !titleEl) return;

            let currentTargetSelect = null;
            let currentButton = null;
            let currentType = null; // 'subject' | 'grade' | 'term' | 'assessment' | 'stream'

            function close() {
                sheet.classList.remove('open');
                backdrop.style.display = 'none';
                document.querySelectorAll('.picker-trigger[aria-expanded="true"]').forEach(b=>b.setAttribute('aria-expanded','false'));
                currentTargetSelect = null;
                currentButton = null;
                currentType = null;
                if (searchEl) searchEl.value = '';
            }
            function buildOptions(filterValue) {
                if (!currentTargetSelect) return;
                const q = (filterValue || '').toLowerCase();
                optionsBox.innerHTML = '';
                const opts = Array.prototype.slice.call(currentTargetSelect.options).filter(o => o.value !== '');
                const filtered = q ? opts.filter(o => o.textContent.toLowerCase().indexOf(q) !== -1) : opts;
                // Determine header label and icon based on type
                let headerText = '';
                if (currentType === 'subject') {
                    const lvlSel = document.getElementById('education_level');
                    const lvlOpt = lvlSel ? lvlSel.options[lvlSel.selectedIndex] : null;
                    headerText = lvlOpt && lvlOpt.value ? lvlOpt.textContent.replace(/^[^A-Za-z0-9]*\s*/, '') : 'Subjects';
                } else if (currentType === 'stream') {
                    const gradeSel = document.getElementById('grade');
                    const gradeOpt = gradeSel ? gradeSel.options[gradeSel.selectedIndex] : null;
                    headerText = gradeOpt && gradeOpt.value ? ('Streams • ' + gradeOpt.textContent.replace(/^[^A-Za-z0-9]*\s*/, '')) : 'Streams';
                } else if (currentType === 'grade') { headerText = 'Grades'; }
                else if (currentType === 'term') { headerText = 'Terms'; }
                else if (currentType === 'assessment') { headerText = 'Assessment Types'; }

                if (headerText) {
                    const hdr = document.createElement('div');
                    hdr.className = 'mobile-sheet-group-header';
                    hdr.textContent = headerText;
                    optionsBox.appendChild(hdr);
                }
                // For subjects, insert sticky alphabetical headers
                let prevAlpha = '';
                if (filtered.length === 0) {
                    const empty = document.createElement('div');
                    empty.textContent = 'No matches';
                    empty.style.padding = '.5rem 0';
                    optionsBox.appendChild(empty);
                    return;
                }
                filtered.forEach(o => {
                    const b = document.createElement('button');
                    b.type = 'button';
                    b.className = 'mobile-sheet-option';
                    const icon = (function(){
                        switch(currentType){
                            case 'subject': return '📖';
                            case 'grade': return '🎓';
                            case 'term': return '📅';
                            case 'assessment': return '📝';
                            case 'stream': return '👥';
                            default: return '•';
                        }
                    })();
                    const label = o.textContent.replace(/^[^A-Za-z0-9]*\s*/, '');
                    if (currentType === 'subject') {
                        const m = label.match(/[A-Za-z]/);
                        const alpha = m ? m[0].toUpperCase() : '#';
                        if (alpha !== prevAlpha) {
                            const a = document.createElement('div');
                            a.className = 'mobile-sheet-alpha';
                            a.textContent = alpha;
                            optionsBox.appendChild(a);
                            prevAlpha = alpha;
                        }
                    }
                    b.innerHTML = '<span class="option-left"><span class="option-icon">'+icon+'</span><span>'+label+'</span></span>';
                    b.addEventListener('click', function(){
                        currentTargetSelect.value = o.value;
                        const evt = new Event('change', { bubbles: true });
                        currentTargetSelect.dispatchEvent(evt);
                        if (currentButton) currentButton.textContent = label;
                        window.hapticTap && window.hapticTap();
                        close();
                    });
                    optionsBox.appendChild(b);
                });
            }

            function open(btn, targetSelect, title, type) {
                titleEl.textContent = title || 'Select';
                currentTargetSelect = targetSelect;
                currentButton = btn;
                currentType = type || null;
                buildOptions('');
                backdrop.style.display = 'block';
                sheet.classList.add('open');
                btn.setAttribute('aria-expanded','true');
                if (searchEl) setTimeout(() => searchEl.focus(), 50);
            }

            backdrop.addEventListener('click', close);
            if (cancelBtn) cancelBtn.addEventListener('click', close);
            const doneBtn = document.getElementById('generic-picker-done');
            if (doneBtn) doneBtn.addEventListener('click', function(){ window.hapticTap && window.hapticTap(); close(); });
            document.addEventListener('keydown', function(e){ if(e.key==='Escape') close(); });
            if (searchEl) {
                searchEl.addEventListener('input', function(){ buildOptions(searchEl.value || ''); });
            }

            // Swipe/drag to close gesture
            (function(){
                let startY = 0, currentY = 0, dragging = false;
                const threshold = 80;
                sheet.addEventListener('touchstart', function(e){
                    if (!sheet.classList.contains('open')) return;
                    dragging = true; startY = e.touches[0].clientY; currentY = startY; sheet.style.transition = 'none';
                }, {passive:true});
                sheet.addEventListener('touchmove', function(e){
                    if (!dragging) return; currentY = e.touches[0].clientY; const dy = Math.max(0, currentY - startY); sheet.style.transform = 'translateY(' + dy + 'px)';
                }, {passive:true});
                sheet.addEventListener('touchend', function(){
                    if (!dragging) return; const dy = Math.max(0, currentY - startY); sheet.style.transition = ''; sheet.style.transform = '';
                    dragging = false; if (dy > threshold) { window.hapticTap && window.hapticTap(); close(); }
                });
            })();

            function syncLabel(selectEl, btnEl, placeholder) {
                if (!selectEl || !btnEl) return;
                var opt = selectEl.options[selectEl.selectedIndex];
                if (opt && opt.value) {
                    btnEl.textContent = opt.textContent.replace(/^[^A-Za-z0-9]*\s*/, '');
                } else {
                    btnEl.textContent = placeholder;
                }
            }

            function wire(btnId, selectId, title, type) {
                const btn = document.getElementById(btnId);
                const sel = document.getElementById(selectId);
                if (!btn || !sel) return;
                btn.addEventListener('click', function(){ open(btn, sel, title, type); });
                // Expose global openPickerFor
                window.openPickerFor = function(which){
                    var map = {
                        subject: ['subject-picker-button','subject','Select Subject','subject'],
                        grade: ['grade-picker-button','grade','Select Grade','grade'],
                        term: ['term-picker-button','term','Select Term','term'],
                        assessment: ['assessment-picker-button','assessment_type','Select Assessment Type','assessment'],
                        stream: ['stream-picker-button','stream','Select Stream','stream']
                    };
                    var conf = map[which];
                    if (!conf) return;
                    var b = document.getElementById(conf[0]);
                    var s = document.getElementById(conf[1]);
                    if (b && s) open(b, s, conf[2], conf[3]);
                };
                // Sync initial label and on change
                syncLabel(sel, btn, title);
                sel.addEventListener('change', function(){ syncLabel(sel, btn, title); });
            }

            wire('subject-picker-button','subject','Select Subject','subject');
            wire('grade-picker-button','grade','Select Grade','grade');
            wire('term-picker-button','term','Select Term','term');
            wire('assessment-picker-button','assessment_type','Select Assessment Type','assessment');
            wire('stream-picker-button','stream','Select Stream','stream');
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGeneric);
        } else { initGeneric(); }
    })();

    // Mobile-specific functions
    function saveStudentMark(studentId) {
        const input = document.querySelector(`input[data-student="${studentId}"]`);
        const mark = input.value;

        if (!mark || mark === '') {
            showMobileAlert('Please enter a mark before saving.', 'warning');
            return;
        }

        const maxMark = parseInt(input.getAttribute('max'));
        if (parseInt(mark) > maxMark) {
            showMobileAlert(`Mark cannot exceed ${maxMark}.`, 'danger');
            return;
        }

        // Show loading state
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;

        // Simulate API call (replace with actual implementation)
        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.classList.remove('mobile-btn-success');
            button.classList.add('mobile-btn-success');

            showMobileAlert(`Mark ${mark} saved for student ${studentId}!`, 'success');

            // Reset button after 2 seconds
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
            }, 2000);
        }, 1000);
    }

    // Subject Report History (mobile)
    async function initMobileReportHistory() {
        const container = document.getElementById('mobile-report-history');
        if (!container) return;

        const filters = {
            subject: document.getElementById('m-filter-subject'),
            grade: document.getElementById('m-filter-grade'),
            stream: document.getElementById('m-filter-stream'),
            term: document.getElementById('m-filter-term'),
            assessment_type: document.getElementById('m-filter-assessment')
        };

        const reload = async () => {
            const params = new URLSearchParams();
            for (const [k, el] of Object.entries(filters)) {
                if (el && el.value) params.set(k, el.value);
            }
            container.setAttribute('aria-busy', 'true');
            container.innerHTML = '<div style="padding:0.75rem;">Loading...</div>';
            try {
                const res = await fetch(`/teacher/api/report-history?${params.toString()}`);
                const data = await res.json();
                renderMobileHistory(container, data);
            } catch (e) {
                container.innerHTML = '<div class="mobile-empty-state"><div class="mobile-empty-icon"><i class="fas fa-exclamation-triangle"></i></div><h3>Error</h3><p>Could not load history.</p></div>';
            } finally {
                container.removeAttribute('aria-busy');
            }
        };

        for (const el of Object.values(filters)) {
            if (el) el.addEventListener('change', reload);
        }

        // Clear filters button
        const clearBtn = document.getElementById('m-filters-clear');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                Object.values(filters).forEach(el => { if (el) el.value = ''; });
                reload();
            });
        }

        await reload();
    }

    function renderMobileHistory(container, data) {
        if (!data || !data.success) {
            container.innerHTML = '<div class="mobile-empty-state"><div class="mobile-empty-icon"><i class="fas fa-history"></i></div><h3>No History</h3><p>Generate a subject report to see it here.</p></div>';
            return;
        }

        if (!data.items || data.items.length === 0) {
            container.innerHTML = '<div class="mobile-empty-state"><div class="mobile-empty-icon"><i class="fas fa-filter"></i></div><h3>No Matches</h3><p>Try changing the filters.</p></div>';
            return;
        }

        const header = `
            <table class="mobile-table">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Grade</th>
                        <th>Stream</th>
                        <th>Term</th>
                        <th>Assess.</th>
                        <th>Avg</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>`;

        const rows = data.items.map(e => `
            <tr>
                <td><strong>${e.subject}</strong></td>
                <td><span class="mobile-badge mobile-badge-primary">${e.grade}</span></td>
                <td><span class="mobile-badge mobile-badge-info">${e.stream || '-'}</span></td>
                <td><span class="mobile-badge mobile-badge-secondary">${e.term}</span></td>
                <td><span class="mobile-badge mobile-badge-warning">${e.assessment_type}</span></td>
                <td><span class="mobile-badge mobile-badge-success">${(e.class_average ?? 0)}%</span></td>
                <td>
                    <a href="${e.view_url || '#'}" target="_blank" class="mobile-btn mobile-btn-sm mobile-btn-primary">Open</a>
                </td>
            </tr>`).join('');

        const footer = '</tbody></table>';
        container.innerHTML = header + rows + footer;
    }

    function viewStudentHistory(studentId) {
        showMobileAlert(`Viewing history for student ${studentId}`, 'info');
        // Implement student history view
    }

    function showMobileAlert(message, type = 'info') {
        // Create mobile-friendly alert
        const alertDiv = document.createElement('div');
        alertDiv.className = `mobile-alert mobile-alert-${type}`;
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'times-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            ${message}
        `;

        // Insert at top of content
        const container = document.querySelector('.mobile-container');
        container.insertBefore(alertDiv, container.firstChild);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            alertDiv.style.opacity = '0';
            alertDiv.style.transform = 'translateY(-20px)';
            setTimeout(() => alertDiv.remove(), 300);
        }, 5000);
    }

    // Touch-friendly interactions
    document.addEventListener('DOMContentLoaded', function() {
        // Add touch feedback to buttons
        document.querySelectorAll('.mobile-btn').forEach(button => {
            button.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.95)';
            });

            button.addEventListener('touchend', function() {
                this.style.transform = 'scale(1)';
            });
        });

        // Add swipe indicator for tables on mobile
        if (window.innerWidth <= 768) {
            const tables = document.querySelectorAll('.mobile-table-container');
            tables.forEach(table => {
                let isScrolling = false;

                table.addEventListener('scroll', function() {
                    if (!isScrolling) {
                        isScrolling = true;
                        this.classList.add('scrolling');

                        setTimeout(() => {
                            isScrolling = false;
                            this.classList.remove('scrolling');
                        }, 1000);
                    }
                });
            });
        }

        // Auto-focus on form inputs when section becomes active
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    const target = mutation.target;
                    if (target.classList.contains('active') && target.classList.contains('dashboard-section')) {
                        const firstInput = target.querySelector('input, select');
                        if (firstInput && window.innerWidth > 768) {
                            setTimeout(() => firstInput.focus(), 300);
                        }
                    }
                }
            });
        });

        document.querySelectorAll('.dashboard-section').forEach(section => {
            observer.observe(section, { attributes: true });
        });
    });
</script>
{% endblock %}
