{% extends "modern_base.html" %} {% block title %}Academic Performance Analytics
- Class Teacher{% endblock %} {% block meta_description %}Class Teacher Academic
Analytics - Performance insights for your assigned classes at {{
school_info.school_name or 'Hillview School' }}{% endblock %} {% block
page_title %}Class Academic Analytics{% endblock %} {% block page_subtitle %}
<p class="text-lg">Performance insights for your assigned classes</p>
{% endblock %} {% block body_class %}analytics-page{% endblock %} {% block
extra_css %}
<!-- Solar Theme Analytics Premium Styling -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/solar_analytics_premium.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/variables.css') }}"
/>

<!-- NUCLEAR OPTION - Inline styles to override base template -->
<style>
  /* Kill all purple and white backgrounds with maximum specificity */
  html,
  body,
  html *,
  body *,
  .page-container,
  .content-wrapper,
  .analytics-filters-section,
  .detailed-performance,
  .top-performers,
  .performance-breakdown,
  .modern-grid,
  .insights-grid,
  .insight-card,
  div[class*="card"],
  div[class*="section"],
  div[class*="panel"],
  div[class*="container"] {
    background: #002b36 !important;
    background-color: #002b36 !important;
    background-image: none !important;
    color: #fdf6e3 !important;
  }

  /* Force dark theme on all containers */
  .analytics-page .analytics-filters-section,
  .analytics-page .detailed-performance,
  .analytics-page .top-performers,
  .analytics-page .performance-breakdown {
    background: rgba(0, 43, 54, 0.9) !important;
    border: 1px solid rgba(253, 246, 227, 0.1) !important;
    border-radius: 0.75rem !important;
    padding: 1.5rem !important;
    backdrop-filter: blur(10px) !important;
  }

  /* Insight cards must be dark */
  .insight-card {
    background: rgba(0, 43, 54, 0.95) !important;
    border: 1px solid rgba(253, 246, 227, 0.1) !important;
    color: #fdf6e3 !important;
  }

  /* Notification animations */
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Loading state improvements */
  .loading-state {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: #fdf6e3;
    font-size: 16px;
  }

  .loading-state i {
    margin-right: 10px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Error state improvements */
  .error-state {
    background: rgba(220, 53, 69, 0.1) !important;
    border: 1px solid rgba(220, 53, 69, 0.3) !important;
    border-radius: 8px;
    margin: 20px 0;
  }
</style>

{% endblock %} {% block content %}
<div class="container">
  <!-- Breadcrumb Navigation -->
  <div class="breadcrumb">
    <a href="{{ url_for('classteacher.dashboard') }}">
      <i class="fas fa-home"></i> Dashboard
    </a>
    <span class="breadcrumb-separator">/</span>
    <span>Academic Performance Analytics</span>
  </div>

  <!-- Page Header -->
  <div class="analytics-page-header">
    <h1><i class="fas fa-chart-line"></i> Academic Performance Analytics</h1>
    <p>
      Comprehensive insights into student performance and subject analytics for
      your assigned classes
    </p>
  </div>

  <!-- Quick Insights Summary -->
  <div class="quick-insights">
    <h3><i class="fas fa-tachometer-alt"></i> Quick Insights</h3>
    <div class="insights-grid">
      <div class="insight-card">
        <div class="insight-value" id="total-students-analyzed">
          {{ analytics_data.summary.students_analyzed or 0 }}
        </div>
        <div class="insight-label">Students Analyzed</div>
      </div>
      <div class="insight-card">
        <div class="insight-value" id="total-subjects-analyzed">
          {{ analytics_data.summary.subjects_analyzed or 0 }}
        </div>
        <div class="insight-label">Subjects Analyzed</div>
      </div>
      <div class="insight-card">
        <div class="insight-value" id="top-subject-performance">
          {{ analytics_data.summary.best_subject_average or 0 }}%
        </div>
        <div class="insight-label">Best Subject Average</div>
      </div>
      <div class="insight-card">
        <div class="insight-value" id="top-student-performance">
          {{ analytics_data.summary.top_student_average or 0 }}%
        </div>
        <div class="insight-label">Top Student Average</div>
      </div>
    </div>
  </div>

  <!-- Analytics Filters -->
  <div class="analytics-filters-section">
    <div class="analytics-actions">
      <h2><i class="fas fa-filter"></i> Analytics Filters</h2>
      <div class="action-buttons">
        <button
          class="modern-btn btn-outline btn-sm"
          onclick="resetAnalyticsFilters()"
        >
          <i class="fas fa-undo"></i> Reset Filters
        </button>
        <button
          class="modern-btn btn-primary btn-sm"
          onclick="refreshAnalyticsData()"
        >
          <i class="fas fa-sync-alt"></i> Refresh Data
        </button>
      </div>
    </div>

    <div class="modern-grid grid-cols-4">
      <div class="form-group">
        <label class="form-label">Term</label>
        <select
          id="analytics-term-filter"
          class="form-select"
          onchange="updateAnalytics()"
        >
          <option value="">All Terms</option>
          {% for term in terms %}
          <option value="{{ term }}" {% if request.args.get('term') == term %}selected{% endif %}>
            {{ term }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Assessment Type</label>
        <select
          id="analytics-assessment-filter"
          class="form-select"
          onchange="updateAnalytics()"
        >
          <option value="">All Assessments</option>
          {% for assessment in assessment_types %}
          <option value="{{ assessment }}" {% if request.args.get('assessment_type') == assessment %}selected{% endif %}>
            {{ assessment }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div
        class="form-group"
        id="analytics-grade-filter-group"
        style="display: none"
      >
        <label class="form-label">Grade</label>
        <select
          id="analytics-grade-filter"
          class="form-select"
          onchange="updateAnalytics()"
        >
          <option value="">All Grades</option>
          <!-- Grades will be populated by JavaScript -->
        </select>
      </div>

      <div
        class="form-group"
        id="analytics-stream-filter-group"
        style="display: none"
      >
        <label class="form-label">Stream</label>
        <select
          id="analytics-stream-filter"
          class="form-select"
          onchange="updateAnalytics()"
        >
          <option value="">All Streams</option>
          <!-- Streams will be populated by JavaScript -->
        </select>
      </div>
    </div>
  </div>

  <!-- Main Analytics Content -->
  <div class="analytics-content-grid">
    <!-- Top Performers Component -->
    <div class="analytics-component top-performers-component">
      <div class="component-header">
        <h3><i class="fas fa-trophy"></i> Top Performing Students</h3>
        <div class="component-actions">
          <button
            class="modern-btn btn-sm btn-outline"
            onclick="refreshAnalytics('top_performers')"
          >
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>

      <div class="component-content">
        <div id="top-performers-container">
          {% if analytics_data.has_data and analytics_data.top_students %}
          <div class="top-performers-list">
            {% for student in analytics_data.top_students[:5] %}
            <div class="performer-item">
              <div class="performer-rank">{{ loop.index }}</div>
              <div class="performer-info">
                <div class="performer-name">{{ student.name }}</div>
                <div class="performer-details">
                  {{ student.grade }} {{ student.stream }} • {{
                  student.subjects_count }} subjects
                </div>
              </div>
              <div class="performer-score">{{ student.average }}%</div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="no-data-message">
            <i class="fas fa-users"></i>
            <p>
              No student performance data available for your assigned classes.
            </p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Subject Performance Component -->
    <div class="analytics-component subject-performance-component">
      <div class="component-header">
        <h3><i class="fas fa-chart-bar"></i> Subject Performance Analysis</h3>
        <div class="component-actions">
          <button
            class="modern-btn btn-sm btn-outline"
            onclick="refreshAnalytics('subject_performance')"
          >
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>

      <div class="component-content">
        <div id="subject-performance-container">
          {% if analytics_data.has_data and analytics_data.subject_performance
          %}
          <div class="subject-performance-grid">
            {% for subject in analytics_data.subject_performance[:6] %}
            <div class="subject-item">
              <div class="subject-header">
                <div class="subject-name">{{ subject.name }}</div>
                <div class="subject-performance">{{ subject.average }}%</div>
              </div>
              <div class="subject-details">
                {{ subject.students_count }} students • {{ subject.total_marks
                }} marks
              </div>
              <div
                class="subject-status {% if subject.average >= 80 %}status-exceeding {% elif subject.average >= 65 %}status-meeting {% elif subject.average >= 50 %}status-approaching {% else %}status-below{% endif %}"
              >
                {% if subject.average >= 80 %}Exceeding Expectation {% elif
                subject.average >= 65 %}Meeting Expectation {% elif
                subject.average >= 50 %}Approaching Expectation {% else %}Below
                Expectation{% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="no-data-message">
            <i class="fas fa-chart-bar"></i>
            <p>
              No subject performance data available for your assigned classes.
            </p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Analytics Section -->
  <div class="analytics-component analytics-full-width">
    <div class="component-header">
      <h3><i class="fas fa-chart-pie"></i> Detailed Performance Breakdown</h3>
      <div class="component-actions">
        <button
          class="modern-btn btn-sm btn-outline"
          onclick="exportAnalytics()"
        >
          <i class="fas fa-download"></i> Export Data
        </button>
      </div>
    </div>

    <div class="component-content">
      <div id="detailed-analytics-container">
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i> Loading detailed analytics...
        </div>
      </div>
    </div>
  </div>

  <!-- No Data State -->
  <div id="no-data-state" class="no-data-state" style="display: none">
    <div class="no-data-icon">
      <i class="fas fa-chart-line"></i>
    </div>
    <h3>No Analytics Data Available</h3>
    <p>
      There isn't enough data to generate meaningful analytics for your assigned
      classes.
    </p>
    <div class="no-data-suggestions">
      <h4>Suggestions:</h4>
      <ul>
        <li>Ensure marks have been uploaded for your students</li>
        <li>Try selecting a different term or assessment type</li>
        <li>Check that students are properly assigned to your classes</li>
        <li>
          Contact the headteacher if you need additional class assignments
        </li>
      </ul>
    </div>
    <div style="margin-top: var(--space-4)">
      <button class="modern-btn btn-primary" onclick="resetAnalyticsFilters()">
        <i class="fas fa-undo"></i> Reset Filters
      </button>
      <a
        href="{{ url_for('classteacher.dashboard') }}"
        class="modern-btn btn-outline"
        style="margin-left: var(--space-2)"
      >
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
  </div>
</div>

<!-- Include Analytics Components Styles -->
{% include 'analytics_dashboard_components.html' %}

<!-- Enhanced Analytics Styles -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/enhanced_analytics.css') }}"
/>

{% endblock %} {% block extra_js %}
<!-- Analytics Dashboard JavaScript -->
<script src="{{ url_for('static', filename='js/analytics_dashboard.js') }}"></script>

<script>
  // Page-specific analytics functions
  function exportAnalytics() {
    // TODO: Implement analytics export functionality
    showNotification("Export functionality coming soon!", "info");
  }

  function refreshAnalyticsData() {
    loadAnalyticsData();
  }

  // Update analytics based on filter changes
  function updateAnalytics() {
    const termFilter = document.getElementById('analytics-term-filter').value;
    const assessmentFilter = document.getElementById('analytics-assessment-filter').value;
    const gradeFilter = document.getElementById('analytics-grade-filter')?.value || '';
    const streamFilter = document.getElementById('analytics-stream-filter')?.value || '';

    // Build URL with filters
    const params = new URLSearchParams();
    if (termFilter) params.append('term', termFilter);
    if (assessmentFilter) params.append('assessment_type', assessmentFilter);
    if (gradeFilter) params.append('grade', gradeFilter);
    if (streamFilter) params.append('stream', streamFilter);

    // Reload page with filters
    const baseUrl = window.location.pathname;
    const newUrl = params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;
    
    // Show loading indication
    showNotification('Updating analytics...', 'info');
    
    // Navigate to filtered URL
    window.location.href = newUrl;
  }

  // Reset filters function
  function resetAnalyticsFilters() {
    // Clear all filter dropdowns
    document.getElementById('analytics-term-filter').value = '';
    document.getElementById('analytics-assessment-filter').value = '';
    if (document.getElementById('analytics-grade-filter')) {
      document.getElementById('analytics-grade-filter').value = '';
    }
    if (document.getElementById('analytics-stream-filter')) {
      document.getElementById('analytics-stream-filter').value = '';
    }
    
    // Reload page without filters
    window.location.href = window.location.pathname;
  }

  // Delete report function for analytics (only for headteachers)
  function deleteReportFromAnalytics(grade, stream, term, assessmentType) {
    // Check if user is headteacher
    const isHeadteacher = {{ 'true' if session.get('headteacher_universal_access') or session.get('role') == 'headteacher' else 'false' }};

    if (!isHeadteacher) {
      showNotification("Only headteachers can delete reports from analytics.", "error");
      return;
    }

    if (!confirm(`Are you sure you want to delete the report for ${grade} ${stream} in ${term} ${assessmentType}? This will delete all associated marks and cannot be undone.`)) {
      return;
    }

    // Show loading state
    showNotification("Deleting report...", "info");

    // Create form data
    const formData = new FormData();
    formData.append('grade', grade);
    formData.append('stream', stream);
    formData.append('term', term);
    formData.append('assessment_type', assessmentType);

    // Send delete request
    fetch('/api/analytics/delete_report', {
      method: 'POST',
      body: formData,
      credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(data.message, "success");
        // Refresh analytics data
        loadAnalyticsData();
      } else {
        showNotification(data.message, "error");
      }
    })
    .catch(error => {
      console.error('Error deleting report:', error);
      showNotification("Error deleting report. Please try again.", "error");
    });
  }

  // Set headteacher flag for delete buttons
  window.isHeadteacher = {{ 'true' if session.get('headteacher_universal_access') or session.get('role') == 'headteacher' else 'false' }};

  // Initialize analytics when page loads
  document.addEventListener("DOMContentLoaded", function () {
    console.log("Classteacher analytics page - initializing dashboard");
    // The analytics dashboard will be initialized by the main analytics_dashboard.js file
    // which now checks for analytics page elements before initializing
  });

  // Utility function for notifications
  function showNotification(message, type = "info") {
    // Create notification element
    const notification = document.createElement("div");
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
            <i class="fas fa-info-circle"></i>
            <span>${message}</span>
        `;

    // Add to page
    document.body.appendChild(notification);

    // Auto-remove after 3 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 3000);
  }
</script>

<style>
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--primary-color);
    color: white;
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-md);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: var(--space-2);
    animation: slideIn 0.3s ease-out;
  }

  .notification-info {
    background: var(--blue-500);
  }

  .notification-success {
    background: var(--green-500);
  }

  .notification-warning {
    background: var(--orange-500);
  }

  .notification-error {
    background: var(--red-500);
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Analytics Data Display Styles */
  .top-performers-list,
  .subject-performance-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .performer-item,
  .subject-item {
    display: flex;
    align-items: center;
    padding: var(--space-3);
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-md);
    transition: all 0.3s ease;
  }

  .performer-item:hover,
  .subject-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
  }

  .performer-rank {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    font-weight: bold;
    margin-right: var(--space-3);
  }

  .performer-info,
  .subject-info {
    flex: 1;
  }

  .performer-name,
  .subject-name {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-1);
  }

  .performer-details,
  .subject-details {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .performer-score,
  .subject-score {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--primary-color);
    margin-right: var(--space-3);
  }

  .subject-trend {
    font-size: 0.9rem;
  }

  .trend-excellent {
    color: var(--green-500);
  }

  .trend-good {
    color: var(--blue-500);
  }

  .trend-needs-improvement {
    color: var(--orange-500);
  }

  .no-data-message {
    text-align: center;
    padding: var(--space-6);
    color: var(--text-secondary);
  }

  .no-data-message i {
    font-size: 3rem;
    margin-bottom: var(--space-3);
    opacity: 0.5;
  }
</style>
{% endblock %} when i o
