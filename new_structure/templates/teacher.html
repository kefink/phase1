<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teacher Dashboard - Kirima Primary School</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Performance indicator styles */
        .percentage-cell {
            font-weight: bold;
            padding: 5px;
            border-radius: 3px;
            text-align: center;
        }

        .percentage-cell.excellent {
            background-color: #d4edda;
            color: #155724;
        }

        .percentage-cell.good {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .percentage-cell.average {
            background-color: #fff3cd;
            color: #856404;
        }

        .percentage-cell.below-average {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Composite subject styles from classteacher */
        .composite-subject-entry-improved {
            width: 100%;
            padding: 5px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .composite-components-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            width: 100%;
        }

        .component-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #ffffff;
            border-radius: 6px;
            padding: 8px;
            border: 2px solid #2196f3;
            margin: 2px;
            min-height: 80px;
            justify-content: space-between;
        }

        .component-column.overall-column {
            background-color: #f0f8ff;
            border-color: #1976d2;
            font-weight: bold;
        }

        .mark-input-container {
            width: 100%;
            margin-bottom: 8px;
        }

        .component-mark {
            width: 100%;
            padding: 8px;
            border: 2px solid #2196f3;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            background-color: #ffffff;
            transition: border-color 0.3s ease;
        }

        .component-mark:focus {
            border-color: #1976d2;
            outline: none;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }

        .component-percentage {
            font-size: 13px;
            color: #1976d2;
            font-weight: bold;
            background-color: #e3f2fd;
            padding: 3px 6px;
            border-radius: 3px;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .overall-percentage {
            font-size: 16px;
            color: #1976d2;
            font-weight: bold;
            background-color: #e3f2fd;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #2196f3;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .component-label {
            font-size: 12px;
            font-weight: bold;
            color: #1976d2;
            text-align: center;
            margin-bottom: 5px;
            padding: 3px 6px;
            background-color: #e3f2fd;
            border-radius: 3px;
            border: 1px solid #2196f3;
        }

        /* Composite Configuration Section Styles */
        .composite-config-section {
            background-color: #f0f8ff;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.1);
        }

        .composite-config-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .composite-config-header h4 {
            color: #1976d2;
            margin: 0 0 5px 0;
            font-size: 16px;
        }

        .composite-config-header p {
            color: #666;
            margin: 0;
            font-size: 14px;
        }

        .component-config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            align-items: end;
        }

        .component-config-item {
            display: flex;
            flex-direction: column;
        }

        .component-config-item label {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .component-config-item input {
            padding: 8px;
            border: 2px solid #2196f3;
            border-radius: 4px;
            font-size: 16px;
            text-align: center;
            background-color: white;
        }

        .component-config-item input:focus {
            border-color: #1976d2;
            outline: none;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }

        .component-config-item.total-display {
            text-align: center;
        }

        .total-marks-display {
            background-color: #2196f3;
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .simplified-mark-entry {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .mark-percentage {
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }

        .component-headers {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 5px;
            font-size: 11px;
            font-weight: normal;
        }

        .component-header-item {
            text-align: center;
            padding: 2px;
            background-color: #e9ecef;
            border-radius: 3px;
        }

        .component-header-item.overall-header {
            background-color: #dee2e6;
            font-weight: bold;
        }

        .table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
        }

        .table-wrapper table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .table-wrapper th,
        .table-wrapper td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }

        .table-wrapper th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .composite-subject-header {
            background-color: #2196f3 !important;
            color: white !important;
            font-weight: bold;
        }

        .component-headers {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 8px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .component-header-item {
            text-align: center;
            padding: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .component-header-item.overall-header {
            background-color: rgba(255, 255, 255, 0.3);
            font-weight: bold;
        }

        .class-average {
            font-size: 1.1em;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }

        .class-average.excellent {
            background-color: #d4edda;
            color: #155724;
        }

        .class-average.good {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .class-average.average {
            background-color: #fff3cd;
            color: #856404;
        }

        .class-average.below-average {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Input validation styles */
        input[type="number"]:invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        input[type="number"]:valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        /* Table styling improvements */
        table {
            margin-top: 20px;
        }

        table th, table td {
            padding: 12px;
            text-align: center;
        }

        table tfoot td {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        /* Subject information styling */
        .subject-info {
            margin-top: 8px;
            padding: 10px;
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .subject-info strong {
            color: #1976d2;
        }

        .subject-info br {
            margin-bottom: 4px;
        }

        /* Composite subject styling */
        .composite-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .composite-info h4 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }

        .composite-info p {
            margin: 0;
            opacity: 0.9;
        }

        .subject-type-info {
            margin-bottom: 15px;
        }

        /* Component input styling */
        .component-input-cell {
            text-align: center;
            padding: 8px;
        }

        .component-input-cell input {
            width: 80px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            font-size: 14px;
        }

        .component-input-cell input:focus {
            border-color: #2196f3;
            outline: none;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }

        /* Clean composite subject entry styling */
        .composite-subject-entry-clean {
            width: 100%;
            padding: 10px;
        }

        .composite-components-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            align-items: center;
            justify-items: center;
        }

        .composite-components-row .component-input-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            min-width: 100px;
        }

        .composite-components-row .component-input-cell input {
            width: 70px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            background: white;
        }

        .composite-components-row .component-input-cell input:focus {
            border-color: #4a90e2;
            outline: none;
            box-shadow: 0 0 5px rgba(74, 144, 226, 0.3);
        }

        .composite-components-row .component-percentage {
            font-size: 12px;
            font-weight: bold;
            color: #4a90e2;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            min-width: 45px;
            text-align: center;
        }

        .composite-components-row .overall-cell {
            background: linear-gradient(135deg, #e8f4fd, #d1ecf1);
            border: 2px solid #4a90e2;
            padding: 15px;
            border-radius: 8px;
        }

        .composite-components-row .overall-percentage {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #4a90e2;
            min-width: 60px;
        }

        /* Enhanced Subject Report Styling */
        .enhanced-subject-report-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #4a90e2;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.15);
        }

        .subject-report-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .subject-report-header h3 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .report-details-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .report-detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .detail-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 16px;
            color: #2c3e50;
            font-weight: bold;
            background: #e8f4fd;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #4a90e2;
        }

        .subject-report-actions {
            text-align: center;
        }

        .enhanced-report-btn {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .enhanced-report-btn:hover {
            background: linear-gradient(135deg, #357abd, #2c5aa0);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
            color: white;
            text-decoration: none;
        }

        .report-description {
            color: #6c757d;
            font-size: 14px;
            margin-top: 15px;
            line-height: 1.5;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Enhanced marks table */
        #marks-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #marks-table th {
            background-color: #f5f5f5;
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            font-weight: bold;
        }

        #marks-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }

        #marks-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        #marks-table tr:hover {
            background-color: #f0f8ff;
        }
    </style>
</head>
<body>
    <!-- Error Message Section -->
    {% if error_message %}
    <div class="alert alert-danger" style="background-color: #f8d7da; color: #721c24; padding: 10px; margin: 10px 0; border-radius: 5px;">
        <strong>Error:</strong> {{ error_message }}
    </div>
    {% endif %}

    <nav class="navbar">
        <a href="#" class="navbar-brand">Kirima Primary School</a>
        <ul class="navbar-nav">
            <li class="nav-item"><a href="{{ url_for('teacher.dashboard') }}" class="nav-link">Dashboard</a></li>
            <li class="nav-item"><a href="{{ url_for('auth.logout_route') }}" class="logout-btn">Logout</a></li>
        </ul>
    </nav>

    <div class="container" style="max-width: 90%; margin-top: 80px;">
        <h1 class="text-center mb-4">Teacher Dashboard</h1>

        <!-- Debug Panel -->
        <div id="debug-panel" class="dashboard-card" style="background-color: #f8f9fa; border: 2px solid #007bff; margin-bottom: 20px; display: none;">
            <div class="card-header" style="background-color: #007bff; color: white;">
                <span>🔧 Debug Information</span>
                <button onclick="toggleDebug()" style="float: right; background: none; border: none; color: white;">Hide</button>
            </div>
            <div id="debug-content" style="padding: 15px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
                <div id="debug-messages"></div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <span>Upload Class Marks</span>
                <small>Complete all fields to process marks</small>
                <button onclick="toggleDebug()" style="float: right; background: none; border: none; color: #007bff; text-decoration: underline;">Show Debug</button>
            </div>

            {% if error_message %}
            <div class="alert alert-danger" style="background-color: #f8d7da; color: #721c24; padding: 10px; margin: 10px 0; border-radius: 5px;">
                <strong>Error:</strong> {{ error_message }}
                <br><br>
                <a href="{{ url_for('teacher.reset_form') }}" class="btn" style="background-color: #dc3545; color: white; margin-top: 10px;">
                    🔄 Reset Form
                </a>
            </div>
            {% endif %}

            {% if not show_students %}
            <!-- Enhanced form with education level filtering -->
            <form id="upload-form" method="POST" action="{{ url_for('teacher.dashboard') }}" class="login-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <!-- Education Level Selection -->
                <div class="form-group">
                    <label for="education_level">Education Level</label>
                    <select id="education_level" name="education_level" required onchange="updateSubjectsByEducationLevel()">
                        <option value="">Select Education Level</option>
                        <option value="lower_primary" {% if education_level == 'lower_primary' %}selected{% endif %}>Lower Primary (Grades 1-3)</option>
                        <option value="upper_primary" {% if education_level == 'upper_primary' %}selected{% endif %}>Upper Primary (Grades 4-6)</option>
                        <option value="junior_secondary" {% if education_level == 'junior_secondary' %}selected{% endif %}>Junior Secondary (Grades 7-9)</option>
                    </select>
                </div>

                <!-- Subject Selection (filtered by education level) -->
                <div class="form-group">
                    <label for="subject">Subject</label>
                    <select id="subject" name="subject" required onchange="handleSubjectSelection()">
                        <option value="">Select Subject</option>
                        <!-- Subjects will be populated based on education level -->
                    </select>
                    <div id="subject-info" class="subject-info" style="display: none;">
                        <small id="subject-details"></small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="term">Term</label>
                    <select id="term" name="term" required>
                        <option value="">Select Term</option>
                        {% for term_option in terms %}
                        <option value="{{ term_option }}" {% if term == term_option %}selected{% endif %}>{{ term_option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="assessment_type">Assessment Type</label>
                    <select id="assessment_type" name="assessment_type" required>
                        <option value="">Select Assessment Type</option>
                        {% for assessment_option in assessment_types %}
                        <option value="{{ assessment_option }}" {% if assessment_type == assessment_option %}selected{% endif %}>{{ assessment_option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" id="total-marks-group">
                    <label for="total_marks">Total Marks (Out Of)</label>
                    <input type="number" id="total_marks" name="total_marks" min="1" value="{{ total_marks if total_marks else '' }}" required>
                </div>

                <!-- Composite Subject Configuration (shown only for English/Kiswahili) -->
                <div id="composite-config" class="composite-config-section" style="display: none;">
                    <div class="composite-config-header">
                        <h4>📚 Composite Subject Configuration</h4>
                        <p>Set maximum marks for each component:</p>
                    </div>

                    <div id="english-config" class="component-config" style="display: none;">
                        <div class="component-config-grid">
                            <div class="component-config-item">
                                <label for="grammar_max">Grammar (Max Marks)</label>
                                <input type="number" id="grammar_max" name="grammar_max" value="{{ grammar_max_marks }}" min="1" max="1000"
                                       oninput="updateComponentMaxMarks()">
                            </div>
                            <div class="component-config-item">
                                <label for="composition_max">Composition (Max Marks)</label>
                                <input type="number" id="composition_max" name="composition_max" value="{{ composition_max_marks }}" min="1" max="1000"
                                       oninput="updateComponentMaxMarks()">
                            </div>
                            <div class="component-config-item total-display">
                                <label>Total Max Marks</label>
                                <div id="english_total_display" class="total-marks-display">{{ grammar_max_marks|int + composition_max_marks|int }}</div>
                            </div>
                        </div>
                    </div>

                    <div id="kiswahili-config" class="component-config" style="display: none;">
                        <div class="component-config-grid">
                            <div class="component-config-item">
                                <label for="lugha_max">Lugha (Max Marks)</label>
                                <input type="number" id="lugha_max" name="lugha_max" value="{{ lugha_max_marks }}" min="1" max="1000"
                                       oninput="updateComponentMaxMarks()">
                            </div>
                            <div class="component-config-item">
                                <label for="insha_max">Insha (Max Marks)</label>
                                <input type="number" id="insha_max" name="insha_max" value="{{ insha_max_marks }}" min="1" max="1000"
                                       oninput="updateComponentMaxMarks()">
                            </div>
                            <div class="component-config-item total-display">
                                <label>Total Max Marks</label>
                                <div id="kiswahili_total_display" class="total-marks-display">{{ lugha_max_marks|int + insha_max_marks|int }}</div>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="form-group">
                    <label for="grade">Grade</label>
                    <select id="grade" name="grade" required onchange="updateStreams()">
                        <option value="">Select Grade</option>
                        {% for grade_option in grades %}
                        <option value="{{ grade_option }}" {% if grade == grade_option %}selected{% endif %}>{{ grade_option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="stream">Stream</label>
                    <select id="stream" name="stream" required>
                        <option value="">Select Stream</option>
                        <!-- Streams will be populated dynamically via JavaScript -->
                    </select>
                </div>

                <div class="form-group" style="grid-column: span 2; text-align: center;">
                    <button type="submit" name="upload_marks" value="1" class="btn" id="upload-btn" onclick="debugFormSubmission()">
                        Upload Marks
                    </button>
                </div>
            </form>
            {% else %}
            <!-- Enhanced form for entering student marks with composite subject support -->
            <div id="pupils-list" class="pupils-list" style="grid-column: span 2;">
                <h3>Enter Marks for {{ subject }} - Grade {{ grade }} Stream {{ stream }}</h3>
                <div id="subject-type-info" class="subject-type-info"></div>

                <form method="POST" action="{{ url_for('teacher.dashboard') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <!-- Keep existing form fields as hidden fields -->
                    <input type="hidden" name="education_level" value="{{ education_level }}">
                    <input type="hidden" name="subject" value="{{ subject }}">
                    <input type="hidden" name="grade" value="{{ grade }}">
                    <input type="hidden" name="stream" value="{{ stream }}">
                    <input type="hidden" name="term" value="{{ term }}">
                    <input type="hidden" name="assessment_type" value="{{ assessment_type }}">
                    <input type="hidden" name="total_marks" value="{{ total_marks }}">

                    <!-- Hidden fields for composite subject configuration -->
                    <input type="hidden" id="hidden_grammar_max" name="grammar_max_marks" value="{{ grammar_max_marks }}">
                    <input type="hidden" id="hidden_composition_max" name="composition_max_marks" value="{{ composition_max_marks }}">
                    <input type="hidden" id="hidden_lugha_max" name="lugha_max_marks" value="{{ lugha_max_marks }}">
                    <input type="hidden" id="hidden_insha_max" name="insha_max_marks" value="{{ insha_max_marks }}">

                    <!-- Proven table structure adapted from classteacher -->
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    {% set subject_obj = namespace(obj=none) %}
                                    {% if education_level and subject %}
                                        {% for s in subjects_by_education_level[education_level] %}
                                            {% if s == subject %}
                                                {% set subject_obj.obj = {'name': subject, 'id': loop.index, 'is_composite': subject in ['ENGLISH', 'KISWAHILI']} %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    <th class="{% if subject_obj.obj and subject_obj.obj.is_composite %}composite-subject-header{% endif %}" data-subject-id="{{ subject_obj.obj.id if subject_obj.obj else '' }}">
                                        {{ subject }}
                                        <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                                            <span class="subject-info">Max Raw: {{ total_marks }}</span>
                                        </div>
                                        {% if subject_obj.obj and subject_obj.obj.is_composite %}
                                        <div class="component-headers">
                                            {% if subject == 'ENGLISH' %}
                                            <div class="component-header-item">Grammar</div>
                                            <div class="component-header-item">Composition</div>
                                            {% elif subject == 'KISWAHILI' %}
                                            <div class="component-header-item">Lugha</div>
                                            <div class="component-header-item">Insha</div>
                                            {% endif %}
                                            <div class="component-header-item overall-header">Overall</div>
                                        </div>
                                        {% endif %}
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                <tr>
                                    <td>{{ student.name }}</td>
                                    <td>
                                        {% if subject in ['ENGLISH', 'KISWAHILI'] %}
                                        <!-- Composite subject entry - clean layout without repetitive labels -->
                                        <div class="composite-subject-entry-clean">
                                            <div class="composite-components-row">
                                                {% if subject == 'ENGLISH' %}
                                                <!-- Grammar input -->
                                                <div class="component-input-cell">
                                                    <input type="number"
                                                        name="component_{{ student.name.replace(' ', '_') }}_1"
                                                        value=""
                                                        min="0"
                                                        max="{{ grammar_max_marks }}"
                                                        placeholder="0-{{ grammar_max_marks }}"
                                                        required
                                                        class="student-mark component-mark grammar-input"
                                                        data-student="{{ student.name.replace(' ', '_') }}"
                                                        data-subject="2"
                                                        data-component="1"
                                                        data-component-weight="0.6"
                                                        data-max-mark="{{ grammar_max_marks }}"
                                                        oninput="updateComponentPercentage(this); calculateOverallSubjectMark('{{ student.name.replace(' ', '_') }}', '2')">
                                                    <div class="component-percentage" id="component_percentage_{{ student.name.replace(' ', '_') }}_2_1">0%</div>
                                                </div>
                                                <!-- Composition input -->
                                                <div class="component-input-cell">
                                                    <input type="number"
                                                        name="component_{{ student.name.replace(' ', '_') }}_2"
                                                        value=""
                                                        min="0"
                                                        max="{{ composition_max_marks }}"
                                                        placeholder="0-{{ composition_max_marks }}"
                                                        required
                                                        class="student-mark component-mark composition-input"
                                                        data-student="{{ student.name.replace(' ', '_') }}"
                                                        data-subject="2"
                                                        data-component="2"
                                                        data-component-weight="0.4"
                                                        data-max-mark="{{ composition_max_marks }}"
                                                        oninput="updateComponentPercentage(this); calculateOverallSubjectMark('{{ student.name.replace(' ', '_') }}', '2')">
                                                    <div class="component-percentage" id="component_percentage_{{ student.name.replace(' ', '_') }}_2_2">0%</div>
                                                </div>
                                                {% elif subject == 'KISWAHILI' %}
                                                <!-- Lugha input -->
                                                <div class="component-input-cell">
                                                    <input type="number"
                                                        name="component_{{ student.name.replace(' ', '_') }}_3"
                                                        value=""
                                                        min="0"
                                                        max="{{ lugha_max_marks }}"
                                                        placeholder="0-{{ lugha_max_marks }}"
                                                        required
                                                        class="student-mark component-mark lugha-input"
                                                        data-student="{{ student.name.replace(' ', '_') }}"
                                                        data-subject="7"
                                                        data-component="3"
                                                        data-component-weight="0.6"
                                                        data-max-mark="{{ lugha_max_marks }}"
                                                        oninput="updateComponentPercentage(this); calculateOverallSubjectMark('{{ student.name.replace(' ', '_') }}', '7')">
                                                    <div class="component-percentage" id="component_percentage_{{ student.name.replace(' ', '_') }}_7_3">0%</div>
                                                </div>
                                                <!-- Insha input -->
                                                <div class="component-input-cell">
                                                    <input type="number"
                                                        name="component_{{ student.name.replace(' ', '_') }}_4"
                                                        value=""
                                                        min="0"
                                                        max="{{ insha_max_marks }}"
                                                        placeholder="0-{{ insha_max_marks }}"
                                                        required
                                                        class="student-mark component-mark insha-input"
                                                        data-student="{{ student.name.replace(' ', '_') }}"
                                                        data-subject="7"
                                                        data-component="4"
                                                        data-component-weight="0.4"
                                                        data-max-mark="{{ insha_max_marks }}"
                                                        oninput="updateComponentPercentage(this); calculateOverallSubjectMark('{{ student.name.replace(' ', '_') }}', '7')">
                                                    <div class="component-percentage" id="component_percentage_{{ student.name.replace(' ', '_') }}_7_4">0%</div>
                                                </div>
                                                {% endif %}
                                                <!-- Overall percentage -->
                                                <div class="component-input-cell overall-cell">
                                                    <div class="overall-percentage" id="overall_percentage_{{ student.name.replace(' ', '_') }}_{{ '2' if subject == 'ENGLISH' else '7' }}">0%</div>
                                                </div>
                                            </div>

                                            <!-- Hidden fields for the overall subject mark (calculated from components) -->
                                            <input type="hidden"
                                                name="mark_{{ student.name.replace(' ', '_') }}_{{ '2' if subject == 'ENGLISH' else '7' }}"
                                                id="overall_mark_{{ student.name.replace(' ', '_') }}_{{ '2' if subject == 'ENGLISH' else '7' }}"
                                                value="0">
                                            <input type="hidden"
                                                name="hidden_percentage_{{ student.name.replace(' ', '_') }}_{{ '2' if subject == 'ENGLISH' else '7' }}"
                                                id="hidden_percentage_{{ student.name.replace(' ', '_') }}_{{ '2' if subject == 'ENGLISH' else '7' }}"
                                                value="0">
                                        </div>
                                        {% else %}
                                        <!-- Regular subject entry -->
                                        <div class="simplified-mark-entry">
                                            <div class="mark-input-container">
                                                <input type="number"
                                                    name="mark_{{ student.name.replace(' ', '_') }}_1"
                                                    value="0"
                                                    min="0"
                                                    max="{{ total_marks }}"
                                                    required
                                                    class="student-mark"
                                                    data-student="{{ student.name.replace(' ', '_') }}"
                                                    data-subject="1"
                                                    data-max-mark="{{ total_marks }}"
                                                    oninput="updateRegularSubjectPercentage(this)">
                                            </div>
                                            <div class="mark-percentage" id="percentage_{{ student.name.replace(' ', '_') }}_1">0%</div>
                                        </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-3">
                        <button type="submit" name="submit_marks" value="1" class="btn">
                            Submit Marks
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>

        <div class="dashboard-card mt-4">
            <div class="card-header">
                <span>Recent Reports</span>
                <a href="#" class="btn-outline">View All</a>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Grade</th>
                            <th>Stream</th>
                            <th>Term</th>
                            <th>Assessment</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_reports %}
                        {% for report in recent_reports %}
                        <tr>
                            <td>{{ report.grade }}</td>
                            <td>{{ report.stream }}</td>
                            <td>{{ report.term }}</td>
                            <td>{{ report.assessment_type }}</td>
                            <td>{{ report.date }}</td>
                            <td>
                                <a href="{{ url_for('classteacher.preview_class_report', grade=report.grade, stream=report.stream, term=report.term, assessment_type=report.assessment_type) }}" class="btn" style="background-color: #007BFF;">
                                    Preview
                                </a>
                                <a href="{{ url_for('classteacher.download_class_report', grade=report.grade, stream=report.stream, term=report.term, assessment_type=report.assessment_type) }}" class="btn" style="background-color: #28A745; margin-left: 5px;">
                                    Download
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6" style="text-align: center;">No recent reports available.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Enhanced Subject Report Section -->
        {% if show_subject_report %}
        <div class="enhanced-subject-report-section">
            <div class="subject-report-header">
                <h3>📈 Enhanced Subject Report</h3>
                <div class="report-details-card">
                    <div class="report-detail-item">
                        <span class="detail-label">Subject:</span>
                        <span class="detail-value">{{ subject }}</span>
                    </div>
                    <div class="report-detail-item">
                        <span class="detail-label">Grade & Stream:</span>
                        <span class="detail-value">{{ grade }} - {{ stream }}</span>
                    </div>
                    <div class="report-detail-item">
                        <span class="detail-label">Assessment:</span>
                        <span class="detail-value">{{ term }} | {{ assessment_type }}</span>
                    </div>
                </div>
            </div>
            <div class="subject-report-actions">
                <a href="{{ url_for('teacher.generate_subject_report',
                         subject=subject,
                         grade=grade,
                         stream=stream,
                         term=term,
                         assessment_type=assessment_type) }}"
                   class="btn btn-primary enhanced-report-btn" target="_blank">
                    📊 Generate Subject Analysis Report
                </a>
                <p class="report-description">
                    Generate a comprehensive subject-specific report with grading analysis,
                    performance statistics, and detailed insights for {{ subject }}.
                </p>
            </div>
        </div>
        {% endif %}
    </div>

    <footer>
        <p>© 2025 Kirima Primary School - All Rights Reserved</p>
    </footer>

    <script>
        // Enhanced JavaScript with education level filtering and composite subject support
        let gradeMapping = {};
        let currentSubjectInfo = null;
        const subjectsByEducationLevel = {{ subjects_by_education_level | tojson }};

        // Debug functions
        function debugLog(message) {
            console.log(message);
            const debugMessages = document.getElementById('debug-messages');
            if (debugMessages) {
                const timestamp = new Date().toLocaleTimeString();
                debugMessages.innerHTML += `<div style="margin-bottom: 5px;"><span style="color: #666;">[${timestamp}]</span> ${message}</div>`;
                debugMessages.scrollTop = debugMessages.scrollHeight;
            }
        }

        function toggleDebug() {
            const debugPanel = document.getElementById('debug-panel');
            if (debugPanel.style.display === 'none') {
                debugPanel.style.display = 'block';
                debugLog('🔧 Debug panel opened');
            } else {
                debugPanel.style.display = 'none';
            }
        }

        function debugFormSubmission() {
            debugLog('🚀 Upload Marks button clicked');

            // Ensure configuration values are updated before submission
            if (document.getElementById('subject').value === 'ENGLISH') {
                const grammarMax = document.getElementById('grammar_max').value;
                const compositionMax = document.getElementById('composition_max').value;
                document.getElementById('hidden_grammar_max').value = grammarMax;
                document.getElementById('hidden_composition_max').value = compositionMax;
                debugLog(`📝 Synced English config: Grammar=${grammarMax}, Composition=${compositionMax}`);
            } else if (document.getElementById('subject').value === 'KISWAHILI') {
                const lughaMax = document.getElementById('lugha_max').value;
                const inshaMax = document.getElementById('insha_max').value;
                document.getElementById('hidden_lugha_max').value = lughaMax;
                document.getElementById('hidden_insha_max').value = inshaMax;
                debugLog(`📝 Synced Kiswahili config: Lugha=${lughaMax}, Insha=${inshaMax}`);
            }

            // Get all form values
            const educationLevel = document.getElementById('education_level').value;
            const subject = document.getElementById('subject').value;
            const grade = document.getElementById('grade').value;
            const stream = document.getElementById('stream').value;
            const term = document.getElementById('term').value;
            const assessmentType = document.getElementById('assessment_type').value;
            const totalMarks = document.getElementById('total_marks').value;

            debugLog('📋 Form values:');
            debugLog('  Education Level: ' + educationLevel);
            debugLog('  Subject: ' + subject);
            debugLog('  Grade: ' + grade);
            debugLog('  Stream: ' + stream);
            debugLog('  Term: ' + term);
            debugLog('  Assessment Type: ' + assessmentType);
            debugLog('  Total Marks: ' + totalMarks);

            // Debug hidden configuration values
            debugLog('🔧 Hidden configuration values:');
            debugLog('  Grammar Max: ' + document.getElementById('hidden_grammar_max').value);
            debugLog('  Composition Max: ' + document.getElementById('hidden_composition_max').value);
            debugLog('  Lugha Max: ' + document.getElementById('hidden_lugha_max').value);
            debugLog('  Insha Max: ' + document.getElementById('hidden_insha_max').value);

            // Check for missing values
            const missingFields = [];
            if (!educationLevel) missingFields.push('Education Level');
            if (!subject) missingFields.push('Subject');
            if (!grade) missingFields.push('Grade');
            if (!stream) missingFields.push('Stream');
            if (!term) missingFields.push('Term');
            if (!assessmentType) missingFields.push('Assessment Type');
            if (!totalMarks) missingFields.push('Total Marks');

            if (missingFields.length > 0) {
                debugLog('❌ Missing fields: ' + missingFields.join(', '));
            } else {
                debugLog('✅ All fields filled - form should submit');
            }
        }

        // Education level to grades mapping
        const educationLevelGrades = {
            'lower_primary': ['Grade 1', 'Grade 2', 'Grade 3'],
            'upper_primary': ['Grade 4', 'Grade 5', 'Grade 6'],
            'junior_secondary': ['Grade 7', 'Grade 8', 'Grade 9']
        };

        // Function to load grade mapping from server
        function loadGradeMapping() {
            fetch('/teacher/get_grade_mapping')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        gradeMapping = data.mapping;
                        debugLog('✅ Grade mapping loaded: ' + JSON.stringify(gradeMapping));
                    } else {
                        debugLog('❌ Failed to load grade mapping: ' + data.message);
                    }
                })
                .catch(error => {
                    debugLog('❌ Error loading grade mapping: ' + error);
                });
        }

        // Function to update subjects and grades based on education level
        function updateSubjectsByEducationLevel() {
            debugLog('🔄 updateSubjectsByEducationLevel called');
            const educationLevelSelect = document.getElementById('education_level');
            const subjectSelect = document.getElementById('subject');
            const gradeSelect = document.getElementById('grade');
            const streamSelect = document.getElementById('stream');
            const educationLevel = educationLevelSelect.value;

            debugLog('🎓 Selected education level: ' + educationLevel);

            // Clear existing options
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            gradeSelect.innerHTML = '<option value="">Select Grade</option>';
            streamSelect.innerHTML = '<option value="">Select Stream</option>';

            if (educationLevel) {
                // Update grades based on education level
                if (educationLevelGrades[educationLevel]) {
                    educationLevelGrades[educationLevel].forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade;
                        option.textContent = grade;
                        gradeSelect.appendChild(option);
                    });
                }

                // Update subjects based on education level
                if (subjectsByEducationLevel[educationLevel]) {
                    // Sort subjects with core subjects first
                    const coreSubjects = ['MATHEMATICS', 'ENGLISH', 'KISWAHILI', 'SCIENCE', 'INTEGRATED SCIENCE'];
                    const subjects = subjectsByEducationLevel[educationLevel];

                    subjects.sort((a, b) => {
                        const aIsCore = coreSubjects.some(core => a.toUpperCase().includes(core));
                        const bIsCore = coreSubjects.some(core => b.toUpperCase().includes(core));

                        if (aIsCore && !bIsCore) return -1;
                        if (!aIsCore && bIsCore) return 1;
                        return a.localeCompare(b);
                    });

                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject;
                        option.textContent = subject;
                        subjectSelect.appendChild(option);
                    });
                }
            }

            // Clear subject info
            hideSubjectInfo();
        }

        // Function to handle subject selection and show composite config
        function handleSubjectSelection() {
            const subjectSelect = document.getElementById('subject');
            const selectedSubject = subjectSelect.value;

            debugLog('📚 Subject selected: ' + selectedSubject);

            // Show/hide composite configuration based on subject
            showCompositeConfig(selectedSubject);

            if (selectedSubject) {
                // Fetch subject information
                fetch(`/teacher/get_subject_info/${encodeURIComponent(selectedSubject)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            currentSubjectInfo = data.subject;
                            debugLog('📚 Subject info loaded: ' + JSON.stringify(data.subject));
                            debugLog('🔍 Is composite: ' + data.subject.is_composite);
                            if (data.subject.components) {
                                debugLog('🔍 Components: ' + data.subject.components.length);
                            }
                            showSubjectInfo(data.subject);
                        } else {
                            debugLog('❌ Error fetching subject info: ' + data.message);
                            currentSubjectInfo = null;
                            hideSubjectInfo();
                        }
                    })
                    .catch(error => {
                        debugLog('❌ Error fetching subject info: ' + error);
                        currentSubjectInfo = null;
                        hideSubjectInfo();
                    });
            } else {
                currentSubjectInfo = null;
                hideSubjectInfo();
            }
        }

        // Function to show/hide composite configuration and total marks field
        function showCompositeConfig(subject) {
            const compositeConfig = document.getElementById('composite-config');
            const englishConfig = document.getElementById('english-config');
            const kiswahiliConfig = document.getElementById('kiswahili-config');
            const totalMarksGroup = document.getElementById('total-marks-group');
            const totalMarksInput = document.getElementById('total_marks');

            if (subject === 'ENGLISH') {
                // Show composite config for English
                compositeConfig.style.display = 'block';
                englishConfig.style.display = 'block';
                kiswahiliConfig.style.display = 'none';

                // Hide total marks field and remove required attribute
                totalMarksGroup.style.display = 'none';
                totalMarksInput.removeAttribute('required');

                // Set default values from backend or use defaults
                const currentGrammarMax = '{{ grammar_max_marks }}' || '60';
                const currentCompositionMax = '{{ composition_max_marks }}' || '40';

                document.getElementById('grammar_max').value = currentGrammarMax;
                document.getElementById('composition_max').value = currentCompositionMax;
                updateComponentMaxMarks();

                // Immediately update hidden fields with current values
                document.getElementById('hidden_grammar_max').value = currentGrammarMax;
                document.getElementById('hidden_composition_max').value = currentCompositionMax;

                debugLog('📚 Showing English composite configuration');
                debugLog('🔒 Hiding total marks field for composite subject');
            } else if (subject === 'KISWAHILI') {
                // Show composite config for Kiswahili
                compositeConfig.style.display = 'block';
                englishConfig.style.display = 'none';
                kiswahiliConfig.style.display = 'block';

                // Hide total marks field and remove required attribute
                totalMarksGroup.style.display = 'none';
                totalMarksInput.removeAttribute('required');

                // Set default values from backend or use defaults
                const currentLughaMax = '{{ lugha_max_marks }}' || '60';
                const currentInshaMax = '{{ insha_max_marks }}' || '40';

                document.getElementById('lugha_max').value = currentLughaMax;
                document.getElementById('insha_max').value = currentInshaMax;
                updateComponentMaxMarks();

                // Immediately update hidden fields with current values
                document.getElementById('hidden_lugha_max').value = currentLughaMax;
                document.getElementById('hidden_insha_max').value = currentInshaMax;

                debugLog('📚 Showing Kiswahili composite configuration');
                debugLog('🔒 Hiding total marks field for composite subject');
            } else {
                // Hide composite config for regular subjects
                compositeConfig.style.display = 'none';
                englishConfig.style.display = 'none';
                kiswahiliConfig.style.display = 'none';

                // Show total marks field and add required attribute
                totalMarksGroup.style.display = 'block';
                totalMarksInput.setAttribute('required', 'required');

                // Clear the total marks field for manual entry
                totalMarksInput.value = '';

                debugLog('📚 Hiding composite configuration');
                debugLog('🔓 Showing total marks field for regular subject');
            }
        }

        // Function to update component max marks and total
        function updateComponentMaxMarks() {
            const subject = document.getElementById('subject').value;

            if (subject === 'ENGLISH') {
                const grammarMax = parseInt(document.getElementById('grammar_max').value) || 0;
                const compositionMax = parseInt(document.getElementById('composition_max').value) || 0;
                const total = grammarMax + compositionMax;

                document.getElementById('english_total_display').textContent = total;
                document.getElementById('total_marks').value = total;

                // Update hidden fields for server submission
                document.getElementById('hidden_grammar_max').value = grammarMax;
                document.getElementById('hidden_composition_max').value = compositionMax;

                // Update all grammar input fields
                document.querySelectorAll('.grammar-input').forEach(input => {
                    input.max = grammarMax;
                    input.placeholder = `0-${grammarMax}`;
                    input.setAttribute('data-max-mark', grammarMax);
                });

                // Update all composition input fields
                document.querySelectorAll('.composition-input').forEach(input => {
                    input.max = compositionMax;
                    input.placeholder = `0-${compositionMax}`;
                    input.setAttribute('data-max-mark', compositionMax);
                });

                // Update max mark displays in labels
                document.querySelectorAll('.grammar-max-display').forEach(span => {
                    span.textContent = grammarMax;
                });
                document.querySelectorAll('.composition-max-display').forEach(span => {
                    span.textContent = compositionMax;
                });

                debugLog(`📊 English totals: Grammar ${grammarMax} + Composition ${compositionMax} = ${total}`);
            } else if (subject === 'KISWAHILI') {
                const lughaMax = parseInt(document.getElementById('lugha_max').value) || 0;
                const inshaMax = parseInt(document.getElementById('insha_max').value) || 0;
                const total = lughaMax + inshaMax;

                document.getElementById('kiswahili_total_display').textContent = total;
                document.getElementById('total_marks').value = total;

                // Update hidden fields for server submission
                document.getElementById('hidden_lugha_max').value = lughaMax;
                document.getElementById('hidden_insha_max').value = inshaMax;

                // Update all lugha input fields
                document.querySelectorAll('.lugha-input').forEach(input => {
                    input.max = lughaMax;
                    input.placeholder = `0-${lughaMax}`;
                    input.setAttribute('data-max-mark', lughaMax);
                });

                // Update all insha input fields
                document.querySelectorAll('.insha-input').forEach(input => {
                    input.max = inshaMax;
                    input.placeholder = `0-${inshaMax}`;
                    input.setAttribute('data-max-mark', inshaMax);
                });

                // Update max mark displays in labels
                document.querySelectorAll('.lugha-max-display').forEach(span => {
                    span.textContent = lughaMax;
                });
                document.querySelectorAll('.insha-max-display').forEach(span => {
                    span.textContent = inshaMax;
                });

                debugLog(`📊 Kiswahili totals: Lugha ${lughaMax} + Insha ${inshaMax} = ${total}`);
            }
        }

        // Function to show subject information
        function showSubjectInfo(subjectInfo) {
            const subjectInfoDiv = document.getElementById('subject-info');
            const subjectDetails = document.getElementById('subject-details');

            if (subjectInfo.is_composite && subjectInfo.components.length > 0) {
                let detailsText = `<strong>📚 Composite Subject Components:</strong><br>`;
                subjectInfo.components.forEach(comp => {
                    detailsText += `• <strong>${comp.name}</strong>: Max ${comp.max_raw_mark} marks<br>`;
                });
                detailsText += `<em>Final percentage will be calculated from total raw marks</em>`;

                subjectDetails.innerHTML = detailsText;
                subjectInfoDiv.style.display = 'block';
            } else {
                subjectDetails.innerHTML = `<strong>📖 Regular Subject</strong><br>Single assessment entry`;
                subjectInfoDiv.style.display = 'block';
            }
        }

        // Function to hide subject information
        function hideSubjectInfo() {
            const subjectInfoDiv = document.getElementById('subject-info');
            subjectInfoDiv.style.display = 'none';
            currentSubjectInfo = null;
        }

        // Function to update stream options based on selected grade using AJAX
        function updateStreams() {
            const gradeSelect = document.getElementById('grade');
            const streamSelect = document.getElementById('stream');
            const grade = gradeSelect.value;

            // Clear existing options
            streamSelect.innerHTML = '<option value="">Select Stream</option>';

            if (grade) {
                console.log(`🔄 Fetching streams for ${grade}`);

                // First try to get grade ID from mapping, if available
                if (gradeMapping[grade]) {
                    const gradeId = gradeMapping[grade];
                    console.log(`📋 Using grade ID from mapping: ${gradeId}`);

                    // Fetch streams via AJAX using grade ID
                    fetch(`/teacher/get_streams/${gradeId}`)
                        .then(response => {
                            console.log(`📡 Response status: ${response.status}`);
                            return response.json();
                        })
                        .then(data => {
                            console.log('📡 Streams response:', data);
                            if (data.streams && data.streams.length > 0) {
                                data.streams.forEach(stream => {
                                    const option = document.createElement('option');
                                    option.value = stream.name;
                                    option.textContent = `Stream ${stream.name}`;
                                    streamSelect.appendChild(option);
                                });
                                console.log(`✅ Loaded ${data.streams.length} streams`);
                            } else if (data.error) {
                                console.error('❌ Server error:', data.error);
                                streamSelect.innerHTML = '<option value="">Error: ' + data.error + '</option>';
                            } else {
                                streamSelect.innerHTML = '<option value="">No streams available</option>';
                                console.log('⚠️ No streams found');
                            }
                        })
                        .catch(error => {
                            console.error('❌ Error fetching streams:', error);
                            streamSelect.innerHTML = '<option value="">Error loading streams</option>';
                        });
                } else {
                    // Fallback: Use a hardcoded mapping if grade mapping isn't loaded yet
                    console.log('⚠️ Grade mapping not loaded, using fallback');
                    const fallbackMapping = {
                        'Grade 1': 3, 'Grade 2': 4, 'Grade 3': 5,
                        'Grade 4': 6, 'Grade 5': 7, 'Grade 6': 8,
                        'Grade 7': 9, 'Grade 8': 1, 'Grade 9': 2
                    };

                    const gradeId = fallbackMapping[grade];
                    if (gradeId) {
                        console.log(`📋 Using fallback grade ID: ${gradeId}`);

                        fetch(`/teacher/get_streams/${gradeId}`)
                            .then(response => {
                                console.log(`📡 Response status: ${response.status}`);
                                return response.json();
                            })
                            .then(data => {
                                console.log('📡 Streams response:', data);
                                if (data.streams && data.streams.length > 0) {
                                    data.streams.forEach(stream => {
                                        const option = document.createElement('option');
                                        option.value = stream.name;
                                        option.textContent = `Stream ${stream.name}`;
                                        streamSelect.appendChild(option);
                                    });
                                    console.log(`✅ Loaded ${data.streams.length} streams`);
                                } else if (data.error) {
                                    console.error('❌ Server error:', data.error);
                                    streamSelect.innerHTML = '<option value="">Error: ' + data.error + '</option>';
                                } else {
                                    streamSelect.innerHTML = '<option value="">No streams available</option>';
                                    console.log('⚠️ No streams found');
                                }
                            })
                            .catch(error => {
                                console.error('❌ Error fetching streams:', error);
                                streamSelect.innerHTML = '<option value="">Error loading streams</option>';
                            });
                    } else {
                        console.error('❌ Grade ID not found for:', grade);
                        streamSelect.innerHTML = '<option value="">Invalid grade</option>';
                    }
                }
            }
        }

        // Function to setup composite subject marks table
        function setupCompositeMarksTable() {
            debugLog('🔧 setupCompositeMarksTable called');
            debugLog('📊 currentSubjectInfo: ' + (currentSubjectInfo ? JSON.stringify(currentSubjectInfo) : 'null'));

            if (!currentSubjectInfo || !currentSubjectInfo.is_composite) {
                debugLog('❌ Not a composite subject or no subject info');
                return;
            }

            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('table-body');
            const subjectTypeInfo = document.getElementById('subject-type-info');

            debugLog('🎯 Table elements found: header=' + !!tableHeader + ', body=' + !!tableBody + ', info=' + !!subjectTypeInfo);

            if (!tableHeader || !tableBody) {
                debugLog('❌ Required table elements not found');
                return;
            }

            // Update subject type info
            if (subjectTypeInfo) {
                subjectTypeInfo.innerHTML = `
                    <div class="composite-info">
                        <h4>📚 Composite Subject: ${currentSubjectInfo.name}</h4>
                        <p>Enter raw marks for each component. Final percentage will be calculated from total raw marks.</p>
                    </div>
                `;
            }

            // Update table header for composite subjects
            let headerHTML = '<tr><th>Student Name</th>';
            currentSubjectInfo.components.forEach(comp => {
                headerHTML += `<th>${comp.name}<br><small>(Max: ${comp.max_raw_mark} marks)</small></th>`;
            });
            headerHTML += '<th>Total Raw Marks</th><th>Percentage</th></tr>';
            tableHeader.innerHTML = headerHTML;
            debugLog('✅ Table header updated for composite subject');

            // Update table body for composite subjects
            const existingRows = tableBody.querySelectorAll('tr');
            debugLog('🔍 Found existing rows: ' + existingRows.length);

            let bodyHTML = '';

            existingRows.forEach((row, index) => {
                const studentNameCell = row.querySelector('td');
                if (studentNameCell) {
                    const studentName = studentNameCell.textContent.trim();
                    const studentKey = studentName.replace(/\s+/g, '_');

                    debugLog('🎓 Processing student ' + (index + 1) + ': ' + studentName + ' (key: ' + studentKey + ')');

                    bodyHTML += `<tr data-student="${studentKey}">`;
                    bodyHTML += `<td>${studentName}</td>`;

                    currentSubjectInfo.components.forEach((comp, compIndex) => {
                        debugLog('📝 Adding component ' + (compIndex + 1) + ': ' + comp.name + ' (max: ' + comp.max_raw_mark + ')');
                        bodyHTML += `
                            <td class="component-input-cell">
                                <input type="number"
                                       name="component_${studentKey}_${comp.id}"
                                       min="0"
                                       max="${comp.max_raw_mark}"
                                       placeholder="0"
                                       oninput="updateCompositePercentage('${studentKey}')"
                                       required>
                            </td>
                        `;
                    });

                    bodyHTML += `<td class="total-marks-cell" id="total_marks_${studentKey}">0/${getTotalMaxMarks()}</td>`;
                    bodyHTML += `<td class="percentage-cell" id="composite_percentage_${studentKey}">0%</td>`;
                    bodyHTML += '</tr>';
                }
            });

            debugLog('🔧 Generated body HTML length: ' + bodyHTML.length);
            debugLog('🔧 Generated body HTML preview: ' + bodyHTML.substring(0, 200) + '...');

            if (bodyHTML) {
                tableBody.innerHTML = bodyHTML;
                debugLog('✅ Composite table body updated with component inputs');

                // Verify the inputs were created
                const componentInputs = tableBody.querySelectorAll('input[name^="component_"]');
                debugLog('🎯 Component inputs created: ' + componentInputs.length);
            } else {
                debugLog('❌ No students found to update composite table');
            }
        }

        // Helper function to get total max marks for composite subjects
        function getTotalMaxMarks() {
            if (!currentSubjectInfo || !currentSubjectInfo.is_composite) return 0;
            return currentSubjectInfo.components.reduce((total, comp) => total + comp.max_raw_mark, 0);
        }

        // Proven JavaScript functions from classteacher
        function updateComponentPercentage(inputElement) {
            debugLog("Updating component percentage...");

            // Get the student, subject, and component information from data attributes
            const student = inputElement.dataset.student;
            const subject = inputElement.dataset.subject;
            const component = inputElement.dataset.component;
            const componentWeight = parseFloat(inputElement.dataset.componentWeight) || 1.0;

            // Get the raw mark and max mark
            let rawMark = parseInt(inputElement.value) || 0;
            const maxMark = parseInt(inputElement.dataset.maxMark) || 100;

            // Validate the mark doesn't exceed the maximum
            if (rawMark > maxMark) {
                rawMark = maxMark;
                inputElement.value = maxMark;
            }

            // Calculate the percentage for this component
            const componentPercentage = (rawMark / maxMark) * 100;

            // Update the component percentage display
            const componentPercentageElement = document.getElementById(`component_percentage_${student}_${subject}_${component}`);
            if (componentPercentageElement) {
                componentPercentageElement.textContent = `${componentPercentage.toFixed(1)}%`;
            }

            debugLog(`Component ${component}: ${rawMark}/${maxMark} = ${componentPercentage.toFixed(1)}%`);
        }

        function calculateOverallSubjectMark(student, subject) {
            debugLog(`Calculating overall mark for student: ${student}, subject: ${subject}`);

            // Find all component inputs for this student and subject
            const componentInputs = document.querySelectorAll(`input.component-mark[data-student="${student}"][data-subject="${subject}"]`);
            debugLog(`Found ${componentInputs.length} component inputs`);

            if (componentInputs.length === 0) return;

            let totalWeightedPercentage = 0;
            let totalWeight = 0;
            let debugInfo = [];

            componentInputs.forEach(input => {
                const rawMark = parseInt(input.value) || 0;
                const maxMark = parseInt(input.dataset.maxMark) || 100;
                const weight = parseFloat(input.dataset.componentWeight) || 1.0;
                const component = input.dataset.component;

                // Calculate component percentage
                const componentPercentage = (rawMark / maxMark) * 100;

                // Calculate weighted contribution
                const weightedContribution = componentPercentage * weight;

                totalWeightedPercentage += weightedContribution;
                totalWeight += weight;

                debugInfo.push(`Component ${component}: ${rawMark}/${maxMark} (${componentPercentage.toFixed(1)}%) × ${weight} = ${weightedContribution.toFixed(1)}`);
            });

            // Calculate final percentage
            const finalPercentage = totalWeight > 0 ? totalWeightedPercentage / totalWeight : 0;

            debugLog(`Overall calculation: ${debugInfo.join(', ')} = ${finalPercentage.toFixed(1)}%`);

            // Update the overall percentage display
            const overallPercentageElement = document.getElementById(`overall_percentage_${student}_${subject}`);
            if (overallPercentageElement) {
                overallPercentageElement.textContent = `${finalPercentage.toFixed(1)}%`;
            }

            // Update hidden fields for form submission
            const hiddenPercentageField = document.getElementById(`hidden_percentage_${student}_${subject}`);
            if (hiddenPercentageField) {
                hiddenPercentageField.value = finalPercentage.toFixed(2);
            }

            const overallMarkField = document.getElementById(`overall_mark_${student}_${subject}`);
            if (overallMarkField) {
                // Calculate the overall raw mark based on percentage
                const totalMarks = 100; // Default total marks
                const overallRawMark = (finalPercentage / 100) * totalMarks;
                overallMarkField.value = overallRawMark.toFixed(2);
            }
        }

        function updateRegularSubjectPercentage(inputElement) {
            const student = inputElement.dataset.student;
            const subject = inputElement.dataset.subject;
            const rawMark = parseInt(inputElement.value) || 0;
            const maxMark = parseInt(inputElement.dataset.maxMark) || 100;

            // Validate the mark doesn't exceed the maximum
            if (rawMark > maxMark) {
                inputElement.value = maxMark;
                rawMark = maxMark;
            }

            // Calculate percentage
            const percentage = (rawMark / maxMark) * 100;

            // Update percentage display
            const percentageElement = document.getElementById(`percentage_${student}_${subject}`);
            if (percentageElement) {
                percentageElement.textContent = `${percentage.toFixed(1)}%`;
            }

            debugLog(`Regular subject: ${rawMark}/${maxMark} = ${percentage.toFixed(1)}%`);
        }

        // Simple function to update percentage in real-time (like classteacher)
        function updatePercentage(inputElement, studentId) {
            const totalMarks = parseInt(document.getElementsByName('total_marks')[0].value);
            const mark = parseInt(inputElement.value) || 0;

            // Validate mark doesn't exceed total
            if (mark > totalMarks) {
                inputElement.value = totalMarks;
                mark = totalMarks;
            }

            const percentage = (mark / totalMarks) * 100;

            // Update percentage displays
            const percentageCell = document.getElementById(`percentage_${studentId}`);
            const percentageDisplayCell = document.getElementById(`percentage_display_${studentId}`);

            if (percentageCell) {
                percentageCell.textContent = Math.round(percentage) + '%';
            }

            if (percentageDisplayCell) {
                percentageDisplayCell.textContent = Math.round(percentage) + '%';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('🚀 Teacher dashboard loaded!');
            debugLog('📊 Subjects by education level: ' + JSON.stringify(subjectsByEducationLevel));

            // Check for error messages
            {% if error_message %}
            debugLog('❌ Server error: {{ error_message }}');
            {% endif %}

            // Load grade mapping
            loadGradeMapping();

            // Add event listeners for composite configuration inputs
            const grammarMaxInput = document.getElementById('grammar_max');
            const compositionMaxInput = document.getElementById('composition_max');
            const lughaMaxInput = document.getElementById('lugha_max');
            const inshaMaxInput = document.getElementById('insha_max');

            if (grammarMaxInput) {
                grammarMaxInput.addEventListener('input', function() {
                    updateComponentMaxMarks();
                    document.getElementById('hidden_grammar_max').value = this.value;
                    debugLog(`📝 Updated hidden grammar max to: ${this.value}`);
                });
            }
            if (compositionMaxInput) {
                compositionMaxInput.addEventListener('input', function() {
                    updateComponentMaxMarks();
                    document.getElementById('hidden_composition_max').value = this.value;
                    debugLog(`📝 Updated hidden composition max to: ${this.value}`);
                });
            }
            if (lughaMaxInput) {
                lughaMaxInput.addEventListener('input', function() {
                    updateComponentMaxMarks();
                    document.getElementById('hidden_lugha_max').value = this.value;
                    debugLog(`📝 Updated hidden lugha max to: ${this.value}`);
                });
            }
            if (inshaMaxInput) {
                inshaMaxInput.addEventListener('input', function() {
                    updateComponentMaxMarks();
                    document.getElementById('hidden_insha_max').value = this.value;
                    debugLog(`📝 Updated hidden insha max to: ${this.value}`);
                });
            }

            // Initialize education level if set
            const educationLevel = document.getElementById('education_level').value;
            debugLog('🎓 Current education level: ' + educationLevel);
            if (educationLevel) {
                debugLog('🔄 Updating subjects for education level: ' + educationLevel);
                updateSubjectsByEducationLevel();
            }

            // Initialize subject if set and fetch its info
            const subjectSelect = document.getElementById('subject');
            if (subjectSelect && subjectSelect.value) {
                debugLog('📚 Current subject: ' + subjectSelect.value);
                handleSubjectSelection();
            }

            // Check if we're in marks entry mode and setup composite table
            const pupilsList = document.getElementById('pupils-list');
            if (pupilsList) {
                debugLog('📝 In marks entry mode');
                // We're in marks entry mode, get subject from hidden field
                const subjectHidden = document.querySelector('input[name="subject"]');
                if (subjectHidden && subjectHidden.value) {
                    debugLog('🔍 Fetching subject info for: ' + subjectHidden.value);
                    // Fetch subject info and setup table
                    fetch(`/teacher/get_subject_info/${encodeURIComponent(subjectHidden.value)}`)
                        .then(response => {
                            debugLog('📡 Subject info response status: ' + response.status);
                            return response.json();
                        })
                        .then(data => {
                            debugLog('📊 Subject info data: ' + JSON.stringify(data));
                            if (data.success) {
                                currentSubjectInfo = data.subject;
                                debugLog('🎯 Subject is composite: ' + data.subject.is_composite);
                                debugLog('🎯 Subject components: ' + JSON.stringify(data.subject.components));

                                if (data.subject.is_composite) {
                                    debugLog('🔧 Setting up composite marks table');
                                    // Add a small delay to ensure DOM is ready
                                    setTimeout(() => {
                                        setupCompositeMarksTable();
                                    }, 100);
                                } else {
                                    debugLog('📖 Regular subject - using standard table');
                                }
                            } else {
                                debugLog('❌ Failed to get subject info: ' + data.message);
                            }
                        })
                        .catch(error => {
                            debugLog('❌ Error fetching subject info for marks entry: ' + error);
                        });
                } else {
                    debugLog('❌ No subject hidden field found');
                }
            } else {
                debugLog('📋 Not in marks entry mode');
            }
        });
    </script>
</body>
</html>