<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Teacher Assignments - Hillview School</title>
    <!-- Inter font for Solar theme -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <style>
      /* Solar Theme Tokens + Heroicon classes */
      :root {
        --solar-bg-1: #fdf6e3;
        --solar-bg-2: #eee8d5;
        --solar-bg-3: #d6d2c4;
        --solar-primary: #b58900;
        --solar-secondary: #268bd2;
        --solar-green: #859900;
        --solar-red: #dc322f;
        --solar-text-primary: #002b36;
        --solar-text-secondary: #073642;
      }
      /* Map legacy variables to Solar */
      :root {
        --primary-color: var(--solar-primary) !important;
        --secondary-color: var(--solar-secondary) !important;
        --background-color: var(--solar-bg-2) !important;
        --white: #ffffff !important;
        --border-color: rgba(238, 232, 213, 0.5) !important;
        --shadow-md: 0 10px 30px rgba(181, 137, 0, 0.1) !important;
        --border-radius: 10px !important;
        --border-radius-lg: 16px !important;
        --spacing-sm: 8px !important;
        --spacing-md: 12px !important;
        --spacing-lg: 20px !important;
        --spacing-xl: 32px !important;
        --transition: all 0.25s ease !important;
      }
      body {
        background: linear-gradient(
            135deg,
            var(--solar-bg-1) 0%,
            var(--solar-bg-2) 60%,
            var(--solar-bg-3) 100%
          ) !important;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif !important;
        color: var(--solar-text-primary) !important;
      }
      .heroicon {
        display: inline-block;
        width: 1.1rem;
        height: 1.1rem;
        fill: currentColor;
        vertical-align: middle;
      }
      .heroicon-lg {
        width: 1.5rem;
        height: 1.5rem;
      }
      .heroicon-solar-blue {
        color: var(--solar-secondary);
      }
      .heroicon-solar-green {
        color: var(--solar-green);
      }
      .heroicon-solar-yellow {
        color: var(--solar-primary);
      }
      .heroicon-solar-red {
        color: var(--solar-red);
      }

      /* Container + Header - Solar glass look */
      .manage-container {
        max-width: 95% !important;
        width: 95% !important;
        margin: 40px auto 60px !important;
        padding: 0 !important;
        background: transparent !important;
      }
      .page-header {
        background: linear-gradient(
            145deg,
            rgba(253, 246, 227, 0.95) 0%,
            rgba(238, 232, 213, 0.9) 100%
          ) !important;
        backdrop-filter: blur(15px);
        padding: 30px !important;
        border-radius: 24px !important;
        box-shadow: 0 20px 40px rgba(0, 43, 54, 0.15) !important;
        border: 1px solid rgba(238, 232, 213, 0.5) !important;
        margin-bottom: 24px !important;
      }
      .page-header h1 {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--solar-text-primary) !important;
        margin: 0 0 10px 0 !important;
      }
      .nav-links {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .nav-links a {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--solar-text-secondary) !important;
        background: rgba(253, 246, 227, 0.5);
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid rgba(238, 232, 213, 0.6);
        text-decoration: none;
      }
      .nav-links a:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
      }

      /* Tabs - Solar */
      .tab {
        overflow: hidden;
        border: 1px solid var(--border-color) !important;
        background: rgba(253, 246, 227, 0.6) !important;
        border-radius: 16px 16px 0 0 !important;
        margin-bottom: 0 !important;
      }
      .tab button {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 16px 22px;
        color: var(--solar-text-primary);
        font-weight: 600;
      }
      .tab button:hover {
        background: rgba(38, 139, 210, 0.08);
      }
      .tab button.active {
        background: var(--solar-primary) !important;
        color: #fff !important;
      }
      .tabcontent {
        display: none;
        padding: 24px;
        background: #fff;
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 16px 16px;
        box-shadow: var(--shadow-md);
      }
      .tabcontent.active {
        display: block;
      }

      /* Table */
      .data-table {
        width: 100%;
        border-collapse: collapse;
      }
      .data-table th,
      .data-table td {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border-color);
      }
      .data-table th {
        background: var(--solar-primary);
        color: #fff;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      .data-table tbody tr:nth-child(even) {
        background: rgba(181, 137, 0, 0.05);
      }
      .data-table tbody tr:hover {
        background: rgba(38, 139, 210, 0.08);
      }

      /* Buttons */
      .btn,
      .edit-btn,
      .delete-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 10px;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: var(--transition);
      }
      .btn {
        background: var(--solar-secondary);
        color: #fff;
      }
      .btn:hover {
        filter: brightness(0.95);
      }
      .edit-btn {
        background: #fdf0c7;
        color: var(--solar-text-primary);
        border: 1px solid rgba(245, 199, 0, 0.3);
      }
      .edit-btn:hover {
        background: #fde9aa;
      }
      .delete-btn {
        background: #fbe3e5;
        color: var(--solar-red);
        border: 1px solid rgba(220, 50, 47, 0.25);
      }
      .delete-btn:hover {
        background: #f8d2d6;
      }

      .filter-section {
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(238, 232, 213, 0.6);
        border-radius: 12px;
        border: 1px solid var(--border-color);
      }
      .filter-section h3 {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0 0 10px 0;
        color: var(--solar-text-secondary);
      }

      /* Remove legacy duplicate tab block (replaced by Solar styles above) */
    </style>
  </head>
  <body>
    <div class="manage-container">
        <header class="page-header">
          <h1>
            <!-- Heroicon: rectangle-stack (solid) -->
            <svg class="heroicon heroicon-lg heroicon-solar-yellow" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M3.75 6A2.25 2.25 0 016 3.75h8.25A2.25 2.25 0 0116.5 6v.75h.75A2.25 2.25 0 0119.5 9v7.5A2.25 2.25 0 0117.25 18H6A2.25 2.25 0 013.75 15.75V6zM6 5.25a.75.75 0 00-.75.75v9.75c0 .414.336.75.75.75h11.25a.75.75 0 00.75-.75V9a.75.75 0 00-.75-.75H16.5V6a.75.75 0 00-.75-.75H6z" clip-rule="evenodd"/></svg>
            Manage Teacher Assignments
          </h1>
          <div class="nav-links">
            <a href="{{ url_for('classteacher.teacher_management_hub') }}">
              <svg class="heroicon heroicon-solar-blue" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M3.375 4.5A2.625 2.625 0 016 1.875h12A2.625 2.625 0 0120.625 4.5v12A2.625 2.625 0 0118 19.125H6A2.625 2.625 0 013.375 16.5v-12zM6 3.375a1.125 1.125 0 00-1.125 1.125v12c0 .621.504 1.125 1.125 1.125h12c.621 0 1.125-.504 1.125-1.125v-12A1.125 1.125 0 0018 3.375H6z" clip-rule="evenodd"/></svg>
              Teacher Hub
            </a>
            <a href="{{ url_for('classteacher.dashboard') }}">
              <svg class="heroicon heroicon-solar-green" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13.5A1.5 1.5 0 014.5 12h15a1.5 1.5 0 010 3h-15A1.5 1.5 0 013 13.5zM3 7.5A1.5 1.5 0 014.5 6h15a1.5 1.5 0 010 3h-15A1.5 1.5 0 013 7.5zM3 19.5A1.5 1.5 0 014.5 18h9a1.5 1.5 0 010 3h-9A1.5 1.5 0 013 19.5z"/></svg>
              Dashboard
            </a>
            <a href="{{ url_for('auth.logout_route') }}">
              <svg class="heroicon heroicon-solar-red" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M3.75 5.25A2.25 2.25 0 016 3h6a2.25 2.25 0 012.25 2.25v2.378a.75.75 0 01-1.5 0V5.25a.75.75 0 00-.75-.75H6a.75.75 0 00-.75.75v13.5c0 .414.336.75.75.75h6a.75.75 0 00.75-.75v-2.378a.75.75 0 011.5 0v2.378A2.25 2.25 0 0112 21H6a2.25 2.25 0 01-2.25-2.25V5.25z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.47 15.28a.75.75 0 001.06 0l3-3a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H9a.75.75 0 000 1.5h7.19l-1.72 1.72a.75.75 0 000 1.06z" clip-rule="evenodd"/></svg>
              Logout
            </a>
          </div>
        </header>

        <!-- Message container for notifications -->
        <div id="message-container">
          {% if error_message %}
          <div class="message message-error">{{ error_message }}</div>
          {% endif %} {% if success_message %}
          <div class="message message-success">{{ success_message }}</div>
          {% endif %} {% if session.get('assignment_success') %}
          <div class="message message-success">
            {{ session.get('assignment_message') }}
          </div>
          {% endif %}
        </div>

        <!-- Tab navigation -->
        <div class="tab">
          <button class="tablinks active" onclick="openTab(event, 'ClassTeachers')">
            <!-- Heroicon: academic-cap -->
            <svg class="heroicon heroicon-solar-yellow" viewBox="0 0 24 24" fill="currentColor"><path d="M11.7 2.37a.75.75 0 01.6 0l8.25 3.75a.75.75 0 010 1.36L12.3 11.23a.75.75 0 01-.6 0L3.45 7.48a.75.75 0 010-1.36L11.7 2.37z"/><path d="M4.5 12.75v3.38a.75.75 0 00.44.68l6.75 3.05a.75.75 0 00.62 0l6.75-3.05a.75.75 0 00.44-.68v-3.38l-6.59 2.99a2.25 2.25 0 01-1.92 0L4.5 12.75z"/></svg>
            Class Teacher Assignments
          </button>
          <button class="tablinks" onclick="openTab(event, 'SubjectTeachers')">
            <!-- Heroicon: book-open -->
            <svg class="heroicon heroicon-solar-blue" viewBox="0 0 24 24" fill="currentColor"><path d="M2.25 5.25A2.25 2.25 0 014.5 3h6.75A2.25 2.25 0 0113.5 5.25v13.5a.75.75 0 01-1.148.638 6.466 6.466 0 00-3.602-1.088H4.5a2.25 2.25 0 01-2.25-2.25V5.25z"/><path d="M12.75 5.25A2.25 2.25 0 0115 3h4.5A2.25 2.25 0 0121.75 5.25v10.5A2.25 2.25 0 0119.5 18h-3.75a6.466 6.466 0 00-3.602 1.088.75.75 0 01-1.148-.638V5.25z"/></svg>
            Subject Teacher Assignments
          </button>
          <button class="tablinks" onclick="openTab(event, 'BulkTransfer')">
            <!-- Heroicon: arrows-right-left -->
            <svg class="heroicon heroicon-solar-green" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 7.5A.75.75 0 013 6.75h12.19l-1.72-1.72a.75.75 0 111.06-1.06l3 3a.75.75 0 010 1.06l-3 3a.75.75 0 01-1.06-1.06l1.72-1.72H3A.75.75 0 012.25 7.5zM21.75 16.5a.75.75 0 00-.75-.75H8.81l1.72-1.72a.75.75 0 10-1.06-1.06l-3 3a.75.75 0 000 1.06l3 3a.75.75 0 001.06-1.06l-1.72-1.72H21a.75.75 0 00.75-.75z" clip-rule="evenodd"/></svg>
            Bulk Transfer
          </button>
        </div>

        <!-- Class Teacher Assignments Tab -->
        <div id="ClassTeachers" class="tabcontent" style="display: block">
          <div class="filter-section">
            <h3>Filter Class Teacher Assignments</h3>
            <select id="educationLevelFilter" onchange="filterClassTeachers()">
              <option value="">All Education Levels</option>
              <option value="lower_primary">Lower Primary (Grades 1-3)</option>
              <option value="upper_primary">Upper Primary (Grades 4-6)</option>
              <option value="junior_secondary">
                Junior Secondary (Grades 7-9)
              </option>
            </select>
            <select id="gradeFilter" onchange="filterClassTeachers()">
              <option value="">All Grades</option>
              {% for grade in grades %}
              <option value="{{ grade.id }}">{{ grade.name }}</option>
              {% endfor %}
            </select>
          </div>

          <table class="data-table">
            <thead>
              <tr>
                <th>Grade</th>
                <th>Stream</th>
                <th>Current Class Teacher</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="classTeacherTableBody">
              {% for assignment in class_teacher_assignments %}
              <tr data-grade="{{ assignment.grade_id }}" data-education-level="{{ assignment.education_level }}">
                <td>{{ assignment.grade_level }}</td>
                <td>{{ assignment.stream_name if assignment.stream_name else 'All Streams' }}</td>
                <td>{{ assignment.teacher_username }}</td>
                <td>
                  <div class="action-buttons">
                    <button
                      class="edit-btn reassign-class-btn"
                      data-assignment-id="{{ assignment.id }}"
                      data-grade="{{ assignment.grade_level }}"
                      data-stream="{{ assignment.stream_name if assignment.stream_name else 'All Streams' }}"
                      data-teacher="{{ assignment.teacher_username }}"
                    >
                      <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor"><path d="M16.023 9.348h4.998a.75.75 0 010 1.5h-3.248l-1.78 6.398a.75.75 0 11-1.446-.402l1.476-5.312H9.727l-1.78 6.398a.75.75 0 01-1.446-.402l1.476-5.312H2.99a.75.75 0 010-1.5h4.998l.53-1.917a2.25 2.25 0 012.162-1.627h2.65a2.25 2.25 0 012.162 1.627l.531 1.917z"/></svg>
                      Reassign
                    </button>
                    <a href="{{ url_for('classteacher.manage_teacher_subjects', teacher_id=assignment.teacher_id) }}" class="edit-btn">
                      <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6c0-1.243 1.007-2.25 2.25-2.25h5.25A2.25 2.25 0 0121.75 6v12A2.25 2.25 0 0119.5 20.25h-5.25A2.25 2.25 0 0112 18V6z"/><path d="M1.5 6A2.25 2.25 0 013.75 3.75H9A2.25 2.25 0 0111.25 6v12A2.25 2.25 0 019 20.25H3.75A2.25 2.25 0 011.5 18V6z"/></svg>
                      Manage Subjects
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
              </tbody>
          </table>
        </div>

        <!-- Subject Teacher Assignments Tab -->
        <div id="SubjectTeachers" class="tabcontent">
          <div class="filter-section">
            <h3>Filter Subject Teacher Assignments</h3>
            <select
              id="subjectEducationLevelFilter"
              onchange="filterSubjectTeachers()"
            >
              <option value="">All Education Levels</option>
              <option value="lower_primary">Lower Primary (Grades 1-3)</option>
              <option value="upper_primary">Upper Primary (Grades 4-6)</option>
              <option value="junior_secondary">
                Junior Secondary (Grades 7-9)
              </option>
            </select>
            <select id="subjectGradeFilter" onchange="filterSubjectTeachers()">
              <option value="">All Grades</option>
              {% for grade in grades %}
              <option value="{{ grade.id }}">{{ grade.name }}</option>
              {% endfor %}
            </select>
            <select id="subjectFilter" onchange="filterSubjectTeachers()">
              <option value="">All Subjects</option>
              {% for subject in subjects %}
              <option value="{{ subject.id }}">{{ subject.name }}</option>
              {% endfor %}
            </select>
          </div>

          <table class="data-table">
            <thead>
              <tr>
                <th>Subject</th>
                <th>Grade</th>
                <th>Stream</th>
                <th>Current Teacher</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="subjectTeacherTableBody">
              {% for assignment in subject_assignments %}
              <tr data-grade="{{ assignment.grade_id }}" data-subject="{{ assignment.subject_id }}" data-education-level="{{ assignment.education_level }}">
                <td>{{ assignment.subject_name }}</td>
                <td>{{ assignment.grade_level }}</td>
                <td>{{ assignment.stream_name if assignment.stream_name else 'All Streams' }}</td>
                <td>{{ assignment.teacher_username }}</td>
                <td>
                  <div class="action-buttons">
                    <button
                      class="edit-btn reassign-subject-btn"
                      data-assignment-id="{{ assignment.id }}"
                      data-subject="{{ assignment.subject_name }}"
                      data-grade="{{ assignment.grade_level }}"
                      data-stream="{{ assignment.stream_name if assignment.stream_name else 'All Streams' }}"
                      data-teacher="{{ assignment.teacher_username }}"
                    >
                      <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor"><path d="M16.023 9.348h4.998a.75.75 0 010 1.5h-3.248l-1.78 6.398a.75.75 0 11-1.446-.402l1.476-5.312H9.727l-1.78 6.398a.75.75 0 01-1.446-.402l1.476-5.312H2.99a.75.75 0 010-1.5h4.998l.53-1.917a2.25 2.25 0 012.162-1.627h2.65a2.25 2.25 0 012.162 1.627l.531 1.917z"/></svg>
                      Reassign
                    </button>
                    <a href="{{ url_for('classteacher.manage_teacher_subjects', teacher_id=assignment.teacher_id) }}" class="edit-btn">
                      <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6c0-1.243 1.007-2.25 2.25-2.25h5.25A2.25 2.25 0 0121.75 6v12A2.25 2.25 0 0119.5 20.25h-5.25A2.25 2.25 0 0112 18V6z"/><path d="M1.5 6A2.25 2.25 0 013.75 3.75H9A2.25 2.25 0 0111.25 6v12A2.25 2.25 0 019 20.25H3.75A2.25 2.25 0 011.5 18V6z"/></svg>
                      Manage Subjects
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
              </tbody>
          </table>
        </div>

        <!-- Bulk Transfer Tab -->
        <div id="BulkTransfer" class="tabcontent">
          <h2>
            <svg class="heroicon heroicon-solar-green" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 7.5A.75.75 0 013 6.75h12.19l-1.72-1.72a.75.75 0 111.06-1.06l3 3a.75.75 0 010 1.06l-3 3a.75.75 0 01-1.06-1.06l1.72-1.72H3A.75.75 0 012.25 7.5zM21.75 16.5a.75.75 0 00-.75-.75H8.81l1.72-1.72a.75.75 0 10-1.06-1.06l-3 3a.75.75 0 000 1.06l3 3a.75.75 0 001.06-1.06l-1.72-1.72H21a.75.75 0 00.75-.75z" clip-rule="evenodd"/></svg>
            Bulk Transfer Assignments
          </h2>
          <p>
            Use this form to transfer all assignments from one teacher to
            another.
          </p>

          <form id="bulkTransferForm" method="POST" action="{{ url_for('classteacher.bulk_transfer_assignments') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

            <div class="form-group">
              <label for="from_teacher_id">Transfer From:</label>
              <select
                id="from_teacher_id"
                name="from_teacher_id"
                required
                class="form-control"
              >
                <option value="">-- Select Teacher --</option>
                {% for teacher in teachers %}
                <option value="{{ teacher.id }}">{{ teacher.username }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label for="to_teacher_id">Transfer To:</label>
              <select
                id="to_teacher_id"
                name="to_teacher_id"
                required
                class="form-control"
              >
                <option value="">-- Select Teacher --</option>
                {% for teacher in teachers %}
                <option value="{{ teacher.id }}">{{ teacher.username }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label>
                <input
                  type="checkbox"
                  name="transfer_class_teacher"
                  value="1"
                />
                Transfer Class Teacher Assignments
              </label>
            </div>

            <div class="form-group">
              <label>
                <input
                  type="checkbox"
                  name="transfer_subject_assignments"
                  value="1"
                />
                Transfer Subject Assignments
              </label>
            </div>

            <button type="submit" name="bulk_transfer" class="btn">
              <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 7.5A.75.75 0 013 6.75h12.19l-1.72-1.72a.75.75 0 111.06-1.06l3 3a.75.75 0 010 1.06l-3 3a.75.75 0 01-1.06-1.06l1.72-1.72H3A.75.75 0 012.25 7.5zM21.75 16.5a.75.75 0 00-.75-.75H8.81l1.72-1.72a.75.75 0 10-1.06-1.06l-3 3a.75.75 0 000 1.06l3 3a.75.75 0 001.06-1.06l-1.72-1.72H21a.75.75 0 00.75-.75z" clip-rule="evenodd"/></svg>
              Transfer Assignments
            </button>
          </form>
        </div>

        <!-- Reassign Class Teacher Modal -->
        <div id="reassignModal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeReassignModal()">&times;</span>
            <h2>Reassign Class Teacher</h2>
            <form
              id="reassignForm"
              method="POST"
              action="{{ url_for('classteacher.reassign_class_teacher') }}"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />
              <input type="hidden" id="assignment_id" name="assignment_id" />

              <div class="form-group">
                <label for="current_details">Current Assignment:</label>
                <input
                  type="text"
                  id="current_details"
                  class="form-control"
                  readonly
                />
              </div>

              <div class="form-group">
                <label for="new_teacher_id">New Class Teacher:</label>
                <select
                  id="new_teacher_id"
                  name="new_teacher_id"
                  required
                  class="form-control"
                >
                  <option value="">-- Select Teacher --</option>
                  {% for teacher in teachers %}
                  <option value="{{ teacher.id }}">
                    {{ teacher.username }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <button
                type="submit"
                name="reassign_class_teacher"
                class="btn btn-primary"
              >
                Reassign Class Teacher
              </button>
            </form>
          </div>
        </div>

        <!-- Reassign Subject Teacher Modal -->
        <div id="reassignSubjectModal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeReassignSubjectModal()"
              >&times;</span
            >
            <h2>Reassign Subject Teacher</h2>
            <form
              id="reassignSubjectForm"
              method="POST"
              action="{{ url_for('classteacher.reassign_subject_teacher') }}"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />
              <input
                type="hidden"
                id="subject_assignment_id"
                name="assignment_id"
              />

              <div class="form-group">
                <label for="subject_current_details">Current Assignment:</label>
                <input
                  type="text"
                  id="subject_current_details"
                  class="form-control"
                  readonly
                />
              </div>

              <div class="form-group">
                <label for="subject_new_teacher_id">New Subject Teacher:</label>
                <select
                  id="subject_new_teacher_id"
                  name="new_teacher_id"
                  required
                  class="form-control"
                >
                  <option value="">-- Select Teacher --</option>
                  {% for teacher in teachers %}
                  <option value="{{ teacher.id }}">
                    {{ teacher.username }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <button
                type="submit"
                name="reassign_subject_teacher"
                class="btn btn-primary"
              >
                Reassign Subject Teacher
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Auto-hide messages after 5 seconds
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(function () {
          const messages = document.querySelectorAll(".message");
          messages.forEach((message) => { message.style.display = "none"; });
        }, 5000);

        // Delegated handlers for reassignment buttons (avoid inline onclick with Jinja)
        document.body.addEventListener('click', function(e) {
          const classBtn = e.target.closest('.reassign-class-btn');
          if (classBtn) {
            const id = classBtn.dataset.assignmentId;
            const grade = classBtn.dataset.grade;
            const stream = classBtn.dataset.stream;
            const teacher = classBtn.dataset.teacher;
            openReassignModal(id, grade, stream, teacher);
          }
          const subjBtn = e.target.closest('.reassign-subject-btn');
          if (subjBtn) {
            const id = subjBtn.dataset.assignmentId;
            const subject = subjBtn.dataset.subject;
            const grade = subjBtn.dataset.grade;
            const stream = subjBtn.dataset.stream;
            const teacher = subjBtn.dataset.teacher;
            openReassignSubjectModal(id, subject, grade, stream, teacher);
          }
        });

        // Confirm on bulk transfer submit
        const bulkForm = document.getElementById('bulkTransferForm');
        if (bulkForm) {
          bulkForm.addEventListener('submit', function(ev) {
            const ok = confirm('Are you sure you want to transfer all selected assignments? This action cannot be undone.');
            if (!ok) ev.preventDefault();
          });
        }
      });

      // Tab functionality
      function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
      }

      // Filter class teachers
      function filterClassTeachers() {
        const educationLevel = document.getElementById(
          "educationLevelFilter"
        ).value;
        const gradeId = document.getElementById("gradeFilter").value;
        const rows = document.querySelectorAll("#classTeacherTableBody tr");

        rows.forEach((row) => {
          let showRow = true;

          if (educationLevel && row.dataset.educationLevel !== educationLevel) {
            showRow = false;
          }

          if (gradeId && row.dataset.grade !== gradeId) {
            showRow = false;
          }

          row.style.display = showRow ? "" : "none";
        });
      }

      // Filter subject teachers
      function filterSubjectTeachers() {
        const educationLevel = document.getElementById(
          "subjectEducationLevelFilter"
        ).value;
        const gradeId = document.getElementById("subjectGradeFilter").value;
        const subjectId = document.getElementById("subjectFilter").value;
        const rows = document.querySelectorAll("#subjectTeacherTableBody tr");

        rows.forEach((row) => {
          let showRow = true;

          if (educationLevel && row.dataset.educationLevel !== educationLevel) {
            showRow = false;
          }

          if (gradeId && row.dataset.grade !== gradeId) {
            showRow = false;
          }

          if (subjectId && row.dataset.subject !== subjectId) {
            showRow = false;
          }

          row.style.display = showRow ? "" : "none";
        });
      }

      // Reassign class teacher modal functions
      function openReassignModal(assignmentId, grade, stream, teacher) {
        document.getElementById("assignment_id").value = assignmentId;
        document.getElementById(
          "current_details"
        ).value = `${grade} ${stream} - Current teacher: ${teacher}`;
        document.getElementById("reassignModal").style.display = "block";
      }

      function closeReassignModal() {
        document.getElementById("reassignModal").style.display = "none";
      }

      // Reassign subject teacher modal functions
      function openReassignSubjectModal(
        assignmentId,
        subject,
        grade,
        stream,
        teacher
      ) {
        document.getElementById("subject_assignment_id").value = assignmentId;
        document.getElementById(
          "subject_current_details"
        ).value = `${subject} - ${grade} ${stream} - Current teacher: ${teacher}`;
        document.getElementById("reassignSubjectModal").style.display = "block";
      }

      function closeReassignSubjectModal() {
        document.getElementById("reassignSubjectModal").style.display = "none";
      }

      // Close modals when clicking outside
      window.onclick = function (event) {
        if (event.target == document.getElementById("reassignModal")) {
          closeReassignModal();
        }
        if (event.target == document.getElementById("reassignSubjectModal")) {
          closeReassignSubjectModal();
        }
      };
    </script>
  </body>
</html>
