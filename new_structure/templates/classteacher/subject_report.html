<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ subject }} Subject Report - {{ grade }} {{ stream }}</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
      }

      .report-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: white;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border-radius: 15px;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .report-header {
        text-align: center;
        padding: 30px 0;
        background: linear-gradient(135deg, #268bd2, #2aa198);
        color: white;
        border-radius: 15px 15px 0 0;
        margin: -20px -20px 30px -20px;
        position: relative;
      }

      .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 25px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .back-button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
      }

      .school-logo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-bottom: 10px;
      }

      .report-title {
        font-size: 2.2rem;
        font-weight: 700;
        margin: 15px 0 5px 0;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }

      .report-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 300;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .stat-card {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        border-left: 4px solid #268bd2;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #268bd2;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .grade-distribution {
        margin: 30px 0;
        background: #f8f9fa;
        padding: 25px;
        border-radius: 12px;
      }

      .grade-distribution h3 {
        color: #268bd2;
        margin-bottom: 20px;
        font-size: 1.3rem;
      }

      .grade-bars {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 15px;
      }

      .grade-bar {
        text-align: center;
      }

      .grade-letter {
        font-weight: 700;
        color: #333;
        margin-bottom: 5px;
        font-size: 1.1rem;
      }

      .bar-container {
        height: 100px;
        background: #e9ecef;
        border-radius: 5px;
        position: relative;
        overflow: hidden;
      }

      .bar-fill {
        position: absolute;
        bottom: 0;
        width: 100%;
        background: linear-gradient(to top, #268bd2, #2aa198);
        border-radius: 0 0 5px 5px;
        transition: height 0.5s ease;
      }

      /* CBC Grade Colors */
      .bar-ee1 { background: linear-gradient(to top, #10b981, #34d399); } /* Exceeds Expectations 1 - Green */
      .bar-ee2 { background: linear-gradient(to top, #059669, #10b981); } /* Exceeds Expectations 2 - Dark Green */
      .bar-me1 { background: linear-gradient(to top, #3b82f6, #60a5fa); } /* Meets Expectations 1 - Blue */
      .bar-me2 { background: linear-gradient(to top, #1d4ed8, #3b82f6); } /* Meets Expectations 2 - Dark Blue */
      .bar-ae1 { background: linear-gradient(to top, #f59e0b, #fbbf24); } /* Approaches Expectations 1 - Orange */
      .bar-ae2 { background: linear-gradient(to top, #d97706, #f59e0b); } /* Approaches Expectations 2 - Dark Orange */
      .bar-be1 { background: linear-gradient(to top, #ef4444, #f87171); } /* Below Expectations 1 - Red */
      .bar-be2 { background: linear-gradient(to top, #dc2626, #ef4444); } /* Below Expectations 2 - Dark Red */

      /* Grade Letter Colors */
      .grade-ee1, .grade-ee2 { color: #10b981; font-weight: bold; }
      .grade-me1, .grade-me2 { color: #3b82f6; font-weight: bold; }
      .grade-ae1, .grade-ae2 { color: #f59e0b; font-weight: bold; }
      .grade-be1, .grade-be2 { color: #ef4444; font-weight: bold; }

      .grade-label {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 5px;
      }

      .grade-count {
        margin-top: 5px;
        font-weight: 600;
        color: #268bd2;
      }

      .students-table {
        margin-top: 30px;
        overflow-x: auto;
      }

      .students-table h3 {
        color: #268bd2;
        margin-bottom: 20px;
        font-size: 1.3rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
      }

      th {
        background: linear-gradient(135deg, #268bd2, #2aa198);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.9rem;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .grade-a {
        color: #28a745;
        font-weight: 600;
      }
      .grade-b {
        color: #17a2b8;
        font-weight: 600;
      }
      .grade-c {
        color: #ffc107;
        font-weight: 600;
      }
      .grade-d {
        color: #fd7e14;
        font-weight: 600;
      }
      .grade-e {
        color: #dc3545;
        font-weight: 600;
      }
      .grade-f {
        color: #6c757d;
        font-weight: 600;
      }

      .action-buttons {
        margin-top: 30px;
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        text-decoration: none;
        font-weight: 600;
        text-align: center;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #268bd2, #2aa198);
        color: white;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
      }

      .btn-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
      }

      .btn-warning {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      @media (max-width: 768px) {
        .report-container {
          margin: 10px;
          padding: 15px;
        }

        .report-title {
          font-size: 1.8rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .grade-bars {
          grid-template-columns: repeat(3, 1fr);
        }

        .action-buttons {
          flex-direction: column;
        }

        .btn {
          width: 100%;
          justify-content: center;
        }
      }

      @media print {
        body {
          background: white;
        }

        .report-container {
          box-shadow: none;
          margin: 0;
        }

        .back-button,
        .action-buttons {
          display: none;
        }
      }
    </style>
  </head>

  <body>
    <div class="report-container">
      <div class="report-header">
        <a href="{{ url_for('classteacher.dashboard') }}" class="back-button">
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>

        {% if school_info.logo_path %}
        <img
          src="{{ url_for('static', filename=school_info.logo_path) }}"
          alt="{{ school_info.school_name }} Logo"
          class="school-logo"
        />
        {% endif %}

        <h1 class="report-title">{{ report_title }}</h1>
        <p class="report_subtitle">{{ report_subtitle }}</p>
      </div>

      <!-- Statistics Overview -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">{{ statistics.total_students }}</div>
          <div class="stat-label">Total Students</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ statistics.students_with_marks }}</div>
          <div class="stat-label">Students with Marks</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ "%.1f"|format(statistics.average) }}</div>
          <div class="stat-label">Average Mark</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">
            {{ "%.1f"|format(statistics.average_percentage) }}%
          </div>
          <div class="stat-label">Average Percentage</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ statistics.highest }}</div>
          <div class="stat-label">Highest Mark</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ statistics.lowest }}</div>
          <div class="stat-label">Lowest Mark</div>
        </div>
      </div>

      <!-- Grade Distribution -->
      <div class="grade-distribution">
        <h3><i class="fas fa-chart-bar"></i> Grade Distribution (CBC System)</h3>
        <div class="grade-bars">
          <!-- EE1: Exceeds Expectations 1 (90-100%) -->
          <div class="grade-bar">
            <div class="grade-letter grade-ee1">EE1</div>
            <div class="grade-label">90-100%</div>
            <div class="bar-container">
              <div
                class="bar-fill bar-ee1"
                style="height: {{ (grade_distribution['EE1'] / statistics.total_students * 100) if statistics.total_students > 0 else 0 }}%"
              ></div>
            </div>
            <div class="grade-count">{{ grade_distribution['EE1'] }}</div>
          </div>

          <!-- EE2: Exceeds Expectations 2 (75-89%) -->
          <div class="grade-bar">
            <div class="grade-letter grade-ee2">EE2</div>
            <div class="grade-label">75-89%</div>
            <div class="bar-container">
              <div
                class="bar-fill bar-ee2"
                style="height: {{ (grade_distribution['EE2'] / statistics.total_students * 100) if statistics.total_students > 0 else 0 }}%"
              ></div>
            </div>
            <div class="grade-count">{{ grade_distribution['EE2'] }}</div>
          </div>

          <!-- ME1: Meets Expectations 1 (58-74%) -->
          <div class="grade-bar">
            <div class="grade-letter grade-me1">ME1</div>
            <div class="grade-label">58-74%</div>
            <div class="bar-container">
              <div
                class="bar-fill bar-me1"
                style="height: {{ (grade_distribution['ME1'] / statistics.total_students * 100) if statistics.total_students > 0 else 0 }}%"
              ></div>
            </div>
            <div class="grade-count">{{ grade_distribution['ME1'] }}</div>
          </div>

          <!-- ME2: Meets Expectations 2 (41-57%) -->
          <div class="grade-bar">
            <div class="grade-letter grade-me2">ME2</div>
            <div class="grade-label">41-57%</div>
            <div class="bar-container">
              <div
                class="bar-fill bar-me2"
                style="height: {{ (grade_distribution['ME2'] / statistics.total_students * 100) if statistics.total_students > 0 else 0 }}%"
              ></div>
            </div>
            <div class="grade-count">{{ grade_distribution['ME2'] }}</div>
          </div>

          <!-- AE1: Approaches Expectations 1 (31-40%) -->
          <div class="grade-bar">
            <div class="grade-letter grade-ae1">AE1</div>
            <div class="grade-label">31-40%</div>
            <div class="bar-container">
              <div
                class="bar-fill bar-ae1"
                style="height: {{ (grade_distribution['AE1'] / statistics.total_students * 100) if statistics.total_students > 0 else 0 }}%"
              ></div>
            </div>
            <div class="grade-count">{{ grade_distribution['AE1'] }}</div>
          </div>

          <!-- AE2: Approaches Expectations 2 (21-30%) -->
          <div class="grade-bar">
            <div class="grade-letter grade-ae2">AE2</div>
            <div class="grade-label">21-30%</div>
            <div class="bar-container">
              <div
                class="bar-fill bar-ae2"
                style="height: {{ (grade_distribution['AE2'] / statistics.total_students * 100) if statistics.total_students > 0 else 0 }}%"
              ></div>
            </div>
            <div class="grade-count">{{ grade_distribution['AE2'] }}</div>
          </div>

          <!-- BE1: Below Expectations 1 (11-20%) -->
          <div class="grade-bar">
            <div class="grade-letter grade-be1">BE1</div>
            <div class="grade-label">11-20%</div>
            <div class="bar-container">
              <div
                class="bar-fill bar-be1"
                style="height: {{ (grade_distribution['BE1'] / statistics.total_students * 100) if statistics.total_students > 0 else 0 }}%"
              ></div>
            </div>
            <div class="grade-count">{{ grade_distribution['BE1'] }}</div>
          </div>

          <!-- BE2: Below Expectations 2 (0-10%) -->
          <div class="grade-bar">
            <div class="grade-letter grade-be2">BE2</div>
            <div class="grade-label">0-10%</div>
            <div class="bar-container">
              <div
                class="bar-fill bar-be2"
                style="height: {{ (grade_distribution['BE2'] / statistics.total_students * 100) if statistics.total_students > 0 else 0 }}%"
              ></div>
            </div>
            <div class="grade-count">{{ grade_distribution['BE2'] }}</div>
          </div>
        </div>
      </div>

      <!-- Students Table -->
      <div class="students-table">
        <h3><i class="fas fa-users"></i> Student Performance</h3>
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Student Name</th>
              <th>Admission No.</th>
              <th>Raw Mark</th>
              <th>Percentage</th>
              <th>Grade</th>
            </tr>
          </thead>
          <tbody>
            {% for student in students %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ student.name }}</td>
              <td>{{ student.admission_number }}</td>
              <td>
                {{ student.raw_mark if student.raw_mark is not none else 'N/A'
                }}
              </td>
              <td>
                {{ "%.1f"|format(student.percentage) if student.percentage is
                not none else 'N/A' }}%
              </td>
              <td>
                <span
                  class="grade-{{ student.grade.lower() if student.grade != 'N/A' else 'f' }}"
                >
                  {{ student.grade }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Action Buttons for Class Teachers -->
      {% if show_actions %}
      <div class="action-buttons">
        <a
          href="{{ url_for('classteacher.edit_class_marks', grade=grade, stream=stream, term=term, assessment_type=assessment_type) }}"
          class="btn btn-warning"
        >
          <i class="fas fa-edit"></i> Edit Marks
        </a>
        <a
          href="{{ url_for('classteacher.preview_class_report', grade=grade, stream=stream, term=term, assessment_type=assessment_type) }}"
          class="btn btn-info"
        >
          <i class="fas fa-eye"></i> View Full Report
        </a>
        <a
          href="{{ url_for('classteacher.view_student_reports', grade=grade, stream=stream, term=term, assessment_type=assessment_type) }}"
          class="btn btn-success"
        >
          <i class="fas fa-users"></i> Student Reports
        </a>
        <a
          href="{{ url_for('classteacher.upload_marks') }}"
          class="btn btn-primary"
        >
          <i class="fas fa-plus"></i> Add More Marks
        </a>
        <a
          href="{{ url_for('classteacher.dashboard') }}"
          class="btn btn-secondary"
        >
          <i class="fas fa-home"></i> Back to Dashboard
        </a>
        <button onclick="window.print()" class="btn btn-success">
          <i class="fas fa-print"></i> Print Report
        </button>
        <a href="#" onclick="exportToCSV()" class="btn btn-warning">
          <i class="fas fa-download"></i> Export CSV
        </a>
        <button onclick="deleteSubjectReport()" class="btn btn-danger">
          <i class="fas fa-trash"></i> Delete Report
        </button>
      </div>
      {% endif %}
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
      function exportToCSV() {
        // Create CSV content
        let csv = 'Rank,Student Name,Admission Number,Raw Mark,Percentage,Grade\n';

        {% for student in students %}
        csv += `{{ loop.index }},"{{ student.name }}","{{ student.admission_number }}","{{ student.raw_mark if student.raw_mark is not none else 'N/A' }}","{{ "%.1f"|format(student.percentage) if student.percentage is not none else 'N/A' }}","{{ student.grade }}"\n`;
        {% endfor %}

        // Create download link
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', '{{ subject }}_{{ grade }}_{{ stream }}_Report.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      // Delete subject report function
      function deleteSubjectReport() {
        if (confirm('Are you sure you want to delete this subject report? This will delete all marks for this subject in this grade/stream/term/assessment. This action cannot be undone.')) {
          // Create form to submit delete request
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '{{ url_for("classteacher.delete_subject_report") }}';

          // Add CSRF token
          const csrfToken = document.createElement('input');
          csrfToken.type = 'hidden';
          csrfToken.name = 'csrf_token';
          csrfToken.value = '{{ csrf_token() }}';
          form.appendChild(csrfToken);

          // Add parameters
          const gradeInput = document.createElement('input');
          gradeInput.type = 'hidden';
          gradeInput.name = 'grade';
          gradeInput.value = '{{ grade }}';
          form.appendChild(gradeInput);

          const streamInput = document.createElement('input');
          streamInput.type = 'hidden';
          streamInput.name = 'stream';
          streamInput.value = '{{ stream }}';
          form.appendChild(streamInput);

          const subjectInput = document.createElement('input');
          subjectInput.type = 'hidden';
          subjectInput.name = 'subject';
          subjectInput.value = '{{ subject }}';
          form.appendChild(subjectInput);

          const termInput = document.createElement('input');
          termInput.type = 'hidden';
          termInput.name = 'term';
          termInput.value = '{{ term }}';
          form.appendChild(termInput);

          const assessmentInput = document.createElement('input');
          assessmentInput.type = 'hidden';
          assessmentInput.name = 'assessment_type';
          assessmentInput.value = '{{ assessment_type }}';
          form.appendChild(assessmentInput);

          document.body.appendChild(form);
          form.submit();
        }
      }

      // Animate grade bars on page load
      window.addEventListener('load', function() {
        const bars = document.querySelectorAll('.bar-fill');
        bars.forEach(bar => {
          const height = bar.style.height;
          bar.style.height = '0%';
          setTimeout(() => {
            bar.style.height = height;
          }, 500);
        });
      });
    </script>
  </body>
</html>
