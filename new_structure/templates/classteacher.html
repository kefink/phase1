<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="description" content="Class Teacher Dashboard - {{ school_info.school_name|default('Hillview School') }} Management System">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#b58900">

    <title>Class Teacher Dashboard - {{ school_info.school_name|default('Hillview School Management System') }}</title>

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <!-- Modern Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          rel="stylesheet"
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer">
          
    <!-- External CSS Files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/classteacher-base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/classteacher-forms.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/classteacher-buttons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/classteacher-navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/classteacher-flexbox.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/recent_reports_fix.css') }}">
    
    <!-- External JavaScript -->
    <script src="{{ url_for('static', filename='js/classteacher-main.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/classteacher-reports.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/classteacher-calculations.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>
</head>

<body class="solar-theme">
    <!-- Error Message Section -->
    {% if error_message %}
    <div class="alert alert-danger">
        <strong><i class="fas fa-exclamation-triangle"></i> Error:</strong> {{ error_message|safe }}
    </div>
    {% endif %}

    <!-- Deletion Confirmation Message -->

    <!-- Deletion Confirmation Message -->
    {% if confirmation_message %}
    <div class="alert alert-success">
        <strong><i class="fas fa-check-circle"></i> Success:</strong> {{ confirmation_message|safe }}
    </div>
    {% endif %}

    <!-- Teacher Assignment Status -->
    {% if not has_assignments %}
    <div class="alert alert-info">
        <strong><i class="fas fa-info-circle"></i> Note:</strong> You are not currently assigned to any class stream. You can still manage students and view reports for all grades and streams.
    </div>
    {% elif stream %}
    <div class="modern-alert alert-success">
        <i class="fas fa-check-circle"></i>
        <strong>Assigned Class:</strong> Grade {{ grade }} {{ stream }}
    </div>
    {% endif %}

    <!-- FLEXBOX HORIZONTAL NAVBAR -->
    <nav class="navbar">
        <!-- LEFT SECTION: Branding area with logo and school name -->
        <a href="#" class="navbar-brand">
            <!-- Hillview School Logo with Enhanced Styling -->
            {% if school_info.logo_path %}
            <img
                src="{{ url_for('static', filename=school_info.logo_path) }}"
                alt="{{ school_info.school_name or 'Hillview School' }} Logo"
                onerror="this.src='{{ url_for('static', filename='uploads/logos/optimized_school_logo_1750595986_hvs.jpg') }}'"
            />
            {% else %}
            <img
                src="{{ url_for('static', filename='uploads/logos/optimized_school_logo_1750595986_hvs.jpg') }}"
                alt="Hillview School Logo"
            />
            {% endif %}
            <div class="brand-text">
                <span class="school-name">{{ school_info.school_name or 'Hillview School' }}</span>
                <span class="role-text">Class Teacher</span>
            </div>
        </a>
        
        <!-- RIGHT SECTION: Navigation menu items in horizontal row -->
        <ul class="navbar-nav">
            <li>
                <a href="#" onclick="navigateToFeature('upload-marks'); return false;" class="nav-link">
                    <i class="fas fa-upload"></i> 
                    <span>Upload</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="navigateToFeature('recent-reports'); return false;" class="nav-link">
                    <i class="fas fa-chart-line"></i> 
                    <span>Reports</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="navigateToFeature('generate-marksheet'); return false;" class="nav-link">
                    <i class="fas fa-file-pdf"></i> 
                    <span>Generate</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('classteacher.analytics_dashboard') }}" class="nav-link">
                    <i class="fas fa-chart-bar"></i> 
                    <span>Analytics</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showManagementOptions(); return false;" class="nav-link">
                    <i class="fas fa-cogs"></i> 
                    <span>Manage</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('auth.logout_route') }}" class="logout-btn nav-link">
                    <i class="fas fa-sign-out-alt"></i> 
                    <span>Logout</span>
                </a>
            </li>
        </ul>
    </nav>

    <div class="modern-container">
        <!-- Reorganized Header with Primary Focus -->
        <header class="modern-header fade-in">
            <div class="header-content">
                <div class="header-primary">
                    <h1 class="header-title">
                        <i class="fas fa-chalkboard-teacher"></i>
                        Class Teacher Dashboard
                    </h1>
                    <p class="header-subtitle">
                        Welcome back, <strong>{{ session.get('username', 'Teacher') }}</strong>!
                        <span class="modern-badge badge-info">
                            <i class="fas fa-user-tie"></i>
                            {{ session.get('role', 'teacher').replace('_', ' ').title() }}
                        </span>
                    </p>
                </div>
                <!-- Quick Class Context (Primary Focus) -->
                {% if assignment_summary and assignment_summary.class_teacher_assignments %}
                <div class="class-context-banner">
                    <div class="context-info">
                        <h2>
                            <i class="fas fa-users"></i>
                            {{ assignment_summary.class_teacher_assignments[0].grade_name }} 
                            Stream {{ assignment_summary.class_teacher_assignments[0].stream_name }}
                        </h2>
                        <p>Your Primary Class â€¢ {{ assignment_summary.class_teacher_assignments[0].subjects|length }} Subjects</p>
                    </div>
                    <div class="context-stats">
                        <div class="stat-item">
                            <span class="number">{{ total_students or 0 }}</span>
                            <span class="label">Students</span>
                        </div>
                        <div class="stat-item">
                            <span class="number">{{ recent_reports|length or 0 }}</span>
                            <span class="label">Reports</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </header>

        <!-- Role-Based Assignments Section -->
        {% if assignment_summary and assignment_summary.teacher %}
        <div class="modern-card slide-up" style="margin-bottom: var(--space-6);">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-user-graduate card-icon"></i>
                    My Teaching Assignments
                </h2>
                <div class="card-actions">
                    <span class="modern-badge badge-info">{{ assignment_summary.role.title() }}</span>
                </div>
            </div>
            <div style="padding: var(--space-6);">
                <!-- Assignment Summary Stats -->
                <div class="modern-grid grid-cols-4" style="margin-bottom: var(--space-6);">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">{{ total_subjects_taught }}</div>
                            <div class="stat-label">Subjects Taught</div>
                        </div>
                    </div>
                    {% if can_manage_classes %}
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chalkboard"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">{{ assignment_summary.total_classes_managed }}</div>
                            <div class="stat-label">Classes Managed</div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">{{ assignment_summary.grades_involved|length if assignment_summary.grades_involved else 0 }}</div>
                            <div class="stat-label">Grades Involved</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-stream"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">{{ assignment_summary.streams_involved|length if assignment_summary.streams_involved else 0 }}</div>
                            <div class="stat-label">Streams Involved</div>
                        </div>
                    </div>
                </div>

                <!-- Class Teacher Assignments (if any) -->
                {% if can_manage_classes and class_teacher_assignments %}
                <div style="margin-bottom: var(--space-6);">
                    <h3 style="color: var(--primary-color); margin-bottom: var(--space-4); font-size: 1.1rem; font-weight: 600;">
                        <i class="fas fa-chalkboard-teacher"></i> Class Teacher Responsibilities
                    </h3>
                    <div class="modern-grid grid-cols-3">
                        {% for assignment in class_teacher_assignments %}
                        <div class="assignment-card class-teacher">
                            <div class="assignment-icon">
                                <i class="fas fa-chalkboard"></i>
                            </div>
                            <div class="assignment-content">
                                <div class="assignment-title">{{ assignment.grade_level }}</div>
                                {% if assignment.stream_name %}
                                <div class="assignment-subtitle">Stream {{ assignment.stream_name }}</div>
                                {% endif %}
                                <div class="assignment-badge">Class Teacher</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Analytics Quick Access -->
                <div class="analytics-quick-access">
                    <div class="quick-access-card">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="card-content">
                            <h3>Academic Performance Analytics</h3>
                            <p>View comprehensive insights into student performance and subject analytics for your assigned classes.</p>
                            <a href="{{ url_for('classteacher.analytics_dashboard') }}" class="modern-btn btn-primary">
                                <i class="fas fa-chart-bar"></i> View Analytics Dashboard
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Subject Assignments with Pagination and Filtering -->
                {% if subject_assignments %}
                <div>
                    <h3 style="color: var(--primary-color); margin-bottom: var(--space-4); font-size: 1.1rem; font-weight: 600;">
                        <i class="fas fa-book-open"></i> Subject Teaching Assignments
                        <span class="modern-badge badge-info" style="font-size: 0.8rem; margin-left: var(--space-2);">
                            {{ subject_assignments|length }} Total
                        </span>
                    </h3>

                    <!-- Assignment Filters -->
                    <div style="background: var(--gray-50); padding: var(--space-4); border-radius: var(--radius-lg); margin-bottom: var(--space-4);">
                        <div class="modern-grid grid-cols-4">
                            <div class="form-group">
                                <label class="form-label" style="font-size: 0.8rem;">Search Subject</label>
                                <input type="text" id="assignment-search" placeholder="Search subjects..."
                                       class="form-input" style="font-size: 0.9rem; padding: var(--space-2);"
                                       onkeyup="filterAssignments()">
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="font-size: 0.8rem;">Filter by Grade</label>
                                <select id="assignment-grade-filter" class="form-select" style="font-size: 0.9rem; padding: var(--space-2);"
                                        onchange="filterAssignments()">
                                    <option value="">All Grades</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="font-size: 0.8rem;">Filter by Role</label>
                                <select id="assignment-role-filter" class="form-select" style="font-size: 0.9rem; padding: var(--space-2);"
                                        onchange="filterAssignments()">
                                    <option value="">All Roles</option>
                                    <option value="class_teacher">Class Teacher</option>
                                    <option value="subject_teacher">Subject Teacher</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="font-size: 0.8rem;">Items per Page</label>
                                <select id="assignment-per-page" class="form-select" style="font-size: 0.9rem; padding: var(--space-2);"
                                        onchange="updateAssignmentPagination()">
                                    <option value="10">10 per page</option>
                                    <option value="20" selected>20 per page</option>
                                    <option value="50">50 per page</option>
                                    <option value="all">Show All</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Assignment Table -->
                    <div style="border: 1px solid var(--gray-200); border-radius: var(--radius-lg); overflow: hidden;">
                        <div class="modern-table-container" style="max-height: 400px; overflow-y: auto;">
                            <table class="modern-table" id="assignments-table">
                                <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; border-bottom: 2px solid var(--glass-border);">
                                    <tr>
                                        <th style="cursor: pointer; color: var(--text-primary);" onclick="sortAssignments('subject')">
                                            <i class="fas fa-book"></i> Subject
                                            <i class="fas fa-sort" id="sort-subject"></i>
                                        </th>
                                        <th style="cursor: pointer; color: var(--text-primary);" onclick="sortAssignments('grade')">
                                            <i class="fas fa-layer-group"></i> Grade
                                            <i class="fas fa-sort" id="sort-grade"></i>
                                        </th>
                                        <th style="color: var(--text-primary);"><i class="fas fa-stream"></i> Stream</th>
                                        <th style="cursor: pointer; color: var(--text-primary);" onclick="sortAssignments('role')">
                                            <i class="fas fa-user-tag"></i> Role
                                            <i class="fas fa-sort" id="sort-role"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="assignments-tbody">
                                    {% if subject_assignments %}
                                        {% for assignment in subject_assignments %}
                                        <tr style="border-bottom: 1px solid rgba(131, 148, 150, 0.1);">
                                            <td style="padding: 1rem; color: var(--text-white); font-weight: 600;">
                                                <i class="fas fa-book" style="color: #b58900; margin-right: 0.5rem;"></i>
                                                {{ assignment.subject_name or 'N/A' }}
                                            </td>
                                            <td style="padding: 1rem; color: var(--text-secondary);">
                                                <span class="grade-badge" style="background: linear-gradient(135deg, rgba(181, 137, 0, 0.2) 0%, rgba(40, 139, 210, 0.2) 100%); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; color: #b58900;">
                                                    Grade {{ assignment.grade_level or 'All' }}
                                                </span>
                                            </td>
                                            <td style="padding: 1rem; color: var(--text-secondary);">
                                                {% if assignment.stream_name %}
                                                    <span class="stream-badge" style="background: linear-gradient(135deg, rgba(42, 161, 152, 0.2) 0%, rgba(40, 139, 210, 0.2) 100%); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; color: #2aa198;">
                                                        {{ assignment.stream_name }}
                                                    </span>
                                                {% else %}
                                                    <span style="color: var(--text-muted); font-style: italic;">All Streams</span>
                                                {% endif %}
                                            </td>
                                            <td style="padding: 1rem;">
                                                <span class="role-badge" style="background: linear-gradient(135deg, rgba(40, 139, 210, 0.2) 0%, rgba(42, 161, 152, 0.2) 100%); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; color: #268bd2;">
                                                    {% if assignment.is_class_teacher %}
                                                        <i class="fas fa-chalkboard-teacher"></i> Class Teacher
                                                    {% else %}
                                                        <i class="fas fa-user-graduate"></i> Subject Teacher
                                                    {% endif %}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                                <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--text-secondary);"></i>
                                                <br>
                                                No subject assignments found.
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pagination Controls -->
                    <div id="assignment-pagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-4); padding: var(--space-4); background: var(--gray-50); border-radius: var(--radius-lg);">
                        <div id="assignment-info" style="color: var(--gray-600); font-size: 0.9rem;"></div>
                        <div id="assignment-controls" style="display: flex; gap: var(--space-2);"></div>
                    </div>
                </div>
                {% endif %}

                <!-- Quick Access Note -->
                <div style="margin-top: var(--space-6); padding: var(--space-4); background: linear-gradient(135deg, var(--blue-50) 0%, var(--indigo-50) 100%); border-radius: var(--radius-lg); border: 1px solid var(--blue-200);">
                    <div style="font-size: 0.9rem; color: var(--gray-600);">
                        <strong style="color: var(--blue-600);"><i class="fas fa-info-circle"></i> Access Control:</strong>
                        {% if assignment_summary.role == 'teacher' %}
                        As a subject teacher, you can upload marks for your assigned subjects only.
                        {% elif assignment_summary.role == 'classteacher' %}
                        As a class teacher, you can upload marks for all your subjects and manage your assigned classes.
                        {% elif assignment_summary.role == 'headteacher' %}
                        As a headteacher, you have full access to all subjects and classes in the system.
                        {% endif %}
                        The forms below are filtered to show only your accessible options.
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Permission Status Widget -->
        <div class="modern-card slide-up" id="permission-status-widget" style="margin-bottom: var(--space-6);">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-key card-icon"></i>
                    Class Permissions
                </h2>
                <div class="card-actions">
                    <button onclick="refreshPermissionStatus()" class="modern-btn btn-outline" style="font-size: 0.8rem; padding: var(--space-2) var(--space-3);">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
            <div id="permission-status-content" style="padding: var(--space-6);">
                <div style="text-align: center; color: var(--gray-500);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: var(--space-2);"></i>
                    <p>Loading permission status...</p>
                </div>
            </div>
        </div>

        <!-- Modern Management Options Section -->
        <div id="management-section" class="modern-card slide-up">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-cogs card-icon"></i>
                    Management Hub
                </h2>
                <div class="card-actions">
                    <span class="modern-badge badge-info">{{ (total_students or 0) + (total_teachers or 0) + (total_subjects or 0) }} Items</span>
                </div>
            </div>

            <div class="management-filters" style="margin-bottom: var(--space-6);">
                <div class="modern-nav" style="margin-bottom: var(--space-4);">
                    <button class="nav-link active" data-filter="all">All</button>
                    <button class="nav-link" data-filter="core">Core</button>
                    <button class="nav-link" data-filter="assignments">Assignments</button>
                    <button class="nav-link" data-filter="structure">Structure</button>
                </div>
                <div class="form-group">
                    <input type="text" id="management-search" placeholder="Search management options..." class="form-input">
                </div>
            </div>
            <div class="modern-grid grid-cols-3">
                <a href="{{ url_for('classteacher.manage_students') }}" class="quick-action-card" data-category="core">
                    <div class="quick-action-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="quick-action-title">Manage Students</h3>
                    <p class="quick-action-desc">Add, edit, and organize student records</p>
                    <div class="modern-badge badge-success">{{ total_students or 0 }} Students</div>
                </a>

                <a href="{{ url_for('classteacher.manage_subjects') }}" class="quick-action-card" data-category="core">
                    <div class="quick-action-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <h3 class="quick-action-title">Manage Subjects</h3>
                    <p class="quick-action-desc">Configure subjects and curriculum</p>
                    <div class="modern-badge badge-warning">{{ total_subjects or 0 }} Subjects</div>
                </a>

                <a href="{{ url_for('classteacher.teacher_management_hub') }}" class="quick-action-card" data-category="core">
                    <div class="quick-action-icon">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <h3 class="quick-action-title">Teacher Hub</h3>
                    <p class="quick-action-desc">Comprehensive teacher and assignment management</p>
                    <div class="modern-badge badge-info">{{ total_teachers or 0 }} Teachers</div>
                </a>

                <a href="{{ url_for('staff.management') }}" class="quick-action-card" data-category="core">
                    <div class="quick-action-icon">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <h3 class="quick-action-title">Staff Management</h3>
                    <p class="quick-action-desc">Dynamic staff assignments and professional profiles</p>
                    <div class="modern-badge badge-success">Enhanced</div>
                </a>

                <a href="{{ url_for('classteacher.manage_grades_streams') }}" class="quick-action-card" data-category="structure">
                    <div class="quick-action-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <h3 class="quick-action-title">Grades & Streams</h3>
                    <p class="quick-action-desc">Configure grade levels and class streams</p>
                    <div class="modern-badge badge-info">{{ total_grades or 0 }} Grades</div>
                </a>

                <a href="{{ url_for('classteacher.manage_terms_assessments') }}" class="quick-action-card" data-category="structure">
                    <div class="quick-action-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <h3 class="quick-action-title">Terms & Assessments</h3>
                    <p class="quick-action-desc">Manage academic terms and assessment types</p>
                    <div class="modern-badge badge-warning">Academic Setup</div>
                </a>

                <a href="{{ url_for('classteacher.report_configuration') }}" class="quick-action-card" data-category="core">
                    <div class="quick-action-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <h3 class="quick-action-title">Report Configuration</h3>
                    <p class="quick-action-desc">Configure staff assignments, term dates, and report settings</p>
                    <div class="modern-badge badge-primary">Dynamic Reports</div>
                </a>
            </div>
        </div>

        <!-- Streamlined Tabs Navigation -->
        <div class="modern-tabs slide-up">
            <div class="tab-nav">
                <button class="tab-button {% if active_tab == 'upload-marks' %}active{% endif %}" onclick="switchMainTab('upload-marks')">
                    <i class="fas fa-upload"></i>
                    <span>Upload Marks</span>
                    <div class="tab-indicator"></div>
                </button>
                <button class="tab-button {% if active_tab == 'generate-marksheet' %}active{% endif %}" onclick="switchMainTab('generate-marksheet')">
                    <i class="fas fa-file-pdf"></i>
                    <span>Generate Reports</span>
                    <div class="tab-indicator"></div>
                </button>
                <button class="tab-button {% if active_tab == 'recent-reports' %}active{% endif %}" onclick="switchMainTab('recent-reports')">
                    <i class="fas fa-chart-line"></i>
                    <span>View Reports</span>
                    <div class="tab-indicator"></div>
                </button>
            </div>
        </div>

        <!-- PRIMARY WORKFLOW SECTION (Always Visible) -->
        <div class="primary-workflow-section slide-up">
            <div class="workflow-header">
                <h2><i class="fas fa-rocket"></i> Daily Tasks</h2>
                <p>Your most frequently used class teacher functions</p>
            </div>

            <!-- Primary Action Cards -->
            <div class="primary-actions-grid">
                <div class="primary-action-card" onclick="switchMainTab('upload-marks')">
                    <div class="action-icon primary">
                        <i class="fas fa-upload"></i>
                    </div>
                    <div class="action-content">
                        <h3>Upload Marks</h3>
                        <p>Add student marks for your class</p>
                        <span class="action-badge">Most Used</span>
                    </div>
                </div>

                <div class="primary-action-card" onclick="switchMainTab('generate-marksheet')">
                    <div class="action-icon secondary">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="action-content">
                        <h3>Generate Reports</h3>
                        <p>Create class marksheets and reports</p>
                        <span class="action-badge">Essential</span>
                    </div>
                </div>

                <div class="primary-action-card" onclick="window.location.href='{{ url_for('classteacher.analytics_dashboard') }}'">
                    <div class="action-icon tertiary">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="action-content">
                        <h3>Class Analytics</h3>
                        <p>View performance insights</p>
                        <span class="action-badge">Insights</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECONDARY FEATURES (Collapsible Sections) -->
        <div class="secondary-features-container slide-up">
            
            <!-- Advanced Features Section -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection('advanced-features')">
                    <h3><i class="fas fa-cogs"></i> Advanced Features</h3>
                    <i class="fas fa-chevron-down toggle-icon" id="advanced-features-icon"></i>
                </div>
                <div class="section-content collapsed" id="advanced-features">
                    <div class="feature-grid">
                        <a href="{{ url_for('classteacher.collaborative_marks_dashboard') }}" class="feature-card">
                            <i class="fas fa-users"></i>
                            <h4>Collaborative Marks</h4>
                            <p>Multi-teacher upload system</p>
                        </a>
                        <a href="{{ url_for('classteacher.grade_reports_dashboard') }}" class="feature-card">
                            <i class="fas fa-layer-group"></i>
                            <h4>Grade Reports</h4>
                            <p>Multi-stream analysis</p>
                        </a>
                        <a href="#" onclick="return downloadTemplate()" class="feature-card">
                            <i class="fas fa-download"></i>
                            <h4>Templates</h4>
                            <p>Download upload templates</p>
                        </a>
                    </div>
                </div>
            </div>

            <!-- System Management Section -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection('system-management')">
                    <h3><i class="fas fa-tools"></i> System Management</h3>
                    <i class="fas fa-chevron-down toggle-icon" id="system-management-icon"></i>
                </div>
                <div class="section-content collapsed" id="system-management">
                    <div class="feature-grid">
                        <a href="{{ url_for('classteacher.manage_students') }}" class="feature-card">
                            <i class="fas fa-user-graduate"></i>
                            <h4>Manage Students</h4>
                            <p>Add, edit student records</p>
                        </a>
                        <a href="{{ url_for('classteacher.manage_grades_streams') }}" class="feature-card">
                            <i class="fas fa-layer-group"></i>
                            <h4>Grades & Streams</h4>
                            <p>Configure class structure</p>
                        </a>
                        <a href="{{ url_for('classteacher.report_configuration') }}" class="feature-card">
                            <i class="fas fa-cog"></i>
                            <h4>Report Config</h4>
                            <p>Setup report parameters</p>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Access Section -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection('quick-access')">
                    <h3><i class="fas fa-bolt"></i> Quick Access</h3>
                    <i class="fas fa-chevron-down toggle-icon" id="quick-access-icon"></i>
                </div>
                <div class="section-content collapsed" id="quick-access">
                    <div class="feature-grid">
                        <a href="{{ url_for('classteacher.all_reports') }}" class="feature-card">
                            <i class="fas fa-chart-bar"></i>
                            <h4>All Reports</h4>
                            <p>Browse all generated reports</p>
                        </a>
                        <a href="{{ url_for('classteacher.manage_terms_assessments') }}" class="feature-card">
                            <i class="fas fa-calendar-alt"></i>
                            <h4>Terms & Assessments</h4>
                            <p>Academic periods setup</p>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modern Recent Reports Tab Content -->
        <div id="recent-reports-tab" class="tab-content-container {% if active_tab == 'recent-reports' %}active{% endif %}">
            <div class="modern-card slide-up">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-line card-icon"></i>
                        Recent Reports
                    </h2>
                    <div class="card-actions">
                        <a href="{{ url_for('classteacher.view_all_reports') }}" class="modern-btn btn-outline">
                            <i class="fas fa-external-link-alt"></i>
                            View All
                        </a>
                    </div>
                </div>

                <!-- Modern Filter Controls -->
                <div class="modern-form" style="background: var(--gray-50); padding: var(--space-6); border-radius: var(--radius-lg); margin-bottom: var(--space-6);">
                    <div class="modern-grid grid-cols-4">
                        <div class="form-group">
                            <label for="sort-reports" class="form-label">Sort by</label>
                            <select id="sort-reports" onchange="sortReports(this.value)" class="form-select">
                                <option value="date" {% if request.args.get('sort') == 'date' or not request.args.get('sort') %}selected{% endif %}>Date (newest first)</option>
                                <option value="grade" {% if request.args.get('sort') == 'grade' %}selected{% endif %}>Grade</option>
                                <option value="term" {% if request.args.get('sort') == 'term' %}selected{% endif %}>Term</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="filter-grade" class="form-label">Grade</label>
                            <select id="filter-grade" onchange="filterReports()" class="form-select">
                                <option value="">All Grades</option>
                                {% for grade_option in grades %}
                                <option value="{{ grade_option }}" {% if request.args.get('filter_grade') == grade_option %}selected{% endif %}>{{ grade_option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="filter-term" class="form-label">Term</label>
                            <select id="filter-term" onchange="filterReports()" class="form-select">
                                <option value="">All Terms</option>
                                {% for term_option in terms %}
                                <option value="{{ term_option }}" {% if request.args.get('filter_term') == term_option %}selected{% endif %}>{{ term_option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <button onclick="resetFilters()" class="modern-btn btn-outline">
                                <i class="fas fa-undo"></i>
                                Reset Filters
                            </button>
                        </div>
                    </div>
                </div>

                <div class="modern-table-container">
                    <table class="modern-table recent-reports-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> ID</th>
                                <th><i class="fas fa-layer-group"></i> Grade</th>
                                <th><i class="fas fa-stream"></i> Stream</th>
                                <th><i class="fas fa-calendar"></i> Term</th>
                                <th><i class="fas fa-clipboard-check"></i> Assessment</th>
                                <th><i class="fas fa-clock"></i> Date</th>
                                <th><i class="fas fa-chart-bar"></i> Marks</th>
                                <th><i class="fas fa-cogs"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if recent_reports %}
                            {% for report in recent_reports %}
                            <tr>
                                <td><strong>{{ report.id }}</strong></td>
                                <td>
                                    <span class="modern-badge badge-info">{{ report.grade }}</span>
                                </td>
                                <td>
                                    <span class="modern-badge badge-success">{{ report.stream }}</span>
                                </td>
                                <td>{{ report.term.replace('_', ' ').title() }}</td>
                                <td>{{ report.assessment_type.replace('_', ' ').title() }}</td>
                                <td>{{ report.date }}</td>
                                <td>
                                    <span class="modern-badge badge-warning">
                                        <i class="fas fa-chart-line"></i>
                                        {{ report.mark_count }} marks
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                                        <a href="{{ url_for('classteacher.edit_class_marks', grade=report.grade, stream=report.stream, term=report.term, assessment_type=report.assessment_type) }}"
                                           class="modern-btn btn-primary" style="font-size: 0.75rem; padding: var(--space-2) var(--space-3);" title="Edit marks">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('classteacher.preview_class_report', grade=report.grade, stream=report.stream, term=report.term, assessment_type=report.assessment_type) }}"
                                           class="modern-btn btn-success" style="font-size: 0.75rem; padding: var(--space-2) var(--space-3);" title="View report">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('classteacher.preview_class_report', grade=report.grade, stream=report.stream, term=report.term, assessment_type=report.assessment_type) }}"
                                           class="modern-btn btn-warning" style="font-size: 0.75rem; padding: var(--space-2) var(--space-3);" title="Print report">
                                            <i class="fas fa-print"></i>
                                        </a>
                                        <button onclick="confirmDeleteReport('{{ report.grade }}', '{{ report.stream }}', '{{ report.term }}', '{{ report.assessment_type }}')"
                                                class="modern-btn btn-danger" style="font-size: 0.75rem; padding: var(--space-2) var(--space-3);" title="Delete report">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="8" style="text-align: center; padding: var(--space-16);">
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: var(--space-4);">
                                        <i class="fas fa-chart-line" style="font-size: 3rem; color: var(--gray-400);"></i>
                                        <h3 style="margin: 0; color: var(--gray-600);">No reports available</h3>
                                        <p style="margin: 0; color: var(--gray-500);">Upload marks to generate reports</p>
                                        <a href="#" onclick="switchMainTab('upload-marks')" class="modern-btn btn-primary">
                                            <i class="fas fa-plus"></i>
                                            Upload Marks
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modern Upload Marks Tab Content -->
        <div id="upload-marks-tab" class="tab-content-container {% if active_tab == 'upload-marks' %}active{% endif %}">
            <div id="upload-marks-section" class="modern-card slide-up">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-upload card-icon"></i>
                        Upload Class Marks
                        {% if portal_summary %}
                            <small style="font-weight: normal; color: #666; margin-left: 10px;">
                                ({{ portal_summary.portal_type }} - {{ portal_summary.total_classes }} classes, {{ portal_summary.total_subjects }} subjects)
                            </small>
                        {% endif %}
                    </h2>
                    <div class="card-actions">
                        {% if portal_summary and portal_summary.is_subject_only_teacher %}
                            <span class="modern-badge badge-warning">Subject Teacher Access</span>
                        {% else %}
                            <span class="modern-badge badge-info">Class Teacher Access</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Multi-Class Assignment Overview -->
                {% if portal_summary and portal_summary.class_assignments %}
                <div class="multi-class-overview">
                    <h4>
                        <i class="fas fa-layer-group me-2"></i>Your Class & Subject Assignments
                    </h4>

                    {% if portal_summary.is_subject_only_teacher %}
                    <div class="info-banner">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Subject Teacher Access:</strong> You can upload marks for your assigned subjects across multiple classes.
                    </div>
                    {% endif %}

                    <div class="class-assignments-grid">
                        {% for class_assignment in portal_summary.class_assignments %}
                        <div class="class-assignment-card">
                            <div class="class-header">
                                <h5>
                                    {{ class_assignment.grade_name }} Stream {{ class_assignment.stream_name }}
                                </h5>
                                {% if class_assignment.is_class_teacher %}
                                    <span class="assignment-type">
                                        CLASS TEACHER
                                    </span>
                                {% else %}
                                    <span class="assignment-type">
                                        SUBJECT TEACHER
                                    </span>
                                {% endif %}
                            </div>

                            <div class="subjects-list">
                                <strong>Subjects ({{ class_assignment.subjects|length }}):</strong>
                                <div class="mt-2">
                                    {% for subject in class_assignment.subjects %}
                                        <span class="subject-tag">
                                            {{ subject.name }}{% if subject.is_composite %} <i class="fas fa-layer-group" title="Composite Subject"></i>{% endif %}
                                        </span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="class-actions">
                                <button onclick="selectClassForUpload('{{ class_assignment.grade_name }}', '{{ class_assignment.stream_name }}', '{{ class_assignment.education_level }}')"
                                        class="modern-btn">
                                    <i class="fas fa-upload me-1"></i> Upload Marks
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

            {% if not show_students %}
            <!-- Enhanced Unified Upload Interface with Flexbox Layout -->
            <div style="background: var(--bg-secondary); padding: var(--space-6); border-radius: var(--radius-lg); margin-bottom: var(--space-6); border: 1px solid var(--glass-border);">
                <!-- Premium Header with Improved Spacing -->
                <div style="display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-8); padding-bottom: var(--space-4); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <div style="background: linear-gradient(135deg, #268bd2 0%, #2aa198 100%); padding: var(--space-4); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-upload" style="color: var(--text-white); font-size: 1.2rem;"></i>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0; color: var(--primary-color); font-size: 1.4rem; font-weight: 700; line-height: 1.2;">
                            Student Marks Upload System
                        </h3>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 1rem; margin-top: var(--space-2); line-height: 1.4;">
                            Choose between manual entry or bulk upload for efficient marks management
                        </p>
                    </div>
                </div>

                <!-- Enhanced Tab Navigation with Flexbox -->
                <div class="modern-tabs" style="margin-bottom: var(--space-8);">
                    <div class="tab-nav" style="background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-radius: var(--radius-lg); padding: var(--space-3); border: 1px solid rgba(40, 139, 210, 0.2); display: flex; gap: var(--space-2);">
                        <button class="tab-button active" data-tab="manual-entry" style="flex: 1; padding: var(--space-4) var(--space-6); border: none; background: linear-gradient(135deg, #268bd2 0%, #2aa198 100%); color: var(--text-white); border-radius: var(--radius-md); font-weight: 600; font-size: 1rem; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: var(--space-3); min-height: 60px;">
                            <i class="fas fa-keyboard" style="font-size: 1.1rem;"></i>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: var(--space-1);">
                                <span>Manual Entry</span>
                                <span style="background: rgba(255, 255, 255, 0.2); padding: 2px 8px; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 500;">RECOMMENDED</span>
                            </div>
                        </button>
                        <button class="tab-button" data-tab="bulk-upload" style="flex: 1; padding: var(--space-4) var(--space-6); border: none; background: transparent; color: var(--text-secondary); border-radius: var(--radius-md); font-weight: 600; font-size: 1rem; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: var(--space-3); min-height: 60px;">
                            <i class="fas fa-file-upload" style="font-size: 1.1rem;"></i>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: var(--space-1);">
                                <span>Bulk Upload</span>
                                <span style="background: rgba(42, 161, 152, 0.1); color: #2aa198; padding: 2px 8px; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 500;">EXCEL/CSV</span>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- Enhanced Configuration Section with Better Flexbox Layout -->
                <div class="unified-form-fields" style="background: linear-gradient(135deg, rgba(40, 139, 210, 0.05) 0%, rgba(42, 161, 152, 0.05) 100%); padding: var(--space-6); border-radius: var(--radius-lg); margin-bottom: var(--space-8); border: 1px solid rgba(40, 139, 210, 0.15);">
                    <!-- Configuration Header -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-6); padding-bottom: var(--space-3); border-bottom: 1px solid rgba(40, 139, 210, 0.1);">
                        <div style="display: flex; align-items: center; gap: var(--space-3);">
                            <div style="background: linear-gradient(135deg, #b58900 0%, #dc322f 100%); padding: var(--space-3); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-cog" style="color: var(--text-white); font-size: 1rem;"></i>
                            </div>
                            <div>
                                <h4 style="margin: 0; color: var(--text-primary); font-size: 1.2rem; font-weight: 600;">
                                    Upload Configuration
                                </h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem; margin-top: var(--space-1);">
                                    Configure settings for both upload methods
                                </p>
                            </div>
                        </div>
                        <span style="background: rgba(181, 137, 0, 0.1); color: #b58900; padding: var(--space-2) var(--space-3); border-radius: var(--radius-full); font-size: 0.8rem; font-weight: 600;">REQUIRED FIELDS</span>
                    </div>

                    <!-- Improved Form Grid with Better Spacing -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-5);">
                        <!-- Education Level -->
                        <div class="form-group" style="display: flex; flex-direction: column; gap: var(--space-2);">
                            <label for="education_level" class="form-label" style="display: flex; align-items: center; gap: var(--space-2); font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">
                                <i class="fas fa-graduation-cap" style="color: #268bd2; font-size: 1rem;"></i>
                                <span>Education Level</span>
                                <span style="color: #dc322f; font-size: 0.9rem;">*</span>
                            </label>
                            <div style="position: relative;">
                                <select id="education_level" name="education_level" required onchange="updateSubjects()" class="form-select" style="width: 100%; background: var(--bg-white); border: 2px solid rgba(40, 139, 210, 0.2); border-radius: var(--radius-md); padding: var(--space-4); font-size: 0.95rem; transition: all 0.3s ease; appearance: none;">
                                    <option value="">Select Education Level</option>
                                    <option value="lower_primary" {% if education_level == 'lower_primary' %}selected{% endif %}>Lower Primary</option>
                                    <option value="upper_primary" {% if education_level == 'upper_primary' %}selected{% endif %}>Upper Primary</option>
                                    <option value="junior_secondary" {% if education_level == 'junior_secondary' %}selected{% endif %}>Junior Secondary</option>
                                </select>
                                <div style="position: absolute; top: 50%; right: 16px; transform: translateY(-50%); pointer-events: none;">
                                    <i class="fas fa-chevron-down" style="color: var(--text-muted); font-size: 0.8rem;"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Academic Term -->
                        <div class="form-group" style="display: flex; flex-direction: column; gap: var(--space-2);">
                            <label for="term" class="form-label" style="display: flex; align-items: center; gap: var(--space-2); font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">
                                <i class="fas fa-calendar-alt" style="color: #2aa198; font-size: 1rem;"></i>
                                <span>Academic Term</span>
                                <span style="color: #dc322f; font-size: 0.9rem;">*</span>
                            </label>
                            <div style="position: relative;">
                                <select id="term" name="term" required class="form-select" style="width: 100%; background: var(--bg-white); border: 2px solid rgba(42, 161, 152, 0.2); border-radius: var(--radius-md); padding: var(--space-4); font-size: 0.95rem; transition: all 0.3s ease; appearance: none;">
                                    <option value="">Select Term</option>
                                    {% for term_option in terms %}
                                    <option value="{{ term_option }}" {% if term == term_option %}selected{% endif %}>{{ term_option.replace('_', ' ').title() }}</option>
                                    {% endfor %}
                                </select>
                                <div style="position: absolute; top: 50%; right: 16px; transform: translateY(-50%); pointer-events: none;">
                                    <i class="fas fa-chevron-down" style="color: var(--text-muted); font-size: 0.8rem;"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Assessment Type -->
                        <div class="form-group" style="display: flex; flex-direction: column; gap: var(--space-2);">
                            <label for="assessment_type" class="form-label" style="display: flex; align-items: center; gap: var(--space-2); font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">
                                <i class="fas fa-clipboard-check" style="color: #b58900; font-size: 1rem;"></i>
                                <span>Assessment Type</span>
                                <span style="color: #dc322f; font-size: 0.9rem;">*</span>
                            </label>
                            <div style="position: relative;">
                                <select id="assessment_type" name="assessment_type" required class="form-select" style="width: 100%; background: var(--bg-white); border: 2px solid rgba(181, 137, 0, 0.2); border-radius: var(--radius-md); padding: var(--space-4); font-size: 0.95rem; transition: all 0.3s ease; appearance: none;">
                                    <option value="">Select Assessment Type</option>
                                    {% for assessment_option in assessment_types %}
                                    <option value="{{ assessment_option }}" {% if assessment_type == assessment_option %}selected{% endif %}>{{ assessment_option.replace('_', ' ').title() }}</option>
                                    {% endfor %}
                                </select>
                                <div style="position: absolute; top: 50%; right: 16px; transform: translateY(-50%); pointer-events: none;">
                                    <i class="fas fa-chevron-down" style="color: var(--text-muted); font-size: 0.8rem;"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Grade Level -->
                        <div class="form-group" style="display: flex; flex-direction: column; gap: var(--space-2);">
                            <label for="grade" class="form-label" style="display: flex; align-items: center; gap: var(--space-2); font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">
                                <i class="fas fa-layer-group" style="color: #dc322f; font-size: 1rem;"></i>
                                <span>Grade Level</span>
                                <span style="color: #dc322f; font-size: 0.9rem;">*</span>
                            </label>
                            <div style="position: relative;">
                                <select id="grade" name="grade" required onchange="fetchStreams()" class="form-select" style="width: 100%; background: var(--bg-white); border: 2px solid rgba(220, 50, 47, 0.2); border-radius: var(--radius-md); padding: var(--space-4); font-size: 0.95rem; transition: all 0.3s ease; appearance: none;">
                                    <option value="">Select Grade</option>
                                    {% for grade_option in grades %}
                                    <option value="{{ grade_option }}" {% if grade == grade_option %}selected{% endif %}>{{ grade_option }}</option>
                                    {% endfor %}
                                </select>
                                <div style="position: absolute; top: 50%; right: 16px; transform: translateY(-50%); pointer-events: none;">
                                    <i class="fas fa-chevron-down" style="color: var(--text-muted); font-size: 0.8rem;"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Class Stream -->
                        <div class="form-group" style="display: flex; flex-direction: column; gap: var(--space-2);">
                            <label for="stream" class="form-label" style="display: flex; align-items: center; gap: var(--space-2); font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">
                                <i class="fas fa-stream" style="color: #6c71c4; font-size: 1rem;"></i>
                                <span>Class Stream</span>
                                <span style="color: #dc322f; font-size: 0.9rem;">*</span>
                            </label>
                            <div style="position: relative;">
                                <select id="stream" name="stream" required class="form-select" style="width: 100%; background: var(--bg-white); border: 2px solid rgba(108, 113, 196, 0.2); border-radius: var(--radius-md); padding: var(--space-4); font-size: 0.95rem; transition: all 0.3s ease; appearance: none;">
                                    <option value="">Select Stream</option>
                                    <!-- Streams will be populated dynamically via JavaScript -->
                                </select>
                                <div style="position: absolute; top: 50%; right: 16px; transform: translateY(-50%); pointer-events: none;">
                                    <i class="fas fa-chevron-down" style="color: var(--text-muted); font-size: 0.8rem;"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Status -->
                    <div id="config-status" style="margin-top: var(--space-6); padding: var(--space-4); background: rgba(255, 255, 255, 0.8); border-radius: var(--radius-md); border-left: 4px solid #268bd2;">
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <i class="fas fa-info-circle" style="color: #268bd2;"></i>
                            <span style="font-size: 0.95rem; color: var(--text-secondary); font-weight: 500;">
                                Complete all fields above to proceed with marks upload. Configuration will be applied to both upload methods.
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Premium Tab Content with Better Layout -->
                <div class="tab-content" style="position: relative;">
                    <!-- Enhanced Manual Entry Tab -->
                    <div class="tab-pane active" id="manual-entry" style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%); backdrop-filter: blur(20px); padding: var(--space-8); border-radius: var(--radius-xl); border: 1px solid rgba(40, 139, 210, 0.15); box-shadow: 0 8px 32px rgba(40, 139, 210, 0.1);">
                        <!-- Enhanced Content Header with Animation -->
                        <div style="text-align: center; margin-bottom: var(--space-10); position: relative;">
                            <!-- Decorative Background Elements -->
                            <div style="position: absolute; top: -30px; left: 50%; transform: translateX(-50%); width: 120px; height: 120px; background: radial-gradient(circle, rgba(40, 139, 210, 0.08), transparent); border-radius: 50%; z-index: 0;"></div>
                            <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 80px; height: 80px; background: radial-gradient(circle, rgba(42, 161, 152, 0.1), transparent); border-radius: 50%; z-index: 1;"></div>
                            
                            <!-- Enhanced Icon Container -->
                            <div style="background: linear-gradient(135deg, rgba(40, 139, 210, 0.12) 0%, rgba(42, 161, 152, 0.08) 100%); display: inline-flex; align-items: center; justify-content: center; width: 100px; height: 100px; border-radius: var(--radius-full); margin-bottom: var(--space-6); position: relative; z-index: 2; border: 2px solid rgba(40, 139, 210, 0.2); box-shadow: 0 8px 24px rgba(40, 139, 210, 0.15);">
                                <i class="fas fa-keyboard" style="font-size: 2.5rem; color: #268bd2; filter: drop-shadow(0 2px 4px rgba(40, 139, 210, 0.3));"></i>
                            </div>
                            
                            <!-- Enhanced Title and Description -->
                            <h4 style="color: var(--text-primary); font-size: 1.6rem; font-weight: 800; margin-bottom: var(--space-4); letter-spacing: -0.02em; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);">
                                Manual Marks Entry
                            </h4>
                            <div style="background: linear-gradient(90deg, #268bd2, #2aa198); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: var(--space-4);">
                                Precision â€¢ Control â€¢ Validation
                            </div>
                            <p style="color: var(--text-secondary); font-size: 1.1rem; line-height: 1.7; max-width: 650px; margin: 0 auto; font-weight: 400;">
                                Load students and subjects to begin entering marks individually. This method provides full control over each student's marks with real-time validation and immediate feedback.
                            </p>
                        </div>

                        <form id="upload-form" method="POST" action="{{ url_for('classteacher.dashboard') }}" class="modern-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" id="total_marks" name="total_marks" value="100">

                            <!-- Enhanced Features Grid with Premium Cards -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: var(--space-6); margin-bottom: var(--space-10); max-width: 900px; margin-left: auto; margin-right: auto;">
                                <!-- Real-time Validation Card -->
                                <div style="background: linear-gradient(135deg, rgba(40, 139, 210, 0.08) 0%, rgba(40, 139, 210, 0.02) 100%); padding: var(--space-6); border-radius: var(--radius-lg); border: 1px solid rgba(40, 139, 210, 0.15); position: relative; overflow: hidden; transition: all 0.3s ease; cursor: pointer; box-shadow: 0 4px 16px rgba(40, 139, 210, 0.1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 32px rgba(40, 139, 210, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(40, 139, 210, 0.1)'">
                                    <!-- Card decoration -->
                                    <div style="position: absolute; top: -10px; right: -10px; width: 40px; height: 40px; background: radial-gradient(circle, rgba(40, 139, 210, 0.1), transparent); border-radius: 50%;"></div>
                                    
                                    <!-- Icon and Title -->
                                    <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4);">
                                        <div style="background: linear-gradient(135deg, #268bd2, #2aa198); padding: var(--space-3); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(40, 139, 210, 0.3);">
                                            <i class="fas fa-check-double" style="color: white; font-size: 1.2rem;"></i>
                                        </div>
                                        <div>
                                            <h5 style="margin: 0; font-weight: 700; color: var(--text-primary); font-size: 1.1rem;">Real-time Validation</h5>
                                            <span style="background: rgba(40, 139, 210, 0.1); color: #268bd2; padding: 2px 8px; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 600; text-transform: uppercase;">INSTANT</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Description -->
                                    <p style="margin: 0; font-size: 0.95rem; color: var(--text-secondary); line-height: 1.5;">
                                        Immediate feedback on mark entries with intelligent validation rules and error prevention
                                    </p>
                                    
                                    <!-- Progress indicator -->
                                    <div style="margin-top: var(--space-4); height: 3px; background: rgba(40, 139, 210, 0.1); border-radius: var(--radius-full); overflow: hidden;">
                                        <div style="height: 100%; width: 85%; background: linear-gradient(90deg, #268bd2, #2aa198); border-radius: var(--radius-full);"></div>
                                    </div>
                                </div>

                                <!-- Student-by-Student Card -->
                                <div style="background: linear-gradient(135deg, rgba(42, 161, 152, 0.08) 0%, rgba(42, 161, 152, 0.02) 100%); padding: var(--space-6); border-radius: var(--radius-lg); border: 1px solid rgba(42, 161, 152, 0.15); position: relative; overflow: hidden; transition: all 0.3s ease; cursor: pointer; box-shadow: 0 4px 16px rgba(42, 161, 152, 0.1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 32px rgba(42, 161, 152, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(42, 161, 152, 0.1)'">
                                    <!-- Card decoration -->
                                    <div style="position: absolute; top: -10px; right: -10px; width: 40px; height: 40px; background: radial-gradient(circle, rgba(42, 161, 152, 0.1), transparent); border-radius: 50%;"></div>
                                    
                                    <!-- Icon and Title -->
                                    <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4);">
                                        <div style="background: linear-gradient(135deg, #2aa198, #268bd2); padding: var(--space-3); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(42, 161, 152, 0.3);">
                                            <i class="fas fa-user-check" style="color: white; font-size: 1.2rem;"></i>
                                        </div>
                                        <div>
                                            <h5 style="margin: 0; font-weight: 700; color: var(--text-primary); font-size: 1.1rem;">Student-by-Student</h5>
                                            <span style="background: rgba(42, 161, 152, 0.1); color: #2aa198; padding: 2px 8px; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 600; text-transform: uppercase;">PRECISION</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Description -->
                                    <p style="margin: 0; font-size: 0.95rem; color: var(--text-secondary); line-height: 1.5;">
                                        Individual control over each entry with detailed tracking and personalized validation
                                    </p>
                                    
                                    <!-- Progress indicator -->
                                    <div style="margin-top: var(--space-4); height: 3px; background: rgba(42, 161, 152, 0.1); border-radius: var(--radius-full); overflow: hidden;">
                                        <div style="height: 100%; width: 92%; background: linear-gradient(90deg, #2aa198, #268bd2); border-radius: var(--radius-full);"></div>
                                    </div>
                                </div>

                                <!-- Auto-Save Card -->
                                <div style="background: linear-gradient(135deg, rgba(181, 137, 0, 0.08) 0%, rgba(181, 137, 0, 0.02) 100%); padding: var(--space-6); border-radius: var(--radius-lg); border: 1px solid rgba(181, 137, 0, 0.15); position: relative; overflow: hidden; transition: all 0.3s ease; cursor: pointer; box-shadow: 0 4px 16px rgba(181, 137, 0, 0.1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 32px rgba(181, 137, 0, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(181, 137, 0, 0.1)'">
                                    <!-- Card decoration -->
                                    <div style="position: absolute; top: -10px; right: -10px; width: 40px; height: 40px; background: radial-gradient(circle, rgba(181, 137, 0, 0.1), transparent); border-radius: 50%;"></div>
                                    
                                    <!-- Icon and Title -->
                                    <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4);">
                                        <div style="background: linear-gradient(135deg, #b58900, #dc322f); padding: var(--space-3); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(181, 137, 0, 0.3);">
                                            <i class="fas fa-save" style="color: white; font-size: 1.2rem;"></i>
                                        </div>
                                        <div>
                                            <h5 style="margin: 0; font-weight: 700; color: var(--text-primary); font-size: 1.1rem;">Auto-Save</h5>
                                            <span style="background: rgba(181, 137, 0, 0.1); color: #b58900; padding: 2px 8px; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 600; text-transform: uppercase;">SECURE</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Description -->
                                    <p style="margin: 0; font-size: 0.95rem; color: var(--text-secondary); line-height: 1.5;">
                                        Progress saved automatically with backup protection and recovery options
                                    </p>
                                    
                                    <!-- Progress indicator -->
                                    <div style="margin-top: var(--space-4); height: 3px; background: rgba(181, 137, 0, 0.1); border-radius: var(--radius-full); overflow: hidden;">
                                        <div style="height: 100%; width: 100%; background: linear-gradient(90deg, #b58900, #dc322f); border-radius: var(--radius-full);"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Action Section -->
                            <div style="text-align: center; margin-top: var(--space-8);">
                                <!-- Pre-action Information -->
                                <div style="background: linear-gradient(135deg, rgba(40, 139, 210, 0.05) 0%, rgba(42, 161, 152, 0.05) 100%); padding: var(--space-5); border-radius: var(--radius-lg); margin-bottom: var(--space-6); border: 1px solid rgba(40, 139, 210, 0.1); max-width: 600px; margin-left: auto; margin-right: auto;">
                                    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-3); margin-bottom: var(--space-3);">
                                        <i class="fas fa-info-circle" style="color: #268bd2; font-size: 1.1rem;"></i>
                                        <span style="font-weight: 600; color: var(--text-primary); font-size: 1rem;">Ready to Start?</span>
                                    </div>
                                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                                        Ensure all configuration fields above are completed before loading students and subjects
                                    </p>
                                </div>

                                <!-- Enhanced Action Button -->
                                <button type="submit" name="upload_marks" value="1" class="modern-btn btn-primary" id="upload-btn" style="padding: var(--space-6) var(--space-10); font-size: 1.2rem; font-weight: 700; background: linear-gradient(135deg, #268bd2 0%, #2aa198 100%); border: none; border-radius: var(--radius-xl); color: var(--text-white); cursor: pointer; transition: all 0.4s ease; box-shadow: 0 8px 32px rgba(40, 139, 210, 0.3); min-width: 300px; display: inline-flex; align-items: center; justify-content: center; gap: var(--space-4); position: relative; overflow: hidden; text-transform: uppercase; letter-spacing: 0.05em;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 40px rgba(40, 139, 210, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(40, 139, 210, 0.3)'">
                                    <!-- Button shine effect -->
                                    <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); transition: left 0.6s ease;"></div>
                                    
                                    <i class="fas fa-users" style="font-size: 1.3rem; z-index: 1;"></i>
                                    <span style="z-index: 1;">Load Students & Subjects</span>
                                    <i class="fas fa-arrow-right" style="font-size: 1rem; z-index: 1; transition: transform 0.3s ease;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'"></i>
                                </button>

                                <!-- Helper Text -->
                                <p style="margin-top: var(--space-4); color: var(--text-muted); font-size: 0.85rem; max-width: 500px; margin-left: auto; margin-right: auto;">
                                    <i class="fas fa-lightbulb" style="color: #b58900; margin-right: var(--space-2);"></i>
                                    This will load the interface for manual mark entry based on your configuration above
                                </p>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Enhanced Bulk Upload Tab -->
                    <div class="tab-pane" id="bulk-upload" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); padding: var(--space-8); border-radius: var(--radius-lg); border: 1px solid rgba(42, 161, 152, 0.15);">
                        <!-- Content Header -->
                        <div style="text-align: center; margin-bottom: var(--space-8);">
                            <div style="background: linear-gradient(135deg, rgba(42, 161, 152, 0.1) 0%, rgba(181, 137, 0, 0.1) 100%); display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; border-radius: var(--radius-full); margin-bottom: var(--space-4);">
                                <i class="fas fa-file-upload" style="font-size: 2rem; color: #2aa198;"></i>
                            </div>
                            <h4 style="color: var(--text-primary); font-size: 1.3rem; font-weight: 700; margin-bottom: var(--space-3);">
                                Bulk Upload System
                            </h4>
                            <p style="color: var(--text-secondary); font-size: 1rem; line-height: 1.6; max-width: 600px; margin: 0 auto;">
                                Upload marks for multiple students at once using Excel or CSV files. Perfect for efficient large-scale mark entry with data validation.
                            </p>
                        </div>

                        <form id="bulk-upload-form" method="POST" action="{{ url_for('classteacher.dashboard') }}" class="modern-form" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" id="bulk_total_marks" name="total_marks" value="100">

                            <!-- Enhanced File Upload Section with Better Layout -->
                            <div class="file-upload-container" style="margin-bottom: var(--space-8);">
                                <!-- Configuration Reminder -->
                                <div id="config-reminder" style="background: linear-gradient(135deg, rgba(181, 137, 0, 0.1) 0%, rgba(220, 50, 47, 0.1) 100%); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-6); border-left: 4px solid #b58900; display: block;">
                                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                                        <i class="fas fa-exclamation-triangle" style="color: #b58900; font-size: 1.1rem;"></i>
                                        <div>
                                            <p style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">Configuration Required</p>
                                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.85rem; margin-top: var(--space-1);">
                                                Please complete the Upload Configuration section above before downloading template or uploading files.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div class="drag-drop-area" onclick="document.getElementById('marks_file').click()" style="background: linear-gradient(135deg, rgba(42, 161, 152, 0.05) 0%, rgba(181, 137, 0, 0.05) 100%); border: 3px dashed rgba(42, 161, 152, 0.3); border-radius: var(--radius-lg); padding: var(--space-8); text-align: center; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px;">
                                    <!-- Decorative elements -->
                                    <div style="position: absolute; top: -20px; right: -20px; width: 40px; height: 40px; background: radial-gradient(circle, rgba(42, 161, 152, 0.1), transparent); opacity: 0.7;"></div>
                                    <div style="position: absolute; bottom: -20px; left: -20px; width: 60px; height: 60px; background: radial-gradient(circle, rgba(181, 137, 0, 0.1), transparent); opacity: 0.5;"></div>
                                    
                                    <div class="file-upload-icon" style="margin-bottom: var(--space-4); position: relative; z-index: 1;">
                                        <div style="background: linear-gradient(135deg, #2aa198 0%, #b58900 100%); display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; border-radius: var(--radius-full); margin-bottom: var(--space-4);">
                                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--text-white);"></i>
                                        </div>
                                    </div>
                                    <h3 style="margin: 0 0 var(--space-3) 0; color: var(--text-primary); font-size: 1.2rem; font-weight: 600;">
                                        Drop marks file here or click to upload
                                    </h3>
                                    <p class="file-upload-text" style="margin: 0 0 var(--space-4) 0; color: var(--text-secondary); font-size: 1rem;">
                                        Supports: Excel (.xlsx, .xls), CSV files
                                    </p>
                                    
                                    <!-- File format badges -->
                                    <div style="display: flex; justify-content: center; gap: var(--space-3); margin-top: var(--space-4);">
                                        <span style="background: rgba(42, 161, 152, 0.1); color: #2aa198; padding: var(--space-2) var(--space-3); border-radius: var(--radius-full); font-size: 0.8rem; font-weight: 600; border: 1px solid rgba(42, 161, 152, 0.2);">XLSX</span>
                                        <span style="background: rgba(181, 137, 0, 0.1); color: #b58900; padding: var(--space-2) var(--space-3); border-radius: var(--radius-full); font-size: 0.8rem; font-weight: 600; border: 1px solid rgba(181, 137, 0, 0.2);">XLS</span>
                                        <span style="background: rgba(40, 139, 210, 0.1); color: #268bd2; padding: var(--space-2) var(--space-3); border-radius: var(--radius-full); font-size: 0.8rem; font-weight: 600; border: 1px solid rgba(40, 139, 210, 0.2);">CSV</span>
                                    </div>
                                    
                                    <input type="file" id="marks_file" name="marks_file" accept=".xlsx,.xls,.csv" required style="display: none;">
                                </div>

                                <!-- File Requirements with Better Layout -->
                                <div class="file-restrictions" style="background: rgba(40, 139, 210, 0.1); padding: var(--space-5); border-radius: var(--radius-md); margin-top: var(--space-5); border-left: 4px solid #268bd2;">
                                    <div style="display: flex; align-items: flex-start; gap: var(--space-4);">
                                        <div style="flex-shrink: 0; background: rgba(40, 139, 210, 0.2); padding: var(--space-2); border-radius: var(--radius-full);">
                                            <i class="fas fa-info-circle" style="color: #268bd2; font-size: 1rem;"></i>
                                        </div>
                                        <div style="flex: 1;">
                                            <p style="margin: 0 0 var(--space-3) 0; font-weight: 600; color: var(--text-primary); font-size: 1rem;">File Requirements:</p>
                                            <ul style="margin: 0; padding-left: var(--space-4); color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6;">
                                                <li style="margin-bottom: var(--space-1);">Excel or CSV format with student names/admission numbers as rows</li>
                                                <li style="margin-bottom: var(--space-1);">Subject names as column headers</li>
                                                <li style="margin-bottom: var(--space-1);">Marks should be numeric values only</li>
                                                <li>Maximum file size: 10MB</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Selected File Display -->
                                <div id="bulk-file-list" class="file-list" style="display: none; margin-top: var(--space-5);">
                                    <!-- Selected files will appear here -->
                                </div>
                            </div>

                            <!-- Features Grid with Improved Flexbox -->
                            <div style="display: flex; flex-wrap: wrap; gap: var(--space-4); margin-bottom: var(--space-8); justify-content: center;">
                                <div style="flex: 1; min-width: 200px; max-width: 250px; background: rgba(42, 161, 152, 0.1); padding: var(--space-5); border-radius: var(--radius-md); border: 1px solid rgba(42, 161, 152, 0.2); text-align: center;">
                                    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-2); margin-bottom: var(--space-3);">
                                        <i class="fas fa-tachometer-alt" style="color: #2aa198; font-size: 1.1rem;"></i>
                                        <span style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">Fast Processing</span>
                                    </div>
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">
                                        Upload hundreds of marks instantly
                                    </p>
                                </div>
                                <div style="flex: 1; min-width: 200px; max-width: 250px; background: rgba(181, 137, 0, 0.1); padding: var(--space-5); border-radius: var(--radius-md); border: 1px solid rgba(181, 137, 0, 0.2); text-align: center;">
                                    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-2); margin-bottom: var(--space-3);">
                                        <i class="fas fa-shield-alt" style="color: #b58900; font-size: 1.1rem;"></i>
                                        <span style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">Data Validation</span>
                                    </div>
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">
                                        Automatic error detection & correction
                                    </p>
                                </div>
                                <div style="flex: 1; min-width: 200px; max-width: 250px; background: rgba(40, 139, 210, 0.1); padding: var(--space-5); border-radius: var(--radius-md); border: 1px solid rgba(40, 139, 210, 0.2); text-align: center;">
                                    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-2); margin-bottom: var(--space-3);">
                                        <i class="fas fa-file-excel" style="color: #268bd2; font-size: 1.1rem;"></i>
                                        <span style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">Format Support</span>
                                    </div>
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">
                                        Excel, CSV, and other formats
                                    </p>
                                </div>
                            </div>

                            <!-- Action Buttons with Better Flexbox Layout -->
                            <div style="display: flex; gap: var(--space-4); justify-content: center; align-items: center; flex-wrap: wrap;">
                                <button type="button" class="modern-btn btn-outline" onclick="return downloadTemplate()" style="flex: 1; min-width: 200px; max-width: 250px; padding: var(--space-5); font-size: 1rem; font-weight: 600; border: 2px solid #2aa198; color: #2aa198; background: transparent; border-radius: var(--radius-lg); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: var(--space-3);">
                                    <i class="fas fa-download" style="font-size: 1rem;"></i>
                                    <span>Download Template</span>
                                </button>
                                <button type="submit" name="bulk_upload_marks" value="1" class="modern-btn btn-primary" id="bulk-upload-btn" style="flex: 1; min-width: 200px; max-width: 250px; padding: var(--space-5); font-size: 1rem; font-weight: 600; background: linear-gradient(135deg, #2aa198 0%, #b58900 100%); border: none; border-radius: var(--radius-lg); color: var(--text-white); cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(42, 161, 152, 0.3); display: flex; align-items: center; justify-content: center; gap: var(--space-3);">
                                    <i class="fas fa-upload" style="font-size: 1rem;"></i>
                                    <span>Upload Marks</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Form for entering student marks for all subjects -->
            <div id="pupils-list" class="pupils-list" style="grid-column: span 2;">
                <h3>Enter Marks for Grade {{ grade }} Stream {{ stream }} - All Subjects</h3>

                <form id="marks-form" method="POST" action="{{ url_for('classteacher.dashboard') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <!-- Keep existing form fields as hidden fields -->
                    <input type="hidden" name="education_level" value="{{ education_level }}">
                    <input type="hidden" name="grade" value="{{ grade }}">
                    <input type="hidden" name="stream" value="{{ stream }}">
                    <input type="hidden" name="term" value="{{ term }}">
                    <input type="hidden" name="assessment_type" value="{{ assessment_type }}">
                    <input type="hidden" name="total_marks" value="{{ total_marks }}">

                    <!-- Subject Upload Status Dashboard -->
                    {% if session.get('all_subjects_status') %}
                    <div class="subject-status-dashboard">
                        <h4><i class="fas fa-chart-bar me-2"></i>Subject Upload Status Overview</h4>
                        <p class="help-text">View which subjects have been uploaded and by whom. You can only upload subjects assigned to you.</p>

                        <div class="status-grid">
                            {% for subject_info in session.get('all_subjects_status', []) %}
                            <div class="status-card {% if subject_info.assigned_to_me %}assigned-to-me{% endif %}">

                                <div class="status-header">
                                    <h5>{{ subject_info.name }}</h5>
                                    {% if subject_info.assigned_to_me %}
                                        <span class="assignment-badge">
                                            ASSIGNED TO YOU
                                        </span>
                                    {% endif %}
                                </div>

                                <div class="status-info">
                                    {% if subject_info.upload_status == 'uploaded_by_me' %}
                                        <div class="status-item">
                                            âœ… Uploaded by you
                                        </div>
                                        <div class="marks-count">
                                            {{ subject_info.marks_count }} student marks
                                        </div>
                                    {% elif subject_info.upload_status == 'uploaded_by_subject_teacher' %}
                                        <div class="status-item">
                                            âœ… Uploaded by {{ subject_info.uploaded_by.username if subject_info.uploaded_by else 'Subject Teacher' }}
                                        </div>
                                        <div class="marks-count">
                                            {{ subject_info.marks_count }} student marks
                                        </div>
                                    {% elif subject_info.upload_status == 'not_uploaded' %}
                                        <div class="status-item">
                                            âš ï¸ Not uploaded yet
                                        </div>
                                        {% if subject_info.assigned_to_me %}
                                            <div class="action-hint">
                                                You can upload this subject below
                                            </div>
                                        {% else %}
                                            <div class="action-hint">
                                                Waiting for subject teacher
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="status-legend">
                            <strong>Legend:</strong> Blue cards indicate subjects assigned to you. Gray cards are handled by other subject teachers.
                        </div>
                    </div>
                    {% endif %}

                    <!-- Subject Selection and Total Marks Configuration Section -->
                    <div class="subject-marks-config">
                        <h4>Select Your Assigned Subjects and Set Maximum Raw Marks</h4>
                        <p class="help-text">
                            <strong>ðŸ“š Flexible Subject Upload:</strong> Only subjects assigned to you are shown below.
                            This reduces your workload by allowing you to upload only the subjects you teach.
                            Subject teachers will upload their own subjects separately.
                        </p>

                        <div class="subject-selection-header">
                            <h5>Subject Selection</h5>
                            <div class="selection-controls">
                                <button type="button" class="btn-sm" onclick="selectAllSubjects()">Select All</button>
                                <button type="button" class="btn-sm" onclick="deselectAllSubjects()">Deselect All</button>
                            </div>
                        </div>
                        <p class="help-text">
                            Check the subjects you want to upload marks for. Only your assigned subjects are shown.
                            Upload status indicators show which subjects have already been uploaded.
                        </p>

                        <div class="subject-marks-grid">
                            {% for subject in subjects %}
                            <div class="subject-mark-item {% if subject.is_composite %}composite-subject-item{% endif %}">
                                <div class="subject-selection">
                                    <input
                                        type="checkbox"
                                        id="include_subject_{{ loop.index0 }}"
                                        name="include_subject_{{ loop.index0 }}"
                                        value="{{ subject.id }}"
                                        checked
                                        class="subject-checkbox"
                                        data-subject-id="{{ subject.id }}"
                                        data-is-composite="{{ 'true' if subject.is_composite else 'false' }}"
                                        onchange="toggleSubjectVisibility(this, '{{ subject.id }}')"
                                    >
                                    <label for="include_subject_{{ loop.index0 }}" class="checkbox-label">
                                        {{ subject.name }}
                                        {% if subject.upload_status %}
                                            {% if subject.upload_status == 'uploaded_by_me' %}
                                                <span class="upload-status uploaded-by-me" title="You have uploaded marks for this subject">
                                                    âœ“ Uploaded by you
                                                </span>
                                            {% elif subject.upload_status == 'uploaded_by_subject_teacher' %}
                                                <span class="upload-status uploaded-by-other" title="Subject teacher has uploaded marks">
                                                    âœ“ Uploaded by {{ subject.uploaded_by.username if subject.uploaded_by else 'Subject Teacher' }}
                                                </span>
                                            {% elif subject.upload_status == 'not_uploaded' %}
                                                <span class="upload-status not-uploaded" title="No marks uploaded yet">
                                                    âš  Not uploaded
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                    </label>
                                </div>

                                {% if subject.is_composite %}
                                <div class="composite-marks-container">
                                    <div class="composite-marks-header">
                                        <span>Component Distribution</span>
                                        <small>Total: <span id="total_composite_{{ loop.index0 }}">{{ total_marks }}</span></small>
                                    </div>

                                    {% set subject_index = loop.index0 %}
                                    {% set components = subject.get_components() %}
                                    <div class="component-grid">
                                        {% for component in components %}
                                        <div class="component-marks-row">
                                            <label for="component_marks_{{ subject_index }}_{{ component.id }}" class="component-label">{{ component.name }}:</label>
                                            <div class="component-marks-input">
                                                <input
                                                    type="number"
                                                    id="component_marks_{{ subject_index }}_{{ component.id }}"
                                                    name="component_max_marks_{{ subject_index }}_{{ component.id }}"
                                                    value="{{ component.max_raw_mark or 100 }}"
                                                    min="1"
                                                    max="100"
                                                    class="component-max-marks"
                                                    data-subject="{{ subject.id }}"
                                                    data-component="{{ component.id }}"
                                                    data-subject-index="{{ subject_index }}"
                                                    data-component-weight="{{ component.weight }}"
                                                    onchange="validateMaxMarks(this); updateComponentMaxMarks('{{ subject.id }}', '{{ component.id }}', this)"
                                                    oninput="validateMaxMarks(this)"
                                                    title="Maximum raw marks for {{ component.name }} component (Max: 100)"
                                                    onchange="updateComponentMaxMarks('{{ subject.id }}', '{{ component.id }}', this)"
                                                >
                                                <span class="component-weight">{{ component.name }}</span>
                                                <small class="component-proportion" id="proportion_{{ subject.id }}_{{ component.id }}" style="color: #666; font-size: 11px; display: block;">
                                                    Weight: calculating...
                                                </small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>

                                    <input
                                        type="hidden"
                                        id="total_marks_{{ loop.index0 }}"
                                        name="total_marks_{{ loop.index0 }}"
                                        value="{{ total_marks }}"
                                        data-subject="{{ subject.id }}"
                                    >
                                </div>
                                {% else %}
                                <div class="marks-input-container">
                                    <label for="total_marks_{{ loop.index0 }}" class="marks-label">Max Marks:</label>
                                    <input
                                        type="number"
                                        id="total_marks_{{ loop.index0 }}"
                                        name="total_marks_{{ loop.index0 }}"
                                        value="{{ total_marks }}"
                                        min="1"
                                        max="100"
                                        class="subject-total-marks"
                                        data-subject="{{ subject.id }}"
                                        onchange="updateAllMarksForSubject('{{ subject.id }}', {{ loop.index0 }}); validateMaxMarks(this)"
                                        oninput="validateMaxMarks(this)"
                                        title="Maximum raw marks for this subject (Max: 100)"
                                    >
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    {% for subject in subjects %}
                                    <th class="{% if subject.is_composite %}composite-subject-header{% endif %}" data-subject-id="{{ subject.id }}">
                                        {{ subject.name }}
                                        <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                                            <span class="subject-info" id="subject_info_{{ loop.index0 }}">Max Raw: {{ total_marks }}</span>
                                        </div>
                                        {% if subject.is_composite %}
                                        {% set components = subject.get_components() %}
                                        <div class="component-headers">
                                            {% for component in components %}
                                            <div class="component-header-item">
                                                {{ component.name }}
                                            </div>
                                            {% endfor %}
                                            <div class="component-header-item overall-header">Overall</div>
                                        </div>
                                        {% endif %}
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                <tr>
                                    <td>{{ student.name }}</td>
                                    {% for subject in subjects %}
                                    <td data-subject-id="{{ subject.id }}">
                                        {% if subject.is_composite %}
                                        <div class="composite-subject-entry-improved">
                                            {% set subject_index = loop.index0 %}
                                            {% set components = subject.get_components() %}

                                            <div class="composite-components-grid">
                                                {% for component in components %}
                                                <div class="component-column">
                                                    <div class="mark-input-container">
                                                        <input type="number"
                                                            name="component_mark_{{ student.name.replace(' ', '_') }}_{{ subject.id }}_{{ component.id }}"
                                                            value="0"
                                                            min="0"
                                                            max="{{ component.max_raw_mark or total_marks }}"
                                                            required
                                                            class="student-mark component-mark"
                                                            data-student="{{ student.name.replace(' ', '_') }}"
                                                            data-subject="{{ subject.id }}"
                                                            data-component="{{ component.id }}"
                                                            data-component-weight="{{ component.weight }}"
                                                            data-subject-index="{{ subject_index }}"
                                                            data-max-mark="{{ component.max_raw_mark or 100 }}"
                                                            oninput="updateComponentPercentage(this); calculateOverallSubjectMark('{{ student.name.replace(' ', '_') }}', '{{ subject.id }}')"
                                                            onchange="updateComponentPercentage(this); calculateOverallSubjectMark('{{ student.name.replace(' ', '_') }}', '{{ subject.id }}')"
                                                            title="Enter raw mark for {{ component.name }} (Max: {{ component.max_raw_mark or 100 }})">
                                                    </div>
                                                </div>
                                                {% endfor %}

                                                <div class="overall-column">
                                                    <div class="overall-percentage-display">
                                                        <span id="overall_percentage_display_{{ student.name.replace(' ', '_') }}_{{ subject.id }}" class="overall-percentage-value">0%</span>
                                                        <div class="percentage-bar">
                                                            <div class="percentage-fill" style="width: 0%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Hidden field for the overall subject mark (calculated from components) -->
                                            <input type="hidden"
                                                name="mark_{{ student.name.replace(' ', '_') }}_{{ subject.id }}"
                                                id="overall_mark_{{ student.name.replace(' ', '_') }}_{{ subject.id }}"
                                                value="0">
                                            <input type="hidden"
                                                name="percentage_{{ student.name.replace(' ', '_') }}_{{ subject.id }}"
                                                id="hidden_percentage_{{ student.name.replace(' ', '_') }}_{{ subject.id }}"
                                                value="0">
                                        </div>
                                        {% else %}
                                        <div class="simplified-mark-entry">
                                            <div class="mark-input-container">
                                                <input type="number"
                                                    name="mark_{{ student.name.replace(' ', '_') }}_{{ subject.id }}"
                                                    value="0"
                                                    min="0"
                                                    max="{{ total_marks }}"
                                                    required
                                                    class="student-mark"
                                                    data-student="{{ student.name.replace(' ', '_') }}"
                                                    data-subject="{{ subject.id }}"
                                                    data-subject-index="{{ loop.index0 }}"
                                                    data-max-mark="{{ total_marks }}"
                                                    oninput="updatePercentage(this)"
                                                    onchange="updatePercentage(this)"
                                                    title="Enter raw mark for {{ subject.name }} (Max: {{ total_marks }})">
                                            </div>
                                            <div class="percentage-display">
                                                <span id="percentage_{{ student.name.replace(' ', '_') }}_{{ subject.id }}" class="percentage-value">0%</span>
                                                <div class="percentage-bar">
                                                    <div class="percentage-fill" style="width: 0%"></div>
                                                </div>
                                                <input type="hidden"
                                                    name="percentage_{{ student.name.replace(' ', '_') }}_{{ subject.id }}"
                                                    id="hidden_percentage_{{ student.name.replace(' ', '_') }}_{{ subject.id }}"
                                                    value="0">
                                            </div>
                                        </div>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-3">
                        <button type="submit" name="submit_marks" value="1" class="btn" id="submit-marks-btn">
                            Submit All Marks
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>

        <!-- Generate Marksheet Tab Content -->
        <div id="generate-marksheet-tab" class="tab-content-container {% if active_tab == 'generate-marksheet' %}active{% endif %}">
            <div class="modern-card slide-up">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-file-pdf card-icon"></i>
                        Generate Grade Marksheet (All Streams)
                    </h2>
                    <div class="card-actions">
                        <span class="modern-badge badge-info">
                            <i class="fas fa-layer-group"></i>
                            Comprehensive Report
                        </span>
                    </div>
                </div>

                <div style="padding: var(--space-6);">
                    <!-- Premium Header Section -->
                    <div style="background: linear-gradient(135deg, rgba(181, 137, 0, 0.1) 0%, rgba(40, 139, 210, 0.1) 100%); padding: var(--space-6); border-radius: var(--radius-lg); margin-bottom: var(--space-6); border: 1px solid rgba(181, 137, 0, 0.2);">
                        <div style="display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-4);">
                            <div style="background: linear-gradient(135deg, #b58900 0%, #268bd2 100%); padding: var(--space-4); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-chart-bar" style="font-size: 1.5rem; color: var(--text-white);"></i>
                            </div>
                            <div>
                                <h3 style="margin: 0; color: var(--primary-color); font-size: 1.4rem; font-weight: 700;">
                                    Multi-Stream Grade Report Generator
                                </h3>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 1rem; margin-top: var(--space-2);">
                                    Select grade, term, and assessment type to generate a comprehensive marksheet for all streams in the grade
                                </p>
                            </div>
                        </div>

                        <!-- Feature Highlights -->
                        <div class="modern-grid grid-cols-3" style="gap: var(--space-4);">
                            <div style="background: rgba(181, 137, 0, 0.1); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid rgba(181, 137, 0, 0.2);">
                                <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                    <i class="fas fa-layer-group" style="color: #b58900;"></i>
                                    <span style="font-weight: 600; color: var(--text-primary);">All Streams</span>
                                </div>
                                <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">
                                    Combines all stream results in one comprehensive report
                                </p>
                            </div>
                            <div style="background: rgba(40, 139, 210, 0.1); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid rgba(40, 139, 210, 0.2);">
                                <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                    <i class="fas fa-chart-line" style="color: #268bd2;"></i>
                                    <span style="font-weight: 600; color: var(--text-primary);">Analytics</span>
                                </div>
                                <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">
                                    Statistical analysis and performance insights
                                </p>
                            </div>
                            <div style="background: rgba(42, 161, 152, 0.1); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid rgba(42, 161, 152, 0.2);">
                                <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                    <i class="fas fa-envelope" style="color: #2aa198;"></i>
                                    <span style="font-weight: 600; color: var(--text-primary);">Notifications</span>
                                </div>
                                <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">
                                    Automatic parent email notifications available
                                </p>
                            </div>
                        </div>
                    </div>

                    <form id="stream-marksheet-form" method="POST" action="{{ url_for('classteacher.dashboard') }}" class="modern-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <!-- Form Fields Section -->
                        <div style="background: var(--bg-secondary); padding: var(--space-6); border-radius: var(--radius-lg); margin-bottom: var(--space-6); border: 1px solid var(--glass-border);">
                            <h4 style="color: var(--primary-color); margin-bottom: var(--space-4); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: var(--space-2);">
                                <i class="fas fa-cog"></i>
                                Report Configuration
                            </h4>

                            <div class="modern-grid grid-cols-3">
                                <div class="form-group">
                                    <label for="stream_grade" class="form-label">
                                        <i class="fas fa-graduation-cap" style="margin-right: var(--space-2); color: #b58900;"></i>Grade Level
                                    </label>
                                    <select id="stream_grade" name="stream_grade" required onchange="checkStreamStatus()" class="form-select">
                                        <option value="">Select Grade</option>
                                        {% for grade_option in grades %}
                                        <option value="{{ grade_option }}">Grade {{ grade_option }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="stream_term" class="form-label">
                                        <i class="fas fa-calendar-alt" style="margin-right: var(--space-2); color: #268bd2;"></i>Academic Term
                                    </label>
                                    <select id="stream_term" name="stream_term" required onchange="checkStreamStatus()" class="form-select">
                                        <option value="">Select Term</option>
                                        {% for term_option in terms %}
                                        <option value="{{ term_option }}">{{ term_option.replace('_', ' ').title() }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="stream_assessment_type" class="form-label">
                                        <i class="fas fa-clipboard-check" style="margin-right: var(--space-2); color: #2aa198;"></i>Assessment Type
                                    </label>
                                    <select id="stream_assessment_type" name="stream_assessment_type" required onchange="checkStreamStatus()" class="form-select">
                                        <option value="">Select Assessment Type</option>
                                        {% for assessment_option in assessment_types %}
                                        <option value="{{ assessment_option }}">{{ assessment_option.replace('_', ' ').title() }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Status Monitoring Section -->
                        <div style="background: var(--bg-secondary); padding: var(--space-6); border-radius: var(--radius-lg); margin-bottom: var(--space-6); border: 1px solid var(--glass-border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                                <h4 style="color: var(--primary-color); margin: 0; font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: var(--space-2);">
                                    <i class="fas fa-info-circle"></i>
                                    Grade Marksheet Status
                                </h4>
                                <button type="button" onclick="checkStreamStatus()" class="modern-btn btn-outline" style="font-size: 0.8rem; padding: var(--space-2) var(--space-3);">
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh Status
                                </button>
                            </div>

                            <div style="background: linear-gradient(135deg, rgba(40, 139, 210, 0.1) 0%, rgba(42, 161, 152, 0.1) 100%); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4); border: 1px solid rgba(40, 139, 210, 0.2);">
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6;">
                                    <i class="fas fa-lightbulb" style="color: #268bd2; margin-right: var(--space-2);"></i>
                                    A grade marksheet combines results from all streams in the selected grade. All streams must have their marks entered before generating a comprehensive report.
                                </p>
                            </div>

                            <div id="stream-status-container" class="stream-status-list" style="display: none;">
                                <div id="stream-status-list">
                                    <!-- Stream status items will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Parent Notification System -->
                        <div style="background: linear-gradient(135deg, rgba(42, 161, 152, 0.1) 0%, rgba(40, 139, 210, 0.1) 100%); padding: var(--space-6); border-radius: var(--radius-lg); margin-bottom: var(--space-6); border: 1px solid rgba(42, 161, 152, 0.2); position: relative; overflow: hidden;">
                            <!-- Decorative background pattern -->
                            <div style="position: absolute; top: -50px; right: -50px; width: 100px; height: 100px; background: radial-gradient(circle, rgba(42, 161, 152, 0.1), transparent); opacity: 0.5;"></div>
                            <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(40, 139, 210, 0.1), transparent); opacity: 0.3;"></div>

                            <div style="display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-5); position: relative; z-index: 1;">
                                <div style="background: linear-gradient(135deg, #2aa198 0%, #268bd2 100%); padding: var(--space-4); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(42, 161, 152, 0.3);">
                                    <i class="fas fa-paper-plane" style="color: var(--text-white); font-size: 1.2rem;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0; color: var(--text-primary); font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: var(--space-2);">
                                        <span>Smart Parent Notification System</span>
                                        <span style="background: linear-gradient(135deg, #2aa198, #268bd2); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 0.75rem; font-weight: 500; padding: var(--space-1) var(--space-2); background-color: rgba(42, 161, 152, 0.1); border-radius: var(--radius-sm); border: 1px solid rgba(42, 161, 152, 0.2);">AUTOMATED</span>
                                    </h4>
                                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem; margin-top: var(--space-2); line-height: 1.5;">
                                        Powered by intelligent email delivery with real-time tracking and delivery confirmation
                                    </p>
                                </div>
                            </div>

                            <!-- System Features Grid -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-5); position: relative; z-index: 1;">
                                <div style="background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid rgba(42, 161, 152, 0.2);">
                                    <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                        <i class="fas fa-check-circle" style="color: #2aa198; font-size: 1rem;"></i>
                                        <span style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">Email Verification</span>
                                    </div>
                                    <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">
                                        Only verified parent accounts receive notifications
                                    </p>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid rgba(40, 139, 210, 0.2);">
                                    <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                        <i class="fas fa-link" style="color: #268bd2; font-size: 1rem;"></i>
                                        <span style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">Parent-Student Links</span>
                                    </div>
                                    <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">
                                        Smart linking system connects parents to their children
                                    </p>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid rgba(181, 137, 0, 0.2);">
                                    <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                        <i class="fas fa-history" style="color: #b58900; font-size: 1rem;"></i>
                                        <span style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">Delivery Tracking</span>
                                    </div>
                                    <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">
                                        Complete email delivery logs and status monitoring
                                    </p>
                                </div>
                            </div>

                            <!-- How It Works Section -->
                            <div style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); padding: var(--space-5); border-radius: var(--radius-lg); margin-bottom: var(--space-5); border: 1px solid rgba(42, 161, 152, 0.15); position: relative; z-index: 1;">
                                <h5 style="color: var(--primary-color); margin-bottom: var(--space-4); font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: var(--space-2);">
                                    <i class="fas fa-cogs" style="color: #2aa198;"></i>
                                    How the System Works
                                </h5>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-4);">
                                    <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                                        <div style="background: linear-gradient(135deg, #2aa198, #268bd2); color: var(--text-white); width: 24px; height: 24px; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; flex-shrink: 0; margin-top: 2px;">1</div>
                                        <div>
                                            <p style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.9rem; margin-bottom: var(--space-1);">Report Generation</p>
                                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">When you generate a marksheet, the system identifies all students in the selected grade/streams</p>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                                        <div style="background: linear-gradient(135deg, #2aa198, #268bd2); color: var(--text-white); width: 24px; height: 24px; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; flex-shrink: 0; margin-top: 2px;">2</div>
                                        <div>
                                            <p style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.9rem; margin-bottom: var(--space-1);">Parent Discovery</p>
                                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">System finds all parents linked to these students with active accounts and email preferences enabled</p>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                                        <div style="background: linear-gradient(135deg, #2aa198, #268bd2); color: var(--text-white); width: 24px; height: 24px; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; flex-shrink: 0; margin-top: 2px;">3</div>
                                        <div>
                                            <p style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.9rem; margin-bottom: var(--space-1);">Email Delivery</p>
                                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">Personalized emails are sent with report notifications and parent portal access links</p>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                                        <div style="background: linear-gradient(135deg, #2aa198, #268bd2); color: var(--text-white); width: 24px; height: 24px; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; flex-shrink: 0; margin-top: 2px;">4</div>
                                        <div>
                                            <p style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.9rem; margin-bottom: var(--space-1);">Tracking & Logs</p>
                                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">All notifications are logged with delivery status and can be viewed in the admin panel</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Notification Toggle -->
                            <label style="display: flex; align-items: flex-start; gap: var(--space-4); cursor: pointer; padding: var(--space-5); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: var(--radius-lg); border: 2px solid rgba(42, 161, 152, 0.2); transition: all 0.3s ease; position: relative; z-index: 1;" onmouseover="this.style.borderColor='rgba(42, 161, 152, 0.4)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(42, 161, 152, 0.15)'" onmouseout="this.style.borderColor='rgba(42, 161, 152, 0.2)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <!-- Custom Checkbox -->
                                <div style="position: relative; margin-top: 2px;">
                                    <input type="checkbox" name="notify_parents" style="appearance: none; width: 20px; height: 20px; border: 2px solid #2aa198; border-radius: 4px; background: transparent; cursor: pointer; position: relative; transition: all 0.2s ease;" 
                                           onchange="
                                               if(this.checked) {
                                                   this.style.background = 'linear-gradient(135deg, #2aa198, #268bd2)';
                                                   this.style.borderColor = '#2aa198';
                                                   this.nextElementSibling.style.opacity = '1';
                                                   this.nextElementSibling.style.transform = 'scale(1)';
                                               } else {
                                                   this.style.background = 'transparent';
                                                   this.style.borderColor = '#2aa198';
                                                   this.nextElementSibling.style.opacity = '0';
                                                   this.nextElementSibling.style.transform = 'scale(0)';
                                               }
                                           ">
                                    <i class="fas fa-check" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); color: white; font-size: 12px; opacity: 0; transition: all 0.2s ease; pointer-events: none;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                        <i class="fas fa-paper-plane" style="color: #2aa198; font-size: 1rem;"></i>
                                        <span style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary);">
                                            Enable Smart Parent Notifications
                                        </span>
                                        <span style="background: linear-gradient(135deg, #2aa198, #268bd2); color: white; font-size: 0.7rem; font-weight: 600; padding: 2px 8px; border-radius: var(--radius-full); text-transform: uppercase; letter-spacing: 0.5px;">RECOMMENDED</span>
                                    </div>
                                    <div style="background: rgba(42, 161, 152, 0.05); padding: var(--space-3); border-radius: var(--radius-md); border-left: 4px solid #2aa198; margin-bottom: var(--space-3);">
                                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; font-weight: 500;">
                                            <i class="fas fa-info-circle" style="color: #2aa198; margin-right: var(--space-2);"></i>
                                            When enabled, the system will automatically send personalized email notifications to all verified parents whose children are included in this marksheet. Parents will receive instant alerts when their child's academic reports are ready for viewing.
                                        </p>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-3);">
                                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                                            <i class="fas fa-shield-alt" style="color: #268bd2; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">GDPR Compliant</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                                            <i class="fas fa-clock" style="color: #b58900; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">Instant Delivery</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                                            <i class="fas fa-mobile-alt" style="color: #2aa198; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">Mobile Optimized</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                                            <i class="fas fa-chart-line" style="color: #dc322f; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">Delivery Analytics</span>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <!-- Email System Configuration Info -->
                        <div style="background: var(--bg-secondary); padding: var(--space-6); border-radius: var(--radius-lg); margin-bottom: var(--space-6); border: 1px solid var(--glass-border);">
                            <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4);">
                                <div style="background: linear-gradient(135deg, #b58900 0%, #dc322f 100%); padding: var(--space-3); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-server" style="color: var(--text-white); font-size: 1rem;"></i>
                                </div>
                                <div>
                                    <h4 style="margin: 0; color: var(--primary-color); font-size: 1.1rem; font-weight: 600;">
                                        Email System Configuration
                                    </h4>
                                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem; margin-top: var(--space-1);">
                                        Backend integration details and system requirements
                                    </p>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-5);">
                                <!-- Email Templates -->
                                <div>
                                    <h5 style="color: var(--text-primary); margin-bottom: var(--space-3); font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: var(--space-2);">
                                        <i class="fas fa-file-alt" style="color: #b58900;"></i>
                                        Email Templates
                                    </h5>
                                    <div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0;">
                                            <i class="fas fa-check-circle" style="color: #2aa198; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Result Notification Template</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0;">
                                            <i class="fas fa-check-circle" style="color: #2aa198; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Email Verification Template</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0;">
                                            <i class="fas fa-check-circle" style="color: #2aa198; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Password Reset Template</span>
                                        </div>
                                        <div style="margin-top: var(--space-3); padding: var(--space-3); background: rgba(181, 137, 0, 0.1); border-radius: var(--radius-sm); border-left: 3px solid #b58900;">
                                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">
                                                Templates are stored in the <code>email_template</code> database table and can be customized by administrators.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- SMTP Configuration -->
                                <div>
                                    <h5 style="color: var(--text-primary); margin-bottom: var(--space-3); font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: var(--space-2);">
                                        <i class="fas fa-cog" style="color: #268bd2;"></i>
                                        SMTP Configuration
                                    </h5>
                                    <div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0;">
                                            <i class="fab fa-google" style="color: #dc322f; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Gmail SMTP Integration</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0;">
                                            <i class="fas fa-shield-alt" style="color: #2aa198; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">SSL/TLS Encryption</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0;">
                                            <i class="fas fa-key" style="color: #b58900; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">App Password Authentication</span>
                                        </div>
                                        <div style="margin-top: var(--space-3); padding: var(--space-3); background: rgba(40, 139, 210, 0.1); border-radius: var(--radius-sm); border-left: 3px solid #268bd2;">
                                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">
                                                Requires <code>GMAIL_USERNAME</code> and <code>GMAIL_APP_PASSWORD</code> environment variables to be configured.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Database Integration -->
                                <div>
                                    <h5 style="color: var(--text-primary); margin-bottom: var(--space-3); font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: var(--space-2);">
                                        <i class="fas fa-database" style="color: #2aa198;"></i>
                                        Database Integration
                                    </h5>
                                    <div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0;">
                                            <i class="fas fa-users" style="color: #2aa198; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Parent Account Management</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0;">
                                            <i class="fas fa-link" style="color: #268bd2; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Parent-Student Relationships</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0;">
                                            <i class="fas fa-history" style="color: #b58900; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Email Delivery Logs</span>
                                        </div>
                                        <div style="margin-top: var(--space-3); padding: var(--space-3); background: rgba(42, 161, 152, 0.1); border-radius: var(--radius-sm); border-left: 3px solid #2aa198;">
                                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">
                                                Uses tables: <code>parent</code>, <code>parent_student</code>, <code>parent_email_log</code>, <code>email_template</code>
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Service Architecture -->
                                <div>
                                    <h5 style="color: var(--text-primary); margin-bottom: var(--space-3); font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: var(--space-2);">
                                        <i class="fas fa-code" style="color: #dc322f;"></i>
                                        Service Architecture
                                    </h5>
                                    <div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0;">
                                            <i class="fas fa-envelope-open" style="color: #dc322f; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">ParentEmailService</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0;">
                                            <i class="fas fa-bell" style="color: #2aa198; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">ParentNotificationService</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0;">
                                            <i class="fas fa-check-double" style="color: #268bd2; font-size: 0.9rem;"></i>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Delivery Confirmation</span>
                                        </div>
                                        <div style="margin-top: var(--space-3); padding: var(--space-3); background: rgba(220, 50, 47, 0.1); border-radius: var(--radius-sm); border-left: 3px solid #dc322f;">
                                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">
                                                Integrated with classteacher view for automatic parent notification when reports are generated.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- System Status Indicator -->
                            <div style="margin-top: var(--space-5); padding: var(--space-4); background: linear-gradient(135deg, rgba(42, 161, 152, 0.05) 0%, rgba(40, 139, 210, 0.05) 100%); border-radius: var(--radius-md); border: 1px solid rgba(42, 161, 152, 0.15);">
                                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--space-3);">
                                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                                            <div id="email-status-indicator" style="width: 12px; height: 12px; background: #2aa198; border-radius: var(--radius-full); animation: pulse 2s infinite;"></div>
                                            <span style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">Email System Status:</span>
                                        </div>
                                        <span id="email-status-text" style="color: #2aa198; font-weight: 500; font-size: 0.9rem;">Operational</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: var(--space-2); font-size: 0.8rem; color: var(--text-secondary);">
                                        <i class="fas fa-info-circle"></i>
                                        <span>Backend services integrated and ready for parent notifications</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Action Buttons Section -->
                        <div style="background: var(--bg-secondary); padding: var(--space-6); border-radius: var(--radius-lg); border: 1px solid var(--glass-border);">
                            <h4 style="color: var(--primary-color); margin-bottom: var(--space-4); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: var(--space-2);">
                                <i class="fas fa-rocket"></i>
                                Generate Report
                            </h4>

                            <div style="display: flex; justify-content: center; gap: var(--space-4); flex-wrap: wrap;">
                                <button type="submit" id="preview-marksheet-btn" name="generate_stream_marksheet" value="1" class="modern-btn btn-primary" style="min-width: 200px;" disabled>
                                    <i class="fas fa-eye"></i>
                                    <span>Preview Grade Marksheet</span>
                                </button>
                                <button type="submit" id="download-marksheet-btn" name="download_stream_marksheet" value="1" class="modern-btn btn-success" style="min-width: 200px;" disabled>
                                    <i class="fas fa-download"></i>
                                    <span>Download PDF Report</span>
                                </button>
                            </div>

                            <div style="text-align: center; margin-top: var(--space-4); color: var(--text-muted); font-size: 0.85rem;">
                                <i class="fas fa-info-circle" style="margin-right: var(--space-1);"></i>
                                Buttons will be enabled once all required fields are selected and streams are ready
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Conditional Download and Preview Class PDF Report Section -->
        {% if show_download_button %}
        <div class="text-center mt-4">
            <a href="{{ url_for('classteacher.edit_class_marks', grade=grade, stream=stream, term=term, assessment_type=assessment_type) }}" class="btn btn-info" style="margin-right: var(--space-3);">
                <i class="fas fa-edit"></i> Edit Class Marks
            </a>
            <a href="{{ url_for('classteacher.preview_class_report', grade=grade, stream=stream, term=term, assessment_type=assessment_type) }}" class="btn btn-primary" style="margin-right: var(--space-3);">
                <i class="fas fa-eye"></i> Preview Class Report
            </a>
            <a href="{{ url_for('classteacher.preview_class_report', grade=grade, stream=stream, term=term, assessment_type=assessment_type) }}" class="btn btn-success" style="margin-right: var(--space-3);">
                <i class="fas fa-print"></i> Print/PDF
            </a>
            <button onclick="confirmDeleteReport('{{ grade }}', '{{ stream }}', '{{ term }}', '{{ assessment_type }}')" class="btn btn-danger">
                <i class="fas fa-trash"></i> Delete Marksheet
            </button>
            <p>Click above to edit, preview, print, download, or delete the class report.</p>
        </div>
        {% endif %}

        <!-- Conditional Individual Reports Section -->
        {% if show_individual_report_button %}
        <div class="text-center mt-4">
            <h3>Individual Learner Reports</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td>{{ student.name }}</td>
                            <td>
                                <a href="{{ url_for('classteacher.preview_individual_report', grade=grade, stream=stream, term=term, assessment_type=assessment_type, student_name=student.name) }}" class="btn btn-primary">
                                    <i class="fas fa-eye"></i> Preview Report
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <button onclick="downloadAllIndividualReports('{{ grade }}', '{{ stream }}', '{{ term }}', '{{ assessment_type }}')" class="btn btn-success mt-3" id="downloadAllBtn">
                Download All Individual Reports
            </button>
            <p>Click above to download a ZIP file containing individual reports for all learners.</p>
        </div>
        {% endif %}
    </div>

    <!-- Delete Confirmation Modal (Hidden by default) -->
    <div id="deleteReportModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div style="background: var(--bg-secondary); padding: var(--space-6); border-radius: var(--radius-lg); border: 1px solid var(--glass-border); box-shadow: var(--shadow-xl);">
                <div style="display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-4);">
                    <div style="background: linear-gradient(135deg, #d33682 0%, #cb4b16 100%); padding: var(--space-3); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--text-white); font-size: 1.2rem;"></i>
                    </div>
                    <div>
                        <h3 style="margin: 0; color: var(--danger-color); font-size: 1.3rem; font-weight: 700;">
                            Confirm Deletion
                        </h3>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem; margin-top: var(--space-1);">
                            This action cannot be undone
                        </p>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, rgba(211, 54, 130, 0.1) 0%, rgba(203, 75, 22, 0.1) 100%); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-6); border: 1px solid rgba(211, 54, 130, 0.2);">
                    <p id="deleteReportMessage" style="margin: 0; color: var(--text-primary); font-size: 1rem; line-height: 1.6;">
                        Are you sure you want to delete this marksheet? This action cannot be undone.
                    </p>
                </div>

                <div style="display: flex; justify-content: center; gap: var(--space-4);">
                    <form id="deleteReportForm" method="POST" action="" style="display: flex; gap: var(--space-3);">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="button" onclick="closeDeleteReportModal()" class="modern-btn btn-outline">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                        <button type="submit" class="modern-btn btn-danger">
                            <i class="fas fa-trash"></i>
                            Delete Marksheet
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <footer style="background: var(--bg-secondary); padding: var(--space-4); margin-top: var(--space-8); border-top: 1px solid var(--glass-border);">
        <p style="text-align: center; margin: 0; color: var(--text-muted); font-size: 0.85rem;">
            Â© 2025 {{ school_info.school_name|default('School Management System') }} - All Rights Reserved
        </p>
    </footer>

    <!-- Include the new form functions JavaScript file -->
    <script src="{{ url_for('static', filename='js/classteacher-form-functions.js') }}" defer></script>
    
    <!-- Tab Switching JavaScript for Upload Interface -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tab switching for upload interface
        const tabButtons = document.querySelectorAll('.tab-button[data-tab]');
        const tabPanes = document.querySelectorAll('.tab-pane');
        
        // Add click event listeners to tab buttons
        tabButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const targetTab = this.getAttribute('data-tab');
                switchUploadTab(targetTab);
            });
        });
        
        // Tab switching function
        function switchUploadTab(tabName) {
            // Remove active class from all tab buttons
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                // Reset inactive button styles
                if (btn.getAttribute('data-tab') !== tabName) {
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-secondary)';
                }
            });
            
            // Hide all tab panes
            tabPanes.forEach(pane => {
                pane.classList.remove('active');
                pane.style.display = 'none';
            });
            
            // Activate the selected tab button
            const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                activeButton.style.background = 'linear-gradient(135deg, #268bd2 0%, #2aa198 100%)';
                activeButton.style.color = 'var(--text-white)';
            }
            
            // Show the selected tab pane
            const activePane = document.getElementById(tabName);
            if (activePane) {
                activePane.classList.add('active');
                activePane.style.display = 'block';
                
                // Add smooth transition effect
                activePane.style.opacity = '0';
                activePane.style.transform = 'translateY(10px)';
                
                setTimeout(() => {
                    activePane.style.transition = 'all 0.3s ease';
                    activePane.style.opacity = '1';
                    activePane.style.transform = 'translateY(0)';
                }, 10);
            }
            
            console.log(`Switched to tab: ${tabName}`);
        }
        
        // Download Template Function with Error Handling
        function downloadTemplate() {
            try {
                // Get current form configuration
                const educationLevel = document.getElementById('education_level')?.value;
                const grade = document.getElementById('grade')?.value;
                const stream = document.getElementById('stream')?.value;
                const term = document.getElementById('term')?.value;
                const assessmentType = document.getElementById('assessment_type')?.value;
                
                // Check if required fields are filled
                if (!educationLevel || !grade || !stream || !term || !assessmentType) {
                    // Highlight the configuration section
                    const configSection = document.querySelector('.unified-form-fields');
                    if (configSection) {
                        configSection.style.border = '2px solid #dc322f';
                        configSection.style.boxShadow = '0 0 10px rgba(220, 50, 47, 0.3)';
                        setTimeout(() => {
                            configSection.style.border = '1px solid rgba(40, 139, 210, 0.15)';
                            configSection.style.boxShadow = 'none';
                        }, 3000);
                    }
                    
                    alert('âš ï¸ Configuration Required!\n\nPlease fill in all required fields in the "Upload Configuration" section above:\n\nâ€¢ Education Level\nâ€¢ Academic Term\nâ€¢ Assessment Type\nâ€¢ Grade Level\nâ€¢ Class Stream\n\nOnce completed, you can download the template with the correct structure for your class.');
                    
                    // Switch to manual entry tab to show configuration
                    switchUploadTab('manual-entry');
                    return false;
                }
                
                // Hide configuration reminder if visible
                const configReminder = document.getElementById('config-reminder');
                if (configReminder) {
                    configReminder.style.display = 'none';
                }
                
                // Build the download URL with parameters
                const params = new URLSearchParams({
                    education_level: educationLevel,
                    grade: grade,
                    stream: stream,
                    term: term,
                    assessment_type: assessmentType
                });
                
                const downloadUrl = `{{ url_for('classteacher.download_marks_template') }}?${params.toString()}`;
                
                // Show loading indication
                const button = event.target.closest('button') || event.target.closest('a') || event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Preparing Download...</span>';
                button.style.pointerEvents = 'none';
                
                console.log('Attempting to download from:', downloadUrl);
                
                // Use multiple download approaches for better compatibility
                try {
                    // Method 1: Direct window location approach
                    window.location.href = downloadUrl;
                    
                    // Show success message
                    setTimeout(() => {
                        button.innerHTML = '<i class="fas fa-check"></i> <span>Download Started!</span>';
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.style.pointerEvents = 'auto';
                        }, 2000);
                    }, 500);
                    
                } catch (e) {
                    console.log('Direct download failed, trying window.open method:', e);
                    
                    // Method 2: Window.open as fallback
                    const downloadWindow = window.open(downloadUrl, '_blank');
                    
                    // Check if window opened successfully
                    if (!downloadWindow || downloadWindow.closed) {
                        console.log('Window.open blocked, trying iframe method');
                        
                        // Method 3: Iframe as last resort
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.src = downloadUrl;
                        document.body.appendChild(iframe);
                        
                        setTimeout(() => {
                            document.body.removeChild(iframe);
                        }, 3000);
                    }
                    
                    // Show success message
                    setTimeout(() => {
                        button.innerHTML = '<i class="fas fa-check"></i> <span>Download Started!</span>';
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.style.pointerEvents = 'auto';
                        }, 2000);
                    }, 500);
                }
                
                console.log('Template download initiated successfully');
                return false;
                
            } catch (error) {
                console.error('Error downloading template:', error);
                alert('âŒ Download Error\n\nThere was an error preparing the template download. Please try again or contact support if the problem persists.');
                
                // Reset button if error occurs
                const button = event.target.closest('button') || event.target.closest('a') || event.target;
                if (button) {
                    button.innerHTML = '<i class="fas fa-download"></i> <span>Download Template</span>';
                    button.style.pointerEvents = 'auto';
                }
                return false;
            }
        }
        
        // Initialize with manual-entry tab active
        setTimeout(() => {
            switchUploadTab('manual-entry');
        }, 100);
        
        // Collapsible Section Toggle Function
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + '-icon');
            
            if (content && icon) {
                content.classList.toggle('collapsed');
                
                if (content.classList.contains('collapsed')) {
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    icon.style.transform = 'rotate(180deg)';
                }
            }
        }

        // Navigation Function for Navbar Links
        function navigateToFeature(featureName) {
            console.log('Navigating to feature:', featureName);
            
            // Handle different navigation scenarios
            switch(featureName) {
                case 'upload-marks':
                    // Switch to upload marks tab and scroll to it
                    switchMainTab('upload-marks');
                    scrollToElement('upload-marks-tab');
                    highlightNavItem('upload');
                    break;
                    
                case 'recent-reports':
                    // Switch to reports tab and scroll to it
                    switchMainTab('recent-reports');
                    scrollToElement('recent-reports-tab');
                    highlightNavItem('reports');
                    break;
                    
                case 'generate-marksheet':
                    // Switch to generate reports tab and scroll to it
                    switchMainTab('generate-marksheet');
                    scrollToElement('generate-marksheet-tab');
                    highlightNavItem('generate');
                    break;
                    
                default:
                    console.warn('Unknown feature:', featureName);
            }
        }

        // Function to smoothly scroll to an element
        function scrollToElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        // Function to highlight active navigation item
        function highlightNavItem(itemName) {
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('nav-active');
            });
            
            // Add active class to current nav item
            const activeLink = document.querySelector(`[onclick*="${itemName}"], [onclick*="${itemName === 'reports' ? 'recent-reports' : itemName}"]`);
            if (activeLink) {
                activeLink.classList.add('nav-active');
                
                // Add visual feedback
                activeLink.style.background = 'rgba(33, 150, 243, 0.2)';
                activeLink.style.borderRadius = '8px';
                
                // Remove highlight after 3 seconds
                setTimeout(() => {
                    activeLink.style.background = '';
                    activeLink.style.borderRadius = '';
                }, 3000);
            }
        }

        // Function to show management options in collapsible sections
        function showManagementOptions() {
            console.log('Showing management options');
            
            // Scroll to secondary features section
            const managementSection = document.querySelector('.secondary-features-container');
            if (managementSection) {
                managementSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Expand all management-related sections
                setTimeout(() => {
                    // Expand System Management section
                    const systemMgmtContent = document.getElementById('system-management');
                    const systemMgmtIcon = document.getElementById('system-management-icon');
                    if (systemMgmtContent && systemMgmtContent.classList.contains('collapsed')) {
                        toggleSection('system-management');
                    }
                    
                    // Expand Advanced Features section  
                    const advancedContent = document.getElementById('advanced-features');
                    if (advancedContent && advancedContent.classList.contains('collapsed')) {
                        toggleSection('advanced-features');
                    }
                    
                    // Highlight the management section
                    managementSection.style.border = '2px solid #2196F3';
                    managementSection.style.borderRadius = '12px';
                    managementSection.style.boxShadow = '0 0 20px rgba(33, 150, 243, 0.3)';
                    
                    // Remove highlight after 4 seconds
                    setTimeout(() => {
                        managementSection.style.border = '';
                        managementSection.style.borderRadius = '';
                        managementSection.style.boxShadow = '';
                    }, 4000);
                }, 500);
            }
            
            highlightNavItem('manage');
        }

        // Enhanced Main Tab Switching Function
        function switchMainTab(tabName) {
            console.log('Switching to main tab:', tabName);
            
            // Hide all tab content containers
            const allTabs = document.querySelectorAll('.tab-content-container');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Show the selected tab
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
                
                // Add smooth transition
                selectedTab.style.opacity = '0';
                selectedTab.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    selectedTab.style.transition = 'all 0.4s ease';
                    selectedTab.style.opacity = '1';
                    selectedTab.style.transform = 'translateY(0)';
                }, 100);
            }
            
            // Update tab button states
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('onclick') && button.getAttribute('onclick').includes(tabName)) {
                    button.classList.add('active');
                }
            });
        }
        
        // Make functions available globally
        window.switchUploadTab = switchUploadTab;
        window.downloadTemplate = downloadTemplate;
        window.toggleSection = toggleSection;
        window.navigateToFeature = navigateToFeature;
        window.showManagementOptions = showManagementOptions;
        window.switchMainTab = switchMainTab;
    });
    </script>
    
    <!-- Note: Analytics Dashboard JavaScript is loaded only on the dedicated analytics page -->
    
    <style>
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* Tab Pane Styling */
        .tab-pane {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }
        
        .tab-pane.active {
            display: block !important;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Tab Button Hover Effects */
        .tab-button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tab-button span {
            position: relative;
            z-index: 2;
        }

        .tab-indicator {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #2196F3, #4CAF50);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .tab-button.active .tab-indicator {
            transform: scaleX(1);
        }

        .tab-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tab-button:hover .tab-indicator {
            transform: scaleX(0.8);
            opacity: 0.6;
        }        /* PRIMARY WORKFLOW SECTION STYLES */
        .primary-workflow-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .primary-workflow-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2196F3, #4CAF50, #FF9800);
        }

        .workflow-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .workflow-header h2 {
            color: #1976D2;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .workflow-header p {
            color: #666;
            font-size: 1.1rem;
        }

        .primary-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .primary-action-card {
            background: white;
            border: 2px solid #e3f2fd;
            border-radius: 10px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .primary-action-card:hover {
            border-color: #2196F3;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.2);
        }

        .action-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }

        .action-icon.primary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .action-icon.secondary {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
        }

        .action-icon.tertiary {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }

        .action-content h3 {
            color: #333;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .action-content p {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        .action-badge {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1976D2;
            font-size: 0.8rem;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-weight: 500;
        }

        /* SECONDARY FEATURES STYLES */
        .secondary-features-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .collapsible-section {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-header {
            background: linear-gradient(135deg, #f5f5f5, #fafafa);
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .section-header:hover {
            background: linear-gradient(135deg, #f0f0f0, #f5f5f5);
        }

        .section-header h3 {
            color: #333;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-icon {
            color: #666;
            transition: transform 0.3s ease;
            font-size: 0.9rem;
        }

        .section-content {
            max-height: 500px;
            overflow: hidden;
            transition: all 0.3s ease;
            opacity: 1;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0 1.5rem;
        }

        .section-content:not(.collapsed) {
            padding: 1.5rem;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .feature-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            background: #e3f2fd;
            border-color: #2196F3;
            transform: translateY(-2px);
            text-decoration: none;
            color: inherit;
        }

        .feature-card i {
            font-size: 1.5rem;
            color: #2196F3;
            margin-bottom: 0.5rem;
        }

        .feature-card h4 {
            color: #333;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .feature-card p {
            color: #666;
            font-size: 0.85rem;
            margin: 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .primary-actions-grid {
                grid-template-columns: 1fr;
            }
            
            .primary-action-card {
                flex-direction: column;
                text-align: center;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
            }
        }

        /* NAVBAR NAVIGATION ENHANCEMENTS */
        .nav-link {
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .nav-link:hover {
            transform: translateY(-2px);
            background: rgba(33, 150, 243, 0.1) !important;
            border-radius: 8px !important;
        }

        .nav-link.nav-active {
            background: rgba(33, 150, 243, 0.2) !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #2196F3, #4CAF50);
            transition: width 0.3s ease;
        }

        .nav-link:hover::after,
        .nav-link.nav-active::after {
            width: 100%;
        }

        /* TAB CONTENT CONTAINER TRANSITIONS */
        .tab-content-container {
            transition: all 0.4s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .tab-content-container.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* SMOOTH SCROLL BEHAVIOR */
        html {
            scroll-behavior: smooth;
        }

        /* HIGHLIGHT ANIMATIONS */
        @keyframes highlightPulse {
            0% { 
                box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7);
                border-color: #2196F3;
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(33, 150, 243, 0);
                border-color: #2196F3;
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(33, 150, 243, 0);
                border-color: #e0e0e0;
            }
        }

        .highlight-animation {
            animation: highlightPulse 2s ease-in-out;
        }
    </style>
</body>
</html>
