<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="description" content="Class Teacher Dashboard - {{ school_info.school_name|default('Hillview School') }} Management System">
    <title>Class Teacher Dashboard - {{ school_info.school_name|default('Hillview School Management System') }}</title>

    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Solar Theme (Bootswatch) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
    
    <!-- Brandi Bootstrap CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='brandi-bootstrap-main/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='brandi-bootstrap-main/css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='brandi-bootstrap-main/css/media-queries.css') }}">
    
    <!-- Custom Solar + Brandi Integration -->
    <style>
        /* Solar Theme Integration with Brandi Bootstrap */
        :root {
            --solar-bg: #002b36;
            --solar-fg: #839496;
            --solar-primary: #268bd2;
            --solar-secondary: #2aa198;
            --solar-success: #859900;
            --solar-warning: #b58900;
            --solar-danger: #dc322f;
            --solar-info: #6c71c4;
        }
        
        body {
            background-color: var(--solar-bg);
            color: var(--solar-fg);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .card {
            background-color: #073642;
            border-color: #586e75;
        }
        
        .btn-primary {
            background-color: var(--solar-primary);
            border-color: var(--solar-primary);
        }
        
        .btn-success {
            background-color: var(--solar-success);
            border-color: var(--solar-success);
        }
        
        .btn-warning {
            background-color: var(--solar-warning);
            border-color: var(--solar-warning);
        }
        
        .btn-danger {
            background-color: var(--solar-danger);
            border-color: var(--solar-danger);
        }
        
        .table-dark {
            --bs-table-bg: #073642;
            --bs-table-border-color: #586e75;
        }
        
        .form-control {
            background-color: #073642;
            border-color: #586e75;
            color: var(--solar-fg);
        }
        
        .form-control:focus {
            background-color: #073642;
            border-color: var(--solar-primary);
            color: var(--solar-fg);
            box-shadow: 0 0 0 0.2rem rgba(38, 139, 210, 0.25);
        }
        
        .form-select {
            background-color: #073642;
            border-color: #586e75;
            color: var(--solar-fg);
        }
        
        .form-select:focus {
            background-color: #073642;
            border-color: var(--solar-primary);
            color: var(--solar-fg);
            box-shadow: 0 0 0 0.2rem rgba(38, 139, 210, 0.25);
        }
        
        .alert-success {
            background-color: rgba(133, 153, 0, 0.1);
            border-color: var(--solar-success);
            color: var(--solar-success);
        }
        
        .alert-danger {
            background-color: rgba(220, 50, 47, 0.1);
            border-color: var(--solar-danger);
            color: var(--solar-danger);
        }
        
        .alert-warning {
            background-color: rgba(181, 137, 0, 0.1);
            border-color: var(--solar-warning);
            color: var(--solar-warning);
        }
        
        .alert-info {
            background-color: rgba(108, 113, 196, 0.1);
            border-color: var(--solar-info);
            color: var(--solar-info);
        }
        
        .navbar-dark {
            background-color: #073642 !important;
        }
        
        .badge {
            font-size: 0.75em;
        }
        
        .text-muted {
            color: #93a1a1 !important;
        }
        
        .border {
            border-color: #586e75 !important;
        }
        
        .bg-light {
            background-color: #073642 !important;
        }
        
        .text-dark {
            color: var(--solar-fg) !important;
        }
        
        /* Custom status cards */
        .status-card {
            background-color: #073642;
            border: 1px solid #586e75;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .status-card:hover {
            border-color: var(--solar-primary);
            box-shadow: 0 4px 8px rgba(38, 139, 210, 0.1);
        }
        
        .status-card.assigned-to-me {
            border-color: var(--solar-success);
            background-color: rgba(133, 153, 0, 0.05);
        }
        
        /* Responsive grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .container-fluid {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }
    </style>
</head>
<body class="bg-dark text-light">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chalkboard-teacher me-2"></i>
                {{ school_info.school_name|default('Hillview School') }}
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user me-1"></i>
                    Welcome, {{ session.get('teacher_name', 'Teacher') }}
                </span>
                <a class="nav-link" href="{{ url_for('auth.logout') }}">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Error Messages -->
        {% if error_message %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> {{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- Success Messages -->
        {% if confirmation_message %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            {{ confirmation_message|safe }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Dashboard Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title mb-0">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            Class Teacher Dashboard
                        </h2>
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            Manage your class assignments, upload marks, generate reports, and track student performance.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Assignment Status -->
        {% if session.get('all_subjects_status') %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-clipboard-list me-2"></i>
                            Subject Assignment Status
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="status-grid">
                            {% for subject_info in session.get('all_subjects_status', []) %}
                            <div class="status-card {% if subject_info.assigned_to_me %}assigned-to-me{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">{{ subject_info.name }}</h5>
                                    {% if subject_info.assigned_to_me %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>
                                            Assigned to You
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-user me-1"></i>
                                            {{ subject_info.assigned_teacher or 'Unassigned' }}
                                        </span>
                                    {% endif %}
                                </div>

                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <div class="h4 mb-1 text-primary">{{ subject_info.total_students }}</div>
                                            <small class="text-muted">Students</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <div class="h4 mb-1 text-success">{{ subject_info.marks_entered }}</div>
                                            <small class="text-muted">Marks Entered</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <div class="h4 mb-1 text-warning">{{ subject_info.pending_marks }}</div>
                                            <small class="text-muted">Pending</small>
                                        </div>
                                    </div>
                                </div>

                                {% if subject_info.assigned_to_me %}
                                <div class="mt-3">
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success"
                                             style="width: {{ (subject_info.marks_entered / subject_info.total_students * 100) if subject_info.total_students > 0 else 0 }}%">
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        {{ "%.1f"|format((subject_info.marks_entered / subject_info.total_students * 100) if subject_info.total_students > 0 else 0) }}% Complete
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Main Action Cards -->
        <div class="row mb-4">
            <!-- Upload Marks Card -->
            <div class="col-lg-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-upload me-2"></i>
                            Upload Marks
                        </h4>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Upload student marks for your assigned subjects and classes.</p>

                        <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                            {{ csrf_token() }}

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="education_level" class="form-label">Education Level</label>
                                    <select class="form-select" id="education_level" name="education_level" required>
                                        <option value="">Select Education Level</option>
                                        <option value="pre_primary" {% if education_level == 'pre_primary' %}selected{% endif %}>Pre-Primary</option>
                                        <option value="primary" {% if education_level == 'primary' %}selected{% endif %}>Primary</option>
                                        <option value="junior_secondary" {% if education_level == 'junior_secondary' %}selected{% endif %}>Junior Secondary</option>
                                        <option value="senior_secondary" {% if education_level == 'senior_secondary' %}selected{% endif %}>Senior Secondary</option>
                                    </select>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="subject" class="form-label">Subject</label>
                                    <select class="form-select" id="subject" name="subject" required>
                                        <option value="">Select Subject</option>
                                        {% for level, subjects in subjects_by_education_level.items() %}
                                            {% for subject_name in subjects %}
                                                <option value="{{ subject_name }}"
                                                        data-education-level="{{ level }}"
                                                        {% if subject == subject_name %}selected{% endif %}>
                                                    {{ subject_name }}
                                                </option>
                                            {% endfor %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="grade" class="form-label">Grade</label>
                                    <select class="form-select" id="grade" name="grade" required>
                                        <option value="">Select Grade</option>
                                        {% for grade_obj in grades %}
                                            <option value="{{ grade_obj.name }}"
                                                    data-education-level="{{ grade_obj.education_level }}"
                                                    {% if grade == grade_obj.name %}selected{% endif %}>
                                                {{ grade_obj.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="stream" class="form-label">Stream</label>
                                    <select class="form-select" id="stream" name="stream" required>
                                        <option value="">Select Stream</option>
                                        <!-- Streams will be populated by JavaScript -->
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="term" class="form-label">Term</label>
                                    <select class="form-select" id="term" name="term" required>
                                        <option value="">Select Term</option>
                                        {% for term_obj in terms %}
                                            <option value="{{ term_obj.name }}" {% if term == term_obj.name %}selected{% endif %}>
                                                {{ term_obj.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="assessment_type" class="form-label">Assessment Type</label>
                                    <select class="form-select" id="assessment_type" name="assessment_type" required>
                                        <option value="">Select Assessment Type</option>
                                        {% for assessment_obj in assessment_types %}
                                            <option value="{{ assessment_obj.name }}" {% if assessment_type == assessment_obj.name %}selected{% endif %}>
                                                {{ assessment_obj.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" name="upload_marks" class="btn btn-primary">
                                    <i class="fas fa-upload me-2"></i>
                                    Upload Marks
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Generate Reports Card -->
            <div class="col-lg-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Generate Reports
                        </h4>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Generate comprehensive class and student performance reports.</p>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#reportModal">
                                <i class="fas fa-file-alt me-2"></i>
                                Class Report
                            </button>

                            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#studentReportModal">
                                <i class="fas fa-user-graduate me-2"></i>
                                Student Report
                            </button>

                            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#marksheetModal">
                                <i class="fas fa-table me-2"></i>
                                Marksheet
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Marks Display Section -->
        {% if show_students and students %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-users me-2"></i>
                            Student Marks - {{ subject }} ({{ grade }} {{ stream }})
                        </h4>
                    </div>
                    <div class="card-body">
                        <form method="POST" id="marksForm">
                            {{ csrf_token() }}
                            <input type="hidden" name="education_level" value="{{ education_level }}">
                            <input type="hidden" name="subject" value="{{ subject }}">
                            <input type="hidden" name="grade" value="{{ grade }}">
                            <input type="hidden" name="stream" value="{{ stream }}">
                            <input type="hidden" name="term" value="{{ term }}">
                            <input type="hidden" name="assessment_type" value="{{ assessment_type }}">
                            <input type="hidden" name="total_marks" value="{{ total_marks }}">

                            <div class="table-responsive">
                                <table class="table table-dark table-striped">
                                    <thead>
                                        <tr>
                                            <th>Student Name</th>
                                            <th>Raw Mark (out of {{ total_marks }})</th>
                                            <th>Percentage</th>
                                            <th>Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in students %}
                                        <tr>
                                            <td>
                                                <strong>{{ student.name }}</strong>
                                                <br>
                                                <small class="text-muted">ID: {{ student.id }}</small>
                                            </td>
                                            <td>
                                                <input type="number"
                                                       class="form-control mark-input"
                                                       name="mark_{{ student.id }}"
                                                       id="mark_{{ student.id }}"
                                                       min="0"
                                                       max="{{ total_marks }}"
                                                       step="0.5"
                                                       data-student-id="{{ student.id }}"
                                                       data-total-marks="{{ total_marks }}"
                                                       placeholder="Enter mark">
                                            </td>
                                            <td>
                                                <span id="percentage_{{ student.id }}" class="badge bg-secondary">-</span>
                                            </td>
                                            <td>
                                                <span id="grade_{{ student.id }}" class="badge bg-secondary">-</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <div class="d-grid mt-3">
                                <button type="submit" name="submit_marks" class="btn btn-success btn-lg">
                                    <i class="fas fa-save me-2"></i>
                                    Submit All Marks
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Recent Reports Section -->
        {% if recent_reports %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>
                            Recent Reports
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-striped">
                                <thead>
                                    <tr>
                                        <th>Grade</th>
                                        <th>Stream</th>
                                        <th>Term</th>
                                        <th>Assessment</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for report in recent_reports %}
                                    <tr>
                                        <td><span class="badge bg-primary">{{ report.grade }}</span></td>
                                        <td><span class="badge bg-info">{{ report.stream }}</span></td>
                                        <td><span class="badge bg-secondary">{{ report.term }}</span></td>
                                        <td><span class="badge bg-warning">{{ report.assessment_type }}</span></td>
                                        <td>{{ report.date }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye me-1"></i>
                                                View
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        // Grade calculation function
        function calculateGrade(percentage) {
            if (percentage >= 80) return { grade: 'A', class: 'bg-success' };
            if (percentage >= 75) return { grade: 'A-', class: 'bg-success' };
            if (percentage >= 70) return { grade: 'B+', class: 'bg-info' };
            if (percentage >= 65) return { grade: 'B', class: 'bg-info' };
            if (percentage >= 60) return { grade: 'B-', class: 'bg-info' };
            if (percentage >= 55) return { grade: 'C+', class: 'bg-warning' };
            if (percentage >= 50) return { grade: 'C', class: 'bg-warning' };
            if (percentage >= 45) return { grade: 'C-', class: 'bg-warning' };
            if (percentage >= 40) return { grade: 'D+', class: 'bg-danger' };
            if (percentage >= 35) return { grade: 'D', class: 'bg-danger' };
            if (percentage >= 30) return { grade: 'D-', class: 'bg-danger' };
            return { grade: 'E', class: 'bg-dark' };
        }

        // Real-time mark calculation
        document.addEventListener('DOMContentLoaded', function() {
            const markInputs = document.querySelectorAll('.mark-input');

            markInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const studentId = this.dataset.studentId;
                    const totalMarks = parseFloat(this.dataset.totalMarks);
                    const rawMark = parseFloat(this.value) || 0;

                    const percentage = totalMarks > 0 ? (rawMark / totalMarks) * 100 : 0;
                    const gradeInfo = calculateGrade(percentage);

                    // Update percentage display
                    const percentageSpan = document.getElementById(`percentage_${studentId}`);
                    percentageSpan.textContent = percentage.toFixed(1) + '%';
                    percentageSpan.className = `badge ${gradeInfo.class}`;

                    // Update grade display
                    const gradeSpan = document.getElementById(`grade_${studentId}`);
                    gradeSpan.textContent = gradeInfo.grade;
                    gradeSpan.className = `badge ${gradeInfo.class}`;
                });
            });
        });

        // Form validation
        document.getElementById('marksForm')?.addEventListener('submit', function(e) {
            const markInputs = document.querySelectorAll('.mark-input');
            let hasMarks = false;

            markInputs.forEach(input => {
                if (input.value && input.value.trim() !== '') {
                    hasMarks = true;
                }
            });

            if (!hasMarks) {
                e.preventDefault();
                alert('Please enter at least one mark before submitting.');
                return false;
            }
        });
    </script>
</body>
</html>
