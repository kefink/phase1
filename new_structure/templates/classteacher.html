<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Class Teacher Dashboard - Kirima Primary School</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>
    <style>
        .stream-status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-ready {
            background-color: #28a745;
        }
        .status-pending {
            background-color: #dc3545;
        }
        .stream-status-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
        }
        .stream-status-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .refresh-status {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }
        .marksheet-info {
            background-color: #f8f9fa;
            border-left: 4px solid #17a2b8;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Error Message Section -->
    {% if error_message %}
    <div class="alert alert-danger" style="background-color: #f8d7da; color: #721c24; padding: 10px; margin: 10px 0; border-radius: 5px;">
        <strong>Error:</strong> {{ error_message }}
    </div>
    {% endif %}

    <!-- Deletion Confirmation Message -->
    {% if confirmation_message %}
    <div class="alert alert-success" style="background-color: #d4edda; color: #155724; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 5px solid #28a745;">
        {{ confirmation_message|safe }}
    </div>
    {% endif %}

    <!-- Teacher Assignment Status -->
    {% if not stream %}
    <div class="alert alert-info" style="background-color: #d1ecf1; color: #0c5460; padding: 10px; margin: 10px 0; border-radius: 5px;">
        <strong>Note:</strong> You are not currently assigned to any class stream. You can still manage students and view reports for all grades and streams.
    </div>
    {% else %}
    <div class="alert alert-success" style="background-color: #d4edda; color: #155724; padding: 10px; margin: 10px 0; border-radius: 5px;">
        <strong>Assigned Class:</strong> Grade {{ grade }} {{ stream }}
    </div>
    {% endif %}

    <nav class="navbar">
        <a href="#" class="navbar-brand">Kirima Primary School</a>
        <ul class="navbar-nav">
            <li class="nav-item"><a href="#" class="nav-link">Dashboard</a></li>
            <li class="nav-item"><a href="#" class="nav-link">Reports</a></li>
            <li class="nav-item"><a href="#" class="nav-link">Help</a></li>
            <li class="nav-item"><a href="{{ url_for('auth.logout_route') }}" class="logout-btn">Logout</a></li>
        </ul>
    </nav>

    <div class="container" style="max-width: 90%; margin-top: 80px;">
        <h1 class="text-center mb-4">Class Teacher Dashboard</h1>

        <!-- Management Options Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <span>Management Options</span>
            </div>
            <div class="management-links" style="padding: 20px;">
                <ul>
                    <li><a href="{{ url_for('classteacher.manage_students') }}">Manage Students</a></li>
                    <li><a href="{{ url_for('classteacher.manage_subjects') }}">Manage Subjects</a></li>
                    <li><a href="{{ url_for('classteacher.manage_teachers') }}">Manage Teachers</a></li>
                    <li><a href="{{ url_for('bulk_assignments.bulk_assignments') }}">Teacher Assignments</a></li>
                    <li><a href="{{ url_for('classteacher.manage_teacher_assignments') }}">Manage Teacher Transfers</a></li>
                    <li><a href="{{ url_for('classteacher.manage_grades_streams') }}">Manage Grades and Streams</a></li>
                    <li><a href="{{ url_for('classteacher.manage_terms_assessments') }}">Manage Terms and Assessment Types</a></li>
                </ul>
            </div>
        </div>

        <div class="dashboard-card mt-4">
            <div class="card-header">
                <span>Upload Class Marks (All Subjects)</span>
                <small>Complete all fields to process marks</small>
            </div>

            {% if not show_students %}
            <!-- Initial form to select grade and class -->
            <div class="tabs">
                <div class="tab-header">
                    <div class="tab-btn active" data-tab="manual-entry">Manual Entry</div>
                    <div class="tab-btn" data-tab="bulk-upload">Bulk Upload</div>
                </div>
                <div class="tab-content">
                    <div class="tab-pane active" id="manual-entry">
                        <form id="upload-form" method="POST" action="{{ url_for('classteacher.dashboard') }}" class="login-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="form-group">
                                <label for="education_level">Education Level</label>
                                <select id="education_level" name="education_level" required onchange="updateSubjects()">
                                    <option value="">Select Education Level</option>
                                    <option value="lower_primary" {% if education_level == 'lower_primary' %}selected{% endif %}>Lower Primary</option>
                                    <option value="upper_primary" {% if education_level == 'upper_primary' %}selected{% endif %}>Upper Primary</option>
                                    <option value="junior_secondary" {% if education_level == 'junior_secondary' %}selected{% endif %}>Junior Secondary</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="term">Term</label>
                                <select id="term" name="term" required>
                                    <option value="">Select Term</option>
                                    {% for term_option in terms %}
                                    <option value="{{ term_option }}" {% if term == term_option %}selected{% endif %}>{{ term_option }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="assessment_type">Assessment Type</label>
                                <select id="assessment_type" name="assessment_type" required>
                                    <option value="">Select Assessment Type</option>
                                    {% for assessment_option in assessment_types %}
                                    <option value="{{ assessment_option }}" {% if assessment_type == assessment_option %}selected{% endif %}>{{ assessment_option }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="total_marks">Default Total Marks (Out Of)</label>
                                <input type="number" id="total_marks" name="total_marks" min="1" value="{{ total_marks if total_marks else '100' }}" required>
                                <p class="help-text">This is the default value. You can set different total marks for each subject when entering marks.</p>
                            </div>

                            <div class="form-group">
                                <label for="grade">Grade</label>
                                <select id="grade" name="grade" required onchange="fetchStreams()">
                                    <option value="">Select Grade</option>
                                    {% for grade_option in grades %}
                                    <option value="{{ grade_option }}" {% if grade == grade_option %}selected{% endif %}>{{ grade_option }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="stream">Stream</label>
                                <select id="stream" name="stream" required>
                                    <option value="">Select Stream</option>
                                    <!-- Streams will be populated dynamically via JavaScript -->
                                </select>
                            </div>

                            <div class="form-group" style="grid-column: span 2; text-align: center;">
                                <button type="submit" name="upload_marks" value="1" class="btn" id="upload-btn">
                                    Load Students & Subjects
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane" id="bulk-upload">
                        <form id="bulk-upload-form" method="POST" action="{{ url_for('classteacher.dashboard') }}" class="login-form" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="form-group">
                                <label for="bulk_education_level">Education Level</label>
                                <select id="bulk_education_level" name="education_level" required>
                                    <option value="">Select Education Level</option>
                                    <option value="lower_primary" {% if education_level == 'lower_primary' %}selected{% endif %}>Lower Primary</option>
                                    <option value="upper_primary" {% if education_level == 'upper_primary' %}selected{% endif %}>Upper Primary</option>
                                    <option value="junior_secondary" {% if education_level == 'junior_secondary' %}selected{% endif %}>Junior Secondary</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="bulk_term">Term</label>
                                <select id="bulk_term" name="term" required>
                                    <option value="">Select Term</option>
                                    {% for term_option in terms %}
                                    <option value="{{ term_option }}" {% if term == term_option %}selected{% endif %}>{{ term_option }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="bulk_assessment_type">Assessment Type</label>
                                <select id="bulk_assessment_type" name="assessment_type" required>
                                    <option value="">Select Assessment Type</option>
                                    {% for assessment_option in assessment_types %}
                                    <option value="{{ assessment_option }}" {% if assessment_type == assessment_option %}selected{% endif %}>{{ assessment_option }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="bulk_total_marks">Total Marks (Out Of)</label>
                                <input type="number" id="bulk_total_marks" name="total_marks" min="1" value="100" required>
                            </div>

                            <div class="form-group">
                                <label for="bulk_grade">Grade</label>
                                <select id="bulk_grade" name="grade" required onchange="fetchBulkStreams()">
                                    <option value="">Select Grade</option>
                                    {% for grade_option in grades %}
                                    <option value="{{ grade_option }}" {% if grade == grade_option %}selected{% endif %}>{{ grade_option }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="bulk_stream">Stream</label>
                                <select id="bulk_stream" name="stream" required>
                                    <option value="">Select Stream</option>
                                    <!-- Streams will be populated dynamically via JavaScript -->
                                </select>
                            </div>

                            <div class="form-group" style="grid-column: span 2;">
                                <label for="marks_file">Upload Marks File (Excel or CSV)</label>
                                <input type="file" id="marks_file" name="marks_file" accept=".xlsx,.xls,.csv" required>
                                <p class="help-text">Upload an Excel or CSV file with student marks. The file should have student names or admission numbers as rows and subjects as columns.</p>
                            </div>

                            <div class="form-group" style="grid-column: span 2; text-align: center;">
                                <a href="#" class="btn-outline" onclick="downloadTemplate()" style="margin-right: 10px;">
                                    Download Template
                                </a>
                                <button type="submit" name="bulk_upload_marks" value="1" class="btn" id="bulk-upload-btn">
                                    Upload Marks
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Form for entering student marks for all subjects -->
            <div id="pupils-list" class="pupils-list" style="grid-column: span 2;">
                <h3>Enter Marks for Grade {{ grade }} Stream {{ stream }} - All Subjects</h3>

                <form method="POST" action="{{ url_for('classteacher.dashboard') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <!-- Keep existing form fields as hidden fields -->
                    <input type="hidden" name="education_level" value="{{ education_level }}">
                    <input type="hidden" name="grade" value="{{ grade }}">
                    <input type="hidden" name="stream" value="{{ stream }}">
                    <input type="hidden" name="term" value="{{ term }}">
                    <input type="hidden" name="assessment_type" value="{{ assessment_type }}">
                    <input type="hidden" name="total_marks" value="{{ total_marks }}">

                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    {% for subject in subjects %}
                                    <th>
                                        {{ subject }}
                                        <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                                            <label for="total_marks_{{ loop.index0 }}">Total Marks:</label>
                                            <input
                                                type="number"
                                                id="total_marks_{{ loop.index0 }}"
                                                name="total_marks_{{ loop.index0 }}"
                                                value="{{ total_marks }}"
                                                min="1"
                                                max="1000"
                                                style="width: 50px; padding: 2px; font-size: 12px;"
                                                onchange="updateAllPercentages('{{ subject.replace(' ', '_') }}')"
                                                class="subject-total-marks"
                                                data-subject="{{ subject.replace(' ', '_') }}"
                                            >
                                        </div>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                <tr>
                                    <td>{{ student.name }}</td>
                                    {% for subject in subjects %}
                                    <td>
                                        <div style="display: flex; flex-direction: column; gap: 5px;">
                                            <div>
                                                <input type="number"
                                                    name="mark_{{ student.name.replace(' ', '_') }}_{{ subject.replace(' ', '_') }}"
                                                    value="0"
                                                    min="0"
                                                    max="{{ total_marks }}"
                                                    required
                                                    style="width: 60px;"
                                                    class="student-mark"
                                                    data-student="{{ student.name.replace(' ', '_') }}"
                                                    data-subject="{{ subject.replace(' ', '_') }}"
                                                    data-subject-index="{{ loop.index0 }}"
                                                    oninput="updatePercentage(this)">
                                                <span style="font-size: 12px; color: #666;">Raw</span>
                                            </div>
                                            <div style="font-size: 12px; color: #666;">
                                                <span id="percentage_{{ student.name.replace(' ', '_') }}_{{ subject.replace(' ', '_') }}">0%</span>
                                                <input type="hidden"
                                                    name="percentage_{{ student.name.replace(' ', '_') }}_{{ subject.replace(' ', '_') }}"
                                                    id="hidden_percentage_{{ student.name.replace(' ', '_') }}_{{ subject.replace(' ', '_') }}"
                                                    value="0">
                                            </div>
                                        </div>
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-3">
                        <button type="submit" name="submit_marks" value="1" class="btn">
                            Submit All Marks
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>

        <!-- Updated Section: Generate Grade Marksheet (All Streams) -->
        <div class="dashboard-card mt-4">
            <div class="card-header">
                <span>Generate Grade Marksheet (All Streams)</span>
                <small>Select grade, term, and assessment type to generate a marksheet for all streams in the grade</small>
            </div>
            <form id="stream-marksheet-form" method="POST" action="{{ url_for('classteacher.dashboard') }}" class="login-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="form-group">
                    <label for="stream_grade">Grade</label>
                    <select id="stream_grade" name="stream_grade" required onchange="checkStreamStatus()">
                        <option value="">Select Grade</option>
                        {% for grade_option in grades %}
                        <option value="{{ grade_option }}">{{ grade_option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="stream_term">Term</label>
                    <select id="stream_term" name="stream_term" required onchange="checkStreamStatus()">
                        <option value="">Select Term</option>
                        {% for term_option in terms %}
                        <option value="{{ term_option }}">{{ term_option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="stream_assessment_type">Assessment Type</label>
                    <select id="stream_assessment_type" name="stream_assessment_type" required onchange="checkStreamStatus()">
                        <option value="">Select Assessment Type</option>
                        {% for assessment_option in assessment_types %}
                        <option value="{{ assessment_option }}">{{ assessment_option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" style="grid-column: span 2;">
                    <div class="marksheet-info">
                        <strong>Grade Marksheet Status:</strong>
                        <p>A grade marksheet combines results from all streams in the selected grade. All streams must have their marks entered before generating.</p>
                        <button type="button" class="refresh-status" onclick="checkStreamStatus()">Refresh Status</button>
                    </div>

                    <div id="stream-status-container" class="stream-status-list" style="display: none;">
                        <div id="stream-status-list">
                            <!-- Stream status items will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="form-group" style="grid-column: span 2; text-align: center;">
                    <button type="submit" id="preview-marksheet-btn" name="generate_stream_marksheet" value="1" class="btn" style="background-color: #007BFF; margin-right: 10px;" disabled>
                        Preview Grade Marksheet
                    </button>
                    <button type="submit" id="download-marksheet-btn" name="download_stream_marksheet" value="1" class="btn" style="background-color: #28A745;" disabled>
                        Download Grade Marksheet
                    </button>
                </div>
            </form>
        </div>

        <div class="dashboard-card mt-4">
            <div class="card-header">
                <span>Recent Reports</span>
                <a href="{{ url_for('classteacher.all_reports') }}" class="btn-outline">View All</a>
            </div>

            <!-- Filter and Sort Controls -->
            <div class="filter-controls" style="padding: 15px; background-color: #f8f9fa; border-bottom: 1px solid #eee; display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                <div style="display: flex; align-items: center;">
                    <label for="sort-reports" style="margin-right: 8px; font-weight: 500;">Sort by:</label>
                    <select id="sort-reports" onchange="sortReports(this.value)" style="padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="date" {% if request.args.get('sort') == 'date' or not request.args.get('sort') %}selected{% endif %}>Date (newest first)</option>
                        <option value="grade" {% if request.args.get('sort') == 'grade' %}selected{% endif %}>Grade</option>
                        <option value="term" {% if request.args.get('sort') == 'term' %}selected{% endif %}>Term</option>
                    </select>
                </div>

                <div style="display: flex; align-items: center;">
                    <label for="filter-grade" style="margin-right: 8px; font-weight: 500;">Grade:</label>
                    <select id="filter-grade" onchange="filterReports()" style="padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">All Grades</option>
                        {% for grade_option in grades %}
                        <option value="{{ grade_option }}" {% if request.args.get('filter_grade') == grade_option %}selected{% endif %}>{{ grade_option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div style="display: flex; align-items: center;">
                    <label for="filter-term" style="margin-right: 8px; font-weight: 500;">Term:</label>
                    <select id="filter-term" onchange="filterReports()" style="padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">All Terms</option>
                        {% for term_option in terms %}
                        <option value="{{ term_option }}" {% if request.args.get('filter_term') == term_option %}selected{% endif %}>{{ term_option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <button onclick="resetFilters()" style="padding: 6px 12px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Reset Filters
                </button>
            </div>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Grade</th>
                            <th>Stream</th>
                            <th>Term</th>
                            <th>Assessment</th>
                            <th>Date</th>
                            <th>Marks</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_reports %}
                        {% for report in recent_reports %}
                        <tr>
                            <td>{{ report.id }}</td>
                            <td>{{ report.grade }}</td>
                            <td>{{ report.stream }}</td>
                            <td>{{ report.term }}</td>
                            <td>{{ report.assessment_type }}</td>
                            <td>{{ report.date }}</td>
                            <td>
                                <span class="badge" style="background-color: #17a2b8; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
                                    {{ report.mark_count }} marks
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons" style="display: flex; flex-wrap: wrap; gap: 5px;">
                                    <a href="{{ url_for('classteacher.edit_class_marks', grade=report.grade, stream=report.stream, term=report.term, assessment_type=report.assessment_type) }}" class="btn" style="background-color: #17a2b8; font-size: 12px; padding: 5px 10px;" title="Edit marks">
                                        <i class="edit-icon">‚úèÔ∏è</i> Edit
                                    </a>
                                    <a href="{{ url_for('classteacher.preview_class_report', grade=report.grade, stream=report.stream, term=report.term, assessment_type=report.assessment_type) }}" class="btn" style="background-color: #007BFF; font-size: 12px; padding: 5px 10px;" title="Preview report">
                                        <i class="preview-icon">üëÅÔ∏è</i> View
                                    </a>
                                    <a href="{{ url_for('classteacher.preview_class_report', grade=report.grade, stream=report.stream, term=report.term, assessment_type=report.assessment_type) }}" class="btn" style="background-color: #28A745; font-size: 12px; padding: 5px 10px;" title="Print report">
                                        <i class="print-icon">üñ®Ô∏è</i> Print
                                    </a>
                                    <button onclick="confirmDeleteReport('{{ report.grade }}', '{{ report.stream }}', '{{ report.term }}', '{{ report.assessment_type }}')" class="btn" style="background-color: #e74c3c; font-size: 12px; padding: 5px 10px;" title="Delete report">
                                        <i class="delete-icon">üóëÔ∏è</i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                    <i style="font-size: 48px; color: #6c757d;">üìä</i>
                                    <p style="margin: 0; font-size: 16px; color: #6c757d;">No reports available</p>
                                    <p style="margin: 0; font-size: 14px; color: #6c757d;">Upload marks to generate reports</p>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination for future implementation -->
            <div class="pagination" style="display: flex; justify-content: center; margin-top: 15px;">
                <a href="#" class="pagination-link" style="display: none;">Previous</a>
                <span class="pagination-info">Showing {{ recent_reports|length }} of {{ recent_reports|length }} reports</span>
                <a href="#" class="pagination-link" style="display: none;">Next</a>
            </div>
        </div>

        <script>
            function sortReports(sortBy) {
                // Get current URL parameters
                const urlParams = new URLSearchParams(window.location.search);

                // Update or add the sort parameter
                urlParams.set('sort', sortBy);

                // Redirect to the new URL with updated parameters
                window.location.href = window.location.pathname + '?' + urlParams.toString();
            }

            function filterReports() {
                // Get current URL parameters
                const urlParams = new URLSearchParams(window.location.search);

                // Get filter values
                const gradeFilter = document.getElementById('filter-grade').value;
                const termFilter = document.getElementById('filter-term').value;

                // Update parameters
                if (gradeFilter) {
                    urlParams.set('filter_grade', gradeFilter);
                } else {
                    urlParams.delete('filter_grade');
                }

                if (termFilter) {
                    urlParams.set('filter_term', termFilter);
                } else {
                    urlParams.delete('filter_term');
                }

                // Redirect to the new URL with updated parameters
                window.location.href = window.location.pathname + '?' + urlParams.toString();
            }

            function resetFilters() {
                // Get current URL parameters
                const urlParams = new URLSearchParams(window.location.search);

                // Remove filter parameters
                urlParams.delete('filter_grade');
                urlParams.delete('filter_term');

                // Keep sort parameter if it exists
                const sortParam = urlParams.get('sort');

                // Clear all parameters
                urlParams.forEach((value, key) => {
                    urlParams.delete(key);
                });

                // Add back sort parameter if it existed
                if (sortParam) {
                    urlParams.set('sort', sortParam);
                }

                // Redirect to the new URL with updated parameters
                window.location.href = window.location.pathname + '?' + urlParams.toString();
            }
        </script>

        <!-- Conditional Download and Preview Class PDF Report Section -->
        {% if show_download_button %}
        <div class="text-center mt-4">
            <a href="{{ url_for('classteacher.edit_class_marks', grade=grade, stream=stream, term=term, assessment_type=assessment_type) }}" class="btn" style="background-color: #17a2b8; margin-right: 10px;">
                Edit Class Marks
            </a>
            <a href="{{ url_for('classteacher.preview_class_report', grade=grade, stream=stream, term=term, assessment_type=assessment_type) }}" class="btn" style="background-color: #007BFF; margin-right: 10px;">
                Preview Class Report
            </a>
            <a href="{{ url_for('classteacher.preview_class_report', grade=grade, stream=stream, term=term, assessment_type=assessment_type) }}" class="btn" style="background-color: #28A745; margin-right: 10px;">
                <i class="print-icon">üñ®Ô∏è</i> Print/PDF
            </a>
            <button onclick="confirmDeleteReport('{{ grade }}', '{{ stream }}', '{{ term }}', '{{ assessment_type }}')" class="btn" style="background-color: #e74c3c;">
                Delete Marksheet
            </button>
            <p>Click above to edit, preview, print, download, or delete the class report.</p>
        </div>
        {% endif %}

        <!-- Conditional Individual Reports Section -->
        {% if show_individual_report_button %}
        <div class="text-center mt-4">
            <h3>Individual Learner Reports</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td>{{ student.name }}</td>
                            <td>
                                <a href="{{ url_for('classteacher.preview_individual_report', grade=grade, stream=stream, term=term, assessment_type=assessment_type, student_name=student.name) }}" class="btn" style="background-color: #007BFF;">Preview Report</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <a href="{{ url_for('classteacher.generate_all_individual_reports', grade=grade, stream=stream, term=term, assessment_type=assessment_type) }}" class="btn mt-3">
                Download All Individual Reports
            </a>
            <p>Click above to download a ZIP file containing individual reports for all learners.</p>
        </div>
        {% endif %}
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteReportModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Deletion</h3>
            <p id="deleteReportMessage">Are you sure you want to delete this marksheet? This action cannot be undone.</p>
            <div class="modal-buttons">
                <form id="deleteReportForm" method="POST" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="button" onclick="closeDeleteReportModal()" class="cancel-btn">Cancel</button>
                    <button type="submit" class="confirm-delete-btn">Delete</button>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <p>¬© 2025 Kirima Primary School - All Rights Reserved</p>
    </footer>

    <style>
        /* Deletion Confirmation Styles */
        .deletion-confirmation {
            padding: 10px;
        }
        .deletion-confirmation h3 {
            color: #155724;
            margin-top: 0;
            font-size: 1.2rem;
        }
        .deletion-confirmation p {
            margin: 8px 0;
        }
        .deletion-confirmation strong {
            font-weight: 600;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 50%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }
        .cancel-btn {
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .cancel-btn:hover {
            background-color: #7f8c8d;
        }
        .confirm-delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .confirm-delete-btn:hover {
            background-color: #c0392b;
        }

        /* Tab styles */
        .tabs {
            width: 100%;
        }

        .tab-header {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            background-color: #f8f9fa;
        }

        .tab-btn.active {
            background-color: #fff;
            border-color: #ddd;
            border-bottom-color: #fff;
            margin-bottom: -1px;
            font-weight: bold;
        }

        .tab-content {
            padding: 20px 0;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .help-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Print Controls Dropdown Styles */
        .dropdown-menu {
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 100;
            border-radius: 4px;
            padding: 8px 0;
            right: 0;
            top: 100%;
            margin-top: 5px;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            text-decoration: none;
            color: #333;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .dropdown-item:hover {
            background-color: #f1f1f1;
        }

        .dropdown-toggle::after {
            content: "";
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
            border-top: 4px solid;
            border-right: 4px solid transparent;
            border-left: 4px solid transparent;
        }

        .print-icon, .download-icon, .info-icon {
            margin-right: 8px;
            font-style: normal;
        }

        .close-btn:hover {
            color: #e74c3c;
        }
    </style>

    <script>
        // Function to update percentage based on raw mark and total marks
        function updatePercentage(inputElement) {
            // Get the student and subject information from data attributes
            const student = inputElement.dataset.student;
            const subject = inputElement.dataset.subject;
            const subjectIndex = inputElement.dataset.subjectIndex;

            // Get the raw mark value
            const rawMark = parseFloat(inputElement.value) || 0;

            // Get the total marks for this subject
            const totalMarksInput = document.querySelector(`#total_marks_${subjectIndex}`);
            const totalMarks = parseFloat(totalMarksInput.value) || 100;

            // Calculate percentage
            const percentage = (rawMark / totalMarks) * 100;
            const roundedPercentage = Math.round(percentage * 10) / 10; // Round to 1 decimal place

            // Update the percentage display
            const percentageSpan = document.getElementById(`percentage_${student}_${subject}`);
            percentageSpan.textContent = `${roundedPercentage}%`;

            // Update the hidden percentage input
            const hiddenPercentageInput = document.getElementById(`hidden_percentage_${student}_${subject}`);
            hiddenPercentageInput.value = roundedPercentage;

            // Update the max attribute of the mark input to match the total marks
            inputElement.max = totalMarks;
        }

        // Function to update all percentages for a subject when total marks change
        function updateAllPercentages(subject) {
            // Get all mark inputs for this subject
            const markInputs = document.querySelectorAll(`.student-mark[data-subject="${subject}"]`);

            // Update each mark's percentage
            markInputs.forEach(input => {
                updatePercentage(input);
            });
        }

        // Function to confirm deletion of a marksheet
        function confirmDeleteReport(grade, stream, term, assessmentType) {
            // Set up the delete form action
            const deleteForm = document.getElementById('deleteReportForm');
            deleteForm.action = `/classteacher/delete_marksheet/${grade}/${stream}/${term}/${assessmentType}`;

            // Update the confirmation message
            const deleteMessage = document.getElementById('deleteReportMessage');
            deleteMessage.textContent = `Are you sure you want to delete all marks for ${grade} ${stream} in ${term} ${assessmentType}? This action cannot be undone.`;

            // Show the modal
            const modal = document.getElementById('deleteReportModal');
            modal.style.display = 'block';
        }

        // Function to close the delete confirmation modal
        function closeDeleteReportModal() {
            // Hide the modal
            const modal = document.getElementById('deleteReportModal');
            modal.style.display = 'none';
        }

        // Close the modal if the user clicks outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('deleteReportModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Function to toggle print options dropdown
        function togglePrintOptions(reportId) {
            const printOptions = document.getElementById(`print-options-${reportId}`);
            if (printOptions.style.display === 'none') {
                // Close any other open dropdowns first
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    if (menu.id !== `print-options-${reportId}`) {
                        menu.style.display = 'none';
                    }
                });
                printOptions.style.display = 'block';
            } else {
                printOptions.style.display = 'none';
            }
        }

        // Function to print a report
        function printReport(grade, stream, term, assessmentType) {
            // Open the report in a new window and print it
            const printWindow = window.open(
                `/classteacher/preview_class_report/${grade}/${stream}/${term}/${assessmentType}`,
                '_blank'
            );

            // Wait for the page to load before printing
            printWindow.addEventListener('load', function() {
                printWindow.print();
            });
        }

        // Function to print a report as PDF
        function printReportAsPDF(grade, stream, term, assessmentType) {
            // Open the report in a new window
            const pdfWindow = window.open(
                `/classteacher/preview_class_report/${grade}/${stream}/${term}/${assessmentType}`,
                '_blank'
            );

            // Wait for the page to load before showing PDF instructions
            pdfWindow.addEventListener('load', function() {
                // Add a banner with instructions at the top of the page
                const instructionsDiv = pdfWindow.document.createElement('div');
                instructionsDiv.style.position = 'fixed';
                instructionsDiv.style.top = '0';
                instructionsDiv.style.left = '0';
                instructionsDiv.style.width = '100%';
                instructionsDiv.style.padding = '15px';
                instructionsDiv.style.backgroundColor = '#f8d7da';
                instructionsDiv.style.color = '#721c24';
                instructionsDiv.style.borderBottom = '1px solid #f5c6cb';
                instructionsDiv.style.zIndex = '9999';
                instructionsDiv.style.textAlign = 'center';
                instructionsDiv.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';

                instructionsDiv.innerHTML = `
                    <h3 style="margin: 0 0 10px 0;">Save as PDF Instructions</h3>
                    <p style="margin: 0;">
                        1. Press <strong>Ctrl+P</strong> (or <strong>Cmd+P</strong> on Mac) to open the print dialog<br>
                        2. Select <strong>"Save as PDF"</strong> from the destination/printer options<br>
                        3. Click <strong>"Save"</strong> to download the PDF file
                    </p>
                    <button id="closeInstructions" style="margin-top: 10px; padding: 5px 10px; background-color: #721c24; color: white; border: none; border-radius: 3px; cursor: pointer;">
                        Close Instructions
                    </button>
                `;

                pdfWindow.document.body.insertBefore(instructionsDiv, pdfWindow.document.body.firstChild);

                // Add event listener to close button
                pdfWindow.document.getElementById('closeInstructions').addEventListener('click', function() {
                    instructionsDiv.style.display = 'none';
                });
            });
        }

        // Function to show printing instructions
        function showPrintInstructions() {
            // Create a modal for printing instructions
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';

            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.width = '60%';

            const closeBtn = document.createElement('span');
            closeBtn.innerHTML = '&times;';
            closeBtn.className = 'close-btn';
            closeBtn.style.position = 'absolute';
            closeBtn.style.right = '20px';
            closeBtn.style.top = '10px';
            closeBtn.style.fontSize = '24px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.onclick = function() {
                document.body.removeChild(modal);
            };

            const title = document.createElement('h3');
            title.textContent = 'Printing Instructions';

            const instructions = document.createElement('div');
            instructions.innerHTML = `
                <h4>How to Print/Save Reports:</h4>
                <ol>
                    <li><strong>Print directly:</strong> Click the "Print Report" button to open the report in a new tab and automatically open the print dialog.</li>
                    <li><strong>Save as PDF:</strong> Click "Save as PDF" to open the report in a new tab with instructions for saving it as a PDF file.</li>
                    <li><strong>For best results:</strong>
                        <ul>
                            <li>Use landscape orientation</li>
                            <li>Enable background colors and images</li>
                            <li>Set margins to "Narrow" or "None"</li>
                            <li>Scale to fit page if needed</li>
                        </ul>
                    </li>
                    <li><strong>Sharing with parents:</strong> The PDF format is recommended for sharing via email or messaging apps.</li>
                </ol>
            `;

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(title);
            modalContent.appendChild(instructions);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        // Function to update subject options based on education level
        function updateSubjects() {
            const educationLevel = document.getElementById('education_level').value;
            const formGroup = document.getElementById('education_level').closest('.form-group');

            if (educationLevel) {
                formGroup.classList.add('success');
                formGroup.classList.remove('error');
            } else {
                formGroup.classList.remove('success');
            }
        }

        // Function to fetch streams dynamically based on selected grade (for uploading marks)
        function fetchStreams() {
            const grade = document.getElementById('grade').value;
            const streamSelect = document.getElementById('stream');
            const formGroup = streamSelect.closest('.form-group');

            // Clear existing options
            streamSelect.innerHTML = '<option value="">Select Stream</option>';

            if (grade) {
                fetch(`/classteacher/get_streams_by_level/${grade}`)
                    .then(response => response.json())
                    .then(data => {
                        data.streams.forEach(stream => {
                            const option = document.createElement('option');
                            option.value = `Stream ${stream.name}`;
                            option.textContent = `Stream ${stream.name}`;
                            streamSelect.appendChild(option);
                        });
                        formGroup.classList.add('success');
                        formGroup.classList.remove('error');
                    })
                    .catch(error => {
                        console.error('Error fetching streams:', error);
                        formGroup.classList.add('error');
                    });
            } else {
                formGroup.classList.remove('success');
            }
        }

        // Function to update percentage in real-time as marks are entered
        function updatePercentage(inputElement, studentSubjectId) {
            const totalMarks = parseInt(document.getElementsByName('total_marks')[0].value);
            const mark = parseInt(inputElement.value) || 0;
            const percentage = (mark / totalMarks) * 100;

            // Find the corresponding percentage cell
            const percentageCell = document.getElementById(`percentage_${studentSubjectId}`);

            if (percentageCell) {
                percentageCell.textContent = percentage.toFixed(1) + '%';
            }
        }

        // Function to check stream status for grade marksheet
        function checkStreamStatus() {
            const grade = document.getElementById('stream_grade').value;
            const term = document.getElementById('stream_term').value;
            const assessmentType = document.getElementById('stream_assessment_type').value;
            const statusContainer = document.getElementById('stream-status-container');
            const statusList = document.getElementById('stream-status-list');
            const previewBtn = document.getElementById('preview-marksheet-btn');
            const downloadBtn = document.getElementById('download-marksheet-btn');

            // Clear the status list
            statusList.innerHTML = '';

            if (grade && term && assessmentType) {
                statusContainer.style.display = 'block';

                // Add loading indicator
                statusList.innerHTML = '<p>Checking stream status...</p>';

                // Fetch stream status from the server
                fetch(`/classteacher/api/check_stream_status/${grade}/${term}/${assessmentType}`)
                    .then(response => response.json())
                    .then(data => {
                        statusList.innerHTML = '';
                        let allStreamsReady = true;

                        if (data.streams && data.streams.length > 0) {
                            data.streams.forEach(stream => {
                                const statusItem = document.createElement('div');
                                statusItem.className = 'stream-status-item';

                                const indicator = document.createElement('span');
                                indicator.className = `stream-status-indicator ${stream.has_report ? 'status-ready' : 'status-pending'}`;

                                const text = document.createElement('span');
                                text.textContent = `${stream.name}: ${stream.has_report ? 'Report Ready' : 'Report Missing'}`;

                                statusItem.appendChild(indicator);
                                statusItem.appendChild(text);
                                statusList.appendChild(statusItem);

                                if (!stream.has_report) {
                                    allStreamsReady = false;
                                }
                            });

                            // Enable or disable buttons based on status
                            previewBtn.disabled = !allStreamsReady;
                            downloadBtn.disabled = !allStreamsReady;

                            if (!allStreamsReady) {
                                const warningText = document.createElement('p');
                                warningText.style.color = '#dc3545';
                                warningText.style.marginTop = '10px';
                                warningText.innerHTML = '<strong>Note:</strong> All streams must have reports generated before creating a grade marksheet.';
                                statusList.appendChild(warningText);
                            } else {
                                const successText = document.createElement('p');
                                successText.style.color = '#28a745';
                                successText.style.marginTop = '10px';
                                successText.innerHTML = '<strong>Ready!</strong> All stream reports are available. You can now generate the grade marksheet.';
                                statusList.appendChild(successText);
                            }
                        } else {
                            statusList.innerHTML = '<p>No streams found for this grade.</p>';
                            previewBtn.disabled = true;
                            downloadBtn.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error checking stream status:', error);
                        statusList.innerHTML = '<p style="color: #dc3545;">Error checking stream status. Please try again.</p>';
                        previewBtn.disabled = true;
                        downloadBtn.disabled = true;
                    });
            } else {
                statusContainer.style.display = 'none';
                previewBtn.disabled = true;
                downloadBtn.disabled = true;
            }
        }

        // Function to fetch streams for bulk upload form
        function fetchBulkStreams() {
            const grade = document.getElementById('bulk_grade').value;
            const streamSelect = document.getElementById('bulk_stream');
            const formGroup = streamSelect.closest('.form-group');

            // Clear existing options
            streamSelect.innerHTML = '<option value="">Select Stream</option>';

            if (grade) {
                fetch(`/classteacher/get_streams_by_level/${grade}`)
                    .then(response => response.json())
                    .then(data => {
                        data.streams.forEach(stream => {
                            const option = document.createElement('option');
                            option.value = `Stream ${stream.name}`;
                            option.textContent = `Stream ${stream.name}`;
                            streamSelect.appendChild(option);
                        });
                        formGroup.classList.add('success');
                        formGroup.classList.remove('error');
                    })
                    .catch(error => {
                        console.error('Error fetching streams:', error);
                        formGroup.classList.add('error');
                    });
            } else {
                formGroup.classList.remove('success');
            }
        }

        // Function to download marks template
        function downloadTemplate() {
            const educationLevel = document.getElementById('bulk_education_level').value;
            const grade = document.getElementById('bulk_grade').value;
            const stream = document.getElementById('bulk_stream').value;
            const term = document.getElementById('bulk_term').value;
            const assessmentType = document.getElementById('bulk_assessment_type').value;

            let url = '/classteacher/download_marks_template?format=xlsx';

            if (educationLevel) {
                url += `&education_level=${educationLevel}`;
            }

            if (grade && stream) {
                url += `&grade=${grade}&stream=${stream}`;

                if (term) {
                    url += `&term=${term}`;
                }

                if (assessmentType) {
                    url += `&assessment_type=${assessmentType}`;
                }
            }

            window.location.href = url;
        }

        // Initialize form validations on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateSubjects();
            fetchStreams();

            // Add event listeners for grade marksheet form fields
            document.getElementById('stream_grade').addEventListener('change', checkStreamStatus);
            document.getElementById('stream_term').addEventListener('change', checkStreamStatus);
            document.getElementById('stream_assessment_type').addEventListener('change', checkStreamStatus);

            // Close print options dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.matches('.dropdown-toggle') && !event.target.closest('.dropdown-menu')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.style.display = 'none';
                    });
                }
            });

            // Tab functionality
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons and panes
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabPanes.forEach(p => p.classList.remove('active'));

                    // Add active class to clicked button and corresponding pane
                    btn.classList.add('active');
                    const tabId = btn.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        });
    </script>
</body>
</html>