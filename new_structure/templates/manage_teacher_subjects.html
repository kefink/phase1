<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Teacher Subjects - Hillview School</title>
    <!-- Inter font for Solar theme -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <style>
      /* Solar Theme Tokens + heroicon base */
      :root {
        --solar-bg-1: #fdf6e3;
        --solar-bg-2: #eee8d5;
        --solar-bg-3: #d6d2c4;
        --solar-primary: #b58900;
        --solar-secondary: #268bd2;
        --solar-green: #859900;
        --solar-red: #dc322f;
        --solar-text-primary: #002b36;
        --solar-text-secondary: #073642;
      }
      :root {
        --primary-color: var(--solar-primary) !important;
        --secondary-color: var(--solar-secondary) !important;
        --white: #ffffff !important;
        --border-color: rgba(238, 232, 213, 0.5) !important;
        --shadow-md: 0 10px 30px rgba(181, 137, 0, 0.1) !important;
        --border-radius: 10px !important;
        --border-radius-lg: 16px !important;
        --spacing-sm: 8px !important;
        --spacing-md: 12px !important;
        --spacing-lg: 20px !important;
        --spacing-xl: 32px !important;
        --transition: all 0.25s ease !important;
      }
      body {
        background: linear-gradient(
          135deg,
          var(--solar-bg-1) 0%,
          var(--solar-bg-2) 60%,
          var(--solar-bg-3) 100%
        ) !important;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif !important;
        color: var(--solar-text-primary) !important;
      }
      .heroicon {
        display: inline-block;
        width: 1.1rem;
        height: 1.1rem;
        fill: currentColor;
        vertical-align: middle;
      }
      .heroicon-lg {
        width: 1.5rem;
        height: 1.5rem;
      }
      .heroicon-solar-blue {
        color: var(--solar-secondary);
      }
      .heroicon-solar-green {
        color: var(--solar-green);
      }
      .heroicon-solar-yellow {
        color: var(--solar-primary);
      }
      .heroicon-solar-red {
        color: var(--solar-red);
      }

      /* Container */
      .manage-container {
        max-width: 95% !important;
        width: 95% !important;
        margin: 40px auto 60px !important;
        padding: 0 !important;
        background: transparent !important;
      }
      .page-header {
        background: linear-gradient(
          145deg,
          rgba(253, 246, 227, 0.95) 0%,
          rgba(238, 232, 213, 0.9) 100%
        ) !important;
        backdrop-filter: blur(15px);
        padding: 30px !important;
        border-radius: 24px !important;
        box-shadow: 0 20px 40px rgba(0, 43, 54, 0.15) !important;
        border: 1px solid rgba(238, 232, 213, 0.5) !important;
        margin-bottom: 24px !important;
      }
      .page-header h1 {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0 0 10px 0;
        color: var(--solar-text-primary) !important;
      }
      .nav-links {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .nav-links a {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--solar-text-secondary) !important;
        background: rgba(253, 246, 227, 0.5);
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid rgba(238, 232, 213, 0.6);
        text-decoration: none;
      }
      .nav-links a:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
      }

      /* Filters */
      .filter-section {
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(238, 232, 213, 0.6);
        border-radius: 12px;
        border: 1px solid var(--border-color);
      }
      .filter-section h3 {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0 0 10px 0;
        color: var(--solar-text-secondary);
      }

      /* Table */
      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow-md);
      }
      .data-table th,
      .data-table td {
        border-bottom: 1px solid var(--border-color);
        padding: 12px 14px;
        text-align: left;
      }
      .data-table th {
        background: var(--solar-primary);
        color: #fff;
        text-transform: none;
        letter-spacing: 0;
      }
      .data-table tbody tr:nth-child(even) {
        background: rgba(181, 137, 0, 0.05);
      }
      .data-table tbody tr:hover {
        background: rgba(38, 139, 210, 0.08);
      }

      /* Buttons */
      .btn,
      .edit-btn,
      .delete-btn,
      .add-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 10px;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: var(--transition);
      }
      .btn {
        background: var(--solar-secondary);
        color: #fff;
      }
      .edit-btn {
        background: #fdf0c7;
        color: var(--solar-text-primary);
        border: 1px solid rgba(245, 199, 0, 0.3);
      }
      .edit-btn:hover {
        background: #fde9aa;
      }
      .delete-btn {
        background: #fbe3e5;
        color: var(--solar-red);
        border: 1px solid rgba(220, 50, 47, 0.25);
      }
      .delete-btn:hover {
        background: #f8d2d6;
      }
      .add-btn {
        background: #e7f2d9;
        color: var(--solar-green);
        border: 1px solid rgba(133, 153, 0, 0.25);
      }
      .add-btn:hover {
        background: #d8ebc2;
      }

      .subject-group {
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 15px;
      }
    </style>
  </head>
  <body>
    <div class="manage-container">
      <header class="page-header">
        <h1>
          <!-- Heroicon: book-open -->
          <svg
            class="heroicon heroicon-lg heroicon-solar-yellow"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M2.25 5.25A2.25 2.25 0 014.5 3h6.75A2.25 2.25 0 0113.5 5.25v13.5a.75.75 0 01-1.148.638 6.466 6.466 0 00-3.602-1.088H4.5a2.25 2.25 0 01-2.25-2.25V5.25z"
            />
            <path
              d="M12.75 5.25A2.25 2.25 0 0115 3h4.5A2.25 2.25 0 0121.75 5.25v10.5A2.25 2.25 0 0119.5 18h-3.75a6.466 6.466 0 00-3.602 1.088.75.75 0 01-1.148-.638V5.25z"
            />
          </svg>
          Manage Teacher Subjects: {{ teacher.username }}
        </h1>
        <div class="nav-links">
          <a href="{{ url_for('classteacher.manage_teacher_assignments') }}">
            <svg
              class="heroicon heroicon-solar-blue"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M2.625 6A2.625 2.625 0 015.25 3.375h13.5A2.625 2.625 0 0121.375 6v9.75A2.625 2.625 0 0118.75 18.375H5.25A2.625 2.625 0 012.625 15.75V6zM5.25 4.875a1.125 1.125 0 00-1.125 1.125v9.75c0 .621.504 1.125 1.125 1.125h13.5c.621 0 1.125-.504 1.125-1.125V6a1.125 1.125 0 00-1.125-1.125H5.25z"
                clip-rule="evenodd"
              />
            </svg>
            Back to Teacher Assignments
          </a>
          <a href="{{ url_for('classteacher.dashboard') }}">
            <svg
              class="heroicon heroicon-solar-green"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M3 13.5A1.5 1.5 0 014.5 12h15a1.5 1.5 0 010 3h-15A1.5 1.5 0 013 13.5zM3 7.5A1.5 1.5 0 014.5 6h15a1.5 1.5 0 010 3h-15A1.5 1.5 0 013 7.5zM3 19.5A1.5 1.5 0 014.5 18h9a1.5 1.5 0 010 3h-9A1.5 1.5 0 013 19.5z"
              />
            </svg>
            Back to Dashboard
          </a>
          <a href="{{ url_for('auth.logout_route') }}">
            <svg
              class="heroicon heroicon-solar-red"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M3.75 5.25A2.25 2.25 0 016 3h6a2.25 2.25 0 012.25 2.25v2.378a.75.75 0 01-1.5 0V5.25a.75.75 0 00-.75-.75H6a.75.75 0 00-.75.75v13.5c0 .414.336.75.75.75h6a.75.75 0 00.75-.75v-2.378a.75.75 0 011.5 0v2.378A2.25 2.25 0 0112 21H6a2.25 2.25 0 01-2.25-2.25V5.25z"
                clip-rule="evenodd"
              />
              <path
                fill-rule="evenodd"
                d="M14.47 15.28a.75.75 0 001.06 0l3-3a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H9a.75.75 0 000 1.5h7.19l-1.72 1.72a.75.75 0 000 1.06z"
                clip-rule="evenodd"
              />
            </svg>
            Logout
          </a>
        </div>
      </header>

      <!-- Message container for notifications -->
      <div id="message-container">
        {% if error_message %}
        <div class="message message-error">{{ error_message }}</div>
        {% endif %} {% if success_message %}
        <div class="message message-success">{{ success_message }}</div>
        {% endif %} {% if session.get('assignment_success') %}
        <div class="message message-success highlight-message">
          {{ session.get('assignment_message') }}
          <script>
            // Remove the session variables after displaying
            window.onload = function () {
              fetch("/clear_assignment_session", { method: "POST" });
            };
          </script>
        </div>
        {% endif %}
      </div>

      <div class="manage-section">
        <h2>Current Subject Assignments</h2>

        <div class="filter-section">
          <h3>Filter Assignments</h3>
          <select id="educationLevelFilter" onchange="filterAssignments()">
            <option value="">All Education Levels</option>
            <option value="lower_primary">Lower Primary (Grades 1-3)</option>
            <option value="upper_primary">Upper Primary (Grades 4-6)</option>
            <option value="junior_secondary">
              Junior Secondary (Grades 7-9)
            </option>
          </select>
          <select id="gradeFilter" onchange="filterAssignments()">
            <option value="">All Grades</option>
            {% for grade in grades %}
            <option value="{{ grade.id }}">{{ grade.name }}</option>
            {% endfor %}
          </select>
        </div>

        <table class="data-table">
          <thead>
            <tr>
              <th>Subject</th>
              <th>Education Level</th>
              <th>Grade</th>
              <th>Stream</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="assignmentsTableBody">
            {% for assignment in subject_assignments %}
            <tr
              data-grade="{{ assignment.grade_id }}"
              data-education-level="{{ assignment.education_level }}"
              class="{% if assignment.is_new and session.get('assignment_success') %}highlight-row{% endif %}"
            >
              <td>{{ assignment.subject_name }}</td>
              <td>
                {{ assignment.education_level|replace('_', ' ')|title if
                assignment.education_level else 'N/A' }}
              </td>
              <td>{{ assignment.grade_level }}</td>
              <td>
                {{ assignment.stream_name if assignment.stream_name else 'All
                Streams' }}
              </td>
              <td>
                <div class="action-buttons">
                  <form
                    method="POST"
                    action="{{ url_for('classteacher.manage_teacher_subjects', teacher_id=teacher.id) }}"
                    style="display: inline"
                  >
                    <input
                      type="hidden"
                      name="csrf_token"
                      value="{{ csrf_token() }}"
                    />
                    <input
                      type="hidden"
                      name="assignment_id"
                      value="{{ assignment.id }}"
                    />
                    <button
                      type="submit"
                      name="remove_subject"
                      class="delete-btn"
                      onclick="return confirm('Remove this subject assignment?')"
                    >
                      <svg
                        class="heroicon"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M16.5 4.5a3 3 0 00-3-3h-3a3 3 0 00-3 3H3.75a.75.75 0 000 1.5H4.5v12A3 3 0 007.5 21h9a3 3 0 003-3v-12h.75a.75.75 0 000-1.5H16.5zm-6-1.5a1.5 1.5 0 00-1.5 1.5h6a1.5 1.5 0 00-1.5-1.5h-3zM8.25 7.5a.75.75 0 011.5 0v9a.75.75 0 01-1.5 0v-9zM12 7.5a.75.75 0 01.75.75v9a.75.75 0 01-1.5 0v-9A.75.75 0 0112 7.5zm3 .75a.75.75 0 00-1.5 0v9a.75.75 0 001.5 0v-9z"
                          clip-rule="evenodd"
                        />
                      </svg>
                      Remove
                    </button>
                  </form>
                  <button
                    class="edit-btn change-subject-btn"
                    data-assignment-id="{{ assignment.id }}"
                    data-subject="{{ assignment.subject_name }}"
                    data-grade="{{ assignment.grade_level }}"
                    data-stream="{{ assignment.stream_name if assignment.stream_name else 'All Streams' }}"
                  >
                    <svg
                      class="heroicon"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                    >
                      <path
                        d="M21.731 2.269a2.625 2.625 0 00-3.713 0l-1.92 1.92 3.713 3.713 1.92-1.92a2.625 2.625 0 000-3.713z"
                      />
                      <path
                        d="M2.684 16.311a2.25 2.25 0 01.59-1.014L14.4 4.17l3.713 3.713L6.987 19.01a2.25 2.25 0 01-1.014.59l-3.34.956a.75.75 0 01-.923-.923l.956-3.34z"
                      />
                    </svg>
                    Change Subject
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="manage-section">
        <h2>Add New Subject Assignments</h2>
        <form
          method="POST"
          action="{{ url_for('classteacher.manage_teacher_subjects', teacher_id=teacher.id) }}"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

          <!-- Education Level Selection -->
          <div class="form-group">
            <label for="education_level">Education Level:</label>
            <select
              id="education_level"
              name="education_level"
              required
              class="form-control"
              onchange="updateSubjectsAndGrades()"
            >
              <option value="">-- Select Education Level --</option>
              <option value="lower_primary">Lower Primary (Grades 1-3)</option>
              <option value="upper_primary">Upper Primary (Grades 4-6)</option>
              <option value="junior_secondary">
                Junior Secondary (Grades 7-9)
              </option>
            </select>
          </div>

          <!-- Grade Selection -->
          <div class="form-group">
            <label for="grade_id">Grade:</label>
            <select
              id="grade_id"
              name="grade_id"
              required
              class="form-control"
              onchange="updateStreams()"
            >
              <option value="">-- Select Grade --</option>
              {% for grade in grades %}
              <option
                value="{{ grade.id }}"
                data-education-level="{% if grade.name in ['Grade 1', 'Grade 2', 'Grade 3'] %}lower_primary{% elif grade.name in ['Grade 4', 'Grade 5', 'Grade 6'] %}upper_primary{% elif grade.name in ['Grade 7', 'Grade 8', 'Grade 9'] %}junior_secondary{% endif %}"
              >
                {{ grade.name }}
              </option>
              {% endfor %}
            </select>
          </div>

          <!-- Stream Selection -->
          <div class="form-group">
            <label for="stream_id">Stream (Optional):</label>
            <select id="stream_id" name="stream_id" class="form-control">
              <option value="">All Streams</option>
              <!-- Streams will be populated by JavaScript -->
            </select>
          </div>

          <!-- Subject Selection -->
          <div class="form-group">
            <label>Subjects:</label>
            <div id="subjectsContainer">
              <!-- Subject checkboxes will be populated by JavaScript -->
              <p>Please select an education level first</p>
            </div>
          </div>

          <button type="submit" name="add_subjects" class="btn">
            <svg class="heroicon" viewBox="0 0 24 24" fill="currentColor">
              <path
                fill-rule="evenodd"
                d="M12 2.25a.75.75 0 01.75.75V11h8a.75.75 0 010 1.5h-8v8a.75.75 0 01-1.5 0v-8H3a.75.75 0 010-1.5h8V3a.75.75 0 01.75-.75z"
                clip-rule="evenodd"
              />
            </svg>
            Add Subject Assignments
          </button>
        </form>
      </div>
    </div>

    <!-- Change Subject Modal -->
    <div id="changeSubjectModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeChangeSubjectModal()">&times;</span>
        <h2>Change Subject Assignment</h2>
        <form
          id="changeSubjectForm"
          method="POST"
          action="{{ url_for('classteacher.manage_teacher_subjects', teacher_id=teacher.id) }}"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input
            type="hidden"
            id="change_assignment_id"
            name="change_assignment_id"
          />

          <div class="form-group">
            <label for="current_assignment">Current Assignment:</label>
            <input
              type="text"
              id="current_assignment"
              class="form-control"
              readonly
            />
          </div>

          <div class="form-group">
            <label for="new_subject_id">New Subject:</label>
            <select
              id="new_subject_id"
              name="new_subject_id"
              required
              class="form-control"
            >
              <option value="">-- Select Subject --</option>
              {% for subject in subjects %}
              <option value="{{ subject.id }}">
                {{ subject.name }} ({{ subject.education_level|replace('_', '
                ')|title }})
              </option>
              {% endfor %}
            </select>
          </div>

          <button type="submit" name="change_subject" class="btn btn-primary">
            Change Subject
          </button>
        </form>
      </div>
    </div>

    <!-- Embedded data as JSON to avoid JS linter issues with Jinja -->
    <script id="subjectsData" type="application/json">
      {{ subjects | tojson | safe }}
    </script>
    <script id="streamsData" type="application/json">
      {{ streams | tojson | safe }}
    </script>

    <script>
      // Auto-hide messages after 5 seconds
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(function () {
          const messages = document.querySelectorAll(".message");
          messages.forEach((message) => {
            message.style.display = "none";
          });
        }, 5000);

        // Initialize the form
        updateSubjectsAndGrades();
      });

      // Filter assignments
      function filterAssignments() {
        const educationLevel = document.getElementById(
          "educationLevelFilter"
        ).value;
        const gradeId = document.getElementById("gradeFilter").value;
        const rows = document.querySelectorAll("#assignmentsTableBody tr");

        rows.forEach((row) => {
          let showRow = true;

          if (educationLevel && row.dataset.educationLevel !== educationLevel) {
            showRow = false;
          }

          if (gradeId && row.dataset.grade !== gradeId) {
            showRow = false;
          }

          row.style.display = showRow ? "" : "none";
        });
      }

      // Update subjects and grades based on education level
      function updateSubjectsAndGrades() {
        const educationLevel = document.getElementById("education_level").value;
        const gradeSelect = document.getElementById("grade_id");
        const subjectsContainer = document.getElementById("subjectsContainer");

        // Filter grades by education level
        Array.from(gradeSelect.options).forEach((option) => {
          if (option.value === "") return; // Skip the placeholder option

          const optionEducationLevel = option.dataset.educationLevel;
          option.style.display =
            !educationLevel || optionEducationLevel === educationLevel
              ? ""
              : "none";
        });

        // Reset grade selection if current selection doesn't match education level
        if (gradeSelect.selectedIndex > 0) {
          const selectedOption = gradeSelect.options[gradeSelect.selectedIndex];
          if (selectedOption.dataset.educationLevel !== educationLevel) {
            gradeSelect.value = "";
          }
        }

        // Update subjects based on education level
        if (!educationLevel) {
          subjectsContainer.innerHTML =
            "<p>Please select an education level first</p>";
          return;
        }

        // Read subjects from embedded JSON
        const subjectsList = JSON.parse(
          document.getElementById("subjectsData").textContent || "[]"
        );
        const filteredSubjects = subjectsList.filter(
          (s) => s.education_level === educationLevel
        );

        if (filteredSubjects.length === 0) {
          subjectsContainer.innerHTML =
            "<p>No subjects found for this education level</p>";
          return;
        }

        // Group subjects by education level
        let html = `<div class="subject-group">
          <h3>${educationLevel
            .replace("_", " ")
            .replace(/\b\w/g, (l) => l.toUpperCase())} Subjects</h3>
          <div class="checkbox-group">`;

        filteredSubjects.forEach((subject) => {
          html += `
            <div class="checkbox-item">
              <input type="checkbox" id="subject_${subject.id}" name="subject_ids" value="${subject.id}">
              <label for="subject_${subject.id}">${subject.name}</label>
            </div>`;
        });

        html += `</div></div>`;

        subjectsContainer.innerHTML = html;

        // Update streams
        updateStreams();
      }

      // Update streams based on grade
      function updateStreams() {
        const gradeId = document.getElementById("grade_id").value;
        const streamSelect = document.getElementById("stream_id");

        // Clear current options except the first one
        while (streamSelect.options.length > 1) {
          streamSelect.remove(1);
        }

        if (!gradeId) return;

        // Read streams from embedded JSON
        const streamsList = JSON.parse(
          document.getElementById("streamsData").textContent || "[]"
        );
        const filteredStreams = streamsList.filter(
          (stream) => String(stream.grade_id) === String(gradeId)
        );

        filteredStreams.forEach((stream) => {
          const option = document.createElement("option");
          option.value = stream.id;
          option.textContent = stream.name;
          streamSelect.appendChild(option);
        });
      }

      // Change subject modal functions
      function openChangeSubjectModal(assignmentId, subject, grade, stream) {
        document.getElementById("change_assignment_id").value = assignmentId;
        document.getElementById(
          "current_assignment"
        ).value = `${subject} - ${grade} ${stream}`;
        document.getElementById("changeSubjectModal").style.display = "block";
      }

      function closeChangeSubjectModal() {
        document.getElementById("changeSubjectModal").style.display = "none";
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target == document.getElementById("changeSubjectModal")) {
          closeChangeSubjectModal();
        }
      };

      document.addEventListener("DOMContentLoaded", function () {
        // Delegated handler for change subject
        document.body.addEventListener("click", function (e) {
          const btn = e.target.closest(".change-subject-btn");
          if (!btn) return;
          const id = btn.dataset.assignmentId;
          const subject = btn.dataset.subject;
          const grade = btn.dataset.grade;
          const stream = btn.dataset.stream;
          openChangeSubjectModal(id, subject, grade, stream);
        });
      });
    </script>
  </body>
</html>
