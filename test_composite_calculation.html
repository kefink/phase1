<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Composite Subject Calculation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .subject-header {
            background-color: #1e6f5c;
            color: white;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .component-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .component-label {
            width: 150px;
            font-weight: bold;
        }
        .component-input {
            width: 80px;
            padding: 5px;
            margin: 0 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .overall-display {
            background-color: #e8f5e9;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            border: 2px solid #28a745;
        }
        .percentage-display {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }
        .debug-info {
            background-color: #f8f9fa;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Composite Subject Calculation</h1>
        <p>This page tests the JavaScript calculation for composite subjects like English and Kiswahili.</p>
        
        <div class="subject-header">
            <h2>English (Composite Subject)</h2>
            <p>Components: Grammar (50%) + Composition (50%)</p>
        </div>
        
        <div class="component-row">
            <span class="component-label">Grammar:</span>
            <input type="number" 
                   class="component-input component-mark" 
                   data-student="Test_Student" 
                   data-subject="2" 
                   data-component="1" 
                   data-component-weight="0.5" 
                   data-max-mark="50" 
                   min="0" 
                   max="50" 
                   value="0"
                   oninput="updateComponentPercentage(this); calculateOverallSubjectMark('Test_Student', '2')"
                   placeholder="0-50">
            <span>/ 50 marks</span>
        </div>
        
        <div class="component-row">
            <span class="component-label">Composition:</span>
            <input type="number" 
                   class="component-input component-mark" 
                   data-student="Test_Student" 
                   data-subject="2" 
                   data-component="2" 
                   data-component-weight="0.5" 
                   data-max-mark="50" 
                   min="0" 
                   max="50" 
                   value="0"
                   oninput="updateComponentPercentage(this); calculateOverallSubjectMark('Test_Student', '2')"
                   placeholder="0-50">
            <span>/ 50 marks</span>
        </div>
        
        <div class="overall-display">
            <h3>Overall English Performance:</h3>
            <div id="overall_percentage_display_Test_Student_2" class="percentage-display">0%</div>
            <div style="margin-top: 10px;">
                <div style="background-color: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div class="percentage-fill" style="width: 0%; height: 100%; background-color: #28a745; transition: width 0.3s ease;"></div>
                </div>
            </div>
        </div>
        
        <!-- Hidden fields (like in the real form) -->
        <input type="hidden" id="overall_mark_Test_Student_2" value="0">
        <input type="hidden" id="hidden_percentage_Test_Student_2" value="0">
        
        <div class="debug-info">
            <h4>Debug Information:</h4>
            <div id="debug-output">Enter marks above to see calculation details...</div>
        </div>
    </div>

    <script>
        // Copy the exact JavaScript functions from the classteacher template
        function updateComponentPercentage(inputElement) {
            console.log("Updating component percentage...");
            
            // Get the student, subject, and component information from data attributes
            const student = inputElement.dataset.student;
            const subject = inputElement.dataset.subject;
            const component = inputElement.dataset.component;
            const componentWeight = parseFloat(inputElement.dataset.componentWeight) || 1.0;
            
            // Get the raw mark and max mark
            let rawMark = parseInt(inputElement.value) || 0;
            const maxMark = parseInt(inputElement.dataset.maxMark) || 100;
            
            // Ensure the raw mark doesn't exceed the max mark
            if (rawMark > maxMark) {
                rawMark = maxMark;
                inputElement.value = maxMark;
                console.log(`Raw mark exceeded maximum (${maxMark}), capped at maximum`);
            }
            
            // Add visual feedback for mark entry
            if (rawMark > 0) {
                inputElement.classList.add('has-value');
                inputElement.style.backgroundColor = '#e8f5e9';
            } else {
                inputElement.classList.remove('has-value');
                inputElement.style.backgroundColor = '';
            }
            
            // Calculate the overall subject mark based on all components
            calculateOverallSubjectMark(student, subject);
        }

        function calculateOverallSubjectMark(student, subject) {
            console.log(`Calculating overall mark for student: ${student}, subject: ${subject}`);
            
            // Find all component inputs for this student and subject
            const componentInputs = document.querySelectorAll(`input.component-mark[data-student="${student}"][data-subject="${subject}"]`);
            console.log(`Found ${componentInputs.length} component inputs`);
            
            if (componentInputs.length === 0) return;
            
            let totalWeightedPercentage = 0;
            let totalWeight = 0;
            let debugInfo = [];
            
            // Calculate weighted percentage for each component
            componentInputs.forEach(input => {
                const rawMark = parseInt(input.value) || 0;
                const maxMark = parseInt(input.dataset.maxMark) || 100;
                const weight = parseFloat(input.dataset.componentWeight) || 1.0;
                const componentName = input.dataset.component === '1' ? 'Grammar' : 'Composition';
                
                // Calculate percentage for this component (out of 100%)
                const percentage = maxMark > 0 ? (rawMark / maxMark) * 100 : 0;
                
                // Apply the weight to get the weighted contribution to the final mark
                const weightedContribution = percentage * weight;
                
                // Add to the total
                totalWeightedPercentage += weightedContribution;
                totalWeight += weight;
                
                debugInfo.push(`${componentName}: ${rawMark}/${maxMark} = ${percentage.toFixed(1)}% × ${weight} = ${weightedContribution.toFixed(1)}`);
                
                console.log(`Component: ${componentName}, Raw: ${rawMark}, Max: ${maxMark}, Weight: ${weight}, Percentage: ${percentage.toFixed(1)}%, Weighted: ${weightedContribution.toFixed(1)}`);
            });
            
            // Calculate overall percentage using weighted average
            const overallPercentage = totalWeight > 0 ? totalWeightedPercentage / totalWeight : 0;
            console.log(`Total weighted percentage: ${totalWeightedPercentage.toFixed(1)}, Total weight: ${totalWeight}, Overall: ${overallPercentage.toFixed(1)}%`);
            
            // Round the overall percentage to a whole number
            const roundedOverallPercentage = Math.round(overallPercentage);
            
            // Update hidden fields for overall mark and percentage
            const overallMarkField = document.getElementById(`overall_mark_${student}_${subject}`);
            const overallPercentageField = document.getElementById(`hidden_percentage_${student}_${subject}`);
            
            if (overallMarkField && overallPercentageField) {
                overallMarkField.value = roundedOverallPercentage;
                overallPercentageField.value = roundedOverallPercentage;
                console.log(`Updated hidden fields: mark=${roundedOverallPercentage}, percentage=${roundedOverallPercentage}`);
            }
            
            // Update the overall percentage display
            const overallPercentageDisplay = document.getElementById(`overall_percentage_display_${student}_${subject}`);
            if (overallPercentageDisplay) {
                overallPercentageDisplay.textContent = `${roundedOverallPercentage}%`;
                console.log(`Updated display to: ${roundedOverallPercentage}%`);
                
                // Update the color based on performance level
                if (roundedOverallPercentage >= 75) {
                    overallPercentageDisplay.style.color = '#28a745'; // Exceeding Expectation
                } else if (roundedOverallPercentage >= 50) {
                    overallPercentageDisplay.style.color = '#17a2b8'; // Meeting Expectation
                } else if (roundedOverallPercentage >= 30) {
                    overallPercentageDisplay.style.color = '#ffc107'; // Approaching Expectation
                } else {
                    overallPercentageDisplay.style.color = '#dc3545'; // Below Expectation
                }
                
                // Update the percentage bar
                const percentageFill = overallPercentageDisplay.nextElementSibling?.querySelector('.percentage-fill');
                if (percentageFill) {
                    percentageFill.style.width = `${Math.min(roundedOverallPercentage, 100)}%`;
                    
                    // Set color based on performance level
                    if (roundedOverallPercentage >= 75) {
                        percentageFill.style.backgroundColor = '#28a745'; // Exceeding Expectation
                    } else if (roundedOverallPercentage >= 50) {
                        percentageFill.style.backgroundColor = '#17a2b8'; // Meeting Expectation
                    } else if (roundedOverallPercentage >= 30) {
                        percentageFill.style.backgroundColor = '#ffc107'; // Approaching Expectation
                    } else {
                        percentageFill.style.backgroundColor = '#dc3545'; // Below Expectation
                    }
                }
            }
            
            // Update debug information
            const debugOutput = document.getElementById('debug-output');
            if (debugOutput) {
                debugOutput.innerHTML = `
                    <strong>Calculation Details:</strong><br>
                    ${debugInfo.join('<br>')}<br>
                    <strong>Total Weighted: ${totalWeightedPercentage.toFixed(1)}</strong><br>
                    <strong>Total Weight: ${totalWeight}</strong><br>
                    <strong>Final Percentage: ${overallPercentage.toFixed(1)}% → ${roundedOverallPercentage}%</strong>
                `;
            }
        }
    </script>
</body>
</html>
